# PCI Compliance For AWS CloudTrail
## Sumo Logic App For: PCI Compliance For AWS CloudTrail
The Sumo Logic App for Payment Card Industry (PCI) Compliance for AWS CloudTrail offers dashboards to monitor systems, account, access and users activity to ensure that login activity and privileged users/activities are within the expected ranges. The PCI Compliance for AWS CloudTrail App covers PCI requirements 01, 08 and 10.
Docs Link: [PCI Compliance For AWS CloudTrail](https://help.sumologic.com/?cid=5111)

## Searches

### Log Searches

- **Console Login Failures**: from Dashboard: PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 10 - Login Activity - New 
- **Console Login Failures**: from Dashboard: PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 10 - Login Activity - New 
- **Console Root Login Failures**: from Dashboard: PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 10 - Login Activity - New 
- **Console Root Login Failures**: from Dashboard: PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 10 - Login Activity - New 
- **Failed API Calls**: from Dashboard: PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 10 - Login Activity - New 
- **Failed API Calls - Acct Breakup**: from Dashboard: PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 10 - Login Activity - New 
- **Failed API Calls - Reason - Login Credentials and Permission Issues**: from Dashboard: PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 10 - Login Activity - New 
- **Non Read Only Events**: from Dashboard: PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 01 - Access Monitoring - New 
- **Read Only Events**: from Dashboard: PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 01 - Access Monitoring - New 
- **Security Group Activity**: from Dashboard: PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 01 - Access Monitoring - New 
- **Security Group Activity**: from Dashboard: PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 01 - Access Monitoring - New 
- **Security Group Activity Over Time**: from Dashboard: PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 01 - Access Monitoring - New 
- **Successful Console Logins**: from Dashboard: PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 10 - Login Activity - New 
- **Successful Console Logins**: from Dashboard: PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 10 - Login Activity - New 
- **Successful Root Console Logins**: from Dashboard: PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 10 - Login Activity - New 
- **Successful Root Console Logins**: from Dashboard: PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 10 - Login Activity - New

### Metric Searches


## Search Table

|app\_topic|search\_name|type|origin|search|
|:--|:--|:--|:--|:--|
|PCI Compliance For AWS CloudTrail|Console Login Failures|Logs|PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 10 - Login Activity - New|\_sourceCategory = Labs/AWS/CloudTrail\* ConsoleLogin AwsConsoleSignIn Failure<br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"errorMessage\\":\\"\*\\"" as errorMessage nodrop \| parse "\\"errorCode\\":\\"\*\\"" as errorCode nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"MFAUsed\\":\\"\*\\"" as mfaUsed nodrop \| parse "\\"responseElements\\":{\\"ConsoleLogin\\":\\"\*\\"}" as loginResult nodrop \| parse field=errorMessage " Error Code: \*; Request ID" as errorCode2 nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop<br />\| if (isEmpty(errorCode), errorCode2, errorCode) as errorCode <br />\| source\_ipaddress as src\_ip \| user as dest\_user<br />\| where event\_name="ConsoleLogin" and event\_type="AwsConsoleSignIn" and loginResult="Failure"<br />\| timeslice 1s<br />\|where if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{aws\_region}}" = "\*", true, aws\_region matches "{{aws\_region}}") AND if ("{{event\_type}}" = "\*", true, event\_type matches "{{event\_type}}") AND if ("{{errorcode}}" = "\*", true, errorcode matches "{{errorcode}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}") AND if ("{{dest\_user}}" = "\*", true, dest\_user matches "{{dest\_user}}") AND if ("{{principalid}}" = "\*", true, principalid matches "{{principalid}}")<br />\|count as eventCount by \_timeslice, src\_ip, dest\_user, mfaUsed, event\_Type, event\_name, errorCode, errorMessage, principalId, aws\_region, accountId<br />\| sort by \_timeslice|
|PCI Compliance For AWS CloudTrail|Console Login Failures|Logs|PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 10 - Login Activity - New|\_sourceCategory = Labs/AWS/CloudTrail\* ConsoleLogin AwsConsoleSignIn Failure<br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"errorMessage\\":\\"\*\\"" as errorMessage nodrop \| parse "\\"errorCode\\":\\"\*\\"" as errorCode nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"MFAUsed\\":\\"\*\\"" as mfaUsed nodrop \| parse "\\"responseElements\\":{\\"ConsoleLogin\\":\\"\*\\"}" as loginResult nodrop \| parse field=errorMessage " Error Code: \*; Request ID" as errorCode2 nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop<br />\| if (isEmpty(errorCode), errorCode2, errorCode) as errorCode <br />\| source\_ipaddress as src\_ip \| user as dest\_user<br />\| where event\_name="ConsoleLogin" and event\_type="AwsConsoleSignIn" and loginResult="Failure"<br />\| fields src\_ip, dest\_user, mfaUsed, event\_Type, event\_name, errorCode, errorMessage, principalId, aws\_region, source\_ipaddress, accountId<br />\|where if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{aws\_region}}" = "\*", true, aws\_region matches "{{aws\_region}}") AND if ("{{event\_type}}" = "\*", true, event\_type matches "{{event\_type}}") AND if ("{{errorcode}}" = "\*", true, errorcode matches "{{errorcode}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}") AND if ("{{dest\_user}}" = "\*", true, dest\_user matches "{{dest\_user}}") AND if ("{{principalid}}" = "\*", true, principalid matches "{{principalid}}")<br />\|count as eventCount|
|PCI Compliance For AWS CloudTrail|Console Root Login Failures|Logs|PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 10 - Login Activity - New|\_sourceCategory = Labs/AWS/CloudTrail\* ConsoleLogin AwsConsoleSignIn Failure Root<br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"errorMessage\\":\\"\*\\"" as errorMessage nodrop \| parse "\\"errorCode\\":\\"\*\\"" as errorCode nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"MFAUsed\\":\\"\*\\"" as mfaUsed nodrop \| parse "\\"responseElements\\":{\\"ConsoleLogin\\":\\"\*\\"}" as loginResult nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse field=arn "\*:\*:\*::\*:\*" as f1, f2, f3, f4, user nodrop \| parse field=arn "\*:\*:\*::\*:\*/\*/\*" as f1, f2, f3, f4, f5, role, f7 nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop<br />\| json "userIdentity.type" as type nodrop<br />\| if (isEmpty(user) and !isEmpty(user\_temp), user\_temp, user) as user<br />\| source\_ipaddress as src\_ip \| user as dest\_user<br />\| where event\_name="ConsoleLogin" and event\_type="AwsConsoleSignIn" and loginResult="Failure" and type="Root"<br />\| fields type, src\_ip, dest\_user, mfaUsed, event\_Type, event\_name, errorCode, errorMessage, principalId, aws\_region, accountId<br />\|where if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{aws\_region}}" = "\*", true, aws\_region matches "{{aws\_region}}") AND if ("{{event\_type}}" = "\*", true, event\_type matches "{{event\_type}}") AND if ("{{errorcode}}" = "\*", true, errorcode matches "{{errorcode}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}") AND if ("{{dest\_user}}" = "\*", true, dest\_user matches "{{dest\_user}}") AND if ("{{principalid}}" = "\*", true, principalid matches "{{principalid}}")<br />\|count as eventCount|
|PCI Compliance For AWS CloudTrail|Console Root Login Failures|Logs|PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 10 - Login Activity - New|\_sourceCategory = Labs/AWS/CloudTrail\* ConsoleLogin AwsConsoleSignIn Failure Root<br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"errorMessage\\":\\"\*\\"" as errorMessage nodrop \| parse "\\"errorCode\\":\\"\*\\"" as errorCode nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"MFAUsed\\":\\"\*\\"" as mfaUsed nodrop \| parse "\\"responseElements\\":{\\"ConsoleLogin\\":\\"\*\\"}" as loginResult nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse field=arn "\*:\*:\*::\*:\*" as f1, f2, f3, f4, user nodrop \| parse field=arn "\*:\*:\*::\*:\*/\*/\*" as f1, f2, f3, f4, f5, role, f7 nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop<br />\| json "userIdentity.type" as type nodrop<br />\| if (isEmpty(user) and !isEmpty(user\_temp), user\_temp, user) as user<br />\| source\_ipaddress as src\_ip \| user as dest\_user<br />\| where event\_name="ConsoleLogin" and event\_type="AwsConsoleSignIn" and loginResult="Failure" and type="Root"<br />\| timeslice 1s<br />\|where if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{role}}" = "\*", true, role matches "{{role}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{aws\_region}}" = "\*", true, aws\_region matches "{{aws\_region}}") AND if ("{{event\_type}}" = "\*", true, event\_type matches "{{event\_type}}") AND if ("{{errorcode}}" = "\*", true, errorcode matches "{{errorcode}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}") AND if ("{{dest\_user}}" = "\*", true, dest\_user matches "{{dest\_user}}") AND if ("{{principalid}}" = "\*", true, principalid matches "{{principalid}}")<br />\|count as eventCount by \_timeslice, type, src\_ip, dest\_user, mfaUsed, event\_Type, event\_name, errorMessage, principalId, aws\_region, accountId<br />\| fields -eventCount<br />\| sort by \_timeslice|
|PCI Compliance For AWS CloudTrail|Failed API Calls|Logs|PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 10 - Login Activity - New|\_sourceCategory = Labs/AWS/CloudTrail\* AwsApiCall ("Client.UnauthorizedOperation" or AccessDenied) <br />\| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"errorCode\\":\\"\*\\"" as errorCode nodrop \| parse "\\"errorMessage\\":\\"\*\\"" as errorMessage nodrop \| parse "\\"mfaAuthenticated\\":\\"\*\\"" as mfaAuthenticated nodrop <br />\| source\_ipaddress as src\_ip \| user as dest\_user<br />\| where event\_type="AwsApiCall" and errorCode in ("Client.UnauthorizedOperation", "AccessDenied")<br />\| fields accountId, src\_ip, dest\_user, mfaAuthenticated, event\_Type, event\_name, errorCode, principalId, aws\_region<br />\|where if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{aws\_region}}" = "\*", true, aws\_region matches "{{aws\_region}}") AND if ("{{event\_type}}" = "\*", true, event\_type matches "{{event\_type}}") AND if ("{{errorcode}}" = "\*", true, errorcode matches "{{errorcode}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}") AND if ("{{dest\_user}}" = "\*", true, dest\_user matches "{{dest\_user}}") AND if ("{{principalid}}" = "\*", true, principalid matches "{{principalid}}")<br />\|count as eventCount|
|PCI Compliance For AWS CloudTrail|Failed API Calls - Acct Breakup|Logs|PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 10 - Login Activity - New|\_sourceCategory = Labs/AWS/CloudTrail\* AwsApiCall ("Client.UnauthorizedOperation" or AccessDenied) <br />\| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"errorCode\\":\\"\*\\"" as errorCode nodrop \| parse "\\"errorMessage\\":\\"\*\\"" as errorMessage nodrop \| parse "\\"mfaAuthenticated\\":\\"\*\\"" as mfaAuthenticated nodrop <br />\| source\_ipaddress as src\_ip \| user as dest\_user<br />\| where event\_type="AwsApiCall" and errorCode in ("Client.UnauthorizedOperation", "AccessDenied")<br />\|where if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{aws\_region}}" = "\*", true, aws\_region matches "{{aws\_region}}") AND if ("{{event\_type}}" = "\*", true, event\_type matches "{{event\_type}}") AND if ("{{errorcode}}" = "\*", true, errorcode matches "{{errorcode}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}") AND if ("{{dest\_user}}" = "\*", true, dest\_user matches "{{dest\_user}}") AND if ("{{principalid}}" = "\*", true, principalid matches "{{principalid}}")<br />\|count as eventCount by accountId \| sort by eventCount|
|PCI Compliance For AWS CloudTrail|Failed API Calls - Reason - Login Credentials and Permission Issues|Logs|PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 10 - Login Activity - New|\_sourceCategory = Labs/AWS/CloudTrail\* AwsApiCall ("Client.UnauthorizedOperation" or AccessDenied) <br />\| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"errorCode\\":\\"\*\\"" as errorCode nodrop \| parse "\\"errorMessage\\":\\"\*\\"" as errorMessage nodrop \| parse "\\"mfaAuthenticated\\":\\"\*\\"" as mfaAuthenticated nodrop <br />\| source\_ipaddress as src\_ip \| user as dest\_user<br />\| where event\_Type="AwsApiCall" and errorcode in ("Client.UnauthorizedOperation", "AccessDenied") <br />\| timeslice 1s<br />\|where if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{aws\_region}}" = "\*", true, aws\_region matches "{{aws\_region}}") AND if ("{{event\_type}}" = "\*", true, event\_type matches "{{event\_type}}") AND if ("{{errorcode}}" = "\*", true, errorcode matches "{{errorcode}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}") AND if ("{{dest\_user}}" = "\*", true, dest\_user matches "{{dest\_user}}") AND if ("{{principalid}}" = "\*", true, principalid matches "{{principalid}}")<br />\|count as eventCount by \_timeslice, src\_ip, dest\_user, mfaAuthenticated, event\_Type, event\_name, errorCode, principalId, aws\_region, accountId<br />\| sort by \_timeslice|
|PCI Compliance For AWS CloudTrail|Non Read Only Events|Logs|PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 01 - Access Monitoring - New|\_sourceCategory = Labs/AWS/CloudTrail\*<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop \| parse field=arn "\*:\*:\*::\*:\*" as f1, f2, f3, f4, user nodrop \| parse field=arn "\*:\*:\*::\*:\*/\*/\*" as f1, f2, f3, f4, f5, role, f7 nodrop <br />\| where !(event\_name matches "Describe\*") and !(event\_name matches "Get\*") and !(event\_name matches "List\*")<br />\| if (isEmpty(user) and !isEmpty(user\_temp), user\_temp, user) as user<br />\|where if ("{{role}}" = "\*", true, role matches "{{role}}") AND if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}") AND if ("{{principalid}}" = "\*", true, principalid matches "{{principalid}}")<br />\|count as eventCount by user, event\_name<br />\| sort eventCount, user, event\_name|
|PCI Compliance For AWS CloudTrail|Read Only Events|Logs|PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 01 - Access Monitoring - New|\_sourceCategory = Labs/AWS/CloudTrail\* (Describe\* or Get\* or List\*)<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop \| parse field=arn "\*:\*:\*::\*:\*" as f1, f2, f3, f4, user nodrop \| parse field=arn "\*:\*:\*::\*:\*/\*/\*" as f1, f2, f3, f4, f5, role, f7 nodrop <br />\| where (event\_name matches "Describe\*" or event\_name matches "Get\*" or event\_name matches "List\*")<br />\| if (isEmpty(user) and !isEmpty(user\_temp), user\_temp, user) as user<br />\|where if ("{{role}}" = "\*", true, role matches "{{role}}") AND if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}") AND if ("{{principalid}}" = "\*", true, principalid matches "{{principalid}}")<br />\|count as eventCount by user, event\_name<br />\| sort eventCount, user, event\_name|
|PCI Compliance For AWS CloudTrail|Security Group Activity|Logs|PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 01 - Access Monitoring - New|\_sourceCategory = Labs/AWS/CloudTrail\* \*SecurityGroup\*<br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"roleName\\":\\"\*\\"" as roleName nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse "\\"portRange\\":{\\"from\\":\*,\\"to\\":\*}" as from\_port,to\_port nodrop \| parse "\\"fromPort\\":\*,\\"toPort\\":\*," as from\_Port,to\_Port nodrop \| parse "\\"cidrBlock\\":\\"\*\\"" as cidr\_block nodrop \| parse "\\"cidrIp\\":\\"\*\\"" as cidr\_ip nodrop \| parse "\\"egress\\":\*," as egress nodrop  \| parse "\\"ruleAction\\":\\"\*\\"" as action nodrop \| parse "\\"groupName\\":\\"\*\\"," as groupName nodrop \| parse "\\"groupDescription\\":\\"\*\\"," as groupDescription nodrop \| parse "\\"groupId\\":\\"\*\\"" as groupId nodrop \| parse regex field=event\_name "SecurityGroup(?\<direction\>[A-Za-z]+)" nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop \| parse field=arn "\*:\*:\*::\*:\*" as f1, f2, f3, f4, user nodrop \| parse field=arn "\*:\*:\*::\*:\*/\*/\*" as f1, f2, f3, f4, f5, role, f7 nodrop<br />\| where event\_name matches "\*SecurityGroup\*" and !(event\_name matches "Describe\*")<br />\| if (isEmpty(user) and !isEmpty(user\_temp), user\_temp, user) as user<br />\| source\_ipaddress as src\_ip \| user as src\_user<br />\| timeslice 1s<br />\|where if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{role}}" = "\*", true, role matches "{{role}}") AND if ("{{source\_ipaddress}}" = "\*", true, source\_ipaddress matches "{{source\_ipaddress}}") AND if ("{{rolename}}" = "\*", true, rolename matches "{{rolename}}") AND if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{aws\_region}}" = "\*", true, aws\_region matches "{{aws\_region}}") AND if ("{{event\_type}}" = "\*", true, event\_type matches "{{event\_type}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}") AND if ("{{principalid}}" = "\*", true, principalid matches "{{principalid}}")<br />\|count as eventCount by \_timeslice, src\_ip, src\_user, event\_type, event\_name, event\_source, principalid, aws\_region, groupid, groupname, groupDescription, direction, from\_port, to\_Port, cidr\_block, cidr\_ip, egress, action, accountid<br />\| sort by \_timeslice|
|PCI Compliance For AWS CloudTrail|Security Group Activity|Logs|PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 01 - Access Monitoring - New|\_sourceCategory = Labs/AWS/CloudTrail\* \*SecurityGroup\*<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop<br />\| where event\_name matches "\*SecurityGroup\*" and !(event\_name matches "Describe\*") and !(event\_name matches "List\*") and !(event\_name matches "Get\*")<br />\|where if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}")<br />\|count as eventCount by event\_name<br />\| sort by eventCount|
|PCI Compliance For AWS CloudTrail|Security Group Activity Over Time|Logs|PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 01 - Access Monitoring - New|\_sourceCategory = Labs/AWS/CloudTrail\* \*SecurityGroup\*<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop<br />\| where event\_name matches "\*SecurityGroup\*" and !(event\_name matches "Describe\*")  and !(event\_name matches "Get\*") and !(event\_name matches "List\*")<br />\| timeslice 1h<br />\|where if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}")<br />\|count as eventCount by \_timeslice, event\_name<br />\| transpose row \_timeslice column event\_name|
|PCI Compliance For AWS CloudTrail|Successful Console Logins|Logs|PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 10 - Login Activity - New|\_sourceCategory = Labs/AWS/CloudTrail\* ConsoleLogin AwsConsoleSignIn Success <br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop\| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop \| parse "\\"MFAUsed\\":\\"\*\\"" as mfaUsed nodrop \| parse "\\"responseElements\\":{\\"ConsoleLogin\\":\\"\*\\"}" as loginResult nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse field=arn "\*:\*:\*::\*:\*" as f1, f2, f3, f4, user nodrop \| parse field=arn "\*:\*:\*::\*:\*/\*/\*" as f1, f2, f3, f4, f5, role, f7 nodrop<br />\| if (isEmpty(user) and !isEmpty(user\_temp), user\_temp, user) as user<br />\| source\_ipaddress as src\_ip \| user as dest\_user<br />\| where loginResult="Success" and event\_Type="AwsConsoleSignIn" and event\_name="ConsoleLogin"<br />\| timeslice 1s<br />\|where if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{role}}" = "\*", true, role matches "{{role}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{aws\_region}}" = "\*", true, aws\_region matches "{{aws\_region}}") AND if ("{{event\_type}}" = "\*", true, event\_type matches "{{event\_type}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}") AND if ("{{dest\_user}}" = "\*", true, dest\_user matches "{{dest\_user}}") AND if ("{{principalid}}" = "\*", true, principalid matches "{{principalid}}")<br />\|count as eventCount by \_timeslice, src\_ip, dest\_user, role, mfaUsed, event\_Type, event\_name, principalId, aws\_region, accountId<br />\| sort by \_timeslice|
|PCI Compliance For AWS CloudTrail|Successful Console Logins|Logs|PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 10 - Login Activity - New|\_sourceCategory = Labs/AWS/CloudTrail\* ConsoleLogin AwsConsoleSignIn Success <br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop\| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop \| parse "\\"MFAUsed\\":\\"\*\\"" as mfaUsed nodrop \| parse "\\"responseElements\\":{\\"ConsoleLogin\\":\\"\*\\"}" as loginResult nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse field=arn "\*:\*:\*::\*:\*" as f1, f2, f3, f4, user nodrop \| parse field=arn "\*:\*:\*::\*:\*/\*/\*" as f1, f2, f3, f4, f5, role, f7 nodrop<br />\| if (isEmpty(user) and !isEmpty(user\_temp), user\_temp, user) as user<br />\| source\_ipaddress as src\_ip \| user as dest\_user<br />\| where loginResult="Success" and event\_Type="AwsConsoleSignIn" and event\_name="ConsoleLogin"<br />\| fields src\_ip, dest\_user, role, mfaUsed, event\_Type, event\_name, principalId, aws\_region, accountId<br />\|where if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{role}}" = "\*", true, role matches "{{role}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{aws\_region}}" = "\*", true, aws\_region matches "{{aws\_region}}") AND if ("{{event\_type}}" = "\*", true, event\_type matches "{{event\_type}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}") AND if ("{{dest\_user}}" = "\*", true, dest\_user matches "{{dest\_user}}") AND if ("{{principalid}}" = "\*", true, principalid matches "{{principalid}}")<br />\|count as eventCount|
|PCI Compliance For AWS CloudTrail|Successful Root Console Logins|Logs|PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 10 - Login Activity - New|\_sourceCategory = Labs/AWS/CloudTrail\* ConsoleLogin AwsConsoleSignIn Success Root<br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop\| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop \| parse "\\"MFAUsed\\":\\"\*\\"" as mfaUsed nodrop \| parse "\\"responseElements\\":{\\"ConsoleLogin\\":\\"\*\\"}" as loginResult nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse field=arn "\*:\*:\*::\*:\*" as f1, f2, f3, f4, user nodrop \| parse field=arn "\*:\*:\*::\*:\*/\*/\*" as f1, f2, f3, f4, f5, role, f7 nodrop<br />\| json "userIdentity.type" as type nodrop<br />\| if (isEmpty(user) and !isEmpty(user\_temp), user\_temp, user) as user<br />\| source\_ipaddress as src\_ip \| user as dest\_user<br />\| where loginResult="Success" and event\_Type="AwsConsoleSignIn" and event\_name="ConsoleLogin" and type="Root"<br />\| timeslice 1s<br />\|where if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{role}}" = "\*", true, role matches "{{role}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{aws\_region}}" = "\*", true, aws\_region matches "{{aws\_region}}") AND if ("{{event\_type}}" = "\*", true, event\_type matches "{{event\_type}}") AND if ("{{errorcode}}" = "\*", true, errorcode matches "{{errorcode}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}") AND if ("{{dest\_user}}" = "\*", true, dest\_user matches "{{dest\_user}}") AND if ("{{principalid}}" = "\*", true, principalid matches "{{principalid}}")<br />\|count as eventCount by \_timeslice, type, src\_ip, dest\_user, mfaUsed, event\_Type, event\_name, principalId, aws\_region, accountId<br />\| count as eventCount|
|PCI Compliance For AWS CloudTrail|Successful Root Console Logins|Logs|PCI Compliance For AWS CloudTrail/AWS CloudTrail - PCI Req 10 - Login Activity - New|\_sourceCategory = Labs/AWS/CloudTrail\* ConsoleLogin AwsConsoleSignIn Success Root<br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop\| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop \| parse "\\"MFAUsed\\":\\"\*\\"" as mfaUsed nodrop \| parse "\\"responseElements\\":{\\"ConsoleLogin\\":\\"\*\\"}" as loginResult nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse field=arn "\*:\*:\*::\*:\*" as f1, f2, f3, f4, user nodrop \| parse field=arn "\*:\*:\*::\*:\*/\*/\*" as f1, f2, f3, f4, f5, role, f7 nodrop<br />\| json "userIdentity.type" as type nodrop<br />\| if (isEmpty(user) and !isEmpty(user\_temp), user\_temp, user) as user<br />\| source\_ipaddress as src\_ip \| user as dest\_user<br />\| where loginResult="Success" and event\_Type="AwsConsoleSignIn" and event\_name="ConsoleLogin" and type="Root"<br />\| timeslice 1s<br />\|where if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{role}}" = "\*", true, role matches "{{role}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{aws\_region}}" = "\*", true, aws\_region matches "{{aws\_region}}") AND if ("{{event\_type}}" = "\*", true, event\_type matches "{{event\_type}}") AND if ("{{errorcode}}" = "\*", true, errorcode matches "{{errorcode}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}") AND if ("{{dest\_user}}" = "\*", true, dest\_user matches "{{dest\_user}}") AND if ("{{principalid}}" = "\*", true, principalid matches "{{principalid}}")<br />\|count as eventCount by \_timeslice, type, src\_ip, dest\_user, mfaUsed, event\_Type, event\_name, principalId, aws\_region, accountId<br />\| fields -eventCount<br />\| sort by \_timeslice|

