# Threat Intel for AWS
## Sumo Logic App For: Threat Intel for AWS
The Sumo Logic Threat Intel for AWS App helps you identify security threats by correlating daily updated threat definitions against your log data using the threat lookup service. This App provides pre built dashboards and queries to analyze threats in your AWS CloudTrail, Amazon VPC Flow Logs, and AWS Elastic Load Balancing Classic logs.
Docs Link: [Threat Intel for AWS](https://help.sumologic.com/?cid=3010)

## Searches

### Log Searches

- **Geo Location of Threats with Accepted Flow Logs**: from Dashboard: Threat Intel for AWS/Threat Intel for AWS - Amazon VPC Flow Logs - New 
- **Geo Location of Threats with Rejected Flow Logs**: from Dashboard: Threat Intel for AWS/Threat Intel for AWS - Amazon VPC Flow Logs - New 
- **Threat Breakdown**: from Dashboard: Threat Intel for AWS/Threat Intel for AWS - Amazon VPC Flow Logs - New 
- **Threats Associated with Accepted Flow Logs**: from Dashboard: Threat Intel for AWS/Threat Intel for AWS - Amazon VPC Flow Logs - New 
- **Threats Associated with Accepted VPC Traffic Flow**: from Search: Threat Intel for AWS/Threats Associated with Accepted VPC Traffic Flow 
- **Threats Associated with CloudTrail Events**: from Search: Threat Intel for AWS/Threats Associated with CloudTrail Events 
- **Threats Associated with CloudTrail Events**: from Dashboard: Threat Intel for AWS/Threat Intel for AWS - AWS CloudTrail - New 
- **Threats Associated with Rejected Flow Logs**: from Dashboard: Threat Intel for AWS/Threat Intel for AWS - Amazon VPC Flow Logs - New 
- **Threats Associated with requesting Client - ELB**: from Search: Threat Intel for AWS/Threats Associated with requesting Client - ELB 
- **Threats By Actor**: from Dashboard: Threat Intel for AWS/Threat Intel for AWS - AWS CloudTrail - New 
- **Threats by Events and I.P**: from Dashboard: Threat Intel for AWS/Threat Intel for AWS - AWS CloudTrail - New 
- **Threats by Events and Result**: from Dashboard: Threat Intel for AWS/Threat Intel for AWS - AWS CloudTrail - New 
- **Threats by Geo Location**: from Dashboard: Threat Intel for AWS/Threat Intel for AWS - AWS CloudTrail - New 
- **Threats Over Time by Action**: from Dashboard: Threat Intel for AWS/Threat Intel for AWS - Amazon VPC Flow Logs - New 
- **Threats Over Time by Result**: from Dashboard: Threat Intel for AWS/Threat Intel for AWS - AWS CloudTrail - New 
- **Top 10 Threat Sources by Action**: from Dashboard: Threat Intel for AWS/Threat Intel for AWS - Amazon VPC Flow Logs - New

### Metric Searches


## Search Table

|app\_topic|search\_name|type|origin|search|
|:--|:--|:--|:--|:--|
|Threat Intel for AWS|Geo Location of Threats with Accepted Flow Logs|Logs|Threat Intel for AWS/Threat Intel for AWS - Amazon VPC Flow Logs - New|\_sourceCategory = Labs/AWS/VPC <br />\| json "message"<br />\| parse field=message "\* \* \* \* \* \* \* \* \* \* \* \* \* \*" as version,accountID,interfaceID,src\_ip,dest\_ip,src\_port,dest\_port,Protocol,Packets,bytes,StartSample,EndSample,Action,status<br />\| where action="ACCEPT"<br />\| lookup type, actor, raw , threatlevel as malicious\_confidence,threat   from sumo://threat/cs on src\_ip=threat<br />\| where type="ip\_address"<br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families<br />\| json field=raw "last\_updated" as last\_updated<br />\| formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| lookup latitude, longitude, country\_code, country\_name, region, city, postal\_code from geo://location on ip = src\_ip<br />\|where if ("{{threat\_malware\_families}}" = "\*", true, threat\_malware\_families matches "{{threat\_malware\_families}}") AND if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{malicious\_confidence}}" = "\*", true, malicious\_confidence matches "{{malicious\_confidence}}") AND if ("{{action}}" = "\*", true, action matches "{{action}}") AND if ("{{actor}}" = "\*", true, actor matches "{{actor}}") AND if ("{{last\_updated}}" = "\*", true, last\_updated matches "{{last\_updated}}") AND if ("{{threat\_last\_updated}}" = "\*", true, threat\_last\_updated matches "{{threat\_last\_updated}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{src\_port}}" = "\*", true, src\_port matches "{{src\_port}}") AND if ("{{interfaceid}}" = "\*", true, interfaceid matches "{{interfaceid}}") AND if ("{{label\_name}}" = "\*", true, label\_name matches "{{label\_name}}")<br />\|count by latitude, longitude, label\_name,threat\_last\_updated|
|Threat Intel for AWS|Geo Location of Threats with Rejected Flow Logs|Logs|Threat Intel for AWS/Threat Intel for AWS - Amazon VPC Flow Logs - New|\_sourceCategory = Labs/AWS/VPC <br />\| json "message"<br />\| parse field=message "\* \* \* \* \* \* \* \* \* \* \* \* \* \*" as version,accountID,interfaceID,src\_ip,dest\_ip,src\_port,dest\_port,Protocol,Packets,bytes,StartSample,EndSample,Action,status<br />\| where action="REJECT"<br />\| lookup type, actor, raw , threatlevel as malicious\_confidence,threat   from sumo://threat/cs on src\_ip=threat<br />\| where type="ip\_address"<br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families<br />\| json field=raw "last\_updated" as last\_updated<br />\| formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| lookup latitude, longitude, country\_code, country\_name, region, city, postal\_code from geo://location on ip = src\_ip<br />\|where if ("{{threat\_malware\_families}}" = "\*", true, threat\_malware\_families matches "{{threat\_malware\_families}}") AND if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{malicious\_confidence}}" = "\*", true, malicious\_confidence matches "{{malicious\_confidence}}") AND if ("{{action}}" = "\*", true, action matches "{{action}}") AND if ("{{actor}}" = "\*", true, actor matches "{{actor}}") AND if ("{{last\_updated}}" = "\*", true, last\_updated matches "{{last\_updated}}") AND if ("{{threat\_last\_updated}}" = "\*", true, threat\_last\_updated matches "{{threat\_last\_updated}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{src\_port}}" = "\*", true, src\_port matches "{{src\_port}}") AND if ("{{interfaceid}}" = "\*", true, interfaceid matches "{{interfaceid}}") AND if ("{{label\_name}}" = "\*", true, label\_name matches "{{label\_name}}")<br />\|count by latitude, longitude, label\_name,threat\_last\_updated|
|Threat Intel for AWS|Threat Breakdown|Logs|Threat Intel for AWS/Threat Intel for AWS - Amazon VPC Flow Logs - New|\_sourceCategory = Labs/AWS/VPC <br />\| json "message"<br />\| parse field=message "\* \* \* \* \* \* \* \* \* \* \* \* \* \*" as version,accountID,interfaceID,src\_ip,dest\_ip,src\_port,dest\_port,Protocol,Packets,bytes,StartSample,EndSample,Action,status<br />\| lookup type, actor, raw , threatlevel as malicious\_confidence,threat   from sumo://threat/cs on src\_ip=threat<br />\| where type="ip\_address" <br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families<br />\| json field=raw "last\_updated" as last\_updated<br />\| formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| concat ( src\_ip," : ", src\_port) as src<br />\| concat ( dest\_ip," : ", dest\_port) as dest<br />\| if (isNull(actor) or actor="","Unassigned",actor) as actor<br />\|where if ("{{threat\_malware\_families}}" = "\*", true, threat\_malware\_families matches "{{threat\_malware\_families}}") AND if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{malicious\_confidence}}" = "\*", true, malicious\_confidence matches "{{malicious\_confidence}}") AND if ("{{action}}" = "\*", true, action matches "{{action}}") AND if ("{{actor}}" = "\*", true, actor matches "{{actor}}") AND if ("{{last\_updated}}" = "\*", true, last\_updated matches "{{last\_updated}}") AND if ("{{threat\_last\_updated}}" = "\*", true, threat\_last\_updated matches "{{threat\_last\_updated}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{src\_port}}" = "\*", true, src\_port matches "{{src\_port}}") AND if ("{{interfaceid}}" = "\*", true, interfaceid matches "{{interfaceid}}") AND if ("{{label\_name}}" = "\*", true, label\_name matches "{{label\_name}}")<br />\|count by actor, Action|
|Threat Intel for AWS|Threats Associated with Accepted Flow Logs|Logs|Threat Intel for AWS/Threat Intel for AWS - Amazon VPC Flow Logs - New|\_sourceCategory = Labs/AWS/VPC <br />\| json "message"<br />\| parse field=message "\* \* \* \* \* \* \* \* \* \* \* \* \* \*" as version,accountID,interfaceID,src\_ip,dest\_ip,src\_port,dest\_port,Protocol,Packets,bytes,StartSample,EndSample,Action,status<br />\| where action="ACCEPT"<br />\| lookup type, actor, raw , threatlevel as malicious\_confidence,threat   from sumo://threat/cs on src\_ip=threat<br />\| where type="ip\_address" <br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families<br />\| json field=raw "last\_updated" as last\_updated<br />\| formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| concat ( src\_ip," : ", src\_port) as src<br />\| concat ( dest\_ip," : ", dest\_port) as dest<br />\|where if ("{{threat\_malware\_families}}" = "\*", true, threat\_malware\_families matches "{{threat\_malware\_families}}") AND if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{malicious\_confidence}}" = "\*", true, malicious\_confidence matches "{{malicious\_confidence}}") AND if ("{{action}}" = "\*", true, action matches "{{action}}") AND if ("{{actor}}" = "\*", true, actor matches "{{actor}}") AND if ("{{last\_updated}}" = "\*", true, last\_updated matches "{{last\_updated}}") AND if ("{{threat\_last\_updated}}" = "\*", true, threat\_last\_updated matches "{{threat\_last\_updated}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{src\_port}}" = "\*", true, src\_port matches "{{src\_port}}") AND if ("{{interfaceid}}" = "\*", true, interfaceid matches "{{interfaceid}}") AND if ("{{label\_name}}" = "\*", true, label\_name matches "{{label\_name}}")<br />\|count by interfaceID, accountID, src, dest, Protocol, malicious\_confidence, label\_name,  threat\_malware\_families,threat\_last\_updated|
|Threat Intel for AWS|Threats Associated with Accepted VPC Traffic Flow|Logs|Threat Intel for AWS/Threats Associated with Accepted VPC Traffic Flow|\_sourceCategory = Labs/AWS/VPC <br />\| json "message"<br />\| parse field=message "\* \* \* \* \* \* \* \* \* \* \* \* \* \*" as version,accountID,interfaceID,src\_ip,dest\_ip,src\_port,dest\_port,Protocol,Packets,bytes,StartSample,EndSample,Action,status<br />\| where action="ACCEPT"<br />\| lookup type, actor, raw , threatlevel as malicious\_confidence,threat   from sumo://threat/cs on src\_ip=threat<br />\| where type="ip\_address" and   malicious\_confidence ="high"<br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families<br />\| json field=raw "last\_updated" as last\_updated<br />\| formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| concat ( src\_ip," : ", src\_port) as src<br />\| concat ( dest\_ip," : ", dest\_port) as dest<br />\| count by interfaceID, accountID, src, dest, Protocol, malicious\_confidence, label\_name,  threat\_malware\_families,threat\_last\_updated<br />\| sort by \_count|
|Threat Intel for AWS|Threats Associated with CloudTrail Events|Logs|Threat Intel for AWS/Threats Associated with CloudTrail Events|\_sourceCategory = Labs/AWS/CloudTrail\* <br />\| json "eventTime","eventName", "awsRegion", "sourceIPAddress", "errorCode","userAgent" as event\_time, event\_name, aws\_region, src\_ip, result,user\_agent nodrop<br />\| json "userIdentity.userName", "userIdentity.accountId" as src\_user, accountId nodrop <br />\| if (result=="" or isNull(result), "Success",result) as result <br />\| lookup type, actor, raw, threatlevel  as malicious\_confidence ,threat from sumo://threat/cs on src\_ip=threat<br />\| where type="ip\_address" and  malicious\_confidence="high"<br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families<br />\| json field=raw "last\_updated" as last\_updated<br />\|  formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| count by event\_time, src\_user,src\_ip,event\_name, aws\_region , result , malicious\_confidence, label\_name,  threat\_malware\_families,threat\_last\_updated<br />\| sort by \_count|
|Threat Intel for AWS|Threats Associated with CloudTrail Events|Logs|Threat Intel for AWS/Threat Intel for AWS - AWS CloudTrail - New|\_sourceCategory = Labs/AWS/CloudTrail\* <br />\| json "eventTime","eventName", "awsRegion", "sourceIPAddress", "errorCode","userAgent" as event\_time, event\_name, aws\_region, src\_ip, result,user\_agent nodrop<br />\| json "userIdentity.userName", "userIdentity.accountId" as src\_user, accountId nodrop <br />\| if (result=="" or isNull(result), "Success",result) as result <br />\| lookup type, actor, raw, threatlevel  as malicious\_confidence ,threat from sumo://threat/cs on src\_ip=threat<br />\| where type="ip\_address" <br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families<br />\| json field=raw "last\_updated" as last\_updated<br />\|  formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\|where if ("{{threat\_malware\_families}}" = "\*", true, threat\_malware\_families matches "{{threat\_malware\_families}}") AND if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{malicious\_confidence}}" = "\*", true, malicious\_confidence matches "{{malicious\_confidence}}") AND if ("{{action}}" = "\*", true, action matches "{{action}}") AND if ("{{actor}}" = "\*", true, actor matches "{{actor}}") AND if ("{{threat\_last\_updated}}" = "\*", true, threat\_last\_updated matches "{{threat\_last\_updated}}") AND if ("{{src\_user}}" = "\*", true, src\_user matches "{{src\_user}}") AND if ("{{result}}" = "\*", true, result matches "{{result}}") AND if ("{{user\_agent}}" = "\*", true, user\_agent matches "{{user\_agent}}") AND if ("{{aws\_region}}" = "\*", true, aws\_region matches "{{aws\_region}}") AND if ("{{label\_name}}" = "\*", true, label\_name matches "{{label\_name}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}") AND if ("{{event\_time}}" = "\*", true, event\_time matches "{{event\_time}}")<br />\|count by event\_time, src\_user,src\_ip,event\_name, aws\_region , result , malicious\_confidence, label\_name,  threat\_malware\_families,threat\_last\_updated|
|Threat Intel for AWS|Threats Associated with Rejected Flow Logs|Logs|Threat Intel for AWS/Threat Intel for AWS - Amazon VPC Flow Logs - New|\_sourceCategory = Labs/AWS/VPC <br />\| json "message"<br />\| parse field=message "\* \* \* \* \* \* \* \* \* \* \* \* \* \*" as version,accountID,interfaceID,src\_ip,dest\_ip,src\_port,dest\_port,Protocol,Packets,bytes,StartSample,EndSample,Action,status<br />\| where action="REJECT"<br />\| lookup type, actor, raw , threatlevel as malicious\_confidence,threat   from sumo://threat/cs on src\_ip=threat<br />\| where type="ip\_address" <br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families<br />\| json field=raw "last\_updated" as last\_updated<br />\| formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| concat ( src\_ip," : ", src\_port) as src<br />\| concat ( dest\_ip," : ", dest\_port) as dest<br />\|where if ("{{threat\_malware\_families}}" = "\*", true, threat\_malware\_families matches "{{threat\_malware\_families}}") AND if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{malicious\_confidence}}" = "\*", true, malicious\_confidence matches "{{malicious\_confidence}}") AND if ("{{action}}" = "\*", true, action matches "{{action}}") AND if ("{{actor}}" = "\*", true, actor matches "{{actor}}") AND if ("{{last\_updated}}" = "\*", true, last\_updated matches "{{last\_updated}}") AND if ("{{threat\_last\_updated}}" = "\*", true, threat\_last\_updated matches "{{threat\_last\_updated}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{src\_port}}" = "\*", true, src\_port matches "{{src\_port}}") AND if ("{{interfaceid}}" = "\*", true, interfaceid matches "{{interfaceid}}") AND if ("{{label\_name}}" = "\*", true, label\_name matches "{{label\_name}}")<br />\|count by interfaceID, accountID, src, dest, Protocol, malicious\_confidence, label\_name,  threat\_malware\_families,threat\_last\_updated|
|Threat Intel for AWS|Threats Associated with requesting Client - ELB|Logs|Threat Intel for AWS/Threats Associated with requesting Client - ELB|\_sourceCategory = Labs/AWS/ELB <br />\| parse regex "\\S+\\s+(?\<elb\_server\>\\S+)\\s+(?\<src\_ip\>\\S+):(?\<src\_port\>\\S+)\\s+(?\<backendhost\>\\S+):(?\<dest\_port\>\\S+)\\s+(?\<requestproc\>\\S+)\\s+(?\<ba\_response\>\\S+)\\s+(?\<cli\_response\>\\S+)\\s+(?\<elb\_statuscode\>\\d+)\\s+(?\<be\_statuscode\>\\d+)\\s+(?\<rcvd\>\\d+)\\s+(?\<send\>\\d+)\\s+\\"(?\<method\>\\w+)\\s+(?\<fullrequest\>\\S+)\\s+HTTP/[^\\"]+\\" \\"(?\<agent\>[^\\"]+)\\" (?\<Cipher\>[A-Za-z0-9-]+) (?\<ssl\_protocol\>[A-Za-z0-9-.]+)"  nodrop<br />\| parse regex field=fullrequest "(?\<protocol\>\\w+)://(?\<hostname\>[^/:]+)" <br />\| lookup type, actor, raw, threatlevel as malicious\_confidence,threat from sumo://threat/cs on src\_ip=threat<br />\| where type="ip\_address" and  malicious\_confidence ="high"<br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families<br />\| json field=raw "last\_updated" as last\_updated<br />\| formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| count by elb\_server, elb\_statuscode, fullrequest,  src\_ip,src\_port , backendhost, dest\_port, malicious\_confidence, label\_name,  threat\_malware\_families,threat\_last\_updated<br />\| fields - \_count|
|Threat Intel for AWS|Threats By Actor|Logs|Threat Intel for AWS/Threat Intel for AWS - AWS CloudTrail - New|\_sourceCategory = Labs/AWS/CloudTrail\* sourceIPAddress <br />\| json "eventTime","eventName", "awsRegion", "sourceIPAddress", "errorCode","userAgent" as event\_time, event\_name, aws\_region, src\_ip, result,user\_agent nodrop<br />\| json "userIdentity.userName", "userIdentity.accountId" as src\_user, accountId nodrop <br />\| if (result=="" or isNull(result), "Unknown",result) as result<br />\| lookup type, actor, raw, threatlevel as malicious\_confidence ,threat from sumo://threat/cs on src\_ip=threat<br />\| where type="ip\_address" <br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families<br />\| json field=raw "last\_updated" as last\_updated<br />\| formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| if (isNull(actor) or actor="","Unassigned",actor) as actor<br />\|where if ("{{threat\_malware\_families}}" = "\*", true, threat\_malware\_families matches "{{threat\_malware\_families}}") AND if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{malicious\_confidence}}" = "\*", true, malicious\_confidence matches "{{malicious\_confidence}}") AND if ("{{action}}" = "\*", true, action matches "{{action}}") AND if ("{{actor}}" = "\*", true, actor matches "{{actor}}") AND if ("{{threat\_last\_updated}}" = "\*", true, threat\_last\_updated matches "{{threat\_last\_updated}}") AND if ("{{src\_user}}" = "\*", true, src\_user matches "{{src\_user}}") AND if ("{{result}}" = "\*", true, result matches "{{result}}") AND if ("{{user\_agent}}" = "\*", true, user\_agent matches "{{user\_agent}}") AND if ("{{aws\_region}}" = "\*", true, aws\_region matches "{{aws\_region}}") AND if ("{{label\_name}}" = "\*", true, label\_name matches "{{label\_name}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}") AND if ("{{event\_time}}" = "\*", true, event\_time matches "{{event\_time}}")<br />\|count by actor|
|Threat Intel for AWS|Threats by Events and I.P|Logs|Threat Intel for AWS/Threat Intel for AWS - AWS CloudTrail - New|\_sourceCategory = Labs/AWS/CloudTrail\* <br />\| json "eventTime","eventName", "awsRegion", "sourceIPAddress", "errorCode","userAgent" as event\_time, event\_name, aws\_region, src\_ip, result,user\_agent nodrop<br />\| json "userIdentity.userName", "userIdentity.accountId" as src\_user, accountId nodrop <br />\| if (result=="" or isNull(result), "Success",result) as result <br />\| where result!="AccessDenied"<br />\| lookup type, actor, raw, threatlevel  as malicious\_confidence ,threat from sumo://threat/cs on src\_ip=threat<br />\| where type="ip\_address" <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\|where if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{malicious\_confidence}}" = "\*", true, malicious\_confidence matches "{{malicious\_confidence}}") AND if ("{{action}}" = "\*", true, action matches "{{action}}") AND if ("{{actor}}" = "\*", true, actor matches "{{actor}}") AND if ("{{src\_user}}" = "\*", true, src\_user matches "{{src\_user}}") AND if ("{{result}}" = "\*", true, result matches "{{result}}") AND if ("{{user\_agent}}" = "\*", true, user\_agent matches "{{user\_agent}}") AND if ("{{aws\_region}}" = "\*", true, aws\_region matches "{{aws\_region}}") AND if ("{{label\_name}}" = "\*", true, label\_name matches "{{label\_name}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}") AND if ("{{event\_time}}" = "\*", true, event\_time matches "{{event\_time}}")<br />\|count by  src\_ip, event\_name<br />\| transpose row src\_ip column event\_name|
|Threat Intel for AWS|Threats by Events and Result|Logs|Threat Intel for AWS/Threat Intel for AWS - AWS CloudTrail - New|\_sourceCategory = Labs/AWS/CloudTrail\* <br />\| json "eventTime","eventName", "awsRegion", "sourceIPAddress", "errorCode","userAgent" as event\_time, event\_name, aws\_region, src\_ip, result,user\_agent nodrop<br />\| json "userIdentity.userName", "userIdentity.accountId" as src\_user, accountId nodrop <br />\| if (result=="" or isNull(result), "Success",result) as result <br />\| lookup type, actor, raw, threatlevel as malicious\_confidence ,threat from sumo://threat/cs on src\_ip=threat<br />\| where type="ip\_address"<br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families<br />\| json field=raw "last\_updated" as last\_updated<br />\| formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| if (isNull(actor) or actor="","Unassigned",actor) as actor<br />\|where if ("{{threat\_malware\_families}}" = "\*", true, threat\_malware\_families matches "{{threat\_malware\_families}}") AND if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{malicious\_confidence}}" = "\*", true, malicious\_confidence matches "{{malicious\_confidence}}") AND if ("{{action}}" = "\*", true, action matches "{{action}}") AND if ("{{actor}}" = "\*", true, actor matches "{{actor}}") AND if ("{{threat\_last\_updated}}" = "\*", true, threat\_last\_updated matches "{{threat\_last\_updated}}") AND if ("{{src\_user}}" = "\*", true, src\_user matches "{{src\_user}}") AND if ("{{result}}" = "\*", true, result matches "{{result}}") AND if ("{{user\_agent}}" = "\*", true, user\_agent matches "{{user\_agent}}") AND if ("{{aws\_region}}" = "\*", true, aws\_region matches "{{aws\_region}}") AND if ("{{label\_name}}" = "\*", true, label\_name matches "{{label\_name}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}") AND if ("{{event\_time}}" = "\*", true, event\_time matches "{{event\_time}}")<br />\|count by event\_name, result<br />\| transpose row event\_name column result|
|Threat Intel for AWS|Threats by Geo Location|Logs|Threat Intel for AWS/Threat Intel for AWS - AWS CloudTrail - New|\_sourceCategory = Labs/AWS/CloudTrail\*  sourceIPAddress<br />\| json "eventTime","eventName", "awsRegion", "sourceIPAddress", "errorCode","userAgent" as event\_time, action, aws\_region, src\_ip, result,user\_agent nodrop<br />\| json "userIdentity.userName", "userIdentity.accountId" as src\_user, accountId nodrop <br />\| if (result=="" or isNull(result), "Success",result) as result <br />\| lookup type, actor, raw, threatlevel as malicious\_confidence,threat from sumo://threat/cs on src\_ip=threat<br />\| where type="ip\_address"<br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families<br />\| json field=raw "last\_updated" as last\_updated<br />\| formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name <br />\| lookup latitude, longitude, country\_code, country\_name, region, city, postal\_code from geo://location on ip = src\_ip<br />\|where if ("{{threat\_malware\_families}}" = "\*", true, threat\_malware\_families matches "{{threat\_malware\_families}}") AND if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{malicious\_confidence}}" = "\*", true, malicious\_confidence matches "{{malicious\_confidence}}") AND if ("{{action}}" = "\*", true, action matches "{{action}}") AND if ("{{actor}}" = "\*", true, actor matches "{{actor}}") AND if ("{{threat\_last\_updated}}" = "\*", true, threat\_last\_updated matches "{{threat\_last\_updated}}") AND if ("{{src\_user}}" = "\*", true, src\_user matches "{{src\_user}}") AND if ("{{result}}" = "\*", true, result matches "{{result}}") AND if ("{{user\_agent}}" = "\*", true, user\_agent matches "{{user\_agent}}") AND if ("{{aws\_region}}" = "\*", true, aws\_region matches "{{aws\_region}}") AND if ("{{label\_name}}" = "\*", true, label\_name matches "{{label\_name}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}") AND if ("{{event\_time}}" = "\*", true, event\_time matches "{{event\_time}}")<br />\|count by latitude, longitude, label\_name,threat\_last\_updated|
|Threat Intel for AWS|Threats Over Time by Action|Logs|Threat Intel for AWS/Threat Intel for AWS - Amazon VPC Flow Logs - New|\_sourceCategory = Labs/AWS/VPC <br />\| json "message"<br />\| parse field=message "\* \* \* \* \* \* \* \* \* \* \* \* \* \*" as version,accountID,interfaceID,src\_ip,dest\_ip,src\_port,dest\_port,Protocol,Packets,bytes,StartSample,EndSample,Action,status<br />\| lookup type, actor, raw , threatlevel as malicious\_confidence,threat   from sumo://threat/cs on src\_ip=threat<br />\| where type="ip\_address"<br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families<br />\| json field=raw "last\_updated" as last\_updated<br />\| formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| concat ( src\_ip," : ", src\_port) as src<br />\| concat ( dest\_ip," : ", dest\_port) as dest<br />\| if (isNull(actor) or actor="","Unassigned",actor) as actor <br />\| timeslice 1h<br />\|where if ("{{threat\_malware\_families}}" = "\*", true, threat\_malware\_families matches "{{threat\_malware\_families}}") AND if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{malicious\_confidence}}" = "\*", true, malicious\_confidence matches "{{malicious\_confidence}}") AND if ("{{action}}" = "\*", true, action matches "{{action}}") AND if ("{{actor}}" = "\*", true, actor matches "{{actor}}") AND if ("{{last\_updated}}" = "\*", true, last\_updated matches "{{last\_updated}}") AND if ("{{threat\_last\_updated}}" = "\*", true, threat\_last\_updated matches "{{threat\_last\_updated}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{src\_port}}" = "\*", true, src\_port matches "{{src\_port}}") AND if ("{{interfaceid}}" = "\*", true, interfaceid matches "{{interfaceid}}") AND if ("{{label\_name}}" = "\*", true, label\_name matches "{{label\_name}}")<br />\|count by \_timeslice, Action<br />\| transpose row \_timeslice column Action|
|Threat Intel for AWS|Threats Over Time by Result|Logs|Threat Intel for AWS/Threat Intel for AWS - AWS CloudTrail - New|\_sourceCategory = Labs/AWS/CloudTrail\* <br />\| json "eventTime","eventName", "awsRegion", "sourceIPAddress", "errorCode","userAgent" as event\_time, event\_name, aws\_region, src\_ip, result,user\_agent nodrop<br />\| json "userIdentity.userName", "userIdentity.accountId" as src\_user, accountId nodrop <br />\| if (result=="" or isNull(result), "Success",result) as result <br />\| lookup type, actor, raw, threatlevel  as malicious\_confidence ,threat from sumo://threat/cs on src\_ip=threat<br />\| where type="ip\_address"<br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families<br />\| json field=raw "last\_updated" as last\_updated<br />\| formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| timeslice 1h<br />\|where if ("{{threat\_malware\_families}}" = "\*", true, threat\_malware\_families matches "{{threat\_malware\_families}}") AND if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{malicious\_confidence}}" = "\*", true, malicious\_confidence matches "{{malicious\_confidence}}") AND if ("{{action}}" = "\*", true, action matches "{{action}}") AND if ("{{actor}}" = "\*", true, actor matches "{{actor}}") AND if ("{{threat\_last\_updated}}" = "\*", true, threat\_last\_updated matches "{{threat\_last\_updated}}") AND if ("{{src\_user}}" = "\*", true, src\_user matches "{{src\_user}}") AND if ("{{result}}" = "\*", true, result matches "{{result}}") AND if ("{{user\_agent}}" = "\*", true, user\_agent matches "{{user\_agent}}") AND if ("{{aws\_region}}" = "\*", true, aws\_region matches "{{aws\_region}}") AND if ("{{label\_name}}" = "\*", true, label\_name matches "{{label\_name}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}") AND if ("{{event\_time}}" = "\*", true, event\_time matches "{{event\_time}}")<br />\|count by \_timeslice, result<br />\| transpose row \_timeslice column result|
|Threat Intel for AWS|Top 10 Threat Sources by Action|Logs|Threat Intel for AWS/Threat Intel for AWS - Amazon VPC Flow Logs - New|\_sourceCategory = Labs/AWS/VPC <br />\| json "message"<br />\| parse field=message "\* \* \* \* \* \* \* \* \* \* \* \* \* \*" as version,accountID,interfaceID,src\_ip,dest\_ip,src\_port,dest\_port,Protocol,Packets,bytes,StartSample,EndSample,Action,status<br />\| lookup type, actor, raw , threatlevel as malicious\_confidence,threat   from sumo://threat/cs on src\_ip=threat<br />\| where type="ip\_address" <br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families<br />\| json field=raw "last\_updated" as last\_updated<br />\| formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| concat ( src\_ip," : ", src\_port) as src<br />\| concat ( dest\_ip," : ", dest\_port) as dest<br />\| if (isNull(actor) or actor="","Unassigned",actor) as actor<br />\|where if ("{{threat\_malware\_families}}" = "\*", true, threat\_malware\_families matches "{{threat\_malware\_families}}") AND if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{malicious\_confidence}}" = "\*", true, malicious\_confidence matches "{{malicious\_confidence}}") AND if ("{{action}}" = "\*", true, action matches "{{action}}") AND if ("{{actor}}" = "\*", true, actor matches "{{actor}}") AND if ("{{last\_updated}}" = "\*", true, last\_updated matches "{{last\_updated}}") AND if ("{{threat\_last\_updated}}" = "\*", true, threat\_last\_updated matches "{{threat\_last\_updated}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{src\_port}}" = "\*", true, src\_port matches "{{src\_port}}") AND if ("{{interfaceid}}" = "\*", true, interfaceid matches "{{interfaceid}}") AND if ("{{label\_name}}" = "\*", true, label\_name matches "{{label\_name}}")<br />\|count by src\_ip,Action<br />\| top 10 src\_ip, Action by \_count|

