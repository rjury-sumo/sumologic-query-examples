# Azure Cosmos DB

## Searches

### Log Searches

- **Control Plane Create Operations**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Audit 
- **Control Plane Delete Operations**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Audit 
- **Control Plane Update Operations**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Audit 
- **Data Plane Request Location**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Overview 
- **Data Plane Request Trend**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Performance 
- **Distribution  by Operation Type (Read, Write and Delete)**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Administrative Operations 
- **Distribution by Operations**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Administrative Operations 
- **Distribution by Status**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Administrative Operations 
- **Duration distribution by Database, Collection**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Overview 
- **Duration in Direct Connection Mode**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Performance 
- **Duration in Gateway Connection Mode**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Performance 
- **Duration Stats by Database, Collection**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Queries 
- **Failed Policy Events**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Policy and Recommendations 
- **Failed Requests**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Performance 
- **Max Duration in Direct Connection Mode**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Performance 
- **Max Duration in Gateway Mode**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Performance 
- **Recent Control Plane Create Operations**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Audit 
- **Recent Control Plane Update Operations**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Audit 
- **Recent Delete Control Plane Operations**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Audit 
- **Recent Delete Operations**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Administrative Operations 
- **Recent Recommendation Events**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Policy and Recommendations 
- **Recent Resource Health Incidents**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Health 
- **Recent Service Health Incidents**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Health 
- **Recent Write Operations**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Administrative Operations 
- **Request Charge by Database, Collection**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Overview 
- **Request Charge Stats by Database, Collection, PartitionKeyRangeId**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Queries 
- **Request units by Operation Type**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Throughput 
- **Request units per sec by databaseName, collectionName, partitionKeyRangeId**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Throughput 
- **Resource Health by  Status**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Health 
- **Response Length Stats by Database, Collection**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Queries 
- **RU consumption by logical partition**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Throughput 
- **RU consumption by physical partition**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Throughput 
- **Service Health by Incident Type**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Health 
- **Service Health by Incident Type**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Health 
- **Status Code by Database, Collection**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Overview 
- **Top 10 operations that caused the most errors**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Administrative Operations 
- **Top 10 partitions by utilisation**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Storage 
- **Top 10 User Agents**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Overview 
- **Top 3 expensive queries (duration) by database, collection**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Queries 
- **Top 3 expensive queries (request charge consumed) by database, collection**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Queries 
- **Top 3 expensive queries (response length) by database, collection**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Queries 
- **Top 3 expensive queries (rows returned) by database, collection**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Queries 
- **Total Failed Policy Events**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Policy and Recommendations 
- **Total Failed Requests**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Performance 
- **Total Recommendation Events**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Policy and Recommendations 
- **Total Success Policy Events**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Policy and Recommendations 
- **Total Success Policy Events**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Policy and Recommendations 
- **Users / Applications by Operation type**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Administrative Operations

### Metric Searches

- **Average Normalized RU Consumption**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Throughput 
- **Data usage**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Storage 
- **Document Count**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Storage 
- **Document Quota**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Storage 
- **Maximum Normalized RU Consumption**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Throughput 
- **Normalized RU Consumption by Database Account**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Throughput 
- **Server Side Latency**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Performance 
- **Service Availability**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Health 
- **Total Data usage**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Storage 
- **Total documents**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Storage 
- **Total Request Units**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Throughput 
- **Total Request Units by Database Account**: from Dashboard: Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Throughput

## Search Table

|app\_topic|search\_name|type|origin|search|
|:--|:--|:--|:--|:--|
|Azure Cosmos DB|Average Normalized RU Consumption|Metrics|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Throughput|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} metric=NormalizedRUConsumption statistic=average  \| avg|
|Azure Cosmos DB|Control Plane Create Operations|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Audit|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} ControlPlaneRequests<br />\| json "time", "category", "operationName", "properties.httpstatusCode", "properties.activityId", "properties.result", "properties.httpMethod", "properties.apiKind", "properties.apiKindResourceType", "properties.operationType", "properties.resourceUri", "properties.resourceDetails"  as time, category, operationName, statusCode, activityId, result, httpMethod,  apiKind, apiKindResourceType, operationType, resourceUri, resourceDetails  nodrop<br />\| where category="ControlPlaneRequests" and operationName matches /([Aa]dd\|[Cc]reate)/ and statusCode matches "2\*" and operationName matches "{{operation\_name}}"<br />\| count by operationName<br />\| sort by \_count desc|
|Azure Cosmos DB|Control Plane Delete Operations|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Audit|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} ControlPlaneRequests<br />\| json "time", "category", "operationName", "properties.httpstatusCode", "properties.activityId", "properties.result", "properties.httpMethod", "properties.apiKind", "properties.apiKindResourceType", "properties.operationType", "properties.resourceUri", "properties.resourceDetails"  as time, category, operationName, statusCode, activityId, result, httpMethod,  apiKind, apiKindResourceType, operationType, resourceUri, resourceDetails  nodrop<br />\| where category="ControlPlaneRequests" and operationName matches /([Dd]elete\|[Rr]emove)/ and statusCode matches "2\*" and operationName matches "{{operation\_name}}"<br />\| count by operationName<br />\| sort by \_count desc|
|Azure Cosmos DB|Control Plane Update Operations|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Audit|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} ControlPlaneRequests<br />\| json "time", "category", "operationName", "properties.httpstatusCode", "properties.activityId", "properties.result", "properties.httpMethod", "properties.apiKind", "properties.apiKindResourceType", "properties.operationType", "properties.resourceUri", "properties.resourceDetails"  as time, category, operationName, statusCode, activityId, result, httpMethod,  apiKind, apiKindResourceType, operationType, resourceUri, resourceDetails  nodrop<br />\| where category="ControlPlaneRequests" and operationName matches /[Uu]pdate/ and statusCode matches "2\*" and operationName matches "{{operation\_name}}"<br />\| count by operationName<br />\| sort by \_count desc|
|Azure Cosmos DB|Data Plane Request Location|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Overview|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} DataPlaneRequests<br />\| json "category", "operationName", "properties.requestResourceType", "properties.collectionName", "properties.databaseName", "properties.statusCode", "properties.duration", "properties.clientIpAddress", "properties.connectionMode", "properties.responseLength", "properties.activityId" as category, operationName, requestResourceType, collectionName, databaseName, statusCode, duration, clientIpAddress, connectionMode, responseLength, activityId <br />\| where category="DataPlaneRequests"<br />\| count by clientIpAddress<br />\| lookup latitude, longitude, country\_code, country\_name, region, city, postal\_code from geo://location on ip = clientIpAddress<br />\| where !isNull(latitude)<br />\| sum(\_count) as \_count by latitude, longitude, country\_code, country\_name, region, city, postal\_code<br />\| sort by \_count|
|Azure Cosmos DB|Data Plane Request Trend|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Performance|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} DataPlaneRequests<br />\| json "category", "operationName", "properties.requestResourceType", "properties.collectionName", "properties.databaseName", "properties.statusCode", "properties.duration", "properties.clientIpAddress", "properties.connectionMode", "properties.responseLength", "properties.activityId" as category, operationName, requestResourceType, collectionName, databaseName, statusCode, duration, clientIpAddress, connectionMode, responseLength, activityId nodrop<br />\| where category="DataPlaneRequests"<br />\| timeslice 5m<br />\| format("resource\_group=%s resource\_name=%s operationName=%s collectionName=%s, databaseName=%s", resource\_group, resource\_name, operationName, collectionName, databaseName) as op\_identifier<br />\| count\_distinct(activityId) by op\_identifier , \_timeslice<br />\| transpose row \_timeslice column op\_identifier|
|Azure Cosmos DB|Data usage|Metrics|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Storage|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} metric=DataUsage statistic=total \| quantize using sum \| sum by resource\_group, resource\_name |
|Azure Cosmos DB|Distribution  by Operation Type (Read, Write and Delete)|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Administrative Operations|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group = {{resource\_group}} resource\_name={{resource\_name}} provider\_name={{provider\_name}} resource\_type={{resource\_type}} Administrative <br />\| json "resultType", "category", "operationName", "resourceId" as resultType, category, operationName, resourceid<br />\| where (resultType="Accept" or resultType="Success") and category="Administrative"<br />\| "OTHERS" as operationType<br />\| if (toUppercase(operationName) matches /WRITE/, "WRITE", operationType) as operationType <br />\| if (toUppercase(operationName) matches /READ/, "READ", operationType) as operationType <br />\| if (toUppercase(operationName) matches /DELETE/, "DELETE", operationType) as operationType <br />\| count by operationType<br />\| sort by \_count, operationType asc|
|Azure Cosmos DB|Distribution by Operations|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Administrative Operations|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group = {{resource\_group}} resource\_name={{resource\_name}} provider\_name={{provider\_name}} resource\_type={{resource\_type}} Administrative <br />\| json "resultType", "category", "operationName", "resourceId" as resultType, category, operationName, resourceid<br />\| where (resultType="Accept" or resultType="Success") and category="Administrative" <br />\| parse field=operationName "\*/\*/\*" as provider\_name, resource\_type, operation\_name<br />\| count by operation\_name<br />\| order by \_count, operation\_name asc|
|Azure Cosmos DB|Distribution by Status|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Administrative Operations|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group = {{resource\_group}} resource\_name={{resource\_name}} provider\_name={{provider\_name}} resource\_type={{resource\_type}} Administrative <br />\| json "resultType", "category" as resultType, category<br />\| where category="Administrative" <br />\| count by resultType<br />\| order by \_count, resultType asc|
|Azure Cosmos DB|Document Count|Metrics|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Storage|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} metric=DocumentCount statistic=total \| sum by resource\_group, resource\_name |
|Azure Cosmos DB|Document Quota|Metrics|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Storage|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} metric=DocumentQuota statistic=total \| sum by resource\_group, resource\_name|
|Azure Cosmos DB|Duration distribution by Database, Collection|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Overview|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} DataPlaneRequests<br />\| json "category", "operationName", "properties.activityId", "properties.requestResourceType", "properties.collectionName", "properties.databaseName", "properties.statusCode", "properties.duration", "properties.clientIpAddress", "properties.connectionMode", "properties.responseLength" as category, operationName, activityId, requestResourceType, collectionName, databaseName, statusCode, duration, clientIpAddress, connectionMode, responseLength nodrop<br />\| where category="DataPlaneRequests" and statusCode matches "2\*" and operationName="Query"<br />\| bin duration width=100, min = 0, max = 100000<br />\| count by \_bin\_label, \_bin\_upper, databaseName, collectionName<br />\| sort by \_bin\_upper<br />\| limit 10<br />\| fields -\_bin\_upper<br />\| transpose row databaseName, collectionName column \_bin\_label|
|Azure Cosmos DB|Duration in Direct Connection Mode|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Performance|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} DataPlaneRequests<br />\| json "category", "operationName", "properties.requestResourceType", "properties.collectionName", "properties.databaseName", "properties.statusCode", "properties.duration", "properties.clientIpAddress", "properties.connectionMode", "properties.responseLength" as category, operationName, requestResourceType, collectionName, databaseName, statusCode, duration, clientIpAddress, connectionMode, responseLength<br />\| where connectionMode="Direct" and category="DataPlaneRequests" and statusCode matches "2\*"<br />\| timeslice 5m<br />\| format("resource\_group=%s resource\_name=%s operationName=%s collectionName=%s, databaseName=%s", resource\_group, resource\_name, operationName, collectionName, databaseName) as op\_identifier<br />\| avg(duration), max(duration) by op\_identifier, \_timeslice<br />\| transpose row \_timeslice column op\_identifier|
|Azure Cosmos DB|Duration in Gateway Connection Mode|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Performance|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} DataPlaneRequests<br />\| json "category", "operationName", "properties.requestResourceType", "properties.collectionName", "properties.databaseName", "properties.statusCode", "properties.duration", "properties.clientIpAddress", "properties.connectionMode", "properties.responseLength" as category, operationName, requestResourceType, collectionName, databaseName, statusCode, duration, clientIpAddress, connectionMode, responseLength<br />\| where connectionMode="Gateway" and category="DataPlaneRequests" and statusCode matches "2\*"<br />\| timeslice 5m<br />\| format("resource\_group=%s resource\_name=%s operationName=%s collectionName=%s, databaseName=%s", resource\_group, resource\_name, operationName, collectionName, databaseName) as op\_identifier<br />\| avg(duration), max(duration) by op\_identifier , \_timeslice<br />\| transpose row \_timeslice column op\_identifier|
|Azure Cosmos DB|Duration Stats by Database, Collection|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Queries|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} DataPlaneRequests<br />\| json "category", "operationName", "properties.activityId", "properties.requestResourceType", "properties.collectionName", "properties.databaseName", "properties.statusCode", "properties.duration", "properties.clientIpAddress", "properties.connectionMode", "properties.responseLength" as category, operationName, activityId, requestResourceType, collectionName, databaseName, statusCode, duration, clientIpAddress, connectionMode, responseLength nodrop<br />\| where category="DataPlaneRequests" and statusCode matches "2\*" and operationName="Query"<br />\| avg(duration) as duration\_avg, pct(duration, 99) as duration\_p99, pct(duration, 95) as duration\_p95, max(duration) as duration\_max by requestResourceType, operationName, databaseName, collectionName|
|Azure Cosmos DB|Failed Policy Events|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Policy and Recommendations|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} Policy Failure<br />\| JSON "category", "resultType", "properties.message", "properties.resourceLocation", "properties.entity", "properties.policies" as category, resultType, message, resourceLocation, entity, policies<br />\| where category="Policy" and resultType="Failure"<br />\| formatDate(\_messageTime, "MM/dd/yyyy HH:mm:ss") as time<br />\| count as Count by time, level, resultType, providers, resource\_group, resource\_name, location, policies|
|Azure Cosmos DB|Failed Requests|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Performance|<br /><br />// fetch the activity ids with high duration<br />[subquery: tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} DataPlaneRequests<br />\| json "category", "operationName", "properties.activityId", "properties.requestResourceType", "properties.collectionName", "properties.databaseName", "properties.statusCode", "properties.duration", "properties.clientIpAddress", "properties.connectionMode", "properties.responseLength" as category, operationName, activityId, requestResourceType, collectionName, databaseName, statusCode, duration, clientIpAddress, connectionMode, responseLength nodrop<br />\| where category="DataPlaneRequests" and !(statusCode matches "2\*")<br />\| count by statusCode, activityId, databaseName, collectionName<br />\| topk(3, \_count) by databaseName, collectionName<br />\| fields statusCode, activityId, \_rank<br />\| save /CosmosDB/DataPlaneRequests/statusCodeActivityIdMapping<br />\| compose activityId keywords<br />]<br />tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} QueryRuntimeStatistics<br />\| json "properties.activityId", "properties.databasename", "properties.collectionname", "properties.useragent", "properties.numberofrowsreturned", "properties.querytext", "properties.queryexecutionstatus" as activityId, databaseName, collectionName, useragent, numberofrowsreturned, querytext, queryexecutionstatus<br />\| json field=querytext "query" <br />\| lookup statusCode, \_rank from /CosmosDB/DataPlaneRequests/statusCodeActivityIdMapping on activityId=activityId<br />\| count by statusCode, activityId, databaseName, collectionName, query, \_rank<br />\| sort by \_count desc<br />\| fields statusCode, activityId, databaseName, collectionName, query, \_rank|
|Azure Cosmos DB|Max Duration in Direct Connection Mode|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Performance|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} DataPlaneRequests<br />\| json "category", "operationName", "properties.requestResourceType", "properties.collectionName", "properties.databaseName", "properties.statusCode", "properties.duration", "properties.clientIpAddress", "properties.connectionMode", "properties.responseLength" as category, operationName, requestResourceType, collectionName, databaseName, statusCode, duration, clientIpAddress, connectionMode, responseLength<br />\| where connectionMode="Direct" and category="DataPlaneRequests" <br />\| max(duration)|
|Azure Cosmos DB|Max Duration in Gateway Mode|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Performance|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} DataPlaneRequests<br />\| json "category", "operationName", "properties.requestResourceType", "properties.collectionName", "properties.databaseName", "properties.statusCode", "properties.duration", "properties.clientIpAddress", "properties.connectionMode", "properties.responseLength" as category, operationName, requestResourceType, collectionName, databaseName, statusCode, duration, clientIpAddress, connectionMode, responseLength<br />\| where connectionMode="Gateway" and category="DataPlaneRequests" <br />\| max(duration)|
|Azure Cosmos DB|Maximum Normalized RU Consumption|Metrics|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Throughput|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} metric=NormalizedRUConsumption statistic=maximum \| quantize using max \| max|
|Azure Cosmos DB|Normalized RU Consumption by Database Account|Metrics|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Throughput|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} metric=NormalizedRUConsumption statistic=maximum \| quantize using max \| max by resource\_group, resource\_name |
|Azure Cosmos DB|Recent Control Plane Create Operations|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Audit|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} ControlPlaneRequests<br />\| json "time", "category", "operationName", "properties.httpstatusCode", "properties.activityId", "properties.result", "properties.httpMethod", "properties.apiKind", "properties.apiKindResourceType", "properties.operationType", "properties.resourceUri", "properties.resourceDetails"  as time, category, operationName, statusCode, activityId, result, httpMethod,  apiKind, apiKindResourceType, operationType, resourceUri, resourceDetails  nodrop<br />\| where category="ControlPlaneRequests" and operationName matches /([Aa]dd\|[Cc]reate)/ and statusCode matches "2\*" and operationName matches "{{operation\_name}}"<br />\| count as Count by time, operationName, activityId, resourceUri, statusCode, result, apiKind, apiKindResourceType, httpMethod<br />\| sort by time desc<br />\| limit 10|
|Azure Cosmos DB|Recent Control Plane Update Operations|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Audit|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} ControlPlaneRequests<br />\| json "time", "category", "operationName", "properties.httpstatusCode", "properties.activityId", "properties.result", "properties.httpMethod", "properties.apiKind", "properties.apiKindResourceType", "properties.operationType", "properties.resourceUri", "properties.resourceDetails"  as time, category, operationName, statusCode, activityId, result, httpMethod,  apiKind, apiKindResourceType, operationType, resourceUri, resourceDetails  nodrop<br />\| where category="ControlPlaneRequests" and operationName matches /[Uu]pdate/ and statusCode matches "2\*" and  operationName matches "{{operation\_name}}"<br />\| count as Count by time, operationName, activityId, resourceUri, statusCode, result, apiKind, apiKindResourceType, httpMethod<br />\| sort by time desc<br />\| limit 10|
|Azure Cosmos DB|Recent Delete Control Plane Operations|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Audit|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} ControlPlaneRequests<br />\| json "time", "category", "operationName", "properties.httpstatusCode", "properties.activityId", "properties.result", "properties.httpMethod", "properties.apiKind", "properties.apiKindResourceType", "properties.operationType", "properties.resourceUri", "properties.resourceDetails"  as time, category, operationName, statusCode, activityId, result, httpMethod,  apiKind, apiKindResourceType, operationType, resourceUri, resourceDetails  nodrop<br />\| where category="ControlPlaneRequests" and operationName matches /([Dd]elete\|[Rr]emove)/ and statusCode matches "2\*" and operationName matches "{{operation\_name}}"<br />\| count as Count by time, operationName, activityId, resourceUri, statusCode, result, apiKind, apiKindResourceType, httpMethod<br />\| sort by time desc<br />\| limit 10|
|Azure Cosmos DB|Recent Delete Operations|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Administrative Operations|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group = {{resource\_group}} resource\_name = {{resource\_name}} provider\_name={{provider\_name}} resource\_type={{resource\_type}}  Administrative <br />\| JSON "properties.statusCode", "properties.message", "resultType", "category", "operationName", "callerIpAddress", "resultSignature", "level", "identity.claims.idtyp", "identity.claims.name", "identity.claims.appid", "properties.entity", "\$['identity']['claims']['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name']","\$['identity']['claims']['http://schemas.microsoft.com/claims/authnmethodsreferences']" as statusCode, message, resultType, category, operationName, callerIpAddress, resultSignature, level, idtyp, name, appid, entity, identity\_claims\_name, authmethods nodrop<br />\| where resultType in ("Accept", "Success") and category="Administrative" and toUppercase(operationName) matches /DELETE/ <br />\| if (idtyp =="user", name, appid) as name<br />\| formatDate(\_messageTime, "MM/dd/yyyy HH:mm:ss") as time<br />\| count by \_messageTime, time, resource\_name, callerIpAddress, name, identity\_claims\_name, authmethods, resultSignature, statusCode, message, entity<br />\| sort by \_messageTime desc<br />\| limit 20 <br />\| fields -\_count,\_messageTime|
|Azure Cosmos DB|Recent Recommendation Events|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Policy and Recommendations|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} Recommendation<br />\| JSON "category", "operationName", "resultType", "properties.recommendationName", "properties.recommendationCategory", "properties.recommendationImpact", "properties.recommendationResourceLink" as category, operationName, resultType, recommendationName, recommendationCategory, recommendationImpact, recommendationResourceLink <br />\| where category="Recommendation"<br />\| parse field=operationName "\*/\*/\*/\*" as provider, category, operation\_name, action nodrop<br />\| formatDate(\_messageTime, "MM/dd/yyyy HH:mm:ss") as time<br />\| count as Count by time, operation\_name, resource\_name, resultType, recommendationName, recommendationCategory, recommendationImpact, recommendationResourceLink|
|Azure Cosmos DB|Recent Resource Health Incidents|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Health|tenant\_name={{tenant\_name}} <br />provider\_name={{provider\_name}}<br />resource\_type={{resource\_type}}<br />subscription\_id={{subscription\_id}}<br />resource\_group={{resource\_group}}<br />resource\_name={{resource\_name}} ResourceHealth <br />\| JSON "category", "operationName", "time","level","resultType", "properties.title", "properties.details", "properties.currentHealthStatus", "properties.type", "properties.cause" as category, operationName, time,level,resultType, title, details, currentHealthStatus, type, cause nodrop<br />\| where category="ResourceHealth"<br />\| parse field=operationName "\*/\*/\*" as category, operation\_name, action nodrop<br />\| count as Count by time, level, resource\_name, resource\_group, resultType, operation\_name, title, details, currentHealthStatus, type, cause|
|Azure Cosmos DB|Recent Service Health Incidents|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Health|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} ServiceHealth<br />\| JSON "category", "properties.incidentType", "properties.service", "properties.region", "properties.impactedServices" as category, incidentType, service, service\_region, impactedServices nodrop<br />\| replace(toLowerCase(service\_region), " ", "") as service\_region <br />\| where service\_region matches "{{location}}"<br />\| where category="ServiceHealth" and (toUpperCase(service) matches /COSMOS/ or toUpperCase(impactedServices) matches /COSMOS/)<br />\| parse field=operationName "\*/\*/\*" as category, operation\_name, action nodrop<br />\| count as Count by time , level, service, impactedServices, resultType, operation\_name, impactStartTime, impactMitigationTime, defaultLanguageTitle, stage|
|Azure Cosmos DB|Recent Write Operations|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Administrative Operations|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group = {{resource\_group}} resource\_name = {{resource\_name}} provider\_name={{provider\_name}} resource\_type={{resource\_type}}  Administrative <br />\| JSON "properties.statusCode", "properties.message", "resultType", "category", "operationName", "callerIpAddress", "resultSignature", "level", "identity.claims.idtyp", "identity.claims.name", "identity.claims.appid", "\$['identity']['claims']['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name']","\$['identity']['claims']['http://schemas.microsoft.com/claims/authnmethodsreferences']"  as statusCode, message, resultType, category, operationName, callerIpAddress, resultSignature, level, idtyp, name, appid, identity\_claims\_name, authmethods nodrop<br />\| where category="Administrative" and resultType in ("Accept", "Success") and toUppercase(operationName) matches /WRITE/<br />\| if (idtyp =="user", name, appid) as name<br />\| formatDate(\_messageTime, "MM/dd/yyyy HH:mm:ss") as time<br />\| count by \_messageTime, time, resource\_name, callerIpAddress, name, identity\_claims\_name, authmethods, resultSignature, statusCode, message<br />\| sort by \_messageTime desc<br />\| limit 20 <br />\| fields -\_count,\_messageTime|
|Azure Cosmos DB|Request Charge by Database, Collection|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Overview|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} DataPlaneRequests<br />\| json "category", "operationName", "properties.requestResourceType", "properties.collectionName", "properties.databaseName", "properties.statusCode", "properties.duration", "properties.clientIpAddress", "properties.connectionMode", "properties.responseLength", "properties.activityId", "properties.requestCharge" as category, operationName, requestResourceType, collectionName, databaseName, statusCode, duration, clientIpAddress, connectionMode, responseLength, activityId, requestCharge<br />\| where category="DataPlaneRequests" and !isBlank(collectionName)<br />\| format("resource\_group=%s resource\_name=%s collectionName=%s databaseName=%s", resource\_group, resource\_name, collectionName, databaseName) as db\_identifier<br />\| sum(requestCharge) by db\_identifier|
|Azure Cosmos DB|Request Charge Stats by Database, Collection, PartitionKeyRangeId|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Queries|<br />tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} PartitionKeyRUConsumption<br />\| json "category","activityId", "properties"<br />\| where category="PartitionKeyRUConsumption"<br />\| json field=properties "operationType", "databaseName","collectionName","partitionKeyRangeId", "requestCharge" <br />\| avg(requestCharge) as requestCharge\_avg, pct(requestCharge, 99) as requestCharge\_p99, pct(requestCharge, 95) as requestCharge\_p95, max(requestCharge) as requestCharge\_max by databaseName, collectionName, partitionKeyRangeId<br />|
|Azure Cosmos DB|Request units by Operation Type|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Throughput|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} PartitionKeyRUConsumption<br />\| json "properties"<br />\| json field=properties "operationType", "databaseName","collectionName","partitionKeyRangeId", "requestCharge" <br />\| sum(requestCharge) as total\_request\_units  by operationType|
|Azure Cosmos DB|Request units per sec by databaseName, collectionName, partitionKeyRangeId|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Throughput|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} PartitionKeyRUConsumption<br />\| json "properties"<br />\| json field=properties "operationType", "databaseName","collectionName","partitionKeyRangeId", "requestCharge" <br />\| where !isBlank(collectionName)<br />\| timeslice 1s<br />\| format("resource\_group=%s resource\_name=%s databaseName=%s collectionName=%s partitionKeyRangeId=%s", resource\_group, resource\_name, databaseName, collectionName, partitionKeyRangeId) as collection\_identifier<br />\| sum(requestCharge) as total\_request\_units  by <br />collection\_identifier, \_timeslice<br />\| transpose row \_timeslice column collection\_identifier|
|Azure Cosmos DB|Resource Health by  Status|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Health|tenant\_name={{tenant\_name}}<br />provider\_name={{provider\_name}}<br />resource\_type={{resource\_type}}<br />subscription\_id={{subscription\_id}}<br />resource\_group={{resource\_group}}<br />resource\_name={{resource\_name}} ResourceHealth <br />\| JSON "category", "properties.currentHealthStatus" as category, currentHealthStatus<br />\| where category="ResourceHealth"<br />\| count as Count by currentHealthStatus|
|Azure Cosmos DB|Response Length Stats by Database, Collection|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Queries|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} DataPlaneRequests<br />\| json "category", "operationName", "properties.activityId", "properties.requestResourceType", "properties.collectionName", "properties.databaseName", "properties.statusCode", "properties.duration", "properties.clientIpAddress", "properties.connectionMode", "properties.responseLength" as category, operationName, activityId, requestResourceType, collectionName, databaseName, statusCode, duration, clientIpAddress, connectionMode, responseLength nodrop<br />\| where category="DataPlaneRequests" and statusCode matches "2\*" and operationName="Query"<br />\| avg(responseLength) as responseLength\_avg, pct(responseLength, 99) as responseLength\_p99, pct(responseLength, 95) as responseLength\_p95, max(responseLength) as responseLength\_max by requestResourceType, operationName, databaseName, collectionName|
|Azure Cosmos DB|RU consumption by logical partition|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Throughput|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} PartitionKeyRUConsumption<br />\| json "properties"<br />\| json field=properties "operationType", "databaseName","collectionName","partitionKeyRangeId", "requestCharge", "partitionKey" <br />\| where !isBlank(collectionName)<br />\| extract field=partitionKey "(?\<partitionKey\>[\\w-]+)" multi<br />\| sum(requestCharge) as total\_request\_units by databaseName, collectionName, partitionKey<br />\| sort by total\_request\_units<br />\| limit 10<br />\| transpose row databaseName, collectionName column partitionKey|
|Azure Cosmos DB|RU consumption by physical partition|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Throughput|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} PartitionKeyRUConsumption<br />\| json "properties"<br />\| json field=properties "operationType", "databaseName","collectionName","partitionKeyRangeId", "requestCharge", "partitionKey" <br />\| where !isBlank(collectionName)<br />\| sum(requestCharge) as total\_request\_units by databaseName, collectionName, partitionKeyRangeId<br />\| sort by total\_request\_units<br />\| limit 10<br />\| transpose row databaseName, collectionName column partitionKeyRangeId|
|Azure Cosmos DB|Server Side Latency|Metrics|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Performance|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} metric=ServerSideLatency statistic=maximum \| max by resource\_group, resource\_name |
|Azure Cosmos DB|Service Availability|Metrics|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Health|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} metric=ServiceAvailability statistic=minimum  \| min by resource\_group, resource\_name |
|Azure Cosmos DB|Service Health by Incident Type|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Health|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} ServiceHealth<br />\| JSON "category", "properties.incidentType", "properties.service", "properties.region", "properties.impactedServices" as category, incidentType, service, service\_region, impactedServices nodrop<br />\| replace(toLowerCase(service\_region), " ", "") as service\_region <br />\| where service\_region matches "{{location}}"<br />\| where category="ServiceHealth" and (toUpperCase(service) matches /COSMOS/ or toUpperCase(impactedServices) matches /COSMOS/)<br />\| count as Count by incidentType|
|Azure Cosmos DB|Service Health by Incident Type|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Health|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} ServiceHealth<br />\| JSON "category", "properties.incidentType", "properties.service", "properties.region", "properties.impactedServices" as category, incidentType, service, service\_region, impactedServices nodrop<br />\| replace(toLowerCase(service\_region), " ", "") as service\_region <br />\| where service\_region matches "{{location}}"<br />\| where category="ServiceHealth" and (toUpperCase(service) matches /COSMOS/ or toUpperCase(impactedServices) matches /COSMOS/)<br />\| count by incidentType<br />\| order by incidentType|
|Azure Cosmos DB|Status Code by Database, Collection|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Overview|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} DataPlaneRequests<br />\| json "category", "operationName", "properties.requestResourceType", "properties.collectionName", "properties.databaseName", "properties.statusCode", "properties.duration", "properties.clientIpAddress", "properties.connectionMode", "properties.responseLength", "properties.activityId" as category, operationName, requestResourceType, collectionName, databaseName, statusCode, duration, clientIpAddress, connectionMode, responseLength, activityId <br />\| where category="DataPlaneRequests" and !isBlank(collectionName)<br />\| format("resource\_group=%s resource\_name=%s collectionName=%s, databaseName=%s", resource\_group, resource\_name, collectionName, databaseName) as op\_identifier<br />\| count by statusCode, op\_identifier<br />\| transpose row op\_identifier column statusCode|
|Azure Cosmos DB|Top 10 operations that caused the most errors|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Administrative Operations|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group = {{resource\_group}} resource\_name = {{resource\_name}} provider\_name={{provider\_name}} resource\_type={{resource\_type}}  Administrative<br />\| json "resultType", "operationName", "properties.statusMessage", "category"  as resultType, operationName, failureMessage, category nodrop<br />\| parse field=operationname "\*/\*/\*" as provider\_name, resource\_type, operation nodrop<br />\| where category="Administrative" and (resultType="Failure" or resultType="Unknown")<br />\| if (isBlank(failureMessage), "Unknown Error", failureMessage) as failureMessage<br />\| count as Count by resource\_name, operation, failureMessage<br />\| order by Count <br />\| limit 10|
|Azure Cosmos DB|Top 10 partitions by utilisation|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Storage|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} PartitionKeyStatistics<br />\| json "properties"<br />\| json field=properties "sizeKb", "databaseName","collectionName", "partitionKey" <br />\| extract field=partitionKey "(?\<partitionKey\>[\\w-]+)" multi<br />\| withtime sizeKb<br />\| most\_recent(sizeKb\_withtime) by resource\_group, resource\_name, databaseName, collectionName, partitionKey<br />\|  \_mostrecent / (20.0 \* 1024.0 \* 1024.0) as utilizationOf20GBLogicalPartition // Azure Cosmos DB enforces a maximum logical partition key size of 20 GB<br />\| top 10 resource\_group, resource\_name, databaseName, collectionName, partitionKey by utilizationOf20GBLogicalPartition<br />\| sort by utilizationOf20GBLogicalPartition desc|
|Azure Cosmos DB|Top 10 User Agents|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Overview|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} QueryRuntimeStatistics<br />\| json "properties.activityId", "properties.databasename", "properties.collectionname", "properties.useragent", "properties.numberofrowsreturned", "properties.querytext", "properties.queryexecutionstatus" as activityId, databaseName, collectionName, useragent, numberofrowsreturned, querytext, queryexecutionstatus<br />\| count by useragent<br />\| top 10 useragent by \_count<br />\| sort by \_count|
|Azure Cosmos DB|Top 3 expensive queries (duration) by database, collection|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Queries|<br /><br />// fetch the activity ids with high duration<br />[subquery: tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} DataPlaneRequests<br />\| json "category", "operationName", "properties.activityId", "properties.requestResourceType", "properties.collectionName", "properties.databaseName", "properties.statusCode", "properties.duration", "properties.clientIpAddress", "properties.connectionMode", "properties.responseLength" as category, operationName, activityId, requestResourceType, collectionName, databaseName, statusCode, duration, clientIpAddress, connectionMode, responseLength nodrop<br />\| where category="DataPlaneRequests" and statusCode matches "2\*"<br />\| count by duration, activityId, databaseName, collectionName<br />\| number(duration) as requestCharge<br />\| topk(3, duration) by databaseName, collectionName<br />\| fields duration, activityId, \_rank<br />\| save /CosmosDB/DataPlaneRequests/durationActivityIdMapping<br />\| compose activityId keywords<br />]<br />tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} QueryRuntimeStatistics<br />\| json "properties.activityId", "properties.databasename", "properties.collectionname", "properties.useragent", "properties.numberofrowsreturned", "properties.querytext", "properties.queryexecutionstatus" as activityId, databaseName, collectionName, useragent, numberofrowsreturned, querytext, queryexecutionstatus<br />\| json field=querytext "query" <br />\| lookup duration, \_rank from /CosmosDB/DataPlaneRequests/durationActivityIdMapping on activityId=activityId<br />\| count by duration, activityId, databaseName, collectionName, query, \_rank<br />\| number(duration) as duration<br />\| sort by duration desc<br />\| fields duration, activityId, databaseName, collectionName, query, \_rank|
|Azure Cosmos DB|Top 3 expensive queries (request charge consumed) by database, collection|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Queries|<br />// fetch the activity ids with high request charge<br />[subquery: tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} PartitionKeyRUConsumption<br />\| json "activityId", "properties", "category"<br />\| where category = "PartitionKeyRUConsumption"<br />\| json field=properties "operationType", "databaseName","collectionName","partitionKeyRangeId", "requestCharge" <br />\| count by requestCharge, activityId, databaseName, collectionName<br />\| number(requestCharge) as requestCharge<br />\| topk(3, requestCharge) by databaseName, collectionName<br />\| fields requestCharge, activityId, \_rank<br />\| save /CosmosDB/DataPlaneRequests/requestChargeActivityIdMapping<br />\| compose activityId keywords<br />]<br />tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} QueryRuntimeStatistics<br />\| json "properties.activityId", "properties.databasename", "properties.collectionname", "properties.useragent", "properties.numberofrowsreturned", "properties.querytext", "properties.queryexecutionstatus" as activityId, databaseName, collectionName, useragent, numberofrowsreturned, querytext, queryexecutionstatus<br />\| json field=querytext "query" <br />\| lookup requestCharge, \_rank from /CosmosDB/DataPlaneRequests/requestChargeActivityIdMapping on activityId=activityId<br />\| count by requestCharge, activityId, databaseName, collectionName, query, \_rank<br />\| number(requestCharge) as requestCharge<br />\| sort by requestCharge desc<br />\| fields requestCharge, activityId, databaseName, collectionName, query, \_rank<br />|
|Azure Cosmos DB|Top 3 expensive queries (response length) by database, collection|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Queries|<br /><br />// fetch the activity ids with high duration<br />[subquery: tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} DataPlaneRequests<br />\| json "category", "operationName", "properties.activityId", "properties.requestResourceType", "properties.collectionName", "properties.databaseName", "properties.statusCode", "properties.duration", "properties.clientIpAddress", "properties.connectionMode", "properties.responseLength" as category, operationName, activityId, requestResourceType, collectionName, databaseName, statusCode, duration, clientIpAddress, connectionMode, responseLength nodrop<br />\| where category="DataPlaneRequests" and statusCode matches "2\*"<br />\| count by responseLength, activityId, databaseName, collectionName<br />\| number(responseLength) as responseLength<br />\| topk(3, responseLength) by databaseName, collectionName<br />\| fields responseLength, activityId, \_rank<br />\| save /CosmosDB/DataPlaneRequests/responseLengthActivityIdMapping<br />\| compose activityId keywords<br />]<br />tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} QueryRuntimeStatistics<br />\| json "properties.activityId", "properties.databasename", "properties.collectionname", "properties.useragent", "properties.numberofrowsreturned", "properties.querytext", "properties.queryexecutionstatus" as activityId, databaseName, collectionName, useragent, numberofrowsreturned, querytext, queryexecutionstatus<br />\| json field=querytext "query" <br />\| lookup responseLength, \_rank from /CosmosDB/DataPlaneRequests/responseLengthActivityIdMapping on activityId=activityId<br />\| count by responseLength, activityId, databaseName, collectionName, query, \_rank<br />\| number(responseLength) as responseLength<br />\| sort by responseLength desc<br />\| fields responseLength, activityId, databaseName, collectionName, query, \_rank|
|Azure Cosmos DB|Top 3 expensive queries (rows returned) by database, collection|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Queries|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} QueryRuntimeStatistics<br />\| json "properties.activityId", "properties.databasename", "properties.collectionname", "properties.useragent", "properties.numberofrowsreturned", "properties.querytext", "properties.queryexecutionstatus", "category" as activityId, databaseName, collectionName, useragent, numberofrowsreturned, querytext, queryexecutionstatus, category<br />\| where category="QueryRuntimeStatistics"<br />\| json field=querytext "query" <br />\| count by numberofrowsreturned, activityId, databaseName, collectionName, query<br />\| number(numberofrowsreturned) as numberofrowsreturned<br />\| topk(3, numberofrowsreturned) by databaseName, collectionName<br />\| sort by numberofrowsreturned desc<br />\| fields numberofrowsreturned, activityId, databaseName, collectionName, query, \_rank|
|Azure Cosmos DB|Total Data usage|Metrics|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Storage|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} metric=DataUsage statistic=total \| sum \| eval \_value/(1024\*1024)|
|Azure Cosmos DB|Total documents|Metrics|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Storage|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} metric=DocumentCount statistic=total \| sum |
|Azure Cosmos DB|Total Failed Policy Events|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Policy and Recommendations|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} location={{location}} resource\_group={{resource\_group}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} Policy Failure<br />\| JSON "category", "resultType" as category, resultType<br />\| where category="Policy" and resultType="Failure"<br />\| count as Count|
|Azure Cosmos DB|Total Failed Requests|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Performance|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} DataPlaneRequests<br />\| json "category", "operationName", "properties.activityId", "properties.requestResourceType", "properties.collectionName", "properties.databaseName", "properties.statusCode", "properties.duration", "properties.clientIpAddress", "properties.connectionMode", "properties.responseLength" as category, operationName, activityId, requestResourceType, collectionName, databaseName, statusCode, duration, clientIpAddress, connectionMode, responseLength nodrop<br />\| where category="DataPlaneRequests" and !(statusCode matches "2\*")<br />\| count|
|Azure Cosmos DB|Total Recommendation Events|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Policy and Recommendations|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} Recommendation<br />\| JSON "category"<br />\| where category="Recommendation"<br />\| count |
|Azure Cosmos DB|Total Request Units|Metrics|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Throughput|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} metric=TotalRequestUnits statistic=total  \| quantize using sum \| sum |
|Azure Cosmos DB|Total Request Units by Database Account|Metrics|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Throughput|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} metric=TotalRequestUnits statistic=total  \| quantize using sum \| sum by resource\_group, resource\_name |
|Azure Cosmos DB|Total Success Policy Events|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Policy and Recommendations|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} location={{location}} resource\_group={{resource\_group}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} Policy <br />\| JSON "category", "resultType" as category, resultType<br />\| where category="Policy" and (resultType="Success" or resultType="Accept")<br />\| count as Count|
|Azure Cosmos DB|Total Success Policy Events|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Policy and Recommendations|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group={{resource\_group}} location={{location}} resource\_type={{resource\_type}} provider\_name={{provider\_name}} resource\_name={{resource\_name}} Policy Success<br />\| JSON "category", "resultType", "properties.message", "properties.resourceLocation", "properties.entity", "properties.policies" as category, resultType, message, resourceLocation, entity, policies<br />\| parse field=entity "/subscriptions/\*/resourceGroups/\*/providers/\*/\*/\*" as subscription\_id, resource\_group, providers, virtualMachineScaleSets, aks nodrop<br />\| where category="Policy" and (resultType="Success" or resultType="Accept")<br />\| formatDate(\_messageTime, "MM/dd/yyyy HH:mm:ss") as time<br />\| count as Count by time, level, resultType, resource\_group, resource\_name, location, policies|
|Azure Cosmos DB|Users / Applications by Operation type|Logs|Installed Apps/Azure Cosmos DB/Azure Cosmos DB - Administrative Operations|tenant\_name={{tenant\_name}} subscription\_id={{subscription\_id}} resource\_group = {{resource\_group}} resource\_name={{resource\_name}} provider\_name={{provider\_name}} resource\_type={{resource\_type}} Administrative <br />\| JSON "properties.statusCode", "properties.message", "resultType", "category", "operationName", "callerIpAddress", "resultSignature", "level", "identity.claims.idtyp", "identity.claims.name", "identity.claims.appid" as statusCode, message, resultType, category, operationName, callerIpAddress, resultSignature, level, idtyp, name, appid nodrop<br />\| where resultType in ("Accept", "Success") and category="Administrative" <br />\| if (idtyp =="user", name, appid) as name<br />\| "Others" as operationType<br />\| if (toUppercase(operationName) matches /WRITE/, "WRITE", operationType) as operationType <br />\| if (toUppercase(operationName) matches /READ/, "READ", operationType) as operationType <br />\| if (toUppercase(operationName) matches /DELETE/, "DELETE", operationType) as operationType <br />\| count by name, operationType<br />\| transpose row name column operationType|

