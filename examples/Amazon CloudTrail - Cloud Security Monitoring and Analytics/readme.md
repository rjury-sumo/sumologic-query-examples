# Amazon CloudTrail - Cloud Security Monitoring and Analytics

## Searches

### Log Searches

- **Added User To Security Group**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview 
- **AWS CloudTrail - ACL or Route Changes**: from Search: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - ACL or Route Changes 
- **AWS CloudTrail - Attempt to create a publicly accessible database**: from Search: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - Attempt to create a publicly accessible database 
- **AWS CloudTrail - Authorisation Failures**: from Search: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - Authorisation Failures 
- **AWS CloudTrail - CloudTrail Changes**: from Search: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - CloudTrail Changes 
- **AWS CloudTrail - CMK Disabled or Scheduled for Deletion**: from Search: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - CMK Disabled or Scheduled for Deletion 
- **AWS CloudTrail - Configuration Changes**: from Search: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - Configuration Changes 
- **AWS CloudTrail - Console Sign-In Failures**: from Search: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - Console Sign-In Failures 
- **AWS CloudTrail - Console Sign-In Without MFA**: from Search: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - Console Sign-In Without MFA 
- **AWS CloudTrail - Default Policy Version Set**: from Search: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - Default Policy Version Set 
- **AWS CloudTrail - Detect Permanent Key Creation**: from Search: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - Detect Permanent Key Creation 
- **AWS CloudTrail - Detect Sts Get Session Token Abuse**: from Search: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - Detect Sts Get Session Token Abuse 
- **AWS CloudTrail - EC2 Instance Changes**: from Search: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - EC2 Instance Changes 
- **AWS CloudTrail - EC2 Large Instance Changes**: from Search: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - EC2 Large Instance Changes 
- **AWS CloudTrail - IAM Policy Changes**: from Search: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - IAM Policy Changes 
- **AWS CloudTrail - Internet Gateway Changes**: from Search: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - Internet Gateway Changes 
- **AWS CloudTrail - Network ACL Changes**: from Search: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - Network ACL Changes 
- **AWS CloudTrail - Organisation Changes**: from Search: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - Organisation Changes 
- **AWS CloudTrail - Root Account Usage**: from Search: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - Root Account Usage 
- **AWS CloudTrail - Route Table Changes**: from Search: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - Route Table Changes 
- **AWS CloudTrail - S3 Bucket Changes**: from Search: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - S3 Bucket Changes 
- **AWS CloudTrail - Security Group Changes**: from Search: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - Security Group Changes 
- **AWS CloudTrail - VPC Changes**: from Search: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - VPC Changes 
- **Console Login Failures**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Login Activity 
- **Console Login Failures**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Login Activity 
- **Console Root Login Failures**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Login Activity 
- **Console Root Login Failures**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Login Activity 
- **Created Access Keys**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring 
- **Created AccessKey**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview 
- **Created AccessKey**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring 
- **Created IAM Roles**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring 
- **Created IAM Users**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring 
- **Created IAM Users**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring 
- **Created Roles**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring 
- **Created Roles**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview 
- **Created Security Groups**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity 
- **Created Security Groups**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity 
- **Created Users**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview 
- **Deleted  IAM Users**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring 
- **Deleted Access Keys**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring 
- **Deleted AccessKey**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring 
- **Deleted AccessKey**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview 
- **Deleted IAM Roles**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring 
- **Deleted IAM Users**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring 
- **Deleted Roles**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview 
- **Deleted Roles**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring 
- **Deleted Security Groups**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity 
- **Deleted Security Groups**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity 
- **Deleted Users**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview 
- **Failed API Calls**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Login Activity 
- **Failed API Calls - Acct Breakup**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Login Activity 
- **Failed API Calls - Reason - Login Credentials and Permission Issues**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Login Activity 
- **Failed Configuration Changes**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity 
- **Failed Policy Changes**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity 
- **Failed Policy Changes**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity 
- **Group Operation Failures**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity 
- **Group Operation Successes**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity 
- **IAM Activity**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring 
- **IAM Events Over Time**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring 
- **Login locations**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview 
- **Non Read Only Events**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Access Monitoring 
- **Non Read Only Events**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview 
- **Non Read Only Events**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Access Monitoring 
- **Operation Failure - Authorize, Revoke Security Groups Ingress, Egress Rules**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity 
- **Operation Success - Authorize, Revoke Security Groups Ingress, Egress Rules**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity 
- **Outlier - Failed Login**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview 
- **Outlier- Failed Configuration Changes**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity 
- **Outlier- Successful Configuration Changes**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity 
- **Password - Create, Update, Delete**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring 
- **Password - Create, Update, Delete**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring 
- **Potential Threats by IP**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview 
- **Read Only Events**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview 
- **Read Only Events**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Access Monitoring 
- **Read Only Events**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Access Monitoring 
- **Removed User From Security Group**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview 
- **Security Group Activity**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Access Monitoring 
- **Security Group Activity**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Access Monitoring 
- **Security Group Activity Over Time**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Access Monitoring 
- **Security Group Activity Over Time**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity 
- **Successful Configuration Changes**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity 
- **Successful Console Logins**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Login Activity 
- **Successful Console Logins**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Login Activity 
- **Successful Policy Changes**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity 
- **Successful Policy Changes**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity 
- **Successful Root Console Logins**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Login Activity 
- **Successful Root Console Logins**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Login Activity 
- **Threat Count by I.P**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Threat Intelligence 
- **Threat Outlier**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview 
- **Threats Associated with CloudTrail Events**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Threat Intelligence 
- **Threats By Actor**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Threat Intelligence 
- **Threats by Events and Result**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Threat Intelligence 
- **Threats by Geo Location**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Threat Intelligence 
- **Threats Over Time**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview 
- **Threats Over Time by Result**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Threat Intelligence 
- **Top 10 Failed Configuration Changes**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity 
- **Top 10 Security Group Activities**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity 
- **Top 10 Successful Configuration Changes**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity 
- **Unauthorized AWS API Requests**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview 
- **User Added To Security Group**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring 
- **User Added To Security Group**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring 
- **User Deleted From Security Group**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring 
- **User Deleted From Security Group**: from Dashboard: Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring

### Metric Searches


## Search Table

|app\_topic|search\_name|type|origin|search|
|:--|:--|:--|:--|:--|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Added User To Security Group|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview|\_sourceCategory = Labs/AWS/CloudTrail "iam.amazonaws.com" (AddUserToGroup ) !errorCode !errorMesage<br />\| json "recipientAccountId" as recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user\_username nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_region nodrop \| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| json "sourceIPAddress" as srcDevice\_ip nodrop \| json "eventSource" as event\_source nodrop<br />\| json "requestParameters.groupName" as groupName nodrop \| json "requestParameters.userName" as targetUser\_username nodrop<br />\| where event\_name in ("AddUserToGroup", "RemoveUserFromGroup") and event\_source="iam.amazonaws.com"<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| timeslice 15m<br />\| count as eventCount by \_timeslice<br />\| sort \_timeslice|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches|AWS CloudTrail - ACL or Route Changes|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - ACL or Route Changes|\_sourceCategory = Labs/AWS/CloudTrail (CreateNetworkAclEntry OR CreateRoute)<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name \| where event\_name in ("CreateNetworkAclEntry","CreateRoute")<br />//EoQ|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches|AWS CloudTrail - Attempt to create a publicly accessible database|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - Attempt to create a publicly accessible database|\_sourceCategory = Labs/AWS/CloudTrail (CreateDBInstance)<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name \| where event\_name="CreateDBInstance"<br />\| parse "\\"publiclyAccessible\\":\\"\*\\"" as publicly\_accessible \| where publicly\_accessible="true"<br />//EoQ|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches|AWS CloudTrail - Authorisation Failures|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - Authorisation Failures|\_sourceCategory = Labs/AWS/CloudTrail errorCode (\*UnauthorizedOperation OR AccessDenied\*)<br />\| parse "\\"errorCode\\":\\"\*\\"" as error\_code \| where error\_code matches "\*UnauthorizedOperation" OR error\_code matches "AccessDenied\*"<br />// EoQ|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches|AWS CloudTrail - CloudTrail Changes|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - CloudTrail Changes|\_sourceCategory = Labs/AWS/CloudTrail (\*Trail OR \*Logging)<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name \| where event\_name in ("CreateTrail","UpdateTrail","DeleteTrail","StartLogging","StopLogging")<br />// EoQ|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches|AWS CloudTrail - CMK Disabled or Scheduled for Deletion|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - CMK Disabled or Scheduled for Deletion|\_sourceCategory = Labs/AWS/CloudTrail (DisableKey OR ScheduleKeyDeletion)<br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source \| where event\_source="kms.amazonaws.com"<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name \| where event\_name in ("DisableKey","ScheduleKeyDeletion")<br />// EoQ|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches|AWS CloudTrail - Configuration Changes|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - Configuration Changes|\_sourceCategory = Labs/AWS/CloudTrail (\*Channel OR \*Recorder)<br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source \| where event\_source="config.amazonaws.com"<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name <br />\| where event\_name in ("DeleteDeliveryChannel","PutDeliveryChannel","PutConfigurationRecorder","StopConfigurationRecorder")<br />// EoQ|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches|AWS CloudTrail - Console Sign-In Failures|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - Console Sign-In Failures|\_sourceCategory = Labs/AWS/CloudTrail (ConsoleLogin Failure)<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name \| where event\_name="ConsoleLogin"<br />\| json field=\_raw "userIdentity.principalId","responseElements.ConsoleLogin" as principal\_id,action nodrop<br />\| toLowerCase(action)<br />\| where action="failure"<br />\| parse "\\"userName\\":\\"\*\\"" as user nodrop<br />\| parse regex field=principal\_id ":(?\<user\_principal\>.\*)" nodrop<br />\| if(user="",user\_principal,user) as user \| fields - event\_name,principal\_id,user\_principal<br />// EoQ|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches|AWS CloudTrail - Console Sign-In Without MFA|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - Console Sign-In Without MFA|\_sourceCategory = Labs/AWS/CloudTrail (ConsoleLogin)<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name<br />\| parse "\\"MFAUsed\\":\\"\*\\"" as mfa\_used<br />\| where (event\_name="ConsoleLogin" AND mfa\_used="No")<br />\| parse "\\"userName\\":\\"\*\\"" as user nodrop<br />\| json field=\_raw "userIdentity.principalId","responseElements.ConsoleLogin" as principal\_id,action nodrop<br />\| parse regex field=principal\_id ":(?\<user\_principal\>.\*)" nodrop<br />\| if(user="",user\_principal,user) as user \| fields - event\_name,principal\_id,user\_principal<br />\| toLowerCase(action)<br />// EoQ|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches|AWS CloudTrail - Default Policy Version Set|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - Default Policy Version Set|\_sourceCategory = Labs/AWS/CloudTrail (SetDefaultPolicyVersion)<br />\| parse "\\"eventSource\\":\\"\*\\"" as eventSource \| where eventSource="iam.amazonaws.com"<br />\| parse "\\"eventName\\":\\"\*\\"" as eventName \| where eventName="SetDefaultPolicyVersion"<br />// EoQ|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches|AWS CloudTrail - Detect Permanent Key Creation|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - Detect Permanent Key Creation|\_sourceCategory = Labs/AWS/CloudTrail (CreateAccessKey IAMUser)<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name \| where event\_name="CreateAccessKey"<br />\| parse "\\"userIdentity\\":{\\"type\\":\\"\*\\"" as type \| where type="IAMUser"<br />// EOQ|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches|AWS CloudTrail - Detect Sts Get Session Token Abuse|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - Detect Sts Get Session Token Abuse|\_sourceCategory = Labs/AWS/CloudTrail (GetSessionToken IAMUser)<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name \| where event\_name="GetSessionToken"<br />\| parse "\\"userIdentity\\":{\\"type\\":\\"\*\\"" as type \| where type="IAMUser"<br />// EOQ|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches|AWS CloudTrail - EC2 Instance Changes|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - EC2 Instance Changes|\_sourceCategory = Labs/AWS/CloudTrail (\*Instances)<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name<br />\| where event\_name in ("RunInstances","RebootInstances","StartInstances","StopInstances","TerminateInstances")<br />// EoQ|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches|AWS CloudTrail - EC2 Large Instance Changes|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - EC2 Large Instance Changes|\_sourceCategory = Labs/AWS/CloudTrail <br /> (RunInstances)<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name \| where event\_name="RunInstances"<br />\| parse "\\"instanceType\\":\\"\*\\"" as instance\_type \| where instance\_type matches "\*.8xlarge" OR instance\_type matches "\*.4xlarge"<br />// EoQ|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches|AWS CloudTrail - IAM Policy Changes|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - IAM Policy Changes|\_sourceCategory = Labs/AWS/CloudTrail  (\*Policy\*)<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name \| where event\_name in ("DeleteGroupPolicy","DeleteRolePolicy","DeleteUserPolicy","PutGroupPolicy","PutRolePolicy","PutUserPolicy","CreatePolicy","DeletePolicy","CreatePolicyVersion","DeletePolicyVersion","AttachRolePolicy","DetachRolePolicy","AttachUserPolicy","DetachUserPolicy","AttachGroupPolicy","DetachGroupPolicy")<br />// EoQ|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches|AWS CloudTrail - Internet Gateway Changes|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - Internet Gateway Changes|\_sourceCategory = Labs/AWS/CloudTrail  (\*Gateway)<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name <br />\| where event\_name in ("CreateCustomerGateway","DeleteCustomerGateway","AttachInternetGateway","CreateInternetGateway","DeleteInternetGateway","DetachInternetGateway")<br />// EoQ|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches|AWS CloudTrail - Network ACL Changes|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - Network ACL Changes|\_sourceCategory = Labs/AWS/CloudTrail  (\*AclEntry OR \*NetworkAcl\*)<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name <br />\| where event\_name in ("CreateNetworkAcl","CreateNetworkAclEntry","DeleteNetworkAcl","DeleteNetworkAclEntry","ReplaceNetworkAclEntry","ReplaceNetworkAclAssociation")<br />//EOQ|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches|AWS CloudTrail - Organisation Changes|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - Organisation Changes|\_sourceCategory = Labs/AWS/CloudTrail (AcceptHandshake OR AttachPolicy OR CancelHandshake OR CreateAccount OR CreateOrganization OR CreateOrganizationalUnit OR CreatePolicy OR DeclineHandshake OR DeleteOrganization OR DeleteOrganizationalUnit OR DeletePolicy OR EnableAllFeatures OR EnablePolicyType OR InviteAccountToOrganization OR LeaveOrganization OR DetachPolicy OR DisablePolicyType OR MoveAccount OR RemoveAccountFromOrganization OR UpdateOrganizationalUnit OR UpdatePolicy)<br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name<br />\| where event\_name in ("AttachPolicy","CancelHandshake","CreateAccount","CreateOrganization","CreateOrganizationalUnit","CreatePolicy","DeclineHandshake","DeleteOrganization","DeleteOrganizationalUnit","DeletePolicy","EnableAllFeatures","EnablePolicyType","InviteAccountToOrganization","LeaveOrganization","DetachPolicy","DisablePolicyType","MoveAccount","RemoveAccountFromOrganization","UpdateOrganizationalUnit","UpdatePolicy") OR (event\_source="organizations.amazonaws.com" AND event\_name="AcceptHandshake")<br />// EoQ|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches|AWS CloudTrail - Root Account Usage|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - Root Account Usage|\_sourceCategory = Labs/AWS/CloudTrail  (Root)<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name \| where !(event\_name="AwsServiceEvent")<br />\| json "userIdentity.type","userIdentity.invokedBy" as type,invoked\_by nodrop <br />\| where isEmpty(invoked\_by) AND type="Root"<br />// EoQ|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches|AWS CloudTrail - Route Table Changes|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - Route Table Changes|\_sourceCategory = Labs/AWS/CloudTrail  (ReplaceRouteTableAssociation OR \*Route OR \*RouteTable)<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name \| where event\_name in ("CreateRoute","CreateRouteTable","ReplaceRoute","ReplaceRouteTableAssociation","DeleteRouteTable","DeleteRoute","DisassociateRouteTable")<br />// EOQ|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches|AWS CloudTrail - S3 Bucket Changes|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - S3 Bucket Changes|\_sourceCategory = Labs/AWS/CloudTrail  (\*Bucket\*)<br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source \| where event\_source="s3.amazonaws.com"<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name <br />\| where event\_name in ("PutBucketAcl","PutBucketPolicy","PutBucketCors","PutBucketLifecycle","PutBucketReplication","DeleteBucketPolicy","DeleteBucketCors","DeleteBucketLifecycle","DeleteBucketReplication")<br />// EOQ|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches|AWS CloudTrail - Security Group Changes|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - Security Group Changes|\_sourceCategory = Labs/AWS/CloudTrail  (\*GroupIngress OR \*GroupEgress OR \*SecurityGroup)<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name \| where event\_name in ("AuthorizeSecurityGroupIngress","AuthorizeSecurityGroupEgress","RevokeSecurityGroupIngress","RevokeSecurityGroupEgress","CreateSecurityGroup","DeleteSecurityGroup")<br />// EoQ|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches|AWS CloudTrail - VPC Changes|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics Searches/AWS CloudTrail - VPC Changes|\_sourceCategory = Labs/AWS/CloudTrail  (\*Vpc\*)<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name \| where event\_name in ("CreateVpc","DeleteVpc","ModifyVpcAttribute","AcceptVpcPeeringConnection","CreateVpcPeeringConnection","DeleteVpcPeeringConnection","RejectVpcPeeringConnection","AttachClassicLinkVpc","DetachClassicLinkVpc","DisableVpcClassicLink","EnableVpcClassicLinkCreateVpc","DeleteVpc","ModifyVpcAttribute","AcceptVpcPeeringConnection","CreateVpcPeeringConnection","DeleteVpcPeeringConnection","RejectVpcPeeringConnection","AttachClassicLinkVpc","DetachClassicLinkVpc","DisableVpcClassicLink","EnableVpcClassicLink")<br />// EOQ|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Console Login Failures|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Login Activity|\_sourceCategory = Labs/AWS/CloudTrail ConsoleLogin AwsConsoleSignIn Failure<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"errorMessage\\":\\"\*\\"" as errorMessage nodrop \| parse "\\"errorCode\\":\\"\*\\"" as errorCode nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"MFAUsed\\":\\"\*\\"" as mfaUsed nodrop \| parse "\\"responseElements\\":{\\"ConsoleLogin\\":\\"\*\\"}" as loginResult nodrop \| parse field=errorMessage " Error Code: \*; Request ID" as errorCode2 nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop<br />\| if (isEmpty(errorCode), errorCode2, errorCode) as errorCode <br />\| source\_ipaddress as src\_ip \| user as dest\_user<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where event\_name="ConsoleLogin" and event\_type="AwsConsoleSignIn" and loginResult="Failure"<br />\| fields src\_ip, dest\_user, mfaUsed, event\_Type, event\_name, errorCode, errorMessage, principalId, aws\_region, source\_ipaddress, accountId<br />\| timeslice 15m<br />\| count as eventCount by \_timeslice<br />\| sort \_timeslice<br />|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Console Login Failures|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Login Activity|\_sourceCategory = Labs/AWS/CloudTrail ConsoleLogin AwsConsoleSignIn Failure<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"errorMessage\\":\\"\*\\"" as errorMessage nodrop \| parse "\\"errorCode\\":\\"\*\\"" as errorCode nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"MFAUsed\\":\\"\*\\"" as mfaUsed nodrop \| parse "\\"responseElements\\":{\\"ConsoleLogin\\":\\"\*\\"}" as loginResult nodrop \| parse field=errorMessage " Error Code: \*; Request ID" as errorCode2 nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop<br />\| if (isEmpty(errorCode), errorCode2, errorCode) as errorCode <br />\| source\_ipaddress as src\_ip \| user as dest\_user<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where event\_name="ConsoleLogin" and event\_type="AwsConsoleSignIn" and loginResult="Failure"<br />\| timeslice 1s<br />\| count as eventCount by \_timeslice, src\_ip, dest\_user, mfaUsed, event\_Type, event\_name, errorCode, errorMessage, principalId, aws\_region, accountId<br />\| sort by \_timeslice|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Console Root Login Failures|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Login Activity|\_sourceCategory = Labs/AWS/CloudTrail ConsoleLogin AwsConsoleSignIn Failure Root<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"errorMessage\\":\\"\*\\"" as errorMessage nodrop \| parse "\\"errorCode\\":\\"\*\\"" as errorCode nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"MFAUsed\\":\\"\*\\"" as mfaUsed nodrop \| parse "\\"responseElements\\":{\\"ConsoleLogin\\":\\"\*\\"}" as loginResult nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse field=arn "\*:\*:\*::\*:\*" as f1, f2, f3, f4, user nodrop \| parse field=arn "\*:\*:\*::\*:\*/\*/\*" as f1, f2, f3, f4, f5, role, f7 nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop<br />\| json "userIdentity.type" as type nodrop<br />\| if (isEmpty(user) and !isEmpty(user\_temp), user\_temp, user) as user<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| source\_ipaddress as src\_ip \| user as dest\_user<br />\| where event\_name="ConsoleLogin" and event\_type="AwsConsoleSignIn" and loginResult="Failure" and type="Root"<br />\| timeslice 1s<br />\| count as eventCount by \_timeslice, type, src\_ip, dest\_user, mfaUsed, event\_Type, event\_name, errorMessage, principalId, aws\_region, accountId<br />\| fields -eventCount<br />\| sort by \_timeslice|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Console Root Login Failures|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Login Activity|\_sourceCategory = Labs/AWS/CloudTrail ConsoleLogin AwsConsoleSignIn Failure Root<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"errorMessage\\":\\"\*\\"" as errorMessage nodrop \| parse "\\"errorCode\\":\\"\*\\"" as errorCode nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"MFAUsed\\":\\"\*\\"" as mfaUsed nodrop \| parse "\\"responseElements\\":{\\"ConsoleLogin\\":\\"\*\\"}" as loginResult nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse field=arn "\*:\*:\*::\*:\*" as f1, f2, f3, f4, user nodrop \| parse field=arn "\*:\*:\*::\*:\*/\*/\*" as f1, f2, f3, f4, f5, role, f7 nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop<br />\| json "userIdentity.type" as type nodrop<br />\| if (isEmpty(user) and !isEmpty(user\_temp), user\_temp, user) as user<br />\| source\_ipaddress as src\_ip \| user as dest\_user<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where event\_name="ConsoleLogin" and event\_type="AwsConsoleSignIn" and loginResult="Failure" and type="Root"<br />\| fields type, src\_ip, dest\_user, mfaUsed, event\_Type, event\_name, errorCode, errorMessage, principalId, aws\_region, accountId<br />\| timeslice 1h<br />\| count as eventCount by \_timeslice<br />\| sort \_timeslice|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Created Access Keys|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring|\_sourceCategory = Labs/AWS/CloudTrail CreateAccessKey <br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user\_username nodrop<br />\| parse "\\"accessKeyId\\":\\"\*\\"" as accessKeyId nodrop \| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| json "eventType" as event\_type nodrop<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where event\_name="CreateAccessKey"<br />\| timeslice 15m<br />\| count as eventCount by \_timeslice<br />\| sort \_timeslice<br />|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Created AccessKey|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview|\_sourceCategory = Labs/AWS/CloudTrail CreateAccessKey <br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user\_username nodrop<br />\| parse "\\"accessKeyId\\":\\"\*\\"" as accessKeyId nodrop \| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| json "eventType" as event\_type nodrop<br />\| where event\_name="CreateAccessKey"<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| timeslice 15m<br />\| count as eventCount by \_timeslice<br />\| sort \_timeslice<br />|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Created AccessKey|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring|\_sourceCategory = Labs/AWS/CloudTrail CreateAccessKey <br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop<br />\| parse "\\"accessKeyId\\":\\"\*\\"" as accessKeyId nodrop \| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| json "eventType" as event\_type nodrop<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where event\_name="CreateAccessKey"<br />\| count by eventTime, user, accessKeyId, accountId<br />\| sort by eventTime<br />\| fields - \_count|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Created IAM Roles|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring|\_sourceCategory = Labs/AWS/CloudTrail CreateRole<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user\_username nodrop<br />\| parse "\\"roleName\\":\\"\*\\"" as roleName nodrop \| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| json "eventType" as event\_type nodrop<br />\| where event\_name="CreateRole"<br />\| timeslice 15m<br />\| count as eventCount by \_timeslice<br />\| sort \_timeslice|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Created IAM Users|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring|\_sourceCategory = Labs/AWS/CloudTrail CreateUser <br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user\_username nodrop<br />\| parse "\\"requestParameters\\":{\\"userName\\":\\"\*\\"}" as targetUser\_username nodrop \| parse "\\"errorCode\\":\\"\*\\"" as errorCode nodrop<br />\| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| json "eventType" as event\_type nodrop<br />\| where aws\_region matches "{{aws\_region}}"<br />\| where event\_name="CreateUser" and errorCode\<\>"AccessDenied"<br />\| timeslice 15m<br />\| count as eventCount by \_timeslice<br />\| sort \_timeslice|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Created IAM Users|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring|\_sourceCategory = Labs/AWS/CloudTrail CreateUser <br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop<br />\| parse "\\"requestParameters\\":{\\"userName\\":\\"\*\\"}" as dest\_user nodrop \| parse "\\"errorCode\\":\\"\*\\"" as errorCode nodrop<br />\| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| json "eventType" as event\_type nodrop<br />\| where aws\_region matches "{{aws\_region}}"<br />\| where event\_name="CreateUser" and errorCode\<\>"AccessDenied"<br />\| count by eventtime, user, dest\_user, accountId<br />\| sort by eventTime<br />\| fields - \_count|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Created Roles|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring|\_sourceCategory = Labs/AWS/CloudTrail CreateRole<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop<br />\| parse "\\"roleName\\":\\"\*\\"" as roleName nodrop \| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| json "eventType" as event\_type nodrop<br />\| where event\_name="CreateRole"<br />\| count by eventTime, user, roleName, accountId<br />\| sort by eventTime<br />\| fields - \_count|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Created Roles|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview|\_sourceCategory = Labs/AWS/CloudTrail CreateRole<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user\_username nodrop<br />\| parse "\\"roleName\\":\\"\*\\"" as roleName nodrop \| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| json "eventType" as event\_type nodrop<br />\| where event\_name="CreateRole"<br />\| timeslice 15m<br />\| count as eventCount by \_timeslice<br />\| sort \_timeslice|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Created Security Groups|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity|\_sourceCategory = Labs/AWS/CloudTrail "ec2.amazonaws.com" CreateSecurityGroup<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop<br />\| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| parse "\\"groupName\\":\\"\*\\"," as groupName nodrop \| parse "\\"groupDescription\\":\\"\*\\"," as groupDescription nodrop \| parse "\\"groupId\\":\\"\*\\"" as groupId nodrop \| json "errorCode" nodrop \| json "errorMessage" as errorMessage nodrop \| json "sourceIPAddress" as source\_ipaddress nodrop \| json "eventSource" as event\_Source nodrop<br />\| where event\_name="CreateSecurityGroup" and errorCode\<\>"Client.UnauthorizedOperation" and event\_Source="ec2.amazonaws.com"<br />\| timeslice 15m <br />\| count as eventCount by \_timeslice<br />\| fillmissing timeslice (15m)<br />\| sort \_timeslice<br />|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Created Security Groups|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity|\_sourceCategory = Labs/AWS/CloudTrail "ec2.amazonaws.com" CreateSecurityGroup<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop<br />\| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| parse "\\"groupName\\":\\"\*\\"," as groupName nodrop \| parse "\\"groupDescription\\":\\"\*\\"," as groupDescription nodrop \| parse "\\"groupId\\":\\"\*\\"" as groupId nodrop \| json "errorCode" nodrop \| json "errorMessage" as errorMessage nodrop \| json "sourceIPAddress" as source\_ipaddress nodrop \| json "eventSource" as event\_Source nodrop<br />\| where event\_name="CreateSecurityGroup" and errorCode\<\>"Client.UnauthorizedOperation" and event\_Source="ec2.amazonaws.com"<br />\| count by eventTime, user, groupid, groupname, accountId, source\_ipaddress<br />\| sort by eventTime<br />\| fields -\_count|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Created Users|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview|\_sourceCategory = Labs/AWS/CloudTrail CreateUser <br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user\_username nodrop<br />\| parse "\\"requestParameters\\":{\\"userName\\":\\"\*\\"}" as targetUser\_username nodrop \| parse "\\"errorCode\\":\\"\*\\"" as errorCode nodrop<br />\| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| json "eventType" as event\_type nodrop<br />\| where event\_name="CreateUser" and errorCode\<\>"AccessDenied"<br />\| where aws\_region matches "{{aws\_region}}"<br />\| timeslice 15m<br />\| count as eventCount by \_timeslice<br />\| sort \_timeslice|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Deleted  IAM Users|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring|\_sourceCategory = Labs/AWS/CloudTrail DeleteUser<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop<br />\| parse "\\"requestParameters\\":{\\"userName\\":\\"\*\\"}" as dest\_user nodrop \| json "eventType" as event\_type nodrop<br />\| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop<br />\| where aws\_region matches "{{aws\_region}}"<br />\| where event\_name="DeleteUser"<br />\| count by eventTime, user, dest\_user, accountId<br />\| sort by eventTime<br />\| fields -\_count|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Deleted Access Keys|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring|\_sourceCategory = Labs/AWS/CloudTrail DeleteAccessKey <br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user\_username nodrop<br />\| parse "\\"accessKeyId\\":\\"\*\\"" as accessKeyId nodrop \| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| json "eventType" as event\_type nodrop<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where event\_name="DeleteAccessKey"<br />\| timeslice 15m<br />\| count as eventCount by \_timeslice<br />\| fillmissing timeslice (15m)<br />\| sort \_timeslice<br />|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Deleted AccessKey|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring|\_sourceCategory = Labs/AWS/CloudTrail DeleteAccessKey <br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop<br />\| parse "\\"accessKeyId\\":\\"\*\\"" as accessKeyId nodrop \| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| json "eventType" as event\_type nodrop<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where event\_name="DeleteAccessKey"<br />\| count by eventTime, user, accessKeyId, accountId<br />\| sort by eventTime<br />\| fields - \_count|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Deleted AccessKey|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview|\_sourceCategory = Labs/AWS/CloudTrail DeleteAccessKey <br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user\_username nodrop<br />\| parse "\\"accessKeyId\\":\\"\*\\"" as accessKeyId nodrop \| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| json "eventType" as event\_type nodrop<br />\| where event\_name="DeleteAccessKey"<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| timeslice 15m<br />\| count as eventCount by \_timeslice<br />\| fillmissing timeslice (15m)<br />\| sort \_timeslice<br />|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Deleted IAM Roles|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring|\_sourceCategory = Labs/AWS/CloudTrail DeleteRole<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user\_username nodrop<br />\| parse "\\"roleName\\":\\"\*\\"" as roleName nodrop \| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| json "eventType" as event\_type nodrop<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where event\_name="DeleteRole"<br />\| timeslice 15m<br />\| count as eventCount by \_timeslice<br />\| sort \_timeslice|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Deleted IAM Users|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring|\_sourceCategory = Labs/AWS/CloudTrail DeleteUser<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user\_username nodrop<br />\| parse "\\"requestParameters\\":{\\"userName\\":\\"\*\\"}" as targetUser\_username nodrop \| json "eventType" as event\_type nodrop<br />\| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop<br />\| where aws\_region matches "{{aws\_region}}"<br />\| where event\_name="DeleteUser"<br />\| timeslice 15m<br />\| count as eventCount by \_timeslice<br />\| sort \_timeslice|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Deleted Roles|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview|\_sourceCategory = Labs/AWS/CloudTrail DeleteRole<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user\_username nodrop<br />\| parse "\\"roleName\\":\\"\*\\"" as roleName nodrop \| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| json "eventType" as event\_type nodrop<br />\| where event\_name="DeleteRole"<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| timeslice 15m<br />\| count as eventCount by \_timeslice<br />\| sort \_timeslice<br />|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Deleted Roles|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring|\_sourceCategory = Labs/AWS/CloudTrail DeleteRole<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop<br />\| parse "\\"roleName\\":\\"\*\\"" as roleName nodrop \| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| json "eventType" as event\_type nodrop<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where event\_name="DeleteRole"<br />\| count by eventTime, user, rolename, accountId<br />\| sort by eventTime<br />\| fields -\_count|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Deleted Security Groups|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity|\_sourceCategory = Labs/AWS/CloudTrail "ec2.amazonaws.com" DeleteSecurityGroup <br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop<br />\| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| parse "\\"groupId\\":\\"\*\\"" as groupId nodrop \| json "errorCode" nodrop \| json "errorMessage" as errorMessage nodrop \| json "sourceIPAddress" as source\_ipaddress nodrop \| json "eventSource" as event\_Source nodrop<br />\| where event\_name="DeleteSecurityGroup" and event\_Source="ec2.amazonaws.com"<br />\| count by eventTime, user, groupid, accountId, source\_ipaddress<br />\| sort by eventTime<br />\| fields - \_count|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Deleted Security Groups|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity|\_sourceCategory = Labs/AWS/CloudTrail "ec2.amazonaws.com" DeleteSecurityGroup <br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop<br />\| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| parse "\\"groupId\\":\\"\*\\"" as groupId nodrop \| json "errorCode" nodrop \| json "errorMessage" as errorMessage nodrop \| json "sourceIPAddress" as source\_ipaddress nodrop \| json "eventSource" as event\_Source nodrop<br />\| where event\_name="DeleteSecurityGroup" and event\_Source="ec2.amazonaws.com"<br />\| timeslice 15m <br />\| count as eventCount by \_timeslice<br />\| fillmissing timeslice (15m)<br />\| sort \_timeslice<br />|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Deleted Users|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview|\_sourceCategory = Labs/AWS/CloudTrail DeleteUser<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user\_username nodrop<br />\| parse "\\"requestParameters\\":{\\"userName\\":\\"\*\\"}" as targetUser\_username nodrop \| json "eventType" as event\_type nodrop<br />\| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop<br />\| where event\_name="DeleteUser"<br />\| where aws\_region matches "{{aws\_region}}"<br />\| timeslice 15m<br />\| count as eventCount by \_timeslice<br />\| sort \_timeslice<br />|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Failed API Calls|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Login Activity|\_sourceCategory = Labs/AWS/CloudTrail AwsApiCall ("Client.UnauthorizedOperation" or AccessDenied) <br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"userName\\":\\"\*\\"" as user\_username nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"errorCode\\":\\"\*\\"" as errorCode nodrop \| parse "\\"errorMessage\\":\\"\*\\"" as errorMessage nodrop \| parse "\\"mfaAuthenticated\\":\\"\*\\"" as mfaAuthenticated nodrop <br />\| source\_ipaddress as srcDevice\_ip \| user as targetUser\_username<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where event\_type="AwsApiCall" and errorCode in ("Client.UnauthorizedOperation", "AccessDenied")<br />\| fields accountId, srcDevice\_ip, targetUser\_username, mfaAuthenticated, event\_Type, event\_name, errorCode, principalId, aws\_region<br />\| timeslice 15m<br />\| count as eventCount by \_timeslice<br />\| sort \_timeslice|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Failed API Calls - Acct Breakup|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Login Activity|\_sourceCategory = Labs/AWS/CloudTrail AwsApiCall ("Client.UnauthorizedOperation" or AccessDenied) <br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"errorCode\\":\\"\*\\"" as errorCode nodrop \| parse "\\"errorMessage\\":\\"\*\\"" as errorMessage nodrop \| parse "\\"mfaAuthenticated\\":\\"\*\\"" as mfaAuthenticated nodrop <br />\| source\_ipaddress as src\_ip \| user as dest\_user<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where event\_type="AwsApiCall" and errorCode in ("Client.UnauthorizedOperation", "AccessDenied")<br />\| timeslice 1h<br />\| count by \_timeslice,accountId <br />\| transpose row \_timeslice column accountId <br /><br />|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Failed API Calls - Reason - Login Credentials and Permission Issues|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Login Activity|\_sourceCategory = Labs/AWS/CloudTrail AwsApiCall ("Client.UnauthorizedOperation" or AccessDenied) <br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"errorCode\\":\\"\*\\"" as errorCode nodrop \| parse "\\"errorMessage\\":\\"\*\\"" as errorMessage nodrop \| parse "\\"mfaAuthenticated\\":\\"\*\\"" as mfaAuthenticated nodrop <br />\| source\_ipaddress as src\_ip \| user as dest\_user<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where event\_Type="AwsApiCall" and errorcode in ("Client.UnauthorizedOperation", "AccessDenied") <br />\| timeslice 1s<br />\| count as eventCount by \_timeslice, src\_ip, dest\_user, mfaAuthenticated, event\_Type, event\_name, errorCode, principalId, aws\_region, accountId<br />\| sort by \_timeslice|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Failed Configuration Changes|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity|\_sourceCategory = Labs/AWS/CloudTrail (Delete\* or Create\* or Terminate\*)<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop \| parse "\\"portRange\\":{\\"from\\":\*,\\"to\\":\*}" as from\_port, to\_port nodrop \| parse "\\"fromPort\\":\*,\\"toPort\\":\*," as from\_Port, to\_Port nodrop \| parse "\\"errorCode\\":\\"\*\\",\\"errorMessage\\":\\"\*\\"" as errorCode, errorMessage nodrop \| parse field=arn "\*:\*:\*::\*:\*" as f1, f2, f3, f4, user nodrop \| parse field=arn "\*:\*:\*::\*:\*/\*/\*" as f1, f2, f3, f4, f5, role, f7 nodrop<br />\| if (isEmpty(errorCode), "Success", "Failure") as OperationStatus<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| where OperationStatus="Failure" and (event\_name matches "Delete\*" or event\_name matches "Create\*" or event\_name matches "Terminate\*")<br />\| from\_port as src\_port \| to\_port as dest\_port \| source\_ipaddress as src\_ip \| user as src\_user<br />\| timeslice 1s<br />\| count as eventCount by \_timeslice, src\_ip, src\_user, event\_Type, event\_name, event\_source, aws\_region, principalId, OperationStatus, errorCode, errorMessage, accountId<br />\| sort by \_timeslice|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Failed Policy Changes|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity|\_sourceCategory = Labs/AWS/CloudTrail (Create\*Policy or Update\*Policy or Put\*Policy or Attach\*Policy or Detach\*Policy or Delete\*Policy) errorCode<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| json "sourceIPAddress" as source\_ipaddress nodrop \| json "eventSource" as event\_Source nodrop \| json "errorCode" nodrop \| json "errorMessage" nodrop \| json "requestParameters.policyName" as policyName nodrop<br />\| where (event\_name matches "Create\*Policy" or event\_name matches "Update\*Policy" or event\_name matches "Put\*Policy" or event\_name matches "Attach\*Policy" or event\_name matches "Detach\*Policy" or event\_name matches "Delete\*Policy")<br />\| timeslice 15m <br />\| count as eventCount by \_timeslice<br />\| fillmissing timeslice (15m)<br />\| sort \_timeslice<br />|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Failed Policy Changes|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity|\_sourceCategory = Labs/AWS/CloudTrail (Create\*Policy or Update\*Policy or Put\*Policy or Attach\*Policy or Detach\*Policy or Delete\*Policy) errorCode<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| json "sourceIPAddress" as source\_ipaddress nodrop \| json "eventSource" as event\_Source nodrop \| json "errorCode" nodrop \| json "errorMessage" nodrop \| json "requestParameters.policyName" as policyName nodrop<br />\| where (event\_name matches "Create\*Policy" or event\_name matches "Update\*Policy" or event\_name matches "Put\*Policy" or event\_name matches "Attach\*Policy" or event\_name matches "Detach\*Policy" or event\_name matches "Delete\*Policy")<br />\| count by eventTime, event\_name, event\_Source, policyName, user, accountId, aws\_Region, source\_ipaddress, errorCode, errorMessage<br />\| sort by eventTime<br />\| fields -\_count|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Group Operation Failures|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity|\_sourceCategory = Labs/AWS/CloudTrail "ec2.amazonaws.com" (AuthorizeSecurityGroupIngress or AuthorizeSecurityGroupEgress or RevokeSecurityGroupIngress or RevokeSecurityGroupEgress) errorCode errorMessage<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| parse "\\"groupId\\":\\"\*\\"" as groupId nodrop \| parse "\\"errorCode\\":\\"\*\\"" as errorCode nodrop \| json "errorMessage" as errorMessage nodrop \| json "sourceIPAddress" as source\_ipaddress nodrop \| json "eventSource" as event\_source nodrop<br />\| where event\_name in("AuthorizeSecurityGroupIngress", "AuthorizeSecurityGroupEgress", "RevokeSecurityGroupIngress", "RevokeSecurityGroupEgress") and event\_source="ec2.amazonaws.com"<br />\| timeslice 15m <br />\| count as eventCount by \_timeslice<br />\| fillmissing timeslice (15m)<br />\| sort \_timeslice<br /><br /><br /><br /><br />|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Group Operation Successes|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity|\_sourceCategory = Labs/AWS/CloudTrail "ec2.amazonaws.com" (AuthorizeSecurityGroupIngress or AuthorizeSecurityGroupEgress or RevokeSecurityGroupIngress or RevokeSecurityGroupEgress) !errorCode !errorMessage<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| parse "\\"groupId\\":\\"\*\\"" as groupId nodrop \| json "sourceIPAddress" as source\_ipaddress nodrop \| json "eventSource" as event\_source nodrop<br />\| where event\_name in ("AuthorizeSecurityGroupIngress", "AuthorizeSecurityGroupEgress", "RevokeSecurityGroupIngress", "RevokeSecurityGroupEgress") and event\_source="ec2.amazonaws.com"<br />\| timeslice 15m <br />\| count as eventCount by \_timeslice<br />\| fillmissing timeslice (15m)<br />\| sort \_timeslice<br />|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|IAM Activity|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring|\_sourceCategory = Labs/AWS/CloudTrail "iam.amazonaws.com" (Create\* or Delete\* or Put\* or Terminate\*)<br />\| json "recipientAccountId" as recipient\_acc\_id nodrop<br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"roleName\\":\\"\*\\"" as roleName nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| if (isEmpty(user) and !isEmpty(user\_temp), user\_temp, user) as user<br />\| source\_ipaddress as src\_ip \| user as src\_user<br />\| where event\_source="iam.amazonaws.com" and (event\_name matches "Create\*" or event\_name matches "Delete\*" or event\_name matches "Put\*" or event\_name matches "Terminate\*")<br />\| fields src\_ip, src\_user, event\_type, event\_name, aws\_region, principalid, roleName, accountid<br />\| count as eventCount by event\_name<br />\| sort by eventCount<br />\| limit 10|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|IAM Events Over Time|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring|\_sourceCategory = Labs/AWS/CloudTrail "iam.amazonaws.com"<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| json "eventType" as event\_type nodrop<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where event\_source="iam.amazonaws.com" and !(event\_name matches "List\*") and !(event\_name matches "Get\*") and !(event\_name matches "Describe\*")<br />\| timeslice 1h<br />\| count by \_timeslice, event\_name<br />\| transpose row \_timeslice column event\_name|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Login locations|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview|\_sourceCategory = Labs/AWS/CloudTrail<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "displayName\\":\\"\*\\"" as user\_username, "ipAddress\\":\\"\*\\"" as srcDevice\_ip nodrop<br />\| parse "\\"userName\\":\\"\*\\"" as user\_username, "\\"sourceIPAddress\\":\\"\*\\"," as srcDevice\_ip <br />\| parse "ruser=\* rhost=\* user=\*" as src\_user, src\_host, dest\_user nodrop<br />\| parse "ruser= rhost=\* user=\*" as src\_host, dest\_user nodrop<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| count by user\_username,srcDevice\_ip  <br />\| lookup latitude, longitude, country\_code,country\_name from geo://location on ip = srcDevice\_ip|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Non Read Only Events|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Access Monitoring|\_sourceCategory = Labs/AWS/CloudTrail<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop \| parse field=arn "\*:\*:\*::\*:\*" as f1, f2, f3, f4, user nodrop \| parse field=arn "\*:\*:\*::\*:\*/\*/\*" as f1, f2, f3, f4, f5, role, f7 nodrop <br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where !(event\_name matches "Describe\*") and !(event\_name matches "Get\*") and !(event\_name matches "List\*")<br />\| if (isEmpty(user) and !isEmpty(user\_temp), user\_temp, user) as user<br />\| timeslice 15m <br />\| count as eventCount by \_timeslice<br />\| sort \_timeslice<br />|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Non Read Only Events|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview|\_sourceCategory = Labs/AWS/CloudTrail<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"userName\\":\\"\*\\"" as user\_username nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop \| parse field=arn "\*:\*:\*::\*:\*" as f1, f2, f3, f4, user nodrop \| parse field=arn "\*:\*:\*::\*:\*/\*/\*" as f1, f2, f3, f4, f5, role, f7 nodrop <br />\| where !(event\_name matches "Describe\*") and !(event\_name matches "Get\*") and !(event\_name matches "List\*")<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| if (isEmpty(user) and !isEmpty(user\_temp), user\_temp, user) as user\_username<br />\| timeslice 15m<br />\| count as eventCount by \_timeslice<br />\| sort \_timeslice|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Non Read Only Events|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Access Monitoring|\_sourceCategory = Labs/AWS/CloudTrail<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop \| parse field=arn "\*:\*:\*::\*:\*" as f1, f2, f3, f4, user nodrop \| parse field=arn "\*:\*:\*::\*:\*/\*/\*" as f1, f2, f3, f4, f5, role, f7 nodrop <br />\| where !(event\_name matches "Describe\*") and !(event\_name matches "Get\*") and !(event\_name matches "List\*")<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| if (isEmpty(user) and !isEmpty(user\_temp), user\_temp, user) as user<br />\| count as eventCount by user, event\_name<br />\| sort eventCount, user, event\_name|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Operation Failure - Authorize, Revoke Security Groups Ingress, Egress Rules|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity|\_sourceCategory = Labs/AWS/CloudTrail "ec2.amazonaws.com" (AuthorizeSecurityGroupIngress or AuthorizeSecurityGroupEgress or RevokeSecurityGroupIngress or RevokeSecurityGroupEgress) errorCode errorMessage<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| parse "\\"groupId\\":\\"\*\\"" as groupId nodrop \| parse "\\"errorCode\\":\\"\*\\"" as errorCode nodrop \| json "errorMessage" as errorMessage nodrop \| json "sourceIPAddress" as source\_ipaddress nodrop \| json "eventSource" as event\_source nodrop<br />\| where event\_name in("AuthorizeSecurityGroupIngress", "AuthorizeSecurityGroupEgress", "RevokeSecurityGroupIngress", "RevokeSecurityGroupEgress") and event\_source="ec2.amazonaws.com"<br />\| count by eventTime, event\_name, user, groupid, accountId, aws\_Region, source\_ipaddress<br />\| sort by eventTime<br />\| fields -\_count<br /><br /><br />|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Operation Success - Authorize, Revoke Security Groups Ingress, Egress Rules|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity|\_sourceCategory = Labs/AWS/CloudTrail "ec2.amazonaws.com" (AuthorizeSecurityGroupIngress or AuthorizeSecurityGroupEgress or RevokeSecurityGroupIngress or RevokeSecurityGroupEgress) !errorCode !errorMessage<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| parse "\\"groupId\\":\\"\*\\"" as groupId nodrop \| json "sourceIPAddress" as source\_ipaddress nodrop \| json "eventSource" as event\_source nodrop<br />\| where event\_name in ("AuthorizeSecurityGroupIngress", "AuthorizeSecurityGroupEgress", "RevokeSecurityGroupIngress", "RevokeSecurityGroupEgress") and event\_source="ec2.amazonaws.com"<br />\| count by eventTime, event\_name, user, groupid, accountId, aws\_Region, source\_ipaddress<br />\| sort by eventTime<br />\| fields -\_count|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Outlier - Failed Login|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview|\_sourceCategory = Labs/AWS/CloudTrail  "ConsoleLogin" "Failure"<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as eventName nodrop<br />\| where eventName="ConsoleLogin"<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| parse "\\"sourceIPAddress\\":\\"\*\\"" as sourceIPAddress nodrop<br />\| parse "\\"userName\\":\\"\*\\"" as user\_username nodrop<br />\| json field=\_raw "userIdentity.principalId" as principal\_id nodrop<br />\| parse regex field = principal\_id ":(?\<user\_principal\>.+)" nodrop<br />\| if (user\_username="", user\_principal, user\_username) as user <br />\| json field=\_raw "responseElements.ConsoleLogin" as loginResult nodrop<br />\| where loginResult ="Failure"<br />\| parse "\\"MFAUsed\\":\\"\*\\"" as mfaUsed nodrop<br />\| timeslice 1h<br />\| count by \_timeslice<br />\| fillmissing timeslice(1h)<br />\| sort by \_timeslice<br />\| outlier \_count |
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Outlier- Failed Configuration Changes|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity|\_sourceCategory = Labs/AWS/CloudTrail (Delete\* or Create\* or Terminate\*)<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop \| parse "\\"portRange\\":{\\"from\\":\*,\\"to\\":\*}" as from\_port, to\_port nodrop \| parse "\\"fromPort\\":\*,\\"toPort\\":\*," as from\_Port, to\_Port nodrop \| parse "\\"errorCode\\":\\"\*\\",\\"errorMessage\\":\\"\*\\"" as errorCode, errorMessage nodrop \| parse field=arn "\*:\*:\*::\*:\*" as f1, f2, f3, f4, user nodrop \| parse field=arn "\*:\*:\*::\*:\*/\*/\*" as f1, f2, f3, f4, f5, role, f7 nodrop <br />\| if (isEmpty(errorCode), "Success", "Failure") as OperationStatus<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where OperationStatus="Failure" and (event\_name matches "Delete\*" or event\_name matches "Create\*" or event\_name matches "Terminate\*")<br />\| from\_port as src\_port \| to\_port as dest\_port \| source\_ipaddress as src\_ip \| user as src\_user<br />\| fields src\_ip, src\_user, event\_Type, event\_name, event\_source, aws\_region, principalId, OperationStatus, errorCode, errorMessage, accountId<br />\| timeslice 15m<br />\| count as eventCount by \_timeslice<br />\| fillmissing timeslice (15m)<br />\| outlier eventCount |
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Outlier- Successful Configuration Changes|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity|\_sourceCategory = Labs/AWS/CloudTrail (Delete\* or Create\* or Terminate\*)<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop \| parse "\\"portRange\\":{\\"from\\":\*,\\"to\\":\*}" as from\_port, to\_port nodrop \| parse "\\"fromPort\\":\*,\\"toPort\\":\*," as from\_Port, to\_Port nodrop \| parse "\\"errorCode\\":\\"\*\\",\\"errorMessage\\":\\"\*\\"" as errorCode, errorMessage nodrop \| parse field=arn "\*:\*:\*::\*:\*" as f1, f2, f3, f4, user nodrop \| parse field=arn "\*:\*:\*::\*:\*/\*/\*" as f1, f2, f3, f4, f5, role, f7 nodrop<br />\| if (isEmpty(errorCode), "Success", "Failure") as OperationStatus<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where OperationStatus="Success" and ((event\_name matches "Delete\*" or event\_name matches "Create\*" or event\_name matches "Terminate\*") and event\_name\<\>"CreateTags")<br />\| if (isEmpty(user) and !isEmpty(user\_temp), user\_temp, user) as user<br />\| from\_port as src\_port \| to\_port as dest\_port \| source\_ipaddress as src\_ip \| user as src\_user<br />\| fields src\_ip, src\_user, event\_Type, event\_name, event\_source, aws\_region, principalId, OperationStatus, accountId<br />\| timeslice 15m<br />\| count as eventCount by \_timeslice<br />\| fillmissing timeslice (15m)<br />\| outlier eventCount <br /><br />|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Password - Create, Update, Delete|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring|\_sourceCategory = Labs/AWS/CloudTrail "iam.amazonaws.com" (ChangePassword or UpdateLoginProfile or DeleteLoginProfile) <br />\| json "recipientAccountId" as recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| json "sourceIPAddress" as source\_ipaddress nodrop \| json "eventSource" as event\_source nodrop \| json "errorCode" nodrop \| json "errorMessage" nodrop \| json "requestParameters.userName" as dest\_user nodrop \| json "userIdentity.principalId" as principalId nodrop \| json "userIdentity.arn" as arn nodrop<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where event\_name in ("ChangePassword", "UpdateLoginProfile", "DeleteLoginProfile") and event\_source="iam.amazonaws.com"<br />\| timeslice 15m <br />\| count as eventCount by \_timeslice<br />\| sort \_timeslice|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Password - Create, Update, Delete|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring|\_sourceCategory = Labs/AWS/CloudTrail "iam.amazonaws.com" (ChangePassword or UpdateLoginProfile or DeleteLoginProfile) <br />\| json "recipientAccountId" as recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| json "sourceIPAddress" as source\_ipaddress nodrop \| json "eventSource" as event\_source nodrop \| json "errorCode" nodrop \| json "errorMessage" nodrop \| json "requestParameters.userName" as dest\_user nodrop \| json "userIdentity.principalId" as principalId nodrop \| json "userIdentity.arn" as arn nodrop<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where event\_name in ("ChangePassword", "UpdateLoginProfile", "DeleteLoginProfile") and event\_source="iam.amazonaws.com"<br />\| count by eventTime, event\_name, event\_source, user, dest\_user, accountId, aws\_Region, source\_ipaddress, errorCode, errorMessage<br />\| sort by eventTime<br />\| fields -\_count|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Potential Threats by IP|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview|\_sourceCategory = Labs/AWS/CloudTrail sourceIPAddress <br />\| json "recipientAccountId" as recipient\_acc\_id nodrop<br />\| json "eventTime","eventName", "awsRegion", "sourceIPAddress", "errorCode","userAgent" as event\_time, event\_name, aws\_region, src\_ip, result,user\_agent nodrop<br />\| json "userIdentity.userName", "userIdentity.accountId" as src\_user, accountId nodrop <br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| if (result=="" or isNull(result), "Success",result) as result <br />\| lookup type, actor, raw, threatlevel as malicious\_confidence ,threat from sumo://threat/cs on src\_ip=threat<br />\| where type="ip\_address" and  malicious\_confidence="high"<br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families<br />\| json field=raw "last\_updated" as last\_updated<br />\|  formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| timeslice 15m<br />\| count as eventCount by \_timeslice<br />\| sort \_timeslice<br /><br />|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Read Only Events|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview|\_sourceCategory = Labs/AWS/CloudTrail (Describe\* or Get\* or List\*)<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"userName\\":\\"\*\\"" as user\_username nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop \| parse field=arn "\*:\*:\*::\*:\*" as f1, f2, f3, f4, user nodrop \| parse field=arn "\*:\*:\*::\*:\*/\*/\*" as f1, f2, f3, f4, f5, role, f7 nodrop <br />\| where (event\_name matches "Describe\*" or event\_name matches "Get\*" or event\_name matches "List\*")<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| if (isEmpty(user) and !isEmpty(user\_temp), user\_temp, user) as user\_username<br />\| timeslice 15m<br />\| count as eventCount by \_timeslice<br />\| sort \_timeslice<br />|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Read Only Events|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Access Monitoring|\_sourceCategory = Labs/AWS/CloudTrail (Describe\* or Get\* or List\*)<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop \| parse field=arn "\*:\*:\*::\*:\*" as f1, f2, f3, f4, user nodrop \| parse field=arn "\*:\*:\*::\*:\*/\*/\*" as f1, f2, f3, f4, f5, role, f7 nodrop <br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where (event\_name matches "Describe\*" or event\_name matches "Get\*" or event\_name matches "List\*")<br />\| if (isEmpty(user) and !isEmpty(user\_temp), user\_temp, user) as user<br />\| timeslice 15m <br />\| count as eventCount by \_timeslice<br />\| sort \_timeslice<br />|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Read Only Events|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Access Monitoring|\_sourceCategory = Labs/AWS/CloudTrail (Describe\* or Get\* or List\*)<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop \| parse field=arn "\*:\*:\*::\*:\*" as f1, f2, f3, f4, user nodrop \| parse field=arn "\*:\*:\*::\*:\*/\*/\*" as f1, f2, f3, f4, f5, role, f7 nodrop <br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where (event\_name matches "Describe\*" or event\_name matches "Get\*" or event\_name matches "List\*")<br />\| if (isEmpty(user) and !isEmpty(user\_temp), user\_temp, user) as user<br />\| count as eventCount by user, event\_name<br />\| sort eventCount, user, event\_name|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Removed User From Security Group|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview|\_sourceCategory = Labs/AWS/CloudTrail "iam.amazonaws.com" (RemoveUserFromGroup) !errorCode !errorMesage<br />\| json "recipientAccountId" as recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_region nodrop \| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| json "sourceIPAddress" as srcDevice\_ip nodrop \| json "eventSource" as event\_source nodrop<br />\| json "requestParameters.groupName" as groupName nodrop \| json "requestParameters.userName" as dest\_user nodrop<br />\| where event\_name in ("AddUserToGroup", "RemoveUserFromGroup") and event\_source="iam.amazonaws.com"<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| timeslice 15m<br />\| count as eventCount by \_timeslice<br />\| fillmissing timeslice (15m)<br />\| sort \_timeslice<br />|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Security Group Activity|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Access Monitoring|\_sourceCategory = Labs/AWS/CloudTrail \*SecurityGroup\*<br />\| json "recipientAccountId" as recipient\_acc\_id nodrop<br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_region nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"roleName\\":\\"\*\\"" as roleName nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse "\\"portRange\\":{\\"from\\":\*,\\"to\\":\*}" as from\_port,to\_port nodrop \| parse "\\"fromPort\\":\*,\\"toPort\\":\*," as from\_Port,to\_Port nodrop \| parse "\\"cidrBlock\\":\\"\*\\"" as cidr\_block nodrop \| parse "\\"cidrIp\\":\\"\*\\"" as cidr\_ip nodrop \| parse "\\"egress\\":\*," as egress nodrop  \| parse "\\"ruleAction\\":\\"\*\\"" as action nodrop \| parse "\\"groupName\\":\\"\*\\"," as groupName nodrop \| parse "\\"groupDescription\\":\\"\*\\"," as groupDescription nodrop \| parse "\\"groupId\\":\\"\*\\"" as groupId nodrop \| parse regex field=event\_name "SecurityGroup(?\<direction\>[A-Za-z]+)" nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop \| parse field=arn "\*:\*:\*::\*:\*" as f1, f2, f3, f4, user nodrop \| parse field=arn "\*:\*:\*::\*:\*/\*/\*" as f1, f2, f3, f4, f5, role, f7 nodrop<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where event\_name matches "\*SecurityGroup\*" and !(event\_name matches "Describe\*")<br />\| if (isEmpty(user) and !isEmpty(user\_temp), user\_temp, user) as user<br />\| source\_ipaddress as src\_ip \| user as src\_user<br />\| timeslice 1s<br />\| count as eventCount by \_timeslice, src\_ip, src\_user, event\_type, event\_name, event\_source, principalid, aws\_region, groupid, groupname, groupDescription, direction, from\_port, to\_Port, cidr\_block, cidr\_ip, egress, action, accountid<br />\| sort by \_timeslice|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Security Group Activity|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Access Monitoring|\_sourceCategory = Labs/AWS/CloudTrail \*SecurityGroup\*<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where event\_name matches "\*SecurityGroup\*" and !(event\_name matches "Describe\*") and !(event\_name matches "List\*") and !(event\_name matches "Get\*")<br />\| count as eventCount by event\_name<br />\| sort by eventCount|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Security Group Activity Over Time|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Access Monitoring|\_sourceCategory = Labs/AWS/CloudTrail \*SecurityGroup\*<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where event\_name matches "\*SecurityGroup\*" and !(event\_name matches "Describe\*")  and !(event\_name matches "Get\*") and !(event\_name matches "List\*")<br />\| timeslice 1h<br />\| count as eventCount by \_timeslice, event\_name<br />\| transpose row \_timeslice column event\_name|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Security Group Activity Over Time|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity|\_sourceCategory = Labs/AWS/CloudTrail \*SecurityGroup\*<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop<br />\| where event\_name matches "\*SecurityGroup\*" and !(event\_name matches "Describe\*")  and !(event\_name matches "Get\*") and !(event\_name matches "List\*")<br />\| timeslice 1h<br />\| count as eventCount by \_timeslice, event\_name<br />\| transpose row \_timeslice column event\_name|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Successful Configuration Changes|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity|\_sourceCategory = Labs/AWS/CloudTrail (Delete\* or Create\* or Terminate\*)<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop \| parse "\\"portRange\\":{\\"from\\":\*,\\"to\\":\*}" as from\_port, to\_port nodrop \| parse "\\"fromPort\\":\*,\\"toPort\\":\*," as from\_Port, to\_Port nodrop \| parse "\\"errorCode\\":\\"\*\\",\\"errorMessage\\":\\"\*\\"" as errorCode, errorMessage nodrop \| parse field=arn "\*:\*:\*::\*:\*" as f1, f2, f3, f4, user nodrop \| parse field=arn "\*:\*:\*::\*:\*/\*/\*" as f1, f2, f3, f4, f5, role, f7 nodrop<br />\| if (isEmpty(errorCode), "Success", "Failure") as OperationStatus<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where OperationStatus="Success" and ((event\_name matches "Delete\*" or event\_name matches "Create\*" or event\_name matches "Terminate\*") and event\_name\<\>"CreateTags")<br />\| if (isEmpty(user) and !isEmpty(user\_temp), user\_temp, user) as user<br />\| from\_port as src\_port \| to\_port as dest\_port \| source\_ipaddress as src\_ip \| user as src\_user<br />\| timeslice 1s<br />\| count as eventCount by \_timeslice, src\_ip, src\_user, event\_Type, event\_name, event\_source, aws\_region, principalId, OperationStatus, accountId<br />\| sort by \_timeslice|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Successful Console Logins|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Login Activity|\_sourceCategory = Labs/AWS/CloudTrail ConsoleLogin AwsConsoleSignIn Success <br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop\| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop \| parse "\\"MFAUsed\\":\\"\*\\"" as mfaUsed nodrop \| parse "\\"responseElements\\":{\\"ConsoleLogin\\":\\"\*\\"}" as loginResult nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse field=arn "\*:\*:\*::\*:\*" as f1, f2, f3, f4, user nodrop \| parse field=arn "\*:\*:\*::\*:\*/\*/\*" as f1, f2, f3, f4, f5, role, f7 nodrop<br />\| if (isEmpty(user) and !isEmpty(user\_temp), user\_temp, user) as user<br />\| source\_ipaddress as src\_ip \| user as dest\_user<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where loginResult="Success" and event\_Type="AwsConsoleSignIn" and event\_name="ConsoleLogin"<br />\| fields src\_ip, dest\_user, role, mfaUsed, event\_Type, event\_name, principalId, aws\_region, accountId<br />\| timeslice 15m<br />\| count as eventCount by \_timeslice<br />\| sort \_timeslice|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Successful Console Logins|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Login Activity|\_sourceCategory = Labs/AWS/CloudTrail ConsoleLogin AwsConsoleSignIn Success <br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop\| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop \| parse "\\"MFAUsed\\":\\"\*\\"" as mfaUsed nodrop \| parse "\\"responseElements\\":{\\"ConsoleLogin\\":\\"\*\\"}" as loginResult nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse field=arn "\*:\*:\*::\*:\*" as f1, f2, f3, f4, user nodrop \| parse field=arn "\*:\*:\*::\*:\*/\*/\*" as f1, f2, f3, f4, f5, role, f7 nodrop<br />\| if (isEmpty(user) and !isEmpty(user\_temp), user\_temp, user) as user<br />\| source\_ipaddress as src\_ip \| user as dest\_user<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where loginResult="Success" and event\_Type="AwsConsoleSignIn" and event\_name="ConsoleLogin"<br />\| timeslice 1s<br />\| count as eventCount by \_timeslice, src\_ip, dest\_user, role, mfaUsed, event\_Type, event\_name, principalId, aws\_region, accountId<br />\| sort by \_timeslice|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Successful Policy Changes|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity|\_sourceCategory = Labs/AWS/CloudTrail (Create\*Policy or Update\*Policy or Put\*Policy or Attach\*Policy or Detach\*Policy or Delete\*Policy) !errorCode !errorMessage<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| json "sourceIPAddress" as source\_ipaddress nodrop \| json "eventSource" as event\_Source nodrop \| json "errorCode" nodrop \| json "errorMessage" nodrop<br />\| json "requestParameters.policyName" as policyName nodrop \| json "requestParameters.policyArn" as policyArn nodrop \| parse field=policyArn ":policy/\*" as policyName nodrop<br />\| where (event\_name matches "Create\*Policy" or event\_name matches "Update\*Policy" or event\_name matches "Put\*Policy" or event\_name matches "Attach\*Policy" or event\_name matches "Detach\*Policy" or event\_name matches "Delete\*Policy") and isEmpty(errorCode)<br />\| count by eventTime, event\_name, event\_Source, policyName, user, accountId, aws\_Region, source\_ipaddress<br />\| sort by eventTime<br />\| fields -\_count|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Successful Policy Changes|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity|\_sourceCategory = Labs/AWS/CloudTrail (Create\*Policy or Update\*Policy or Put\*Policy or Attach\*Policy or Detach\*Policy or Delete\*Policy) !errorCode !errorMessage<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| json "sourceIPAddress" as source\_ipaddress nodrop \| json "eventSource" as event\_Source nodrop \| json "errorCode" nodrop \| json "errorMessage" nodrop<br />\| json "requestParameters.policyName" as policyName nodrop \| json "requestParameters.policyArn" as policyArn nodrop \| parse field=policyArn ":policy/\*" as policyName nodrop<br />\| where (event\_name matches "Create\*Policy" or event\_name matches "Update\*Policy" or event\_name matches "Put\*Policy" or event\_name matches "Attach\*Policy" or event\_name matches "Detach\*Policy" or event\_name matches "Delete\*Policy") and isEmpty(errorCode)<br />\| timeslice 15m <br />\| count as eventCount by \_timeslice<br />\| sort \_timeslice<br />|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Successful Root Console Logins|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Login Activity|\_sourceCategory = Labs/AWS/CloudTrail ConsoleLogin AwsConsoleSignIn Success Root<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop\| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop \| parse "\\"MFAUsed\\":\\"\*\\"" as mfaUsed nodrop \| parse "\\"responseElements\\":{\\"ConsoleLogin\\":\\"\*\\"}" as loginResult nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse field=arn "\*:\*:\*::\*:\*" as f1, f2, f3, f4, user nodrop \| parse field=arn "\*:\*:\*::\*:\*/\*/\*" as f1, f2, f3, f4, f5, role, f7 nodrop<br />\| json "userIdentity.type" as type nodrop<br />\| if (isEmpty(user) and !isEmpty(user\_temp), user\_temp, user) as user<br />\| source\_ipaddress as src\_ip \| user as dest\_user<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where loginResult="Success" and event\_Type="AwsConsoleSignIn" and event\_name="ConsoleLogin" and type="Root"<br />\| timeslice 1s<br />\| count as eventCount by \_timeslice, type, src\_ip, dest\_user, mfaUsed, event\_Type, event\_name, principalId, aws\_region, accountId<br />\| fields -eventCount<br />\| sort by \_timeslice|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Successful Root Console Logins|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Login Activity|\_sourceCategory = Labs/AWS/CloudTrail ConsoleLogin AwsConsoleSignIn Success Root<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop\| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop \| parse "\\"MFAUsed\\":\\"\*\\"" as mfaUsed nodrop \| parse "\\"responseElements\\":{\\"ConsoleLogin\\":\\"\*\\"}" as loginResult nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse field=arn "\*:\*:\*::\*:\*" as f1, f2, f3, f4, user nodrop \| parse field=arn "\*:\*:\*::\*:\*/\*/\*" as f1, f2, f3, f4, f5, role, f7 nodrop<br />\| json "userIdentity.type" as type nodrop<br />\| if (isEmpty(user) and !isEmpty(user\_temp), user\_temp, user) as user<br />\| source\_ipaddress as src\_ip \| user as dest\_user<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where loginResult="Success" and event\_Type="AwsConsoleSignIn" and event\_name="ConsoleLogin" and type="Root"<br />\| timeslice 1h<br />\| count as eventCount by \_timeslice<br />\| sort \_timeslice|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Threat Count by I.P|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Threat Intelligence|\_sourceCategory = Labs/AWS/CloudTrail <br />\| json "recipientAccountId" as recipient\_acc\_id nodrop<br />\| json "eventTime","eventName", "awsRegion", "sourceIPAddress", "errorCode","userAgent" as event\_time, event\_name, aws\_region, src\_ip, result,user\_agent nodrop<br />\| json "userIdentity.userName", "userIdentity.accountId" as src\_user, accountId nodrop <br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| if (result=="" or isNull(result), "Success",result) as result <br />\| where result!="AccessDenied"<br />\| lookup type, actor, raw, threatlevel  as malicious\_confidence ,threat from sumo://threat/cs on src\_ip=threat<br />\| where type="ip\_address" <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| where malicious\_confidence matches "high"<br />\| count as eventCount by src\_ip<br />\| sort by eventCount<br />\| limit 10 |
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Threat Outlier|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview|\_sourceCategory = Labs/AWS/CloudTrail sourceIPAddress <br />\| json "recipientAccountId" as recipient\_acc\_id nodrop<br />\| json "eventTime","eventName", "awsRegion", "sourceIPAddress", "errorCode","userAgent" as event\_time, event\_name, aws\_region, src\_ip, result,user\_agent nodrop<br />\| json "userIdentity.userName", "userIdentity.accountId" as user\_username, accountId nodrop <br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| if (result=="" or isNull(result), "Success",result) as result <br />\| lookup type, actor, raw, threatlevel as malicious\_confidence,threat from sumo://threat/cs on src\_ip=threat<br />\| where type="ip\_address" and  malicious\_confidence="high"<br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families<br />\| json field=raw "last\_updated" as last\_updated<br />\|  formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| timeslice 1h<br />\| count by \_timeslice<br />\| outlier \_count<br />|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Threats Associated with CloudTrail Events|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Threat Intelligence|\_sourceCategory = Labs/AWS/CloudTrail <br />\| json "recipientAccountId" as recipient\_acc\_id nodrop<br />\| json "eventTime","eventName", "awsRegion", "sourceIPAddress", "errorCode","userAgent" as event\_time, event\_name, aws\_region, src\_ip, result,user\_agent nodrop<br />\| json "userIdentity.userName", "userIdentity.accountId" as src\_user, accountId nodrop <br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| if (result=="" or isNull(result), "Success",result) as result <br />\| lookup type, actor, raw, threatlevel  as malicious\_confidence ,threat from sumo://threat/cs on src\_ip=threat<br />\| where type="ip\_address" <br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families<br />\| json field=raw "last\_updated" as last\_updated<br />\| formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| where malicious\_confidence matches "high"<br />\| count by event\_time, src\_user,src\_ip,event\_name, aws\_region , result , malicious\_confidence, label\_name,  threat\_malware\_families,threat\_last\_updated|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Threats By Actor|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Threat Intelligence|\_sourceCategory = Labs/AWS/CloudTrail sourceIPAddress <br />\| json "recipientAccountId" as recipient\_acc\_id nodrop<br />\| json "eventTime","eventName", "awsRegion", "sourceIPAddress", "errorCode","userAgent" as event\_time, event\_name, aws\_region, src\_ip, result,user\_agent nodrop<br />\| json "userIdentity.userName", "userIdentity.accountId" as src\_user, accountId nodrop <br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| if (result=="" or isNull(result), "Unknown",result) as result<br />\| lookup type, actor, raw, threatlevel as malicious\_confidence ,threat from sumo://threat/cs on src\_ip=threat<br />\| where type="ip\_address" <br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families<br />\| json field=raw "last\_updated" as last\_updated<br />\| formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| if (isNull(actor) or actor="","Unassigned",actor) as actor<br />\| where malicious\_confidence matches "high"<br />\| count as eventCount by actor<br />\| sort by eventCount<br />|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Threats by Events and Result|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Threat Intelligence|\_sourceCategory = Labs/AWS/CloudTrail <br />\| json "recipientAccountId" as recipient\_acc\_id nodrop<br />\| json "eventTime","eventName", "awsRegion", "sourceIPAddress", "errorCode","userAgent" as event\_time, event\_name, aws\_region, src\_ip, result,user\_agent nodrop<br />\| json "userIdentity.userName", "userIdentity.accountId" as src\_user, accountId nodrop <br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| if (result=="" or isNull(result), "Success",result) as result <br />\| lookup type, actor, raw, threatlevel as malicious\_confidence ,threat from sumo://threat/cs on src\_ip=threat<br />\| where type="ip\_address"<br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families<br />\| json field=raw "last\_updated" as last\_updated<br />\| formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| if (isNull(actor) or actor="","Unassigned",actor) as actor<br />\| where malicious\_confidence matches "high"<br />\| count as eventCount by event\_name, result<br />\| sort by result<br />\| limit 10<br />\| transpose row event\_name column result|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Threats by Geo Location|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Threat Intelligence|\_sourceCategory = Labs/AWS/CloudTrail  sourceIPAddress<br />\| json "recipientAccountId" as recipient\_acc\_id nodrop<br />\| json "eventTime","eventName", "awsRegion", "sourceIPAddress", "errorCode","userAgent" as event\_time, action, aws\_region, src\_ip, result,user\_agent nodrop<br />\| json "userIdentity.userName", "userIdentity.accountId" as src\_user, accountId nodrop <br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| if (result=="" or isNull(result), "Success",result) as result <br />\| lookup type, actor, raw, threatlevel as malicious\_confidence,threat from sumo://threat/cs on src\_ip=threat<br />\| where type="ip\_address"<br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families<br />\| json field=raw "last\_updated" as last\_updated<br />\| formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name <br />\| lookup latitude, longitude, country\_code, country\_name, region, city, postal\_code from geo://location on ip = src\_ip<br />\| where malicious\_confidence matches "high"<br />\| count by latitude, longitude, label\_name,threat\_last\_updated|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Threats Over Time|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview|\_sourceCategory = Labs/AWS/CloudTrail sourceIPAddress <br />\| json "recipientAccountId" as recipient\_acc\_id nodrop<br />\| json "eventTime","eventName", "awsRegion", "sourceIPAddress", "errorCode","userAgent" as event\_time, event\_name, aws\_region, src\_ip, result,user\_agent nodrop<br />\| json "userIdentity.userName", "userIdentity.accountId" as src\_user, accountId nodrop <br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| if (result=="" or isNull(result), "Success",result) as result <br />\| lookup type, actor, raw, threatlevel as malicious\_confidence,threat from sumo://threat/cs on src\_ip=threat<br />\| where type="ip\_address" and  malicious\_confidence="high"<br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families<br />\| json field=raw "last\_updated" as last\_updated<br />\|  formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| timeslice 1h<br />\| count by \_timeslice<br />|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Threats Over Time by Result|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Threat Intelligence|\_sourceCategory = Labs/AWS/CloudTrail <br />\| json "recipientAccountId" as recipient\_acc\_id nodrop<br />\| json "eventTime","eventName", "awsRegion", "sourceIPAddress", "errorCode","userAgent" as event\_time, event\_name, aws\_region, src\_ip, result,user\_agent nodrop<br />\| json "userIdentity.userName", "userIdentity.accountId" as src\_user, accountId nodrop <br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| if (result=="" or isNull(result), "Success",result) as result <br />\| lookup type, actor, raw, threatlevel  as malicious\_confidence ,threat from sumo://threat/cs on src\_ip=threat<br />\| where type="ip\_address"<br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families<br />\| json field=raw "last\_updated" as last\_updated<br />\| formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| timeslice 1h<br />\| where malicious\_confidence matches "high"<br />\| count by \_timeslice, result<br />\| transpose row \_timeslice column result|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Top 10 Failed Configuration Changes|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity|\_sourceCategory = Labs/AWS/CloudTrail (Delete\* or Create\* or Terminate\*)<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop \| parse "\\"portRange\\":{\\"from\\":\*,\\"to\\":\*}" as from\_port, to\_port nodrop \| parse "\\"fromPort\\":\*,\\"toPort\\":\*," as from\_Port, to\_Port nodrop \| parse "\\"errorCode\\":\\"\*\\",\\"errorMessage\\":\\"\*\\"" as errorCode, errorMessage nodrop \| parse field=arn "\*:\*:\*::\*:\*" as f1, f2, f3, f4, user nodrop \| parse field=arn "\*:\*:\*::\*:\*/\*/\*" as f1, f2, f3, f4, f5, role, f7 nodrop <br />\| if (isEmpty(errorCode), "Success", "Failure") as OperationStatus<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where OperationStatus="Failure" and (event\_name matches "Delete\*" or event\_name matches "Create\*" or event\_name matches "Terminate\*")<br />\| from\_port as src\_port \| to\_port as dest\_port \| source\_ipaddress as src\_ip \| user as src\_user<br />\| fields src\_ip, src\_user, event\_Type, event\_name, event\_source, aws\_region, principalId, OperationStatus, errorCode, errorMessage, accountId<br />\| count as eventCount by event\_name<br />\| sort by eventCount <br />\| limit 10|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Top 10 Security Group Activities|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity|\_sourceCategory = Labs/AWS/CloudTrail \*SecurityGroup\*<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop<br />\| where event\_name matches "\*SecurityGroup\*" and !(event\_name matches "Describe\*") and !(event\_name matches "List\*") and !(event\_name matches "Get\*")<br />\| count as eventCount by event\_name<br />\| sort by eventCount <br />\| limit 10|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Top 10 Successful Configuration Changes|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Analytics - Privileged Activity|\_sourceCategory = Labs/AWS/CloudTrail (Delete\* or Create\* or Terminate\*)<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| parse "\\"eventSource\\":\\"\*\\"" as event\_source nodrop \| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"eventType\\":\\"\*\\"" as event\_Type nodrop \| parse "\\"sourceIPAddress\\":\\"\*\\"" as source\_ipaddress nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"principalId\\":\\"\*\\"" as principalId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"arn\\":\\"\*\\"" as arn nodrop \| parse field=principalId "\*:\*" as accesskeyId, user\_temp nodrop \| parse "\\"portRange\\":{\\"from\\":\*,\\"to\\":\*}" as from\_port, to\_port nodrop \| parse "\\"fromPort\\":\*,\\"toPort\\":\*," as from\_Port, to\_Port nodrop \| parse "\\"errorCode\\":\\"\*\\",\\"errorMessage\\":\\"\*\\"" as errorCode, errorMessage nodrop \| parse field=arn "\*:\*:\*::\*:\*" as f1, f2, f3, f4, user nodrop \| parse field=arn "\*:\*:\*::\*:\*/\*/\*" as f1, f2, f3, f4, f5, role, f7 nodrop<br />\| if (isEmpty(errorCode), "Success", "Failure") as OperationStatus<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where OperationStatus="Success" and ((event\_name matches "Delete\*" or event\_name matches "Create\*" or event\_name matches "Terminate\*") and event\_name\<\>"CreateTags")<br />\| if (isEmpty(user) and !isEmpty(user\_temp), user\_temp, user) as user<br />\| from\_port as src\_port \| to\_port as dest\_port \| source\_ipaddress as src\_ip \| user as src\_user<br />\| fields src\_ip, src\_user, event\_Type, event\_name, event\_source, aws\_region, principalId, OperationStatus, accountId<br />\| count as eventCount by event\_name<br />\| sort by eventCount <br />\| limit 10|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|Unauthorized AWS API Requests|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Overview|\_sourceCategory = Labs/AWS/CloudTrail ("AccessDenied" or "UnauthorizedOperation")<br />\| json "awsRegion", "recipientAccountId" as aws\_region, recipient\_acc\_id nodrop<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| json "sourceIPAddress" as srcDevice\_ip<br />\| json "errorCode" as error<br />\| json "eventName"<br />\| json "userIdentity.sessionContext.sessionIssuer.userName" as user\_username<br />\| where error="AccessDenied" or error="UnauthorizedOperation"<br />\| count by user\_username, error <br />\| transpose row user\_username column error|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|User Added To Security Group|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring|\_sourceCategory = Labs/AWS/CloudTrail "iam.amazonaws.com" (AddUserToGroup ) !errorCode !errorMesage<br />\| json "recipientAccountId" as recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user\_username nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| json "sourceIPAddress" as srcDevice\_ip nodrop \| json "eventSource" as event\_source nodrop<br />\| json "requestParameters.groupName" as groupName nodrop \| json "requestParameters.userName" as targetUser\_username nodrop<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where event\_name in ("AddUserToGroup", "RemoveUserFromGroup") and event\_source="iam.amazonaws.com"<br />\| timeslice 15m<br />\| count as eventCount by \_timeslice<br />\| sort \_timeslice<br />|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|User Added To Security Group|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring|\_sourceCategory = Labs/AWS/CloudTrail "iam.amazonaws.com" (AddUserToGroup ) !errorCode !errorMesage<br />\| json "recipientAccountId" as recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user\_username nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_Region nodrop \| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| json "sourceIPAddress" as srcDevice\_ip nodrop \| json "eventSource" as event\_source nodrop<br />\| json "requestParameters.groupName" as groupName nodrop \| json "requestParameters.userName" as targetUser\_username nodrop<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where event\_name in ("AddUserToGroup", "RemoveUserFromGroup") and event\_source="iam.amazonaws.com"<br />\| timeslice 15m<br />\| count by eventTime, event\_name, event\_source, user, groupName, groupId, accountId, aws\_Region, source\_ipaddress<br />\| sort by eventTime<br />\| fields -\_count<br />|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|User Deleted From Security Group|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring|\_sourceCategory = Labs/AWS/CloudTrail "iam.amazonaws.com" (RemoveUserFromGroup) !errorCode !errorMesage<br />\| json "recipientAccountId" as recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_region nodrop \| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| json "sourceIPAddress" as srcDevice\_ip nodrop \| json "eventSource" as event\_source nodrop<br />\| json "requestParameters.groupName" as groupName nodrop \| json "requestParameters.userName" as dest\_user nodrop<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where event\_name in ("AddUserToGroup", "RemoveUserFromGroup") and event\_source="iam.amazonaws.com"<br />\| timeslice 15m<br />\| count by eventTime, event\_name, event\_source, user, groupName, groupId, accountId, aws\_Region, source\_ipaddress<br />\| sort by eventTime<br />\| fields -\_count<br /><br />|
|Amazon CloudTrail - Cloud Security Monitoring and Analytics|User Deleted From Security Group|Logs|Amazon CloudTrail - Cloud Security Monitoring and Analytics/Amazon CloudTrail - Security Monitoring - Account and System Monitoring|\_sourceCategory = Labs/AWS/CloudTrail "iam.amazonaws.com" (RemoveUserFromGroup) !errorCode !errorMesage<br />\| json "recipientAccountId" as recipient\_acc\_id nodrop<br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name nodrop \| parse "\\"accountId\\":\\"\*\\"" as accountId nodrop \| parse "\\"userName\\":\\"\*\\"" as user nodrop \| parse "\\"awsRegion\\":\\"\*\\"" as aws\_region nodrop \| parse "\\"eventTime\\":\\"\*\\"" as eventTime nodrop \| json "sourceIPAddress" as srcDevice\_ip nodrop \| json "eventSource" as event\_source nodrop<br />\| json "requestParameters.groupName" as groupName nodrop \| json "requestParameters.userName" as dest\_user nodrop<br />\| where recipient\_acc\_id matches "{{aws\_account}}" and aws\_region matches "{{aws\_region}}"<br />\| where event\_name in ("AddUserToGroup", "RemoveUserFromGroup") and event\_source="iam.amazonaws.com"<br />\| timeslice 15m<br />\| count as eventCount by \_timeslice<br />\| fillmissing timeslice (15m)<br />\| sort \_timeslice|

