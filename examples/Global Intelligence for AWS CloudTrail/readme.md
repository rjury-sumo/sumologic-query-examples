# Global Intelligence for AWS CloudTrail

## Searches

### Log Searches

- **Aggregate Event Count to Main Index**: from Search: Global Intelligence for AWS CloudTrail/Notable Event Count Queries/Aggregate Event Count to Main Index 
- **Attack Surface: Create,Delete,Update**: from Search: Global Intelligence for AWS CloudTrail/Attack Surface Queries/Attack Surface: Create,Delete,Update 
- **Attack Surface: EC2,Redshift,S3**: from Search: Global Intelligence for AWS CloudTrail/Attack Surface Queries/Attack Surface: EC2,Redshift,S3 
- **Attack Surface: IAM,KMS,Lambda,RDS**: from Search: Global Intelligence for AWS CloudTrail/Attack Surface Queries/Attack Surface: IAM,KMS,Lambda,RDS 
- **Attack Surface: Service**: from Search: Global Intelligence for AWS CloudTrail/Attack Surface Queries/Attack Surface: Service 
- **CloudTrail_DisableEvents,EncryptWithNewKey_CountEventResources**: from Search: Global Intelligence for AWS CloudTrail/Event Resource Count Queries/CloudTrail_DisableEvents,EncryptWithNewKey_CountEventResources 
- **CloudTrail_DisableGlobalEventsOrDisableLogOrEncryptWithNewKey**: from Search: Global Intelligence for AWS CloudTrail/Notable Event Count Queries/CloudTrail_DisableGlobalEventsOrDisableLogOrEncryptWithNewKey 
- **CloudTrail_DisableTrails**: from Search: Global Intelligence for AWS CloudTrail/Notable Event Count Queries/CloudTrail_DisableTrails 
- **EC2_AuthorizeSecurityGroupIngressToPublic_CountEventResources**: from Search: Global Intelligence for AWS CloudTrail/Event Resource Count Queries/EC2_AuthorizeSecurityGroupIngressToPublic_CountEventResources 
- **EC2_DescribeInstanceUserData**: from Search: Global Intelligence for AWS CloudTrail/Notable Event Count Queries/EC2_DescribeInstanceUserData 
- **EC2_DescribeInstanceUserData_CountEventResources**: from Search: Global Intelligence for AWS CloudTrail/Event Resource Count Queries/EC2_DescribeInstanceUserData_CountEventResources 
- **EC2_DisableterminationprotectionOrListInstances_CountEventResources**: from Search: Global Intelligence for AWS CloudTrail/Event Resource Count Queries/EC2_DisableterminationprotectionOrListInstances_CountEventResources 
- **EC2_Events**: from Search: Global Intelligence for AWS CloudTrail/Notable Event Count Queries/EC2_Events 
- **EC2_ListSecurityGroupsOrSecurityGroups_CountEventResources**: from Search: Global Intelligence for AWS CloudTrail/Event Resource Count Queries/EC2_ListSecurityGroupsOrSecurityGroups_CountEventResources 
- **EC2_TrafficMirroringOrDescribeRouteTables_CountEventResources**: from Search: Global Intelligence for AWS CloudTrail/Event Resource Count Queries/EC2_TrafficMirroringOrDescribeRouteTables_CountEventResources 
- **Event Priority Computation**: from Search: Global Intelligence for AWS CloudTrail/Event Priority Computation Query/Event Priority Computation 
- **IAM_AddUserToGroup,CompromisedUserOrKeys_CountEventResources**: from Search: Global Intelligence for AWS CloudTrail/Event Resource Count Queries/IAM_AddUserToGroup,CompromisedUserOrKeys_CountEventResources 
- **IAM_AttachPutRoleOrGroupOrUserPolicy_CountEventResources**: from Search: Global Intelligence for AWS CloudTrail/Event Resource Count Queries/IAM_AttachPutRoleOrGroupOrUserPolicy_CountEventResources 
- **IAM_ConsoleLoginsNoMfa**: from Search: Global Intelligence for AWS CloudTrail/Notable Event Count Queries/IAM_ConsoleLoginsNoMfa 
- **IAM_ConsoleLoginsOrNoMfa_CountEventResources**: from Search: Global Intelligence for AWS CloudTrail/Event Resource Count Queries/IAM_ConsoleLoginsOrNoMfa_CountEventResources 
- **IAM_CreateUpdatePolicy_CountEventResources**: from Search: Global Intelligence for AWS CloudTrail/Event Resource Count Queries/IAM_CreateUpdatePolicy_CountEventResources 
- **IAM_Events**: from Search: Global Intelligence for AWS CloudTrail/Notable Event Count Queries/IAM_Events 
- **IAM_TooManyAccessDenied**: from Search: Global Intelligence for AWS CloudTrail/Notable Event Count Queries/IAM_TooManyAccessDenied 
- **IAM_TooManyAccessDenied_CountEventResources**: from Search: Global Intelligence for AWS CloudTrail/Event Resource Count Queries/IAM_TooManyAccessDenied_CountEventResources 
- **IAM_UpdateAssumeRolePolicy_CountEventResources**: from Search: Global Intelligence for AWS CloudTrail/Event Resource Count Queries/IAM_UpdateAssumeRolePolicy_CountEventResources 
- **Lambda_ExcessPermissions_CountEventResources**: from Search: Global Intelligence for AWS CloudTrail/Event Resource Count Queries/Lambda_ExcessPermissions_CountEventResources 
- **Lambda_ExcessPermissionsOrInteractWithIam**: from Search: Global Intelligence for AWS CloudTrail/Notable Event Count Queries/Lambda_ExcessPermissionsOrInteractWithIam 
- **Lambda_InteractWithIam_CountEventResources**: from Search: Global Intelligence for AWS CloudTrail/Event Resource Count Queries/Lambda_InteractWithIam_CountEventResources 
- **RDS_ModifyingAdminPassword**: from Search: Global Intelligence for AWS CloudTrail/Notable Event Count Queries/RDS_ModifyingAdminPassword 
- **RDS_ModifyingAdminPwd,RestoreFromBackup_CountEventResources**: from Search: Global Intelligence for AWS CloudTrail/Event Resource Count Queries/RDS_ModifyingAdminPwd,RestoreFromBackup_CountEventResources 
- **RDS_ModifySecurityGroup_CountEventResources**: from Search: Global Intelligence for AWS CloudTrail/Event Resource Count Queries/RDS_ModifySecurityGroup_CountEventResources 
- **RDS_RestoreFromBackupOrModifySecGroup**: from Search: Global Intelligence for AWS CloudTrail/Notable Event Count Queries/RDS_RestoreFromBackupOrModifySecGroup 
- **Redshift_DisableEncryption**: from Search: Global Intelligence for AWS CloudTrail/Notable Event Count Queries/Redshift_DisableEncryption 
- **Redshift_DisableEncryption,DisableAccessLogging_CountEventResources**: from Search: Global Intelligence for AWS CloudTrail/Event Resource Count Queries/Redshift_DisableEncryption,DisableAccessLogging_CountEventResources 
- **Redshift_DisableSSL_CountEventResources**: from Search: Global Intelligence for AWS CloudTrail/Event Resource Count Queries/Redshift_DisableSSL_CountEventResources 
- **Redshift_DisableSSLOrDisableAccesslogging**: from Search: Global Intelligence for AWS CloudTrail/Notable Event Count Queries/Redshift_DisableSSLOrDisableAccesslogging 
- **S3_AccessDeniedOrBucketConfigChecksFromPublicIp**: from Search: Global Intelligence for AWS CloudTrail/Notable Event Count Queries/S3_AccessDeniedOrBucketConfigChecksFromPublicIp 
- **S3_AccessDeniedOrBucketConfigChecksFromPublicIp_CountEventResources**: from Search: Global Intelligence for AWS CloudTrail/Event Resource Count Queries/S3_AccessDeniedOrBucketConfigChecksFromPublicIp_CountEventResources 
- **S3_CrudBucketsFromPublicIp**: from Search: Global Intelligence for AWS CloudTrail/Notable Event Count Queries/S3_CrudBucketsFromPublicIp 
- **S3_CrudBucketsFromPublicIp_CountEventResources**: from Search: Global Intelligence for AWS CloudTrail/Event Resource Count Queries/S3_CrudBucketsFromPublicIp_CountEventResources 
- **S3_DisableMfaDeleteOrBucketVersionioningOrAccessLogging**: from Search: Global Intelligence for AWS CloudTrail/Notable Event Count Queries/S3_DisableMfaDeleteOrBucketVersionioningOrAccessLogging 
- **S3_DisableMfaDeleteOrBucketVersionioningOrAccessLogging_CountEventResources**: from Search: Global Intelligence for AWS CloudTrail/Event Resource Count Queries/S3_DisableMfaDeleteOrBucketVersionioningOrAccessLogging_CountEventResources 
- **S3_EnablePublicAccess**: from Search: Global Intelligence for AWS CloudTrail/Notable Event Count Queries/S3_EnablePublicAccess 
- **S3_EnablePublicAccess_CountEventResources**: from Search: Global Intelligence for AWS CloudTrail/Event Resource Count Queries/S3_EnablePublicAccess_CountEventResources 
- **S3_ListBuckets**: from Search: Global Intelligence for AWS CloudTrail/Notable Event Count Queries/S3_ListBuckets

### Metric Searches


## Search Table

|app\_topic|search\_name|type|origin|search|
|:--|:--|:--|:--|:--|
|Global Intelligence for AWS CloudTrail/Notable Event Count Queries|Aggregate Event Count to Main Index|Logs|Global Intelligence for AWS CloudTrail/Notable Event Count Queries/Aggregate Event Count to Main Index|\_index=cloudtrail\_analytics\_inc\_v1\_rnd4685946T96PXzbCsyGRaXAZRUmB<br />\| sum(count) as count by benchmarkname<br />\| toInt(count) as count<br />\| "EventCount" as type<br />\| fields benchmarkname, type, count|
||Attack Surface: Create,Delete,Update|Logs|Global Intelligence for AWS CloudTrail/Attack Surface Queries/Attack Surface: Create,Delete,Update|\_sourceCategory = Labs/AWS/CloudTrail eventName<br />\| json "eventName", "errorCode" nodrop <br />\| where isBlank(errorCode) and (<br />    (eventName matches "Modify\*" or eventName matches "Disassociate\*" or eventName matches "Disable\*" or eventName matches "Enable\*" or eventName matches "Detach\*" or eventName matches "Unassign\*" or eventName matches "Revoke\*" or eventName matches "Reset\*" or eventName matches "Update\*" or eventName matches "Put\*" or eventName matches "Add\*" or eventName matches "Remove\*" or eventName matches "Change\*")  <br />or (eventName matches "Create\*") <br />or (eventName matches "Delete\*"))<br />\| "" as classification<br />\| if (eventName matches "Create\*",concat("ResourcesCount\_Create,",classification),classification) as classification<br />\| if (eventName matches "Delete\*",concat("ResourcesCount\_Delete,",classification),classification) as classification<br />\| if (eventName matches "Modify\*" or eventName matches "Disassociate\*" or eventName matches "Disable\*" or eventName matches "Enable\*" or eventName matches "Detach\*" or eventName matches "Unassign\*" or eventName matches "Revoke\*" or eventName matches "Reset\*" or eventName matches "Update\*" or eventName matches "Put\*" or eventName matches "Add\*" or eventName matches "Remove\*" or eventName matches "Change\*",concat("ResourcesCount\_Update,",classification),classification) as classification<br />\| parse regex field=classification "(?\<benchmarkname\>[^,]+)," multi <br />\| "ActionEventCount" as type <br />\| count as count by benchmarkname, type<br />\| fillmissing values("ResourcesCount\_Create","ResourcesCount\_Update","ResourcesCount\_Delete") in benchmarkname, values("ActionEventCount") in type <br />\| toInt(count) as count|
||Attack Surface: EC2,Redshift,S3|Logs|Global Intelligence for AWS CloudTrail/Attack Surface Queries/Attack Surface: EC2,Redshift,S3|\_sourceCategory = Labs/AWS/CloudTrail (instanceId or clusterIdentifier or bucketName)<br />\| json "eventSource", "errorCode" nodrop <br />\| where isBlank(errorCode) and (eventSource="ec2.amazonaws.com"  or eventSource="redshift.amazonaws.com" or eventSource="s3.amazonaws.com")<br />\| parse regex "\\"(?\<objectType\>instanceId\|clusterIdentifier\|bucketName)\\".\*?:.\*?(?\<objectId\>[^\\"]+)\\"" multi <br />\| "" as classification<br />\| if (objectType="instanceId" and eventSource="ec2.amazonaws.com",concat("ResourcesCount\_EC2,",classification),classification) as classification<br />\| if (objectType="clusterIdentifier" and eventSource="redshift.amazonaws.com",concat("ResourcesCount\_Redshift,",classification),classification) as classification<br />\| if (objectType="bucketName" and eventSource="s3.amazonaws.com",concat("ResourcesCount\_S3,",classification),classification) as classification<br />\| parse regex field=classification "(?\<benchmarkname\>[^,]+)," multi <br />\| "ResourceCount" as type <br />\| count\_distinct(objectId) as count by benchmarkName, type<br />\| fillmissing values("ResourcesCount\_EC2","ResourcesCount\_Redshift","ResourcesCount\_S3") in benchmarkname, values("ResourceCount") in type <br />\| toInt(count) as count|
||Attack Surface: IAM,KMS,Lambda,RDS|Logs|Global Intelligence for AWS CloudTrail/Attack Surface Queries/Attack Surface: IAM,KMS,Lambda,RDS|\_sourceCategory = Labs/AWS/CloudTrail (arn:aws:iam or arn:aws:kms  or arn:aws:lambda  or arn:aws:rds)<br />\| json "errorCode" nodrop <br />\| where isBlank(errorCode) <br />\| parse regex "\\"(?\<arn\>arn:[^\\"]+)\\"" multi <br />\| parse regex field=arn ".\*?:.\*?:(?\<service\>[^:]+):.\*?:.\*?:(?\<resource\>[^:]+\$)" <br />\| where service in ("iam","rds","lambda","kms")<br />\| "" as classification<br />\| if (service="iam",concat("ResourcesCount\_IAM,",classification),classification) as classification<br />\| if (service="rds",concat("ResourcesCount\_RDS,",classification),classification) as classification<br />\| if (service="lambda",concat("ResourcesCount\_Lambda,",classification),classification) as classification<br />\| if (service="kms",concat("ResourcesCount\_KMS,",classification),classification) as classification<br />\| parse regex field=classification "(?\<benchmarkname\>[^,]+)," multi <br />\| "ResourceCount" as type <br />\| count\_distinct(arn) as count by benchmarkname,type<br />\| fillmissing values("ResourcesCount\_IAM","ResourcesCount\_KMS","ResourcesCount\_Lambda","ResourcesCount\_RDS") in benchmarkname, values("ResourceCount") in type <br />\| toInt(count) as count|
||Attack Surface: Service|Logs|Global Intelligence for AWS CloudTrail/Attack Surface Queries/Attack Surface: Service|\_sourceCategory = Labs/AWS/CloudTrail <br />\| json "eventSource", "errorCode" nodrop <br />\| where isBlank(errorCode) <br />\| count\_distinct(eventSource) as count <br />\| "ResourcesCount\_Service" as benchmarkname <br />\| "ResourceCount" as type <br />\| fillmissing values("ResourcesCount\_Service") in benchmarkname, values("ResourceCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Event Resource Count Queries|CloudTrail\_DisableEvents,EncryptWithNewKey\_CountEventResources|Logs|Global Intelligence for AWS CloudTrail/Event Resource Count Queries/CloudTrail\_DisableEvents,EncryptWithNewKey\_CountEventResources|\_sourceCategory = Labs/AWS/CloudTrail <br />(includeGlobalServiceEvents  or enableLogFileValidation or StopLogging or kmsKeyId)<br /><br />\| json "eventSource", "eventName", "errorCode" nodrop <br />\| where isBlank(errorCode) and eventSource="cloudtrail.amazonaws.com"  and (eventName="UpdateTrail"  or eventName="StopLogging") <br />\| json "requestParameters.includeGlobalServiceEvents" ,"requestParameters.enableLogFileValidation",  "requestParameters.name", "requestParameters.kmsKeyId" as inclGlobalServiceEvents, disableLogFileValidation, arn, kmsKeyId nodrop<br />\| where (inclGlobalServiceEvents="false" or disableLogFileValidation="false" or eventName="StopLogging" or kmsKeyId="") <br />\| json "requestParameters.name" as name <br />\| "" as classification<br />\| if (inclGlobalServiceEvents="false",concat("CloudTrail\_DisableGlobalEvents\_CountEventResources,",classification),classification) as classification<br />\| if(disableLogFileValidation="false",concat("CloudTrail\_DisableLogIntegrityValidation\_CountEventResources,",classification),classification) as classification<br />\| if(eventName="StopLogging",concat("CloudTrail\_DisableTrails\_CountEventResources,",classification),classification) as classification <br />\| if(kmsKeyId="",concat("CloudTrail\_EncryptWithNewKey\_CountEventResources,",classification),classification) as classification<br />\| parse regex field=classification "(?\<benchmarkname\>[^,]+)," multi <br />\| parse regex field=name "(?\<prefix\>.\*?:.\*?:.\*?:.\*?:.\*?:)?(?\<resource\>[^:]+\$)" <br />\| "EventResourceCount" as type <br />\| count\_distinct(resource) as count by benchmarkname, type<br />\| fillmissing values("CloudTrail\_DisableGlobalEvents\_CountEventResources","CloudTrail\_EncryptWithNewKey\_CountEventResources","CloudTrail\_DisableLogIntegrityValidation\_CountEventResources","CloudTrail\_DisableTrails\_CountEventResources") in benchmarkname, values("EventResourceCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Notable Event Count Queries|CloudTrail\_DisableGlobalEventsOrDisableLogOrEncryptWithNewKey|Logs|Global Intelligence for AWS CloudTrail/Notable Event Count Queries/CloudTrail\_DisableGlobalEventsOrDisableLogOrEncryptWithNewKey|\_sourceCategory = Labs/AWS/CloudTrail (includeGlobalServiceEvents or enableLogFileValidation or kmsKeyId)<br />\| json "eventSource", "eventName", "errorCode" nodrop <br />\| where isBlank(errorCode) and eventName="UpdateTrail" and eventSource="cloudtrail.amazonaws.com" <br />\| json "requestParameters.includeGlobalServiceEvents", "requestParameters.enableLogFileValidation", "requestParameters.kmsKeyId" as inclGlobalServiceEvents, disableLogFileValidation, kmsKeyId nodrop<br />\| "" as classification<br />\| if(inclGlobalServiceEvents matches "false",concat("CloudTrail\_DisableGlobalEvents,",classification),classification) as classification<br />\| if(disableLogFileValidation matches "false",concat("CloudTrail\_DisableLogIntegrityValidation,",classification ),classification) as classification<br />\| if(\_raw matches "\*kmsKeyId\*" and isBlank(kmsKeyId),concat("CloudTrail\_EncryptWithNewKey,",classification ),classification) as classification<br />\| if(!isBlank(classification), 1, 0) as indicator<br />\| parse regex field=classification "(?\<benchmarkname\>[^,]+)," multi<br />\| "EventCount" as type<br />\| sum(indicator) as count by benchmarkname, type<br />\| fillmissing values("CloudTrail\_DisableGlobalEvents","CloudTrail\_DisableLogIntegrityValidation","CloudTrail\_EncryptWithNewKey") in benchmarkname, values("EventCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Notable Event Count Queries|CloudTrail\_DisableTrails|Logs|Global Intelligence for AWS CloudTrail/Notable Event Count Queries/CloudTrail\_DisableTrails|\_sourceCategory = Labs/AWS/CloudTrail StopLogging <br />\| json "eventName", "errorCode" nodrop <br />\| where isBlank(errorCode) and eventName="StopLogging" <br />\| count as count <br />\| "CloudTrail\_DisableTrails" as benchmarkname <br />\| "EventCount" as type <br />\| fillmissing values("CloudTrail\_DisableTrails") in benchmarkname, values("EventCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Event Resource Count Queries|EC2\_AuthorizeSecurityGroupIngressToPublic\_CountEventResources|Logs|Global Intelligence for AWS CloudTrail/Event Resource Count Queries/EC2\_AuthorizeSecurityGroupIngressToPublic\_CountEventResources|\_sourceCategory = Labs/AWS/CloudTrail AuthorizeSecurityGroupIngress <br />\| json "eventSource", "eventName", "errorCode" nodrop <br />\| where eventSource="ec2.amazonaws.com" and eventName="AuthorizeSecurityGroupIngress" and isBlank(errorCode) <br />\| json "requestParameters.ipPermissions.items[\*]" as listIpPermissions <br />\| parse regex field=listIpPermissions "\\"cidrIp\\"\\s\*:\\s\*\\"(?\<cirdrIp\>[^\\"]+)\\"" multi <br />\| parse regex field=listIpPermissions "\\"ipProtocol\\"\\s\*:\\s\*\\"(?\<ipProtocol\>[^\\"]+)\\"" multi <br />\| where cirdrIp="0.0.0.0\\\\/0" and toString(ipProtocol)="-1" <br />\| json "requestParameters.groupId" as groupId <br />\| count\_distinct(groupId) as count <br />\| "EC2\_AuthorizeSecurityGroupIngressToPublic\_CountEventResources" as benchmarkname <br />\| "EventResourceCount" as type <br />\| fillmissing values("EC2\_AuthorizeSecurityGroupIngressToPublic\_CountEventResources") in benchmarkname, values("EventResourceCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Notable Event Count Queries|EC2\_DescribeInstanceUserData|Logs|Global Intelligence for AWS CloudTrail/Notable Event Count Queries/EC2\_DescribeInstanceUserData|\_sourceCategory = Labs/AWS/CloudTrail DescribeInstanceAttribute <br />\| json "eventSource", "eventName", "errorCode", "requestParameters.attribute" as eventSource, eventName, errorCode, requestedAttribute nodrop <br />\| where eventSource="ec2.amazonaws.com" and eventName="DescribeInstanceAttribute" and isBlank(errorCode) <br />\| if((requestedAttribute="userData"),1,0) as userDataRequestEvent <br />\| sum(userDataRequestEvent) as count <br />\| "EC2\_DescribeInstanceUserData" as benchmarkname <br />\| "EventCount" as type <br />\| fillmissing values("EC2\_DescribeInstanceUserData") in benchmarkname, values("EventCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Event Resource Count Queries|EC2\_DescribeInstanceUserData\_CountEventResources|Logs|Global Intelligence for AWS CloudTrail/Event Resource Count Queries/EC2\_DescribeInstanceUserData\_CountEventResources|\_sourceCategory = Labs/AWS/CloudTrail DescribeInstanceAttribute <br />\| json "eventSource", "eventName", "errorCode", "requestParameters.attribute", "requestParameters.instanceId" as eventSource, eventName, errorCode, requestedAttribute, requestedInstance nodrop <br />\| where eventSource="ec2.amazonaws.com" and eventName="DescribeInstanceAttribute" and isBlank(errorCode) and requestedAttribute="userData" <br />\| count\_distinct(requestedInstance) as count <br />\| "EC2\_DescribeInstanceUserData\_CountEventResources" as benchmarkname <br />\| "EventResourceCount" as type <br />\| fillmissing values("EC2\_DescribeInstanceUserData\_CountEventResources") in benchmarkname, values("EventResourceCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Event Resource Count Queries|EC2\_DisableterminationprotectionOrListInstances\_CountEventResources|Logs|Global Intelligence for AWS CloudTrail/Event Resource Count Queries/EC2\_DisableterminationprotectionOrListInstances\_CountEventResources|\_sourceCategory = Labs/AWS/CloudTrail (ModifyInstanceAttribute or DescribeInstances )<br />\| json "eventSource", "eventName", "errorCode" nodrop <br />\| where eventSource="ec2.amazonaws.com" and (eventName="ModifyInstanceAttribute" or eventName="DescribeInstances") and isBlank(errorCode) <br />\| json "requestParameters.attribute", "requestParameters.value" as attribute, val nodrop<br />\| "" as classification<br />\| if(eventName ="ModifyInstanceAttribute" and attribute="disableApiTermination" and val="true",concat("EC2\_Disableterminationprotection\_CountEventResources,",classification),classification) as classification<br />\| if(eventName ="DescribeInstances",concat("EC2\_ListInstances\_CountEventResources,",classification),classification) as classification<br />\| parse regex field=classification "(?\<benchmarkname\>[^,]+)," multi <br />\| parse regex "\\"instanceId\\"\\s\*:\\s\*\\"(?\<instanceId\>[^\\"]+)\\"" multi <br />\| "EventResourceCount" as type <br />\| count\_distinct(instanceId) as count by benchmarkname , type<br />\| fillmissing values("EC2\_Disableterminationprotection\_CountEventResources","EC2\_ListInstances\_CountEventResources") in benchmarkname, values("EventResourceCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Notable Event Count Queries|EC2\_Events|Logs|Global Intelligence for AWS CloudTrail/Notable Event Count Queries/EC2\_Events|\_sourceCategory = Labs/AWS/CloudTrail (DescribeInstanceAttribute or ModifyInstanceAttribute or DescribeRouteTables or (AuthorizeSecurityGroupIngress and "0.0.0.0\\\\/0") or DescribeImages or DescribeInstances or DescribeSecurityGroups or CreateTraffic\*)<br />\| json "eventSource", "eventName", "errorCode", "requestParameters.ipPermissions.items[\*]","requestParameters.attribute", "requestParameters.value" as eventSource, eventName, errorCode, listIpPermissions, attribute, val nodrop <br />\| where eventSource="ec2.amazonaws.com" and isBlank(errorCode) and eventName in ("AuthorizeSecurityGroupIngress","ModifyInstanceAttribute","DescribeRouteTables","DescribeImages", "DescribeInstances","DescribeSecurityGroups","CreateTrafficMirrorTarget", "CreateTrafficMirrorSession", "CreateTrafficMirrorFilter", "CreateTrafficMirrorFilterRule")  <br />\| parse regex field=listIpPermissions "\\"cidrIp\\".\*?:.\*?(?\<cirdrIp\>[^\\"]+)\\"" multi nodrop<br />\| parse regex field=listIpPermissions "\\"ipProtocol\\".\*?:.\*?(?\<ipProtocol\>[^\\"]+)\\"" multi nodrop<br />\| "" as classification<br />\| if(eventName = "ModifyInstanceAttribute" and attribute="disableApiTermination" and val="true",concat("EC2\_Disableterminationprotection,",classification),classification) as classification<br />\| if(eventName = "DescribeRouteTables",concat("EC2\_DescribeRouteTables,",classification),classification) as classification<br />\| if(eventName = "AuthorizeSecurityGroupIngress" and cirdrIp="0.0.0.0\\\\/0" and toString(ipProtocol)="-1" ,concat("EC2\_AuthorizeSecurityGroupIngressToPublic,",classification),classification) as classification<br />\| if(eventName = "DescribeImages",concat("EC2\_ListAMIs,",classification),classification) as classification<br />\| if(eventName = "DescribeInstances",concat("EC2\_ListInstances,",classification),classification) as classification<br />\| if(eventName = "DescribeSecurityGroups",concat("EC2\_ListSecurityGroups,",classification),classification) as classification<br />\| if(eventName in ("CreateTrafficMirrorTarget", "CreateTrafficMirrorSession", "CreateTrafficMirrorFilter", "CreateTrafficMirrorFilterRule"),concat("EC2\_TrafficMirroring,",classification),classification) as classification<br />\| parse regex field=classification "(?\<benchmarkname\>[^,]+)," multi <br />\| "EventCount" as type <br />\| count as count by benchmarkname,type<br />\| fillmissing values("EC2\_Disableterminationprotection","EC2\_DescribeRouteTables", "EC2\_AuthorizeSecurityGroupIngressToPublic","EC2\_ListAMIs","EC2\_ListInstances","EC2\_ListSecurityGroups","EC2\_TrafficMirroring") in benchmarkname, values("EventCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Event Resource Count Queries|EC2\_ListSecurityGroupsOrSecurityGroups\_CountEventResources|Logs|Global Intelligence for AWS CloudTrail/Event Resource Count Queries/EC2\_ListSecurityGroupsOrSecurityGroups\_CountEventResources|\_sourceCategory = Labs/AWS/CloudTrail (DescribeSecurityGroups or DescribeImages)<br />\| json "eventSource", "eventName", "errorCode" nodrop <br />\| where eventSource="ec2.amazonaws.com" and (eventName="DescribeSecurityGroups" or eventName="DescribeImages") and isBlank(errorCode) <br />\| "" as classification<br />\| if(eventName ="DescribeSecurityGroups" ,concat("EC2\_ListSecurityGroups\_CountEventResources,",classification),classification) as classification<br />\| if(eventName ="DescribeImages",concat("EC2\_ListAMIs\_CountEventResources,",classification),classification) as classification<br />\| parse regex field=classification "(?\<benchmarkname\>[^,]+)," multi <br />\| parse regex "\\"groupId\\"\\s\*:\\s\*\\"(?\<objectId\>[^\\"]+)\\"" multi nodrop<br />\| parse regex "\\"imageId\\"\\s\*:\\s\*\\"(?\<objectId\>[^\\"]+)\\"" multi nodrop<br />\| where !isBlank(objectId)<br />\| "EventResourceCount" as type <br />\| count\_distinct(objectId) as count by benchmarkname, type<br />\| fillmissing values("EC2\_ListSecurityGroups\_CountEventResources","EC2\_ListAMIs\_CountEventResources") in benchmarkname, values("EventResourceCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Event Resource Count Queries|EC2\_TrafficMirroringOrDescribeRouteTables\_CountEventResources|Logs|Global Intelligence for AWS CloudTrail/Event Resource Count Queries/EC2\_TrafficMirroringOrDescribeRouteTables\_CountEventResources|\_sourceCategory = Labs/AWS/CloudTrail ( CreateTraffic\* or DescribeRouteTables)<br />\| json "eventSource", "eventName", "errorCode" nodrop <br />\| where eventSource="ec2.amazonaws.com" and eventName in ("CreateTrafficMirrorTarget", "CreateTrafficMirrorSession", "CreateTrafficMirrorFilter", "CreateTrafficMirrorFilterRule","DescribeRouteTables") and isBlank(errorCode) <br />\| if(\_raw matches /requestParameters.\*?NetworkInterfaceId/,1,0) as hasNetworkInterface <br />\| if(\_raw matches /requestParameters.\*?TrafficMirrorFilterId/,1,0) as hasTrafficMirrorFilterId <br />//\| where hasNetworkInterface \> 0 or hasTrafficMirrorFilterId \> 0 <br />\| "" as classification<br />\| if (eventName in ("CreateTrafficMirrorTarget", "CreateTrafficMirrorSession", "CreateTrafficMirrorFilter", "CreateTrafficMirrorFilterRule") and (hasNetworkInterface \> 0 or hasTrafficMirrorFilterId \> 0),concat("EC2\_TrafficMirroring\_CountEventResources,",classification),classification) as classification<br />\| if(eventName ="DescribeRouteTables",concat("EC2\_DescribeRouteTables\_CountEventResources,",classification),classification) as classification<br />\| parse regex field=classification "(?\<benchmarkname\>[^,]+)," multi <br />\| parse regex "\\"NetworkInterfaceId\\"\\s\*:\\s\*\\"(?\<resource\>[^\\"]+)\\"" multi nodrop <br />\| parse regex "\\"hasTrafficMirrorFilterId\\"\\s\*:\\s\*\\"(?\<resource\>[^\\"]+)\\"" multi nodrop <br />\| parse regex "\\"routeTableId\\"\\s\*:\\s\*\\"(?\<resource\>[^\\"]+)\\"" multi nodrop<br />\| "EventResourceCount" as type <br />\| where !isblank(resource)<br />\| count\_distinct(resource) as count by benchmarkname, type<br />\| fillmissing values("EC2\_TrafficMirroring\_CountEventResources","EC2\_DescribeRouteTables\_CountEventResources") in benchmarkname, values("EventResourceCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Event Priority Computation Query|Event Priority Computation|Logs|Global Intelligence for AWS CloudTrail/Event Priority Computation Query/Event Priority Computation|\_index=cloudtrail\_analytics\_v1\_rnd4685946Wbczy2GDgJ2dKUvO2fFD<br />\| where type in ("EventCount", "EventResourceCount")<br />\| withtime count \| most\_recent(count\_withtime) as count by benchmarkname \| toInt(count) as count<br />\| join (parse field=benchmarkname "\*\_CountEventResources" as event) as event1, (benchmarkname as event) as event2 on event1.event = event2.event<br />\| event1\_benchmarkname as benchmarkname \| event1\_count as resourceCount \| event2\_count as eventCount<br />\| infer \_category=cloudtrail \_model=benchmark<br />\| median as resourceCountBaseline<br />\| toInt(resourceCountBaseline) as resourceCountBaseline<br /><br />\| event2\_benchmarkname as benchmarkname<br />\| fields benchmarkname, eventcount, resourcecount, resourcecountbaseline<br />\| infer \_category=cloudtrail \_model=benchmark<br />\| median as eventcountbaseline<br />\| toInt(eventcountbaseline) as eventcountbaseline<br /><br />\| (eventCount - eventCountBaseline) as eventCount\_difference \| if (eventCount\_difference \< 0, 0, eventCount\_difference) as eventCount\_difference<br />\| eventCount\_difference \* resourceCount as deviation<br />\| sort by deviation<br />\| parse field=benchmarkname "\*\_\*" as resourceType, eventName<br />\| 1 as idx \| accum idx as priority<br />\| fields eventName, eventCount, resourceCount, eventCountBaseline, resourceCountBaseline, priority<br />\| save /shared/CloudTrailGIS/EventPriority|
|Global Intelligence for AWS CloudTrail/Event Resource Count Queries|IAM\_AddUserToGroup,CompromisedUserOrKeys\_CountEventResources|Logs|Global Intelligence for AWS CloudTrail/Event Resource Count Queries/IAM\_AddUserToGroup,CompromisedUserOrKeys\_CountEventResources|\_sourceCategory = Labs/AWS/CloudTrail ( AddUser\*  or "CreateAccessKey" or "CreateLoginProfile" or "UpdateLoginProfile" ) iam.amazonaws.com<br />\| json "eventSource", "eventName", "errorCode", "requestParameters" nodrop <br />\| where eventName in ("AddUserToGroup", "AddUsersToGroup","CreateAccessKey", "CreateLoginProfile", "UpdateLoginProfile") and isBlank(errorCode) and eventSource="iam.amazonaws.com" <br />\| "" as classification<br />\| if (eventName in ("AddUserToGroup", "AddUsersToGroup"),concat("IAM\_AddUserToGroup\_CountEventResources,",classification),classification) as classification<br />\| if (eventName in ("CreateAccessKey", "CreateLoginProfile", "UpdateLoginProfile"),concat("IAM\_CompromisedUserOrKeys\_CountEventResources,",classification),classification) as classification<br />\| parse regex field=classification "(?\<benchmarkname\>[^,]+)," multi <br />\| parse regex field=requestparameters "\\"userName\\"\\s\*:\\s\*\\"(?\<userName\>[^\\"]+)\\"" multi <br />\| "EventResourceCount" as type <br />\| count\_distinct(userName) as count by benchmarkname,type <br />\| fillmissing values("IAM\_AddUserToGroup\_CountEventResources","IAM\_CompromisedUserOrKeys\_CountEventResources") in benchmarkname, values("EventResourceCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Event Resource Count Queries|IAM\_AttachPutRoleOrGroupOrUserPolicy\_CountEventResources|Logs|Global Intelligence for AWS CloudTrail/Event Resource Count Queries/IAM\_AttachPutRoleOrGroupOrUserPolicy\_CountEventResources|\_sourceCategory = Labs/AWS/CloudTrail \*GroupPolicy or \*RolePolicy or \*UserPolicy<br />\| json "eventSource", "eventName", "errorCode" nodrop <br />\| where eventName in ("AttachRolePolicy", "PutRolePolicy","AttachGroupPolicy", "PutGroupPolicy","AttachUserPolicy", "PutUserPolicy") and isBlank(errorCode) and eventSource="iam.amazonaws.com" <br />\| json "requestParameters.policyArn", "requestParameters.policyName" as policyArn, policyName nodrop <br />\| parse regex field=policyArn ".\*?:.\*?:.\*?:.\*?:.\*?:policy/(?\<resourceName\>.\*)" nodrop <br />\| "" as classification<br />\| if (eventName in ("AttachRolePolicy", "PutRolePolicy"),concat("IAM\_AttachPutRolePolicy\_CountEventResources,",classification),classification) as classification<br />\| if (eventName in ("AttachGroupPolicy", "PutGroupPolicy"),concat("IAM\_AttachPutGroupPolicy\_CountEventResources,",classification),classification) as classification<br />\| if (eventName in ("AttachUserPolicy", "PutUserPolicy"),concat("IAM\_AttachPutUserPolicy\_CountEventResources,",classification),classification) as classification<br />\| parse regex field=classification "(?\<benchmarkname\>[^,]+)," multi <br />\| concat(resourceName, policyName) as policyId <br />\| where !isBlank(policyId) and !isBlank(policyArn)<br />\| "EventResourceCount" as type <br />\| count\_distinct(policyId) as count by benchmarkname, type<br />\| fillmissing values("IAM\_AttachPutRolePolicy\_CountEventResources","IAM\_AttachPutGroupPolicy\_CountEventResources","IAM\_AttachPutUserPolicy\_CountEventResources") in benchmarkname, values("EventResourceCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Notable Event Count Queries|IAM\_ConsoleLoginsNoMfa|Logs|Global Intelligence for AWS CloudTrail/Notable Event Count Queries/IAM\_ConsoleLoginsNoMfa|\_sourceCategory = Labs/AWS/CloudTrail MFAUsed <br />\| json "eventName", "errorCode", "additionalEventData.MFAUsed" as eventName, errorCode, MFAUsed nodrop <br />\| where isBlank(errorCode) and eventName="ConsoleLogin" <br />\| if(MFAUsed="No",1,0) as NotAuth <br />\| sum(NotAuth) as count <br />\| "IAM\_ConsoleLoginsNoMfa" as benchmarkname <br />\| "EventCount" as type <br />\| fillmissing values("IAM\_ConsoleLoginsNoMfa") in benchmarkname, values("EventCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Event Resource Count Queries|IAM\_ConsoleLoginsOrNoMfa\_CountEventResources|Logs|Global Intelligence for AWS CloudTrail/Event Resource Count Queries/IAM\_ConsoleLoginsOrNoMfa\_CountEventResources|\_sourceCategory = Labs/AWS/CloudTrail (ConsoleLogin or MFAUsed )<br />\| json "eventName", "errorCode", "additionalEventData.MFAUsed" as eventName, errorCode, MFAUsed nodrop<br />\| where isBlank(errorCode) and eventName="ConsoleLogin" <br />\| json "userIdentity.arn" as arn <br />\| where !isBlank(arn)<br />\| "" as classification<br />\| if (eventName="ConsoleLogin",concat("IAM\_TotalConsoleLogins\_CountEventResources,",classification),classification) as classification<br />\| if(eventName="ConsoleLogin" and MFAUsed="No",concat("IAM\_ConsoleLoginsNoMfa\_CountEventResources,",classification),classification) as classification<br />\| parse regex field=classification "(?\<benchmarkname\>[^,]+)," multi <br />\| count\_distinct(arn) as count by benchmarkname, type<br />\| "EventResourceCount" as type <br />\| fillmissing values("IAM\_TotalConsoleLogins\_CountEventResources","IAM\_ConsoleLoginsNoMfa\_CountEventResources") in benchmarkname, values("EventResourceCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Event Resource Count Queries|IAM\_CreateUpdatePolicy\_CountEventResources|Logs|Global Intelligence for AWS CloudTrail/Event Resource Count Queries/IAM\_CreateUpdatePolicy\_CountEventResources|\_sourceCategory = Labs/AWS/CloudTrail \*Policy\* <br />\| json "eventSource", "eventName", "errorCode" nodrop <br />\| where eventName in ("SetDefaultPolicyVersion" , "CreatePolicy", "CreatePolicyVersion") and isBlank(errorCode) and eventSource="iam.amazonaws.com" <br />\| parse regex "[vV]ersionId\\"\\s\*:\\s\*\\"(?\<version\>[^\\"]+)\\"" <br />\| parse regex "\\"(?\<arn\>arn:[^\\"]+)\\"" multi <br />\| parse regex field=arn ".\*?:.\*?:.\*?:.\*?:.\*?:(?\<resource\>[^:]+\$)" multi <br />\| where resource matches "policy\*" <br />\| concat(arn, version) as policyId <br />\| count\_distinct(policyId) as count <br />\| "IAM\_CreateUpdatePolicy\_CountEventResources" as benchmarkname <br />\| "EventResourceCount" as type <br />\| fillmissing values("IAM\_CreateUpdatePolicy\_CountEventResources") in benchmarkname, values("EventResourceCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Notable Event Count Queries|IAM\_Events|Logs|Global Intelligence for AWS CloudTrail/Notable Event Count Queries/IAM\_Events|\_sourceCategory = Labs/AWS/CloudTrail (\*UserPolicy or \*RolePolicy or \*GroupPolicy or AddUser\* or \*LoginProfile or CreateAccessKey or SetDefaultPolicyVersion or CreatePolicy\* or HIDDEN\_DUE\_TO\_SECURITY\_REASONS or ConsoleLogin or UpdateAssumeRolePolicy)<br />\| json "eventSource", "eventName", "errorCode","userIdentity.userName", "responseElements.ConsoleLogin" as eventSource, eventName, errorCode,userName, loginStatus nodrop <br />\| where (eventName in ("AttachUserPolicy", "PutUserPolicy","AttachRolePolicy", "PutRolePolicy","AttachGroupPolicy", "PutGroupPolicy","AddUserToGroup", "AddUsersToGroup","CreateAccessKey", "CreateLoginProfile", "UpdateLoginProfile","SetDefaultPolicyVersion" , "CreatePolicy", "CreatePolicyVersion", "UpdateAssumeRolePolicy") and isBlank(errorCode) and eventSource= "iam.amazonaws.com" ) or (userName = "HIDDEN\_DUE\_TO\_SECURITY\_REASONS") or (eventName = "ConsoleLogin" and isBlank(errorCode))<br />\| "" as classification<br />\| if(eventName in ("AttachUserPolicy", "PutUserPolicy"),concat("IAM\_AttachPutUserPolicy,",classification),classification) as classification<br />\| if(eventName in ("AttachRolePolicy", "PutRolePolicy"),concat("IAM\_AttachPutRolePolicy,",classification),classification) as classification<br />\| if(eventName in ("AttachGroupPolicy", "PutGroupPolicy"),concat("IAM\_AttachPutGroupPolicy,",classification),classification) as classification<br />\| if(eventName in ("AddUserToGroup", "AddUsersToGroup"),concat("IAM\_AddUserToGroup,",classification),classification) as classification<br />\| if(eventName in ("CreateAccessKey", "CreateLoginProfile", "UpdateLoginProfile"),concat("IAM\_CompromisedUserOrKeys,",classification),classification) as classification<br />\| if(eventName in ("SetDefaultPolicyVersion" , "CreatePolicy", "CreatePolicyVersion"),concat("IAM\_CreateUpdatePolicy,",classification),classification) as classification<br />\| if(userName="HIDDEN\_DUE\_TO\_SECURITY\_REASONS" and loginStatus="Failure",concat("IAM\_ConsoleLoginFailureWithHiddenResponse,",classification),classification) as classification<br />\| if(eventName="ConsoleLogin",concat("IAM\_TotalConsoleLogins,",classification),classification) as classification<br />\| if(eventName="UpdateAssumeRolePolicy",concat("IAM\_UpdateAssumeRolePolicy,",classification),classification) as classification<br />\| parse regex field=classification "(?\<benchmarkname\>[^,]+)," multi <br />\| "EventCount" as type <br />\| count as count by benchmarkname,type<br />\| fillmissing values("IAM\_AttachPutUserPolicy","IAM\_AttachPutRolePolicy","IAM\_AttachPutGroupPolicy","IAM\_AddUserToGroup","IAM\_CompromisedUserOrKeys","IAM\_CreateUpdatePolicy","IAM\_ConsoleLoginFailureWithHiddenResponse","IAM\_TotalConsoleLogins","IAM\_UpdateAssumeRolePolicy") in benchmarkname, values("EventCount") in type <br />\| toInt(count) as count<br />|
|Global Intelligence for AWS CloudTrail/Notable Event Count Queries|IAM\_TooManyAccessDenied|Logs|Global Intelligence for AWS CloudTrail/Notable Event Count Queries/IAM\_TooManyAccessDenied|\_sourceCategory = Labs/AWS/CloudTrail AccessDenied <br />\| json "eventName", "eventSource", "errorCode", "sourceIPAddress", "userIdentity.type", "userIdentity.userName" as eventName, eventSource, errorCode, sourceIPAddress, userType, userName <br />\| where errorCode="AccessDenied" <br />\| count as failures, count\_distinct(eventName) as methods, count\_distinct(eventSource) as sources by userType, userName, eventSource, errorCode, sourceIPAddress <br />\| where failures \> 5 and methods \> 1 and sources \> 1 <br />\| count as count <br />\| "IAM\_TooManyAccessDenied" as benchmarkname <br />\| "EventCount" as type <br />\| fillmissing values("IAM\_TooManyAccessDenied") in benchmarkname, values("EventCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Event Resource Count Queries|IAM\_TooManyAccessDenied\_CountEventResources|Logs|Global Intelligence for AWS CloudTrail/Event Resource Count Queries/IAM\_TooManyAccessDenied\_CountEventResources|\_sourceCategory = Labs/AWS/CloudTrail AccessDenied <br />\| json "eventName", "eventSource", "errorCode", "sourceIPAddress", "userIdentity.type", "userIdentity.userName" as eventName, eventSource, errorCode, sourceIPAddress, userType, userName <br />\| where errorCode="AccessDenied" <br />\| count as failures, count\_distinct(eventName) as methods, count\_distinct(eventSource) as sources by userType, userName, eventSource, errorCode, sourceIPAddress <br />\| where failures \> 5 and methods \> 1 and sources \> 1 <br />\| count\_distinct(username) as count <br />\| "IAM\_TooManyAccessDenied\_CountEventResources" as benchmarkname <br />\| "EventResourceCount" as type <br />\| fillmissing values("IAM\_TooManyAccessDenied\_CountEventResources") in benchmarkname, values("EventResourceCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Event Resource Count Queries|IAM\_UpdateAssumeRolePolicy\_CountEventResources|Logs|Global Intelligence for AWS CloudTrail/Event Resource Count Queries/IAM\_UpdateAssumeRolePolicy\_CountEventResources|\_sourceCategory = Labs/AWS/CloudTrail UpdateAssumeRolePolicy <br />\| json "eventSource", "eventName", "errorCode" nodrop <br />\| where eventName="UpdateAssumeRolePolicy" and isBlank(errorCode) and eventSource="iam.amazonaws.com" <br />\| json "requestParameters.roleName" as roleName <br />\| count\_distinct(roleName) as count <br />\| "IAM\_UpdateAssumeRolePolicy\_CountEventResources" as benchmarkname <br />\| "EventResourceCount" as type <br />\| fillmissing values("IAM\_UpdateAssumeRolePolicy\_CountEventResources") in benchmarkname, values("EventResourceCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Event Resource Count Queries|Lambda\_ExcessPermissions\_CountEventResources|Logs|Global Intelligence for AWS CloudTrail/Event Resource Count Queries/Lambda\_ExcessPermissions\_CountEventResources|\_sourceCategory = Labs/AWS/CloudTrail lambda.amazonaws.com <br />\| json "eventSource", "eventName", "errorCode", "userIdentity.type" as eventSource, eventName, errorCode, userType nodrop <br />\| where userType="IAMUser" and isBlank(errorCode) and eventSource="lambda.amazonaws.com" and (eventName matches "CreateFunction\*" or eventName matches "Invoke\*" or eventName matches "CreateEventSourceMapping\*" or eventName matches "UpdateFunctionCode\*" or eventName matches "UpdateFunctionConfiguration\*") <br />\| json "requestParameters.functionName" as functionName <br />\| parse regex field=functionName "(?\<prefix\>.\*?:.\*?:.\*?:.\*?:.\*?:)?(?\<resource\>[^:]+\$)" <br />\| count\_distinct(resource) as count <br />\| "Lambda\_ExcessPermissions\_CountEventResources" as benchmarkname <br />\| "EventResourceCount" as type <br />\| fillmissing values("Lambda\_ExcessPermissions\_CountEventResources") in benchmarkname, values("EventResourceCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Notable Event Count Queries|Lambda\_ExcessPermissionsOrInteractWithIam|Logs|Global Intelligence for AWS CloudTrail/Notable Event Count Queries/Lambda\_ExcessPermissionsOrInteractWithIam|\_sourceCategory = Labs/AWS/CloudTrail lambda.amazonaws.com <br />\| json "eventSource", "eventName", "errorCode", "userIdentity.type", "userIdentity.invokedBy" as eventSource, eventName, errorCode, userType, service nodrop <br />\| where isBlank(errorCode) and (userType="IAMUser" and eventSource="lambda.amazonaws.com" and (eventName matches "CreateFunction\*" or eventName matches "Invoke\*" or eventName matches "CreateEventSourceMapping\*" or eventName matches "UpdateFunctionCode\*" or eventName matches "UpdateFunctionConfiguration\*") or (service="lambda.amazonaws.com" and userType="IAMUser"))<br />\| "" as classification<br />\| if (service="lambda.amazonaws.com",concat("Lambda\_InteractWithIam,",classification),classification) as classification<br />\| if(eventSource="lambda.amazonaws.com",concat("Lambda\_ExcessPermissions,",classification),classification) as classification<br />\| parse regex field=classification "(?\<benchmarkname\>[^,]+)," multi <br />\| "EventCount" as type <br />\| count as count by benchmarkname, type<br />\| fillmissing values("Lambda\_ExcessPermissions","Lambda\_InteractWithIam") in benchmarkname, values("EventCount") in type <br />\| toInt(count) as count<br />|
|Global Intelligence for AWS CloudTrail/Event Resource Count Queries|Lambda\_InteractWithIam\_CountEventResources|Logs|Global Intelligence for AWS CloudTrail/Event Resource Count Queries/Lambda\_InteractWithIam\_CountEventResources|\_sourceCategory = Labs/AWS/CloudTrail lambda.amazonaws.com <br />\| json "userIdentity.type", "userIdentity.invokedBy", "errorCode" as userType, service, errorCode nodrop <br />\| where service="lambda.amazonaws.com" and isBlank(errorCode) and !isBlank(service) and userType="IAMUser" <br />\| parse regex "\\"(?\<arn\>arn:[^\\"]+)\\"" multi <br />\| parse regex field=arn ".\*?:.\*?:(?\<service\>[^:]+):.\*?:.\*?:(?\<resource\>[^:]+\$)" <br />\| where service="lambda" <br />\| where !isBlank(resource) <br />\| count\_distinct(resource) as count <br />\| "Lambda\_InteractWithIam\_CountEventResources" as benchmarkname <br />\| "EventResourceCount" as type <br />\| fillmissing values("Lambda\_InteractWithIam\_CountEventResources") in benchmarkname, values("EventResourceCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Notable Event Count Queries|RDS\_ModifyingAdminPassword|Logs|Global Intelligence for AWS CloudTrail/Notable Event Count Queries/RDS\_ModifyingAdminPassword|\_sourceCategory = Labs/AWS/CloudTrail ModifyDBInstance <br />\| json "eventSource", "eventName", "errorCode", "responseElements.pendingModifiedValues.masterUserPassword" as eventSource, eventName, errorCode, setPassword nodrop <br />\| where isBlank(errorCode) and eventSource="rds.amazonaws.com" and eventName="ModifyDBInstance" <br />\| if((!isBlank(setPassword)),1,0) as setPasswordEvent <br />\| sum(setPasswordEvent) as count <br />\| "RDS\_ModifyingAdminPassword" as benchmarkname <br />\| "EventCount" as type <br />\| fillmissing values("RDS\_ModifyingAdminPassword") in benchmarkname, values("EventCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Event Resource Count Queries|RDS\_ModifyingAdminPwd,RestoreFromBackup\_CountEventResources|Logs|Global Intelligence for AWS CloudTrail/Event Resource Count Queries/RDS\_ModifyingAdminPwd,RestoreFromBackup\_CountEventResources|\_sourceCategory = Labs/AWS/CloudTrail (ModifyDBInstance or AuthorizeDBSecurityGroupIngress or Restore\*From\*Snapshot)<br />\| json "eventName", "errorCode", "eventSource", "responseElements.pendingModifiedValues.masterUserPassword" as eventName, errorCode, eventSource,setPassword nodrop<br />\| where isBlank(errorCode) and ((eventSource="rds.amazonaws.com" and eventName="ModifyDBInstance") or eventName matches "Restore\*From\*Snapshot" )<br />\| "" as classification<br />\| if (eventSource="rds.amazonaws.com" and eventName="ModifyDBInstance" and !isBlank(setPassword),concat("RDS\_ModifyingAdminPassword\_CountEventResources,",classification),classification) as classification<br />\| if(eventName matches "Restore\*From\*Snapshot",concat("RDS\_RestoreFromBackup\_CountEventResources,",classification),classification) as classification<br />\| parse regex field=classification "(?\<benchmarkname\>[^,]+)," multi <br />\| json "requestParameters.dBInstanceIdentifier" as rdsId <br />\| "EventResourceCount" as type <br />\| count\_distinct(rdsId) as count by benchmarkname, type<br />\| fillmissing values("RDS\_ModifyingAdminPassword\_CountEventResources","RDS\_RestoreFromBackup\_CountEventResources") in benchmarkname, values("EventResourceCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Event Resource Count Queries|RDS\_ModifySecurityGroup\_CountEventResources|Logs|Global Intelligence for AWS CloudTrail/Event Resource Count Queries/RDS\_ModifySecurityGroup\_CountEventResources|\_sourceCategory = Labs/AWS/CloudTrail AuthorizeDBSecurityGroupIngress <br />\| json "eventName", "errorCode" nodrop <br />\| where isBlank(errorCode) and eventName="AuthorizeDBSecurityGroupIngress" <br />\| json "requestParameters.dBSecurityGroupName" as groupName <br />\| parse regex field=groupName "(?\<prefix\>.\*?:.\*?:.\*?:.\*?:.\*?:)?(?\<resource\>[^:]+\$)" <br />\| count\_distinct(resource) as count <br />\| "RDS\_ModifySecurityGroup\_CountEventResources" as benchmarkname <br />\| "EventResourceCount" as type <br />\| fillmissing values("RDS\_ModifySecurityGroup\_CountEventResources") in benchmarkname, values("EventResourceCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Notable Event Count Queries|RDS\_RestoreFromBackupOrModifySecGroup|Logs|Global Intelligence for AWS CloudTrail/Notable Event Count Queries/RDS\_RestoreFromBackupOrModifySecGroup|\_sourceCategory = Labs/AWS/CloudTrail (Restore\*From\*Snapshot or AuthorizeDBSecurityGroupIngress)<br />\| json "eventName", "errorCode" as eventName, errorCode nodrop <br />\| where isBlank(errorCode) <br />\| "" as classification<br />\| if(eventName matches "Restore\*From\*Snapshot",concat("RDS\_RestoreFromBackup,",classification),classification) as classification<br />\| if(eventName matches "AuthorizeDBSecurityGroupIngress",concat("RDS\_ModifySecurityGroup,",classification),classification) as classification<br />\| if(!isBlank(classification), 1, 0) as indicator<br />\| parse regex field=classification "(?\<benchmarkname\>[^,]+)," multi<br />\| "EventCount" as type <br />\| sum(indicator) as count by benchmarkname, type<br />\| fillmissing values("RDS\_RestoreFromBackup","RDS\_ModifySecurityGroup") in benchmarkname, values("EventCount") in type <br />\| toInt(count) as count<br />|
|Global Intelligence for AWS CloudTrail/Notable Event Count Queries|Redshift\_DisableEncryption|Logs|Global Intelligence for AWS CloudTrail/Notable Event Count Queries/Redshift\_DisableEncryption|\_sourceCategory = Labs/AWS/CloudTrail encryptionType <br />\| json "eventSource", "eventName", "errorCode" nodrop <br />\| where isBlank(errorCode) and eventSource="redshift.amazonaws.com" and eventName="ModifyCluster" <br />\| json "responseElements.pendingModifiedValues.encryptionType" as encrypted <br />\| if((encrypted matches "NONE"),1,0) as disableEncryptionEvent <br />\| sum(disableEncryptionEvent) as count <br />\| count as count <br />\| "Redshift\_DisableEncryption" as benchmarkname <br />\| "EventCount" as type <br />\| fillmissing values("Redshift\_DisableEncryption") in benchmarkname, values("EventCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Event Resource Count Queries|Redshift\_DisableEncryption,DisableAccessLogging\_CountEventResources|Logs|Global Intelligence for AWS CloudTrail/Event Resource Count Queries/Redshift\_DisableEncryption,DisableAccessLogging\_CountEventResources|\_sourceCategory = Labs/AWS/CloudTrail (DisableLogging or encryptionType)<br />\| json "eventSource", "eventName", "errorCode" ,"responseElements.pendingModifiedValues.encryptionType" as eventSource, eventName, errorCode, encrypted nodrop<br />\| where isBlank(errorCode) and eventSource="redshift.amazonaws.com" and ( eventName="DisableLogging" or (eventName="ModifyCluster" and encrypted="NONE"))<br />\| "" as classification<br />\| if (eventName="DisableLogging" ,concat("Redshift\_DisableAccesslogging\_CountEventResources,",classification),classification) as classification<br />\| if(eventName ="ModifyCluster" and encrypted="NONE",concat("Redshift\_DisableEncryption\_CountEventResources,",classification),classification) as classification<br />\| parse regex field=classification "(?\<benchmarkname\>[^,]+)," multi <br />\| json "requestParameters.clusterIdentifier" as rdsId <br />\| "EventResourceCount" as type <br />\| count\_distinct(rdsId) as count by benchmarkname, type<br />\| fillmissing values("Redshift\_DisableAccesslogging\_CountEventResources","Redshift\_DisableEncryption\_CountEventResources") in benchmarkname, values("EventResourceCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Event Resource Count Queries|Redshift\_DisableSSL\_CountEventResources|Logs|Global Intelligence for AWS CloudTrail/Event Resource Count Queries/Redshift\_DisableSSL\_CountEventResources|\_sourceCategory = Labs/AWS/CloudTrail ModifyClusterParameterGroup <br />\| json "eventSource", "eventName", "errorCode", "requestParameters.parameters" as eventSource, eventName, errorCode, listParams nodrop <br />\| where isBlank(errorCode) and eventSource="redshift.amazonaws.com" and eventName="ModifyClusterParameterGroup" <br />\| parse regex field=listParams "\\{(?\<param\>[^\\}]+\\})" multi <br />\| concat("{", param) as param <br />\| json field=param "parameterName", "parameterValue" <br />\| where parameterName="require\_ssl" and parameterValue="false" <br />\| json "requestParameters.parameterGroupName" as groupId <br />\| count\_distinct(groupId) as count <br />\| "Redshift\_DisableSSL\_CountEventResources" as benchmarkname <br />\| "EventResourceCount" as type <br />\| fillmissing values("Redshift\_DisableSSL\_CountEventResources") in benchmarkname, values("EventResourceCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Notable Event Count Queries|Redshift\_DisableSSLOrDisableAccesslogging|Logs|Global Intelligence for AWS CloudTrail/Notable Event Count Queries/Redshift\_DisableSSLOrDisableAccesslogging|\_sourceCategory = Labs/AWS/CloudTrail (ModifyClusterParameterGroup or DisableLogging)<br />\| json "eventSource", "eventName", "errorCode", "requestParameters.parameters" as eventSource, eventName, errorCode, listParams nodrop <br />\| where isBlank(errorCode) and eventSource="redshift.amazonaws.com" and (eventName="ModifyClusterParameterGroup" or eventName="DisableLogging")<br />\| parse regex field=listParams "\\{(?\<param\>[^\\}]+\\})" multi nodrop<br />\| concat("{", param) as param <br />\| json field=param "parameterName", "parameterValue" nodrop<br />\| "" as classification<br />\| if (parameterName="require\_ssl" and parameterValue="false",concat("Redshift\_DisableSSL,",classification),classification) as classification<br />\| if(eventName="DisableLogging",concat("Redshift\_DisableAccesslogging,",classification),classification) as classification<br />\| parse regex field=classification "(?\<benchmarkname\>[^,]+)," multi <br />\| "EventCount" as type <br />\| count as count by benchmarkname, type<br />\| fillmissing values("Redshift\_DisableSSL","Redshift\_DisableAccesslogging") in benchmarkname, values("EventCount") in type <br />\| toInt(count) as count<br />|
|Global Intelligence for AWS CloudTrail/Notable Event Count Queries|S3\_AccessDeniedOrBucketConfigChecksFromPublicIp|Logs|Global Intelligence for AWS CloudTrail/Notable Event Count Queries/S3\_AccessDeniedOrBucketConfigChecksFromPublicIp|\_sourceCategory = Labs/AWS/CloudTrail (AccessDenied or GetBucket\*)<br />\| json "eventSource", "eventName", "sourceIPAddress", "errorCode" nodrop <br />\| where eventSource="s3.amazonaws.com"  <br />\| "" as classification<br />\| if(errorCode="AccessDenied",concat("S3\_AccessDeniedTotal,",classification),classification) as classification<br />\| if(isPublicIP(sourceIPAddress) and errorCode="AccessDenied",concat("S3\_AccessDeniedForPublicIp,",classification),classification) as classification<br />\| if(isBlank(errorCode) and eventName in ("GetBucketAcl", "GetBucketCors", "GetBucketEncryption", "GetBucketLogging", "GetBucketPolicy", "GetBucketPublicAccessBlock", "GetBucketVersioning"),concat("S3\_BucketConfigChecksFromPublicIp,",classification),classification) as classification<br />\| if(!isBlank(classification), 1, 0) as indicator<br />\| parse regex field=classification "(?\<benchmarkname\>[^,]+)," multi<br />\| "EventCount" as type<br />\| sum(indicator) as count by benchmarkname, type<br />\| fillmissing values("S3\_AccessDeniedTotal","S3\_AccessDeniedForPublicIp", "S3\_BucketConfigChecksFromPublicIp") in benchmarkname, values("EventCount") in type<br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Event Resource Count Queries|S3\_AccessDeniedOrBucketConfigChecksFromPublicIp\_CountEventResources|Logs|Global Intelligence for AWS CloudTrail/Event Resource Count Queries/S3\_AccessDeniedOrBucketConfigChecksFromPublicIp\_CountEventResources|\_sourceCategory = Labs/AWS/CloudTrail (AccessDenied or GetBucket\*)<br />\| json "eventSource", "eventName", "sourceIPAddress", "errorCode" nodrop <br />\| json "requestParameters.bucketName" as bucketName<br />\| where eventSource="s3.amazonaws.com"  <br />\| "" as classification<br />\| if (errorCode="AccessDenied",concat("S3\_AccessDeniedTotal\_CountEventResources,",classification),classification) as classification<br />\| if(isPublicIP(sourceIPAddress) and errorCode="AccessDenied",concat("S3\_AccessDeniedForPublicIp\_CountEventResources,",classification),classification) as classification<br />\| if(isBlank(errorCode) and eventSource="s3.amazonaws.com" and eventName in ("GetBucketAcl", "GetBucketCors", "GetBucketEncryption", "GetBucketLogging", "GetBucketPolicy", "GetBucketPublicAccessBlock", "GetBucketVersioning"),concat("S3\_BucketConfigChecksFromPublicIp\_CountEventResources,",classification),classification) as classification<br />\| parse regex field=classification "(?\<benchmarkname\>[^,]+)," multi <br />\| "EventResourceCount" as type <br />\| count\_distinct(bucketName) as count by benchmarkname, type<br />\| fillmissing values("S3\_AccessDeniedTotal\_CountEventResources","S3\_AccessDeniedForPublicIp\_CountEventResources", "S3\_BucketConfigChecksFromPublicIp\_CountEventResources") in benchmarkname, values("EventResourceCount") in type <br />\| toInt(count) as count<br />|
|Global Intelligence for AWS CloudTrail/Notable Event Count Queries|S3\_CrudBucketsFromPublicIp|Logs|Global Intelligence for AWS CloudTrail/Notable Event Count Queries/S3\_CrudBucketsFromPublicIp|\_sourceCategory = Labs/AWS/CloudTrail s3.amazonaws.com <br />\| json "eventSource", "eventName", "sourceIPAddress", "errorCode" nodrop <br />\| where isBlank(errorCode) and eventSource="s3.amazonaws.com" <br />\| if(isPublicIP(sourceIPAddress) and ((eventName matches "Put\*") or (eventName matches "Create\*") or (eventName matches "Delete\*") or (eventName matches "Update\*")), 1 ,0) as eventNotRead <br />\| sum(eventNotRead) as count <br />\| "S3\_CrudBucketsFromPublicIp" as benchmarkname <br />\| "EventCount" as type <br />\| fillmissing values("S3\_CrudBucketsFromPublicIp") in benchmarkname, values("EventCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Event Resource Count Queries|S3\_CrudBucketsFromPublicIp\_CountEventResources|Logs|Global Intelligence for AWS CloudTrail/Event Resource Count Queries/S3\_CrudBucketsFromPublicIp\_CountEventResources|\_sourceCategory = Labs/AWS/CloudTrail s3.amazonaws.com <br />\| json "eventSource", "eventName", "sourceIPAddress", "errorCode" nodrop <br />\| json "requestParameters.bucketName" as bucketName<br />\| where isBlank(errorCode) and eventSource="s3.amazonaws.com" and isPublicIP(sourceIPAddress) and (eventName matches "Put\*") or (eventName matches "Create\*") or (eventName matches "Delete\*") or (eventName matches "Update\*") <br />\| count\_distinct(bucketName) as count <br />\| "S3\_CrudBucketsFromPublicIp\_CountEventResources" as benchmarkname <br />\| "EventResourceCount" as type <br />\| fillmissing values("S3\_CrudBucketsFromPublicIp\_CountEventResources") in benchmarkname, values("EventResourceCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Notable Event Count Queries|S3\_DisableMfaDeleteOrBucketVersionioningOrAccessLogging|Logs|Global Intelligence for AWS CloudTrail/Notable Event Count Queries/S3\_DisableMfaDeleteOrBucketVersionioningOrAccessLogging|\_sourceCategory = Labs/AWS/CloudTrail (PutBucketLogging  or Suspended or MfaDelete)<br />\| json "eventSource", "eventName", "errorCode" nodrop <br />\| where isBlank(errorCode) and eventSource="s3.amazonaws.com" and (eventName="PutBucketLogging"  or eventName="PutBucketVersioning") <br />\| json "requestParameters.BucketLoggingStatus.LoggingEnabled" ,"requestParameters.VersioningConfiguration.Status",  "requestParameters.VersioningConfiguration.MfaDelete" as loggingEnabled, versioningStatus, mfaDelete nodrop<br />\| where (isNull(loggingEnabled)  or versioningStatus="Suspended" or mfaDelete="Disabled") <br />\| "" as classification<br />\| if (eventName="PutBucketLogging" and isNull(loggingEnabled),concat("S3\_DisableAccessLogging,",classification),classification) as classification<br />\| if (eventName="PutBucketVersioning" and versioningStatus="Suspended" ,concat("S3\_DisableBucketVersioning,",classification),classification) as classification<br />\| if(eventName="PutBucketVersioning" and mfaDelete="Disabled",concat("S3\_DisableMfaDelete,",classification),classification) as classification <br />\| if(!isBlank(classification), 1, 0) as indicator<br />\| parse regex field=classification "(?\<benchmarkname\>[^,]+)," multi  <br />\| "EventCount" as type <br />\| sum(indicator) as count by benchmarkname, type<br />\| fillmissing values("S3\_DisableAccessLogging","S3\_DisableBucketVersioning","S3\_DisableMfaDelete") in benchmarkname, values("EventCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Event Resource Count Queries|S3\_DisableMfaDeleteOrBucketVersionioningOrAccessLogging\_CountEventResources|Logs|Global Intelligence for AWS CloudTrail/Event Resource Count Queries/S3\_DisableMfaDeleteOrBucketVersionioningOrAccessLogging\_CountEventResources|\_sourceCategory = Labs/AWS/CloudTrail (PutBucketLogging  or Suspended or MfaDelete)<br /><br />\| json "eventSource", "eventName", "errorCode" nodrop <br />\| json "requestParameters.bucketName" as bucketName<br />\| where isBlank(errorCode) and eventSource="s3.amazonaws.com" and (eventName="PutBucketLogging"  or eventName="PutBucketVersioning") <br />\| json "requestParameters.BucketLoggingStatus.LoggingEnabled" ,"requestParameters.VersioningConfiguration.Status",  "requestParameters.VersioningConfiguration.MfaDelete" as loggingEnabled, versioningStatus, mfaDelete nodrop<br />\| where (isNull(loggingEnabled)  or versioningStatus="Suspended" or mfaDelete="Disabled") <br />\| "" as classification<br />\| if (eventName="PutBucketLogging" and isNull(loggingEnabled),concat("S3\_DisableAccessLogging\_CountEventResources,",classification),classification) as classification<br />\| if (eventName="PutBucketVersioning" and versioningStatus="Suspended" ,concat("S3\_DisableBucketVersioning\_CountEventResources,",classification),classification) as classification<br />\| if(eventName="PutBucketVersioning" and mfaDelete="Disabled",concat("S3\_DisableMfaDelete\_CountEventResources,",classification),classification) as classification <br />\| parse regex field=classification "(?\<benchmarkname\>[^,]+)," multi <br />\| "EventResourceCount" as type <br />\| count\_distinct(bucketName) as count by benchmarkname, type<br />\| fillmissing values("S3\_DisableAccessLogging\_CountEventResources","S3\_DisableBucketVersioning\_CountEventResources","S3\_DisableMfaDelete\_CountEventResources") in benchmarkname, values("EventResourceCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Notable Event Count Queries|S3\_EnablePublicAccess|Logs|Global Intelligence for AWS CloudTrail/Notable Event Count Queries/S3\_EnablePublicAccess|\_sourceCategory = Labs/AWS/CloudTrail \*Bucket\* <br />\| json "eventName", "requestParameters.bucketName", "requestParameters.x-amz-acl", "requestParameters.x-amz-grant-read", "requestParameters.x-amz-grant-read-acp", "requestParameters.x-amz-grant-write", "requestParameters.x-amz-grant-write-acp","userIdentity.accountId", "userIdentity.arn", "userIdentity.sessionContext.sessionIssuer.userName", "sourceIPAddress", "requestParameters.AccessControlPolicy.AccessControlList.Grant[\*].Grantee.URI", "requestParameters.AccessControlPolicy.AccessControlList.Grant[\*].Permission", "eventTime", "errorCode" as event, bucket, acl, grant\_read, grant\_read\_acp, grant\_write, grant\_write\_acp, account, arn, user, src\_ip, grant\_uri, permission, datetime, errorCode nodrop <br />\| where isBlank(errorCode) and (grant\_uri matches "\*AllUsers\*" or grant\_uri matches "\*AuthenticatedUsers\*") or (acl matches "\*public\*") or (grant\_read matches "\*AllUsers\*") or (grant\_read matches "AuthenticatedUsers") or (grant\_read\_acp matches "\*AllUsers\*") or (grant\_read\_acp matches "AuthenticatedUsers") or (grant\_write matches "\*AllUsers\*") or (grant\_write matches "\*AuthenticatedUsers\*") or (grant\_write\_acp matches "\*AllUsers\*") or (grant\_write\_acp matches "\*AuthenticatedUsers\*") <br />\| where event="PutBucketAcl" or event="CreateBucket" <br />\| count as count <br />\| "S3\_EnablePublicAccess" as benchmarkname <br />\| "EventCount" as type <br />\| fillmissing values("S3\_EnablePublicAccess") in benchmarkname, values("EventCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Event Resource Count Queries|S3\_EnablePublicAccess\_CountEventResources|Logs|Global Intelligence for AWS CloudTrail/Event Resource Count Queries/S3\_EnablePublicAccess\_CountEventResources|\_sourceCategory = Labs/AWS/CloudTrail \*Bucket\* <br />\| json "eventName", "requestParameters.bucketName", "requestParameters.x-amz-acl", "requestParameters.x-amz-grant-read", "requestParameters.x-amz-grant-read-acp", "requestParameters.x-amz-grant-write", "requestParameters.x-amz-grant-write-acp","userIdentity.accountId", "userIdentity.arn", "userIdentity.sessionContext.sessionIssuer.userName", "sourceIPAddress", "requestParameters.AccessControlPolicy.AccessControlList.Grant[\*].Grantee.URI", "requestParameters.AccessControlPolicy.AccessControlList.Grant[\*].Permission", "eventTime", "errorCode" as event, bucket, acl, grant\_read, grant\_read\_acp, grant\_write, grant\_write\_acp, account, arn, user, src\_ip, grant\_uri, permission, datetime, errorCode nodrop <br />\| json "requestParameters.bucketName" as bucketName<br />\| where isBlank(errorCode) and (grant\_uri matches "\*AllUsers\*" or grant\_uri matches "\*AuthenticatedUsers\*") or (acl matches "\*public\*") or (grant\_read matches "\*AllUsers\*") or (grant\_read matches "AuthenticatedUsers") or (grant\_read\_acp matches "\*AllUsers\*") or (grant\_read\_acp matches "AuthenticatedUsers") or (grant\_write matches "\*AllUsers\*") or (grant\_write matches "\*AuthenticatedUsers\*") or (grant\_write\_acp matches "\*AllUsers\*") or (grant\_write\_acp matches "\*AuthenticatedUsers\*") <br />\| where event="PutBucketAcl" or event="CreateBucket" <br />\| count\_distinct(bucketName) as count <br />\| "S3\_EnablePublicAccess\_CountEventResources" as benchmarkname <br />\| "EventResourceCount" as type <br />\| fillmissing values("S3\_EnablePublicAccess\_CountEventResources") in benchmarkname, values("EventResourceCount") in type <br />\| toInt(count) as count|
|Global Intelligence for AWS CloudTrail/Notable Event Count Queries|S3\_ListBuckets|Logs|Global Intelligence for AWS CloudTrail/Notable Event Count Queries/S3\_ListBuckets|\_sourceCategory = Labs/AWS/CloudTrail ListBuckets <br />\| json "eventSource", "eventName", "errorCode" nodrop <br />\| where eventSource="s3.amazonaws.com" and eventName="ListBuckets" and isBlank(errorCode) <br />\| count as count <br />\| "S3\_ListBuckets" as benchmarkname <br />\| "EventCount" as type <br />\| fillmissing values("S3\_ListBuckets") in benchmarkname, values("EventCount") in type <br />\| toInt(count) as count|

