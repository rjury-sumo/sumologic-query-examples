# 

## Searches

### Log Searches

- **Action Plan**: from Dashboard: Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS Resources 
- **Findings by Category**: from Dashboard: Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS Resources 
- **Findings by Resource**: from Dashboard: Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS Resources 
- **Findings by Resource Type**: from Dashboard: Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS Resources 
- **Findings Trend**: from Dashboard: Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS Resources 
- **Threats by Actor**: from Dashboard: Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS Storage 
- **Threats by Actor**: from Dashboard: Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS APIs 
- **Threats by Country**: from Dashboard: Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS Resources 
- **Threats by Events and Result**: from Dashboard: Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS Storage 
- **Threats by Events and Result**: from Dashboard: Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS APIs 
- **Threats by Geo Location**: from Dashboard: Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS Storage 
- **Threats by Geo Location**: from Dashboard: Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS APIs 
- **Threats by Resource**: from Dashboard: Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS Storage 
- **Threats by Resource**: from Dashboard: Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS APIs 
- **Threats Count**: from Dashboard: Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS APIs 
- **Threats Count**: from Dashboard: Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS Storage 
- **Threats Trend**: from Dashboard: Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS Storage 
- **Threats Trend**: from Dashboard: Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS APIs 
- **Total Findings**: from Dashboard: Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS Resources

### Metric Searches


## Search Table

|app\_topic|search\_name|type|origin|search|
|:--|:--|:--|:--|:--|
||Action Plan|Logs|Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS Resources|\_sourceCategory={{GuardDutyLogsdatasource}}  <br />\| json "accountId", "region", "partition", "id", "arn", "type","service.serviceName","service.detectorId","service.action","severity","title","description", "vpcId", "subnetId", "groupId" , "tags", "groupName", "resource.instanceDetails", "resource.accessKeyDetails.userName" as cloud.account.id, cloud.region, partition, id, arn, type, service\_name, detector\_id, action, severity\_level, title, description, vpcId, subnetId , securityGroupId, tags, securityGroupName, instanceDetails, user.name nodrop<br /><br />\| json field=instanceDetails "instanceId", "instanceType","networkInterfaces[0].publicIp" as instanceid, cloud.machine.type, server.ip<br />\| json field=\_raw "resource.resourceType" as resourceType<br />\| json field=\_raw "resource.s3BucketDetails[0].name" as bucketName nodrop<br />\| if (resourceType = "S3Bucket", bucketName, instanceid) as cloud.instance.id<br /><br />\| json field=action "awsApiCallAction.remoteIpDetails.ipAddressV4", "networkConnectionAction.remoteIpDetails.ipAddressV4","networkConnectionAction.localPortDetails.port","networkConnectionAction.remoteIpDetails.geoLocation.lon", "networkConnectionAction.remoteIpDetails.geoLocation.lat", "networkConnectionAction.remoteIpDetails.organization.asnOrg", "networkConnectionAction.remoteIpDetails.organization.org", "networkConnectionAction.remoteIpDetails.organization.isp" as awsCallActionIp, networkActionIp, localPort,longitude, latitude, asnOrg, organization, isp nodrop<br /><br />\| parse field=type "\*:\*/\*" as threat.tactic.name,cloud.service.name,threat.technique.name <br />\| if (severity\_level = 0, 0, 0) as risk.static\_level<br />\| if (severity\_level \> 0 and severity\_level \<= 2, 1, risk.static\_level) as risk.static\_level<br />\| if (severity\_level \> 2 and severity\_level \<= 5, 2, risk.static\_level) as risk.static\_level<br />\| if (severity\_level \> 5 and severity\_level \<= 9, 3, risk.static\_level) as risk.static\_level<br />\| if (severity\_level \> 9, 3, risk.static\_level) as risk.static\_level<br /><br />// handle empty values<br />\| if(isEmpty(user.name), "NA", user.name) as user.name<br />\| if(isEmpty(awsCallActionIp), if (isEmpty(networkActionIp), "NA",networkActionIp) , awsCallActionIp) as client.ip<br />\| if(isEmpty(cloud.account.id), "NA", cloud.account.id) as cloud.account.id<br /><br />// global filters<br />\| where if ("{{cloud.account.id}}" = "\*", true, cloud.account.id matches "{{cloud.account.id}}") AND if ("{{cloud.region}}" = "\*", true, cloud.region matches "{{cloud.region}}") AND if ("{{cloud.instance.id}}" = "\*", true, cloud.instance.id matches "{{cloud.instance.id}}") AND if ("{{server.ip}}" = "\*", true, server.ip matches "{{server.ip}}") AND if ("{{risk.static\_level}}" = "\*", true, risk.static\_level \>= toInt("{{risk.static\_level}}")) AND if ("{{threat.tactic.name}}" = "\*", true, threat.tactic.name matches "{{threat.tactic.name}}") AND if ("{{cloud.service.name}}" = "\*", true, cloud.service.name matches "{{cloud.service.name}}") AND if ("{{user.name}}" = "\*", true, user.name matches "{{user.name}}") AND if ("{{client.ip}}" = "\*", true, client.ip matches "{{client.ip}}")<br /><br />\| if(!isNull(cloud.instance.id),concat ("https://",region,".console.aws.amazon.com/ec2/v2/home?region=",cloud.region,"#Instances:search=",cloud.instance.id),"") as link<br />\| tourl (link, cloud.account.id) as cloud.account.id<br />\| count as frequency by title, cloud.account.id, cloud.service.name, organization, isp, client.ip<br />\| sort by frequency|
||Findings by Category|Logs|Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS Resources|\_sourceCategory={{GuardDutyLogsdatasource}}  <br />\| json "accountId", "region", "partition", "id", "arn", "type","service.serviceName","service.detectorId","service.action","severity","title","description", "vpcId", "subnetId", "groupId" , "tags", "groupName", "resource.instanceDetails", "resource.accessKeyDetails.userName" as cloud.account.id, cloud.region, partition, id, arn, type, service\_name, detector\_id, action, severity\_level, title, description, vpcId, subnetId , securityGroupId, tags, securityGroupName, instanceDetails, user.name nodrop<br /><br />\| json field=instanceDetails "instanceId", "instanceType","networkInterfaces[0].publicIp" as instanceid, cloud.machine.type, server.ip<br />\| json field=\_raw "resource.resourceType" as resourceType<br />\| json field=\_raw "resource.s3BucketDetails[0].name" as bucketName nodrop<br />\| if (resourceType = "S3Bucket", bucketName, instanceid) as cloud.instance.id<br /><br />\| json field=action "awsApiCallAction.remoteIpDetails.ipAddressV4", "networkConnectionAction.remoteIpDetails.ipAddressV4","networkConnectionAction.localPortDetails.port" as awsCallActionIp, networkActionIp, localPort nodrop<br /><br />\| parse field=type "\*:\*/\*" as threat.tactic.name,cloud.service.name,threat.technique.name <br />\| if (severity\_level = 0, 0, 0) as risk.static\_level<br />\| if (severity\_level \> 0 and severity\_level \<= 2, 1, risk.static\_level) as risk.static\_level<br />\| if (severity\_level \> 2 and severity\_level \<= 5, 2, risk.static\_level) as risk.static\_level<br />\| if (severity\_level \> 5 and severity\_level \<= 9, 3, risk.static\_level) as risk.static\_level<br />\| if (severity\_level \> 9, 3, risk.static\_level) as risk.static\_level<br /><br />// handle empty values<br />\| if(isEmpty(user.name), "NA", user.name) as user.name<br />\| if(isEmpty(awsCallActionIp), if (isEmpty(networkActionIp), "NA",networkActionIp) , awsCallActionIp) as client.ip<br />\| if(isEmpty(cloud.account.id), "NA", cloud.account.id) as cloud.account.id<br /><br />// global filters<br />\| where if ("{{cloud.account.id}}" = "\*", true, cloud.account.id matches "{{cloud.account.id}}") AND if ("{{cloud.region}}" = "\*", true, cloud.region matches "{{cloud.region}}") AND if ("{{cloud.instance.id}}" = "\*", true, cloud.instance.id matches "{{cloud.instance.id}}") AND if ("{{server.ip}}" = "\*", true, server.ip matches "{{server.ip}}") AND if ("{{risk.static\_level}}" = "\*", true, risk.static\_level \>= toInt("{{risk.static\_level}}")) AND if ("{{threat.tactic.name}}" = "\*", true, threat.tactic.name matches "{{threat.tactic.name}}") AND if ("{{cloud.service.name}}" = "\*", true, cloud.service.name matches "{{cloud.service.name}}") AND if ("{{user.name}}" = "\*", true, user.name matches "{{user.name}}") AND if ("{{client.ip}}" = "\*", true, client.ip matches "{{client.ip}}")<br /><br />\| count by threat.tactic.name<br />\| sort by \_count<br />\| limit 10|
||Findings by Resource|Logs|Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS Resources|\_sourceCategory={{GuardDutyLogsdatasource}}  <br />\| json "accountId", "region", "partition", "id", "arn", "type","service.serviceName","service.detectorId","service.action","severity","title","description", "vpcId", "subnetId", "groupId" , "tags", "groupName", "resource.instanceDetails", "resource.accessKeyDetails.userName" as cloud.account.id, cloud.region, partition, id, arn, type, service\_name, detector\_id, action, severity\_level, title, description, vpcId, subnetId , securityGroupId, tags, securityGroupName, instanceDetails, user.name nodrop<br /><br />\| json field=instanceDetails "instanceId", "instanceType","networkInterfaces[0].publicIp" as instanceid, cloud.machine.type, server.ip<br />\| json field=\_raw "resource.resourceType" as resourceType<br />\| json field=\_raw "resource.s3BucketDetails[0].name" as bucketName nodrop<br />\| if (resourceType = "S3Bucket", bucketName, instanceid) as cloud.instance.id<br /><br />\| json field=action "awsApiCallAction.remoteIpDetails.ipAddressV4", "networkConnectionAction.remoteIpDetails.ipAddressV4","networkConnectionAction.localPortDetails.port" as awsCallActionIp, networkActionIp, localPort nodrop<br /><br />\| parse field=type "\*:\*/\*" as threat.tactic.name,cloud.service.name,threat.technique.name <br />\| if (severity\_level = 0, 0, 0) as risk.static\_level<br />\| if (severity\_level \> 0 and severity\_level \<= 2, 1, risk.static\_level) as risk.static\_level<br />\| if (severity\_level \> 2 and severity\_level \<= 5, 2, risk.static\_level) as risk.static\_level<br />\| if (severity\_level \> 5 and severity\_level \<= 9, 3, risk.static\_level) as risk.static\_level<br />\| if (severity\_level \> 9, 3, risk.static\_level) as risk.static\_level<br /><br />// handle empty values<br />\| if(isEmpty(user.name), "NA", user.name) as user.name<br />\| if(isEmpty(awsCallActionIp), if (isEmpty(networkActionIp), "NA",networkActionIp) , awsCallActionIp) as client.ip<br />\| if(isEmpty(cloud.account.id), "NA", cloud.account.id) as cloud.account.id<br /><br />// global filters<br />\| where if ("{{cloud.account.id}}" = "\*", true, cloud.account.id matches "{{cloud.account.id}}") AND if ("{{cloud.region}}" = "\*", true, cloud.region matches "{{cloud.region}}") AND if ("{{cloud.instance.id}}" = "\*", true, cloud.instance.id matches "{{cloud.instance.id}}") AND if ("{{server.ip}}" = "\*", true, server.ip matches "{{server.ip}}") AND if ("{{risk.static\_level}}" = "\*", true, risk.static\_level \>= toInt("{{risk.static\_level}}")) AND if ("{{threat.tactic.name}}" = "\*", true, threat.tactic.name matches "{{threat.tactic.name}}") AND if ("{{cloud.service.name}}" = "\*", true, cloud.service.name matches "{{cloud.service.name}}") AND if ("{{user.name}}" = "\*", true, user.name matches "{{user.name}}") AND if ("{{client.ip}}" = "\*", true, client.ip matches "{{client.ip}}")<br /><br />\| count by cloud.instance.id, cloud.account.id, cloud.region, risk.static\_level,threat.tactic.name,cloud.service.name,threat.technique.name, user.name, client.ip<br />\| sort by \_count<br />\| limit 10|
||Findings by Resource Type|Logs|Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS Resources|\_sourceCategory={{GuardDutyLogsdatasource}}  <br />\| json "accountId", "region", "partition", "id", "arn", "type","service.serviceName","service.detectorId","service.action","severity","title","description", "vpcId", "subnetId", "groupId" , "tags", "groupName", "resource.instanceDetails", "resource.accessKeyDetails.userName" as cloud.account.id, cloud.region, partition, id, arn, type, service\_name, detector\_id, action, severity\_level, title, description, vpcId, subnetId , securityGroupId, tags, securityGroupName, instanceDetails, user.name nodrop<br /><br />\| json field=instanceDetails "instanceId", "instanceType","networkInterfaces[0].publicIp" as instanceid, cloud.machine.type, server.ip<br />\| json field=\_raw "resource.resourceType" as resourceType<br />\| json field=\_raw "resource.s3BucketDetails[0].name" as bucketName nodrop<br />\| if (resourceType = "S3Bucket", bucketName, instanceid) as cloud.instance.id<br /><br />\| json field=action "awsApiCallAction.remoteIpDetails.ipAddressV4", "networkConnectionAction.remoteIpDetails.ipAddressV4","networkConnectionAction.localPortDetails.port" as awsCallActionIp, networkActionIp, localPort nodrop<br /><br />\| parse field=type "\*:\*/\*" as threat.tactic.name,cloud.service.name,threat.technique.name <br />\| if (severity\_level = 0, 0, 0) as risk.static\_level<br />\| if (severity\_level \> 0 and severity\_level \<= 2, 1, risk.static\_level) as risk.static\_level<br />\| if (severity\_level \> 2 and severity\_level \<= 5, 2, risk.static\_level) as risk.static\_level<br />\| if (severity\_level \> 5 and severity\_level \<= 9, 3, risk.static\_level) as risk.static\_level<br />\| if (severity\_level \> 9, 3, risk.static\_level) as risk.static\_level<br /><br />// handle empty values<br />\| if(isEmpty(user.name), "NA", user.name) as user.name<br />\| if(isEmpty(awsCallActionIp), if (isEmpty(networkActionIp), "NA",networkActionIp) , awsCallActionIp) as client.ip<br />\| if(isEmpty(cloud.account.id), "NA", cloud.account.id) as cloud.account.id<br /><br />// global filters<br />\| where if ("{{cloud.account.id}}" = "\*", true, cloud.account.id matches "{{cloud.account.id}}") AND if ("{{cloud.region}}" = "\*", true, cloud.region matches "{{cloud.region}}") AND if ("{{cloud.instance.id}}" = "\*", true, cloud.instance.id matches "{{cloud.instance.id}}") AND if ("{{server.ip}}" = "\*", true, server.ip matches "{{server.ip}}") AND if ("{{risk.static\_level}}" = "\*", true, risk.static\_level \>= toInt("{{risk.static\_level}}")) AND if ("{{threat.tactic.name}}" = "\*", true, threat.tactic.name matches "{{threat.tactic.name}}") AND if ("{{cloud.service.name}}" = "\*", true, cloud.service.name matches "{{cloud.service.name}}") AND if ("{{user.name}}" = "\*", true, user.name matches "{{user.name}}") AND if ("{{client.ip}}" = "\*", true, client.ip matches "{{client.ip}}")<br /><br />\| count by cloud.service.name<br />\| sort by \_count<br />\| limit 10|
||Findings Trend|Logs|Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS Resources|\_sourceCategory={{GuardDutyLogsdatasource}}  <br />\| json "accountId", "region", "partition", "id", "arn", "type","service.serviceName","service.detectorId","service.action","severity","title","description", "vpcId", "subnetId", "groupId" , "tags", "groupName", "resource.instanceDetails", "resource.accessKeyDetails.userName" as cloud.account.id, cloud.region, partition, id, arn, type, service\_name, detector\_id, action, severity\_level, title, description, vpcId, subnetId , securityGroupId, tags, securityGroupName, instanceDetails, user.name nodrop<br /><br />\| json field=instanceDetails "instanceId", "instanceType","networkInterfaces[0].publicIp" as instanceid, cloud.machine.type, server.ip<br />\| json field=\_raw "resource.resourceType" as resourceType<br />\| json field=\_raw "resource.s3BucketDetails[0].name" as bucketName nodrop<br />\| if (resourceType = "S3Bucket", bucketName, instanceid) as cloud.instance.id<br /><br />\| json field=action "awsApiCallAction.remoteIpDetails.ipAddressV4", "networkConnectionAction.remoteIpDetails.ipAddressV4","networkConnectionAction.localPortDetails.port" as awsCallActionIp, networkActionIp, localPort nodrop<br /><br />\| parse field=type "\*:\*/\*" as threat.tactic.name,cloud.service.name,threat.technique.name <br />\| if (severity\_level = 0, 0, 0) as risk.static\_level<br />\| if (severity\_level \> 0 and severity\_level \<= 2, 1, risk.static\_level) as risk.static\_level<br />\| if (severity\_level \> 2 and severity\_level \<= 5, 2, risk.static\_level) as risk.static\_level<br />\| if (severity\_level \> 5 and severity\_level \<= 9, 3, risk.static\_level) as risk.static\_level<br />\| if (severity\_level \> 9, 3, risk.static\_level) as risk.static\_level<br /><br />// handle empty values<br />\| if(isEmpty(user.name), "NA", user.name) as user.name<br />\| if(isEmpty(awsCallActionIp), if (isEmpty(networkActionIp), "NA",networkActionIp) , awsCallActionIp) as client.ip<br />\| if(isEmpty(cloud.account.id), "NA", cloud.account.id) as cloud.account.id<br /><br />// global filters<br />\| where if ("{{cloud.account.id}}" = "\*", true, cloud.account.id matches "{{cloud.account.id}}") AND if ("{{cloud.region}}" = "\*", true, cloud.region matches "{{cloud.region}}") AND if ("{{cloud.instance.id}}" = "\*", true, cloud.instance.id matches "{{cloud.instance.id}}") AND if ("{{server.ip}}" = "\*", true, server.ip matches "{{server.ip}}") AND if ("{{risk.static\_level}}" = "\*", true, risk.static\_level \>= toInt("{{risk.static\_level}}")) AND if ("{{threat.tactic.name}}" = "\*", true, threat.tactic.name matches "{{threat.tactic.name}}") AND if ("{{cloud.service.name}}" = "\*", true, cloud.service.name matches "{{cloud.service.name}}") AND if ("{{user.name}}" = "\*", true, user.name matches "{{user.name}}") AND if ("{{client.ip}}" = "\*", true, client.ip matches "{{client.ip}}")<br /><br />\| timeslice 1d<br />\| count by \_timeslice|
||Threats by Actor|Logs|Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS Storage|\_sourceCategory={{CloudTrailLogsdatasource}}  "s3.amazonaws.com"<br />\| json "userIdentity", "eventTime", "eventSource", "eventName", "awsRegion", "sourceIPAddress", "userAgent", "errorCode", "requestParameters", "eventType" as userIdentity, event\_time, eventSource, event.action, cloud.region, client.ip, user\_agent, event.outcome, requestParameters, eventType nodrop<br />\| where eventSource = "s3.amazonaws.com"<br />\| json field=userIdentity "type", "accountId" as userType, cloud.account.id<br />\| json field=requestParameters "bucketName" as cloud.instance.id<br />\| parse field=eventSource "\*." as cloud.service.name<br />\| parse regex "\\"(?i)userName\\":\\"(?\<user\_name\>.\*?)\\"" nodrop<br />\| parse "\\"userId\\":\\"\*\\"" as user\_id nodrop<br />\| if (user\_name="", user\_id, user\_name) as user.name<br /><br />\| if (userType matches("IAMUser"), "user", "machine") as event.agent<br /><br />\| lookup type, actor, raw, threatlevel as malicious\_confidence, threat from sumo://threat/cs on threat=client.ip<br />\| where type="ip\_address"<br /><br />\| if (malicious\_confidence = "low", 1, 0) as risk.static\_level<br />\| if (malicious\_confidence = "medium", 2, risk.static\_level) as risk.static\_level<br />\| if (malicious\_confidence = "high", 3, risk.static\_level) as risk.static\_level<br /><br />// handle empty values<br />\| if (isEmpty(event.outcome), "Success", event.outcome) as event.outcome<br />\| if (isEmpty(user.name), "NA", user.name) as user.name<br />\| if (isEmpty(actor), "Unassigned", actor) as actor<br />\| if(isEmpty(cloud.account.id), "NA", cloud.account.id) as cloud.account.id<br /><br />// global filters<br />\| where if ("{{cloud.instance.id}}" = "\*", true, cloud.instance.id matches "{{cloud.instance.id}}") AND if ("{{event.action}}" = "\*", true, event.action matches "{{event.action}}") AND if ("{{user.name}}" = "\*", true, user.name matches "{{user.name}}") AND if ("{{event.action}}" = "\*", true, event.action matches "{{event.action}}") AND if ("{{client.ip}}" = "\*", true, client.ip matches "{{client.ip}}") AND if ("{{risk.static\_level}}" = "\*", true, risk.static\_level \>= toInt("{{risk.static\_level}}")) AND if ("{{threat.group.name}}" = "\*", true, actor matches "{{threat.group.name}}") AND if ("{{source.user}}" = "\*", true, source.user matches "{{source.user}}}")<br /><br />\| count by actor<br />\| sort by \_count|
||Threats by Actor|Logs|Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS APIs|\_sourceCategory={{CloudTrailLogsdatasource}}  sourceIPAddress !("s3.amazonaws.com")<br />\| json "eventTime", "eventName", "eventSource", "awsRegion", "sourceIPAddress", "errorCode", "userAgent" as event\_time, event.action, eventSource, cloud.region, client.ip, event.outcome, user\_agent nodrop<br />\| json "userIdentity.accountId", "userIdentity.type" as cloud.account.id, user\_identity\_type nodrop<br />\| json field=\_raw "requestParameters.dBInstanceIdentifier", "requestParameters.instancesSet.items[0].instanceId" as db\_instance\_id, cloud\_instance\_id nodrop<br /><br />\| parse regex "\\"(?i)userName\\":\\"(?\<user\_name\>.\*?)\\"" nodrop<br />\| parse "\\"userId\\":\\"\*\\"" as user\_id nodrop<br />\| if (user\_name="", user\_id, user\_name) as user.name <br />\| parse field=eventSource "\*." as cloud.service.name<br />\| parse "\\"accessKeyId\\":\\"\*\\"" as accessKeyId nodrop<br /><br />\| lookup type, actor, raw, threatlevel as malicious\_confidence, threat from sumo://threat/cs on threat=client.ip<br />\| where type="ip\_address"<br /><br />\| if (malicious\_confidence = "low", 1, 0) as risk.static\_level<br />\| if (malicious\_confidence = "medium", 2, risk.static\_level) as risk.static\_level<br />\| if (malicious\_confidence = "high", 3, risk.static\_level) as risk.static\_level<br /><br />// handle empty values<br />\| if(isEmpty(db\_instance\_id),cloud\_instance\_id,db\_instance\_id) as cloud.instance.id<br />\| if(isEmpty(cloud.instance.id),"NA", cloud.instance.id) as cloud.instance.id<br />\| if (isEmpty(event.outcome), "Success", event.outcome) as event.outcome<br />\| if (isEmpty(user.name), "NA", user.name) as user.name<br />\| if (isEmpty(actor), "Unassigned", actor) as actor<br />\| if(isEmpty(cloud.account.id), "NA", cloud.account.id) as cloud.account.id<br /><br />// global filters<br />\| where if ("{{cloud.account.id}}" = "\*", true, cloud.account.id matches "{{cloud.account.id}}") AND if ("{{cloud.region}}" = "\*", true, cloud.region matches "{{cloud.region}}") AND if ("{{event.action}}" = "\*", true, event.action matches "{{event.action}}") AND if ("{{event.outcome}}" = "\*", true, event.outcome matches "{{event.outcome}}") AND if ("{{user.name}}" = "\*", true, user.name matches "{{user.name}}") AND if ("{{client.ip}}" = "\*", true, client.ip matches "{{client.ip}}") AND if ("{{cloud.service.name}}" = "\*", true, cloud.service.name matches "{{cloud.service.name}}") AND if ("{{cloud.instance.id}}" = "\*", true, cloud.instance.id matches "{{cloud.instance.id}}") AND if ("{{threat.group.name}}" = "\*", true, actor matches "{{threat.group.name}}") AND if ("{{risk.static\_level}}" = "\*", true, risk.static\_level \>= toInt("{{risk.static\_level}}"))<br /><br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families nodrop<br />\| json field=raw "last\_updated" as last\_updated nodrop<br />\| formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated<br />\| json field=raw "labels[\*].name" as label\_name nodrop<br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br /><br />\| count by actor, label\_name, risk.static\_level \| sort by \_count, actor, label\_name, risk.static\_level asc|
||Threats by Country|Logs|Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS Resources|\_sourceCategory={{GuardDutyLogsdatasource}}  (geoLocation and lat and lon)<br />\| json "accountId", "region", "partition", "id", "arn", "type","service.serviceName","service.detectorId","service.action","severity","title","description", "vpcId", "subnetId", "groupId" , "tags", "groupName", "resource.instanceDetails", "resource.accessKeyDetails.userName" as cloud.account.id, cloud.region, partition, id, arn, type, service\_name, detector\_id, action, severity\_level, title, description, vpcId, subnetId , securityGroupId, tags, securityGroupName, instanceDetails, user.name nodrop<br /><br />\| json field=instanceDetails "instanceId", "instanceType","networkInterfaces[0].publicIp" as instanceid, cloud.machine.type, server.ip<br />\| json field=\_raw "resource.resourceType" as resourceType<br />\| json field=\_raw "resource.s3BucketDetails[0].name" as bucketName nodrop<br />\| if (resourceType = "S3Bucket", bucketName, instanceid) as cloud.instance.id<br /><br />\| json field=action "awsApiCallAction.remoteIpDetails.ipAddressV4", "networkConnectionAction.remoteIpDetails.ipAddressV4","networkConnectionAction.localPortDetails.port","networkConnectionAction.remoteIpDetails.geoLocation.lon", "networkConnectionAction.remoteIpDetails.geoLocation.lat", "networkConnectionAction.remoteIpDetails.organization.asnOrg", "networkConnectionAction.remoteIpDetails.organization.org", "networkConnectionAction.remoteIpDetails.organization.isp" as awsCallActionIp, networkActionIp, localPort,longitude, latitude, asnOrg, organization, isp nodrop<br /><br />\| parse field=type "\*:\*/\*" as threat.tactic.name,cloud.service.name,threat.technique.name <br />\| if (severity\_level = 0, 0, 0) as risk.static\_level<br />\| if (severity\_level \> 0 and severity\_level \<= 2, 1, risk.static\_level) as risk.static\_level<br />\| if (severity\_level \> 2 and severity\_level \<= 5, 2, risk.static\_level) as risk.static\_level<br />\| if (severity\_level \> 5 and severity\_level \<= 9, 3, risk.static\_level) as risk.static\_level<br />\| if (severity\_level \> 9, 3, risk.static\_level) as risk.static\_level<br /><br />// handle empty values<br />\| if(isEmpty(user.name), "NA", user.name) as user.name<br />\| if(isEmpty(awsCallActionIp), networkActionIp, awsCallActionIp) as client.ip<br />\| if(isEmpty(cloud.account.id), "NA", cloud.account.id) as cloud.account.id<br /><br />// global filters<br />\| where if ("{{cloud.account.id}}" = "\*", true, cloud.account.id matches "{{cloud.account.id}}") AND if ("{{cloud.region}}" = "\*", true, cloud.region matches "{{cloud.region}}") AND if ("{{cloud.instance.id}}" = "\*", true, cloud.instance.id matches "{{cloud.instance.id}}") AND if ("{{server.ip}}" = "\*", true, server.ip matches "{{server.ip}}") AND if ("{{risk.static\_level}}" = "\*", true, risk.static\_level \>= toInt("{{risk.static\_level}}")) AND if ("{{threat.tactic.name}}" = "\*", true, threat.tactic.name matches "{{threat.tactic.name}}") AND if ("{{cloud.service.name}}" = "\*", true, cloud.service.name matches "{{cloud.service.name}}") AND if ("{{user.name}}" = "\*", true, user.name matches "{{user.name}}") AND if ("{{client.ip}}" = "\*", true, client.ip matches "{{client.ip}}")<br /><br />\| lookup latitude, longitude from geo://location on ip = client.ip<br />\| count by latitude, longitude|
||Threats by Events and Result|Logs|Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS Storage|\_sourceCategory={{CloudTrailLogsdatasource}}  "s3.amazonaws.com"<br />\| json "userIdentity", "eventTime", "eventSource", "eventName", "awsRegion", "sourceIPAddress", "userAgent", "errorCode", "requestParameters", "eventType" as userIdentity, event\_time, eventSource, event.action, cloud.region, client.ip, user\_agent, event.outcome, requestParameters, eventType nodrop<br />\| where eventSource = "s3.amazonaws.com"<br />\| json field=userIdentity "type", "accountId" as userType, cloud.account.id<br />\| json field=requestParameters "bucketName" as cloud.instance.id<br />\| parse field=eventSource "\*." as cloud.service.name<br />\| parse regex "\\"(?i)userName\\":\\"(?\<user\_name\>.\*?)\\"" nodrop<br />\| parse "\\"userId\\":\\"\*\\"" as user\_id nodrop<br />\| if (user\_name="", user\_id, user\_name) as user.name<br /><br />\| if (userType matches("IAMUser"), "user", "machine") as event.agent<br /><br />\| lookup type, actor, raw, threatlevel as malicious\_confidence, threat from sumo://threat/cs on threat=client.ip<br />\| where type="ip\_address"<br /><br />\| if (malicious\_confidence = "low", 1, 0) as risk.static\_level<br />\| if (malicious\_confidence = "medium", 2, risk.static\_level) as risk.static\_level<br />\| if (malicious\_confidence = "high", 3, risk.static\_level) as risk.static\_level<br /><br />// handle empty values<br />\| if (isEmpty(event.outcome), "Success", event.outcome) as event.outcome<br />\| if (isEmpty(user.name), "NA", user.name) as user.name<br />\| if (isEmpty(actor), "Unassigned", actor) as actor<br />\| if(isEmpty(cloud.account.id), "NA", cloud.account.id) as cloud.account.id<br /><br />// global filters<br />\| where if ("{{cloud.instance.id}}" = "\*", true, cloud.instance.id matches "{{cloud.instance.id}}") AND if ("{{event.action}}" = "\*", true, event.action matches "{{event.action}}") AND if ("{{user.name}}" = "\*", true, user.name matches "{{user.name}}") AND if ("{{event.action}}" = "\*", true, event.action matches "{{event.action}}") AND if ("{{client.ip}}" = "\*", true, client.ip matches "{{client.ip}}") AND if ("{{risk.static\_level}}" = "\*", true, risk.static\_level \>= toInt("{{risk.static\_level}}")) AND if ("{{threat.group.name}}" = "\*", true, actor matches "{{threat.group.name}}") AND if ("{{source.user}}" = "\*", true, source.user matches "{{source.user}}}")<br /> <br />\| count by event.action, event.outcome<br />\| transpose row event.action column event.outcome|
||Threats by Events and Result|Logs|Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS APIs|\_sourceCategory={{CloudTrailLogsdatasource}}  sourceIPAddress !("s3.amazonaws.com")<br />\| json "eventTime", "eventName", "eventSource", "awsRegion", "sourceIPAddress", "errorCode", "userAgent" as event\_time, event.action, eventSource, cloud.region, client.ip, event.outcome, user\_agent nodrop<br />\| json "userIdentity.accountId", "userIdentity.type" as cloud.account.id, user\_identity\_type nodrop<br />\| json field=\_raw "requestParameters.dBInstanceIdentifier", "requestParameters.instancesSet.items[0].instanceId" as db\_instance\_id, cloud\_instance\_id nodrop<br /><br />\| parse regex "\\"(?i)userName\\":\\"(?\<user\_name\>.\*?)\\"" nodrop<br />\| parse "\\"userId\\":\\"\*\\"" as user\_id nodrop<br />\| if (user\_name="", user\_id, user\_name) as user.name <br />\| parse field=eventSource "\*." as cloud.service.name<br />\| parse "\\"accessKeyId\\":\\"\*\\"" as accessKeyId nodrop<br /><br />\| lookup type, actor, raw, threatlevel as malicious\_confidence, threat from sumo://threat/cs on threat=client.ip<br />\| where type="ip\_address"<br /><br />\| if (malicious\_confidence = "low", 1, 0) as risk.static\_level<br />\| if (malicious\_confidence = "medium", 2, risk.static\_level) as risk.static\_level<br />\| if (malicious\_confidence = "high", 3, risk.static\_level) as risk.static\_level<br /><br />// handle empty values<br />\| if(isEmpty(db\_instance\_id),cloud\_instance\_id,db\_instance\_id) as cloud.instance.id<br />\| if(isEmpty(cloud.instance.id),"NA", cloud.instance.id) as cloud.instance.id<br />\| if (isEmpty(event.outcome), "Success", event.outcome) as event.outcome<br />\| if (isEmpty(user.name), "NA", user.name) as user.name<br />\| if (isEmpty(actor), "Unassigned", actor) as actor<br />\| if(isEmpty(cloud.account.id), "NA", cloud.account.id) as cloud.account.id<br /><br />// global filters<br />\| where if ("{{cloud.account.id}}" = "\*", true, cloud.account.id matches "{{cloud.account.id}}") AND if ("{{cloud.region}}" = "\*", true, cloud.region matches "{{cloud.region}}") AND if ("{{event.action}}" = "\*", true, event.action matches "{{event.action}}") AND if ("{{event.outcome}}" = "\*", true, event.outcome matches "{{event.outcome}}") AND if ("{{user.name}}" = "\*", true, user.name matches "{{user.name}}") AND if ("{{client.ip}}" = "\*", true, client.ip matches "{{client.ip}}") AND if ("{{cloud.service.name}}" = "\*", true, cloud.service.name matches "{{cloud.service.name}}") AND if ("{{cloud.instance.id}}" = "\*", true, cloud.instance.id matches "{{cloud.instance.id}}") AND if ("{{threat.group.name}}" = "\*", true, actor matches "{{threat.group.name}}") AND if ("{{risk.static\_level}}" = "\*", true, risk.static\_level \>= toInt("{{risk.static\_level}}"))<br /><br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families nodrop<br />\| json field=raw "last\_updated" as last\_updated nodrop<br />\| formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated<br />\| json field=raw "labels[\*].name" as label\_name nodrop<br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br /><br />\| count by event.action, event.outcome<br />\| transpose row event.action column event.outcome|
||Threats by Geo Location|Logs|Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS Storage|\_sourceCategory={{CloudTrailLogsdatasource}}  "s3.amazonaws.com"<br />\| json "userIdentity", "eventTime", "eventSource", "eventName", "awsRegion", "sourceIPAddress", "userAgent", "errorCode", "requestParameters", "eventType" as userIdentity, event\_time, eventSource, event.action, cloud.region, client.ip, user\_agent, event.outcome, requestParameters, eventType nodrop<br />\| where eventSource = "s3.amazonaws.com"<br />\| json field=userIdentity "type", "accountId" as userType, cloud.account.id<br />\| json field=requestParameters "bucketName" as cloud.instance.id<br />\| parse field=eventSource "\*." as cloud.service.name<br />\| parse regex "\\"(?i)userName\\":\\"(?\<user\_name\>.\*?)\\"" nodrop<br />\| parse "\\"userId\\":\\"\*\\"" as user\_id nodrop<br />\| if (user\_name="", user\_id, user\_name) as user.name<br /><br />\| if (userType matches("IAMUser"), "user", "machine") as event.agent<br /><br />\| lookup type, actor, raw, threatlevel as malicious\_confidence, threat from sumo://threat/cs on threat=client.ip<br />\| where type="ip\_address"<br /><br />\| if (malicious\_confidence = "low", 1, 0) as risk.static\_level<br />\| if (malicious\_confidence = "medium", 2, risk.static\_level) as risk.static\_level<br />\| if (malicious\_confidence = "high", 3, risk.static\_level) as risk.static\_level<br /><br />// handle empty values<br />\| if (isEmpty(event.outcome), "Success", event.outcome) as event.outcome<br />\| if (isEmpty(user.name), "NA", user.name) as user.name<br />\| if (isEmpty(actor), "Unassigned", actor) as actor<br />\| if(isEmpty(cloud.account.id), "NA", cloud.account.id) as cloud.account.id<br /><br />// global filters<br />\| where if ("{{cloud.instance.id}}" = "\*", true, cloud.instance.id matches "{{cloud.instance.id}}") AND if ("{{event.action}}" = "\*", true, event.action matches "{{event.action}}") AND if ("{{user.name}}" = "\*", true, user.name matches "{{user.name}}") AND if ("{{event.action}}" = "\*", true, event.action matches "{{event.action}}") AND if ("{{client.ip}}" = "\*", true, client.ip matches "{{client.ip}}") AND if ("{{risk.static\_level}}" = "\*", true, risk.static\_level \>= toInt("{{risk.static\_level}}")) AND if ("{{threat.group.name}}" = "\*", true, actor matches "{{threat.group.name}}") AND if ("{{source.user}}" = "\*", true, source.user matches "{{source.user}}}")<br /><br />\| lookup latitude, longitude from geo://location on ip = client.ip<br />\| count by latitude, longitude|
||Threats by Geo Location|Logs|Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS APIs|\_sourceCategory={{CloudTrailLogsdatasource}}  sourceIPAddress !("s3.amazonaws.com")<br />\| json "eventTime", "eventName", "eventSource", "awsRegion", "sourceIPAddress", "errorCode", "userAgent" as event\_time, event.action, eventSource, cloud.region, client.ip, event.outcome, user\_agent nodrop<br />\| json "userIdentity.accountId", "userIdentity.type" as cloud.account.id, user\_identity\_type nodrop<br />\| json field=\_raw "requestParameters.dBInstanceIdentifier", "requestParameters.instancesSet.items[0].instanceId" as db\_instance\_id, cloud\_instance\_id nodrop<br /><br />\| parse regex "\\"(?i)userName\\":\\"(?\<user\_name\>.\*?)\\"" nodrop<br />\| parse "\\"userId\\":\\"\*\\"" as user\_id nodrop<br />\| if (user\_name="", user\_id, user\_name) as user.name<br />\| parse field=eventSource "\*." as cloud.service.name<br />\| parse "\\"accessKeyId\\":\\"\*\\"" as accessKeyId nodrop<br /><br />\| lookup type, actor, raw, threatlevel as malicious\_confidence, threat from sumo://threat/cs on threat=client.ip<br />\| where type="ip\_address"<br /><br />\| if (malicious\_confidence = "low", 1, 0) as risk.static\_level<br />\| if (malicious\_confidence = "medium", 2, risk.static\_level) as risk.static\_level<br />\| if (malicious\_confidence = "high", 3, risk.static\_level) as risk.static\_level<br /><br />// handle empty values<br />\| if(isEmpty(db\_instance\_id),cloud\_instance\_id,db\_instance\_id) as cloud.instance.id<br />\| if(isEmpty(cloud.instance.id),"NA", cloud.instance.id) as cloud.instance.id<br />\| if (isEmpty(event.outcome), "Success", event.outcome) as event.outcome<br />\| if (isEmpty(user.name), "NA", user.name) as user.name<br />\| if (isEmpty(actor), "Unassigned", actor) as actor<br />\| if(isEmpty(cloud.account.id), "NA", cloud.account.id) as cloud.account.id<br /><br />// global filters<br />\| where if ("{{cloud.account.id}}" = "\*", true, cloud.account.id matches "{{cloud.account.id}}") AND if ("{{cloud.region}}" = "\*", true, cloud.region matches "{{cloud.region}}") AND if ("{{event.action}}" = "\*", true, event.action matches "{{event.action}}") AND if ("{{event.outcome}}" = "\*", true, event.outcome matches "{{event.outcome}}") AND if ("{{user.name}}" = "\*", true, user.name matches "{{user.name}}") AND if ("{{client.ip}}" = "\*", true, client.ip matches "{{client.ip}}") AND if ("{{cloud.service.name}}" = "\*", true, cloud.service.name matches "{{cloud.service.name}}") AND if ("{{cloud.instance.id}}" = "\*", true, cloud.instance.id matches "{{cloud.instance.id}}") AND if ("{{threat.group.name}}" = "\*", true, actor matches "{{threat.group.name}}") AND if ("{{risk.static\_level}}" = "\*", true, risk.static\_level \>= toInt("{{risk.static\_level}}"))<br /><br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families nodrop<br />\| json field=raw "last\_updated" as last\_updated nodrop<br />\| formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated<br />\| json field=raw "labels[\*].name" as label\_name nodrop<br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br /><br />\| lookup latitude, longitude from geo://location on ip = client.ip<br />\| count by latitude, longitude, label\_name, threat\_last\_updated|
||Threats by Resource|Logs|Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS Storage|\_sourceCategory={{CloudTrailLogsdatasource}}  "s3.amazonaws.com"<br />\| json "userIdentity", "eventTime", "eventSource", "eventName", "awsRegion", "sourceIPAddress", "userAgent", "errorCode", "requestParameters", "eventType" as userIdentity, event\_time, eventSource, event.action, cloud.region, client.ip, user\_agent, event.outcome, requestParameters, eventType nodrop<br />\| where eventSource = "s3.amazonaws.com"<br />\| json field=userIdentity "type", "accountId" as userType, cloud.account.id<br />\| json field=requestParameters "bucketName" as cloud.instance.id<br />\| parse field=eventSource "\*." as cloud.service.name<br />\| if (userType matches("IAMUser"), "user", "machine") as event.agent<br />\| parse regex "\\"(?i)userName\\":\\"(?\<user\_name\>.\*?)\\"" nodrop<br />\| parse "\\"userId\\":\\"\*\\"" as user\_id nodrop<br />\| if (user\_name="", user\_id, user\_name) as user.name<br /><br />\| lookup type, actor, raw, threatlevel as malicious\_confidence, threat from sumo://threat/cs on threat=client.ip<br />\| where type="ip\_address"<br /><br />\| if (malicious\_confidence = "low", 1, 0) as risk.static\_level<br />\| if (malicious\_confidence = "medium", 2, risk.static\_level) as risk.static\_level<br />\| if (malicious\_confidence = "high", 3, risk.static\_level) as risk.static\_level<br /><br />// handle empty values<br />\| if (isEmpty(event.outcome), "Success", event.outcome) as event.outcome<br />\| if (isEmpty(user.name), "NA", user.name) as user.name<br />\| if (isEmpty(actor), "Unassigned", actor) as actor<br />\| if(isEmpty(cloud.account.id), "NA", cloud.account.id) as cloud.account.id<br /><br />// global filters<br />\| where if ("{{cloud.instance.id}}" = "\*", true, cloud.instance.id matches "{{cloud.instance.id}}") AND if ("{{event.action}}" = "\*", true, event.action matches "{{event.action}}") AND if ("{{user.name}}" = "\*", true, user.name matches "{{user.name}}") AND if ("{{event.action}}" = "\*", true, event.action matches "{{event.action}}") AND if ("{{client.ip}}" = "\*", true, client.ip matches "{{client.ip}}") AND if ("{{risk.static\_level}}" = "\*", true, risk.static\_level \>= toInt("{{risk.static\_level}}")) AND if ("{{threat.group.name}}" = "\*", true, actor matches "{{threat.group.name}}") AND if ("{{source.user}}" = "\*", true, source.user matches "{{source.user}}}")<br /><br />\| count by cloud.instance.id, client.ip, user.name, risk.static\_level<br />\| sort by \_count|
||Threats by Resource|Logs|Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS APIs|\_sourceCategory={{CloudTrailLogsdatasource}}  sourceIPAddress !("s3.amazonaws.com")<br />\| json "eventTime", "eventName", "eventSource", "awsRegion", "sourceIPAddress", "errorCode", "userAgent" as event\_time, event.action, eventSource, cloud.region, client.ip, event.outcome, user\_agent nodrop<br />\| json "userIdentity.accountId", "userIdentity.type" as cloud.account.id, user\_identity\_type nodrop<br />\| json field=\_raw "requestParameters.dBInstanceIdentifier", "requestParameters.instancesSet.items[0].instanceId" as db\_instance\_id, cloud\_instance\_id nodrop<br /><br />\| parse regex "\\"(?i)userName\\":\\"(?\<user\_name\>.\*?)\\"" nodrop<br />\| parse "\\"userId\\":\\"\*\\"" as user\_id nodrop<br />\| if (user\_name="", user\_id, user\_name) as user.name<br />\| parse field=eventSource "\*." as cloud.service.name<br />\| parse "\\"accessKeyId\\":\\"\*\\"" as accessKeyId nodrop<br /><br />\| lookup type, actor, raw, threatlevel as malicious\_confidence, threat from sumo://threat/cs on threat=client.ip<br />\| where type="ip\_address"<br /><br />\| if (malicious\_confidence = "low", 1, 0) as risk.static\_level<br />\| if (malicious\_confidence = "medium", 2, risk.static\_level) as risk.static\_level<br />\| if (malicious\_confidence = "high", 3, risk.static\_level) as risk.static\_level<br /><br />// handle empty values<br />\| if(isEmpty(db\_instance\_id),cloud\_instance\_id,db\_instance\_id) as cloud.instance.id<br />\| if(isEmpty(cloud.instance.id),"NA", cloud.instance.id) as cloud.instance.id<br />\| if (isEmpty(event.outcome), "Success", event.outcome) as event.outcome<br />\| if (isEmpty(user.name), "NA", user.name) as user.name<br />\| if (isEmpty(actor), "Unassigned", actor) as actor<br />\| if(isEmpty(cloud.account.id), "NA", cloud.account.id) as cloud.account.id<br /><br />// global filters<br />\| where if ("{{cloud.account.id}}" = "\*", true, cloud.account.id matches "{{cloud.account.id}}") AND if ("{{cloud.region}}" = "\*", true, cloud.region matches "{{cloud.region}}") AND if ("{{event.action}}" = "\*", true, event.action matches "{{event.action}}") AND if ("{{event.outcome}}" = "\*", true, event.outcome matches "{{event.outcome}}") AND if ("{{user.name}}" = "\*", true, user.name matches "{{user.name}}") AND if ("{{client.ip}}" = "\*", true, client.ip matches "{{client.ip}}") AND if ("{{cloud.service.name}}" = "\*", true, cloud.service.name matches "{{cloud.service.name}}") AND if ("{{cloud.instance.id}}" = "\*", true, cloud.instance.id matches "{{cloud.instance.id}}") AND if ("{{threat.group.name}}" = "\*", true, actor matches "{{threat.group.name}}") AND if ("{{risk.static\_level}}" = "\*", true, risk.static\_level \>= toInt("{{risk.static\_level}}"))<br /><br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families nodrop<br />\| json field=raw "last\_updated" as last\_updated nodrop<br />\| formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated<br />\| json field=raw "labels[\*].name" as label\_name nodrop<br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br /><br />\| count by client.ip, event.action, user.name, cloud.account.id, cloud.region, cloud.instance.id, cloud.service.name, user\_identity\_type, accessKeyId<br />\| sum(\_count) as total\_threats by client.ip, event.action,user\_identity\_type,user.name,accessKeyId , cloud.account.id, cloud.region, cloud.instance.id, cloud.service.name<br />\| sort by total\_threats|
||Threats Count|Logs|Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS APIs|\_sourceCategory={{CloudTrailLogsdatasource}}  sourceIPAddress !("s3.amazonaws.com")<br />\| json "eventTime", "eventName", "eventSource", "awsRegion", "sourceIPAddress", "errorCode", "userAgent" as event\_time, event.action, eventSource, cloud.region, client.ip, event.outcome, user\_agent nodrop<br />\| json "userIdentity.accountId", "userIdentity.type" as cloud.account.id, user\_identity\_type nodrop<br />\| json field=\_raw "requestParameters.dBInstanceIdentifier", "requestParameters.instancesSet.items[0].instanceId" as db\_instance\_id, cloud\_instance\_id nodrop<br /><br />\| parse regex "\\"(?i)userName\\":\\"(?\<user\_name\>.\*?)\\"" nodrop<br />\| parse "\\"userId\\":\\"\*\\"" as user\_id nodrop<br />\| if (user\_name="", user\_id, user\_name) as user.name <br />\| parse field=eventSource "\*." as cloud.service.name<br />\| parse "\\"accessKeyId\\":\\"\*\\"" as accessKeyId nodrop<br /><br />\| lookup type, actor, raw, threatlevel as malicious\_confidence, threat from sumo://threat/cs on threat=client.ip<br />\| where type="ip\_address"<br /><br />\| if (malicious\_confidence = "low", 1, 0) as risk.static\_level<br />\| if (malicious\_confidence = "medium", 2, risk.static\_level) as risk.static\_level<br />\| if (malicious\_confidence = "high", 3, risk.static\_level) as risk.static\_level<br /><br />// handle empty values<br />\| if(isEmpty(db\_instance\_id),cloud\_instance\_id,db\_instance\_id) as cloud.instance.id<br />\| if(isEmpty(cloud.instance.id),"NA", cloud.instance.id) as cloud.instance.id<br />\| if (isEmpty(event.outcome), "Success", event.outcome) as event.outcome<br />\| if (isEmpty(user.name), "NA", user.name) as user.name<br />\| if (isEmpty(actor), "Unassigned", actor) as actor<br />\| if(isEmpty(cloud.account.id), "NA", cloud.account.id) as cloud.account.id<br /><br />// global filters<br />\| where if ("{{cloud.account.id}}" = "\*", true, cloud.account.id matches "{{cloud.account.id}}") AND if ("{{cloud.region}}" = "\*", true, cloud.region matches "{{cloud.region}}") AND if ("{{event.action}}" = "\*", true, event.action matches "{{event.action}}") AND if ("{{event.outcome}}" = "\*", true, event.outcome matches "{{event.outcome}}") AND if ("{{user.name}}" = "\*", true, user.name matches "{{user.name}}") AND if ("{{client.ip}}" = "\*", true, client.ip matches "{{client.ip}}") AND if ("{{cloud.service.name}}" = "\*", true, cloud.service.name matches "{{cloud.service.name}}") AND if ("{{cloud.instance.id}}" = "\*", true, cloud.instance.id matches "{{cloud.instance.id}}") AND if ("{{threat.group.name}}" = "\*", true, actor matches "{{threat.group.name}}") AND if ("{{risk.static\_level}}" = "\*", true, risk.static\_level \>= toInt("{{risk.static\_level}}"))<br /><br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families nodrop<br />\| json field=raw "last\_updated" as last\_updated nodrop<br />\| formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated<br />\| json field=raw "labels[\*].name" as label\_name nodrop<br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br /><br />\| count|
||Threats Count|Logs|Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS Storage|\_sourceCategory={{CloudTrailLogsdatasource}}  "s3.amazonaws.com"<br />\| json "userIdentity", "eventTime", "eventSource", "eventName", "awsRegion", "sourceIPAddress", "userAgent", "errorCode", "requestParameters", "eventType" as userIdentity, event\_time, eventSource, event.action, cloud.region, client.ip, user\_agent, event.outcome, requestParameters, eventType nodrop<br />\| where eventSource = "s3.amazonaws.com"<br />\| json field=userIdentity "type", "accountId" as userType, cloud.account.id<br />\| json field=requestParameters "bucketName" as cloud.instance.id<br />\| parse field=eventSource "\*." as cloud.service.name<br />\| if (userType matches("IAMUser"), "user", "machine") as event.agent<br />\| parse regex "\\"(?i)userName\\":\\"(?\<user\_name\>.\*?)\\"" nodrop<br />\| parse "\\"userId\\":\\"\*\\"" as user\_id nodrop<br />\| if (user\_name="", user\_id, user\_name) as user.name<br /><br />\| lookup type, actor, raw, threatlevel as malicious\_confidence, threat from sumo://threat/cs on threat=client.ip<br />\| where type="ip\_address"<br /><br />\| if (malicious\_confidence = "low", 1, 0) as risk.static\_level<br />\| if (malicious\_confidence = "medium", 2, risk.static\_level) as risk.static\_level<br />\| if (malicious\_confidence = "high", 3, risk.static\_level) as risk.static\_level<br /><br />// handle empty values<br />\| if (isEmpty(event.outcome), "Success", event.outcome) as event.outcome<br />\| if (isEmpty(user.name), "NA", user.name) as user.name<br />\| if (isEmpty(actor), "Unassigned", actor) as actor<br />\| if(isEmpty(cloud.account.id), "NA", cloud.account.id) as cloud.account.id<br /><br />// global filters<br />\| where if ("{{cloud.instance.id}}" = "\*", true, cloud.instance.id matches "{{cloud.instance.id}}") AND if ("{{event.action}}" = "\*", true, event.action matches "{{event.action}}") AND if ("{{user.name}}" = "\*", true, user.name matches "{{user.name}}") AND if ("{{event.action}}" = "\*", true, event.action matches "{{event.action}}") AND if ("{{client.ip}}" = "\*", true, client.ip matches "{{client.ip}}") AND if ("{{risk.static\_level}}" = "\*", true, risk.static\_level \>= toInt("{{risk.static\_level}}")) AND if ("{{threat.group.name}}" = "\*", true, actor matches "{{threat.group.name}}") AND if ("{{source.user}}" = "\*", true, source.user matches "{{source.user}}}")<br /><br />\| count|
||Threats Trend|Logs|Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS Storage|\_sourceCategory={{CloudTrailLogsdatasource}}  "s3.amazonaws.com"<br />\| json "userIdentity", "eventTime", "eventSource", "eventName", "awsRegion", "sourceIPAddress", "userAgent", "errorCode", "requestParameters", "eventType" as userIdentity, event\_time, eventSource, event.action, cloud.region, client.ip, user\_agent, event.outcome, requestParameters, eventType nodrop<br />\| where eventSource = "s3.amazonaws.com"<br />\| json field=userIdentity "type", "accountId" as userType, cloud.account.id<br />\| json field=requestParameters "bucketName" as cloud.instance.id<br />\| parse field=eventSource "\*." as cloud.service.name<br />\| parse regex "\\"(?i)userName\\":\\"(?\<user\_name\>.\*?)\\"" nodrop<br />\| parse "\\"userId\\":\\"\*\\"" as user\_id nodrop<br />\| if (user\_name="", user\_id, user\_name) as user.name<br /><br />\| if (userType matches("IAMUser"), "user", "machine") as event.agent<br /><br />\| lookup type, actor, raw, threatlevel as malicious\_confidence, threat from sumo://threat/cs on threat=client.ip<br />\| where type="ip\_address"<br /><br />\| if (malicious\_confidence = "low", 1, 0) as risk.static\_level<br />\| if (malicious\_confidence = "medium", 2, risk.static\_level) as risk.static\_level<br />\| if (malicious\_confidence = "high", 3, risk.static\_level) as risk.static\_level<br /><br />// handle empty values<br />\| if (isEmpty(event.outcome), "Success", event.outcome) as event.outcome<br />\| if (isEmpty(user.name), "NA", user.name) as user.name<br />\| if (isEmpty(actor), "Unassigned", actor) as actor<br />\| if(isEmpty(cloud.account.id), "NA", cloud.account.id) as cloud.account.id<br /><br />// global filters<br />\| where if ("{{cloud.instance.id}}" = "\*", true, cloud.instance.id matches "{{cloud.instance.id}}") AND if ("{{event.action}}" = "\*", true, event.action matches "{{event.action}}") AND if ("{{user.name}}" = "\*", true, user.name matches "{{user.name}}") AND if ("{{event.action}}" = "\*", true, event.action matches "{{event.action}}") AND if ("{{client.ip}}" = "\*", true, client.ip matches "{{client.ip}}") AND if ("{{risk.static\_level}}" = "\*", true, risk.static\_level \>= toInt("{{risk.static\_level}}")) AND if ("{{threat.group.name}}" = "\*", true, actor matches "{{threat.group.name}}") AND if ("{{source.user}}" = "\*", true, source.user matches "{{source.user}}}")<br /><br />\| timeslice 1d<br />\| count by \_timeslice<br />\| fillmissing timeslice|
||Threats Trend|Logs|Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS APIs|\_sourceCategory={{CloudTrailLogsdatasource}}  sourceIPAddress !("s3.amazonaws.com")<br />\| json "eventTime", "eventName", "eventSource", "awsRegion", "sourceIPAddress", "errorCode", "userAgent" as event\_time, event.action, eventSource, cloud.region, client.ip, event.outcome, user\_agent nodrop<br />\| json "userIdentity.accountId", "userIdentity.type" as cloud.account.id, user\_identity\_type nodrop<br />\| json field=\_raw "requestParameters.dBInstanceIdentifier", "requestParameters.instancesSet.items[0].instanceId" as db\_instance\_id, cloud\_instance\_id nodrop<br /><br />\| parse regex "\\"(?i)userName\\":\\"(?\<user\_name\>.\*?)\\"" nodrop<br />\| parse "\\"userId\\":\\"\*\\"" as user\_id nodrop<br />\| if (user\_name="", user\_id, user\_name) as user.name <br />\| parse field=eventSource "\*." as cloud.service.name<br />\| parse "\\"accessKeyId\\":\\"\*\\"" as accessKeyId nodrop<br /><br />\| lookup type, actor, raw, threatlevel as malicious\_confidence, threat from sumo://threat/cs on threat=client.ip<br />\| where type="ip\_address"<br /><br />\| if (malicious\_confidence = "low", 1, 0) as risk.static\_level<br />\| if (malicious\_confidence = "medium", 2, risk.static\_level) as risk.static\_level<br />\| if (malicious\_confidence = "high", 3, risk.static\_level) as risk.static\_level<br /><br />// handle empty values<br />\| if(isEmpty(db\_instance\_id),cloud\_instance\_id,db\_instance\_id) as cloud.instance.id<br />\| if(isEmpty(cloud.instance.id),"NA", cloud.instance.id) as cloud.instance.id<br />\| if (isEmpty(event.outcome), "Success", event.outcome) as event.outcome<br />\| if (isEmpty(user.name), "NA", user.name) as user.name<br />\| if (isEmpty(actor), "Unassigned", actor) as actor<br />\| if(isEmpty(cloud.account.id), "NA", cloud.account.id) as cloud.account.id<br /><br />// global filters<br />\| where if ("{{cloud.account.id}}" = "\*", true, cloud.account.id matches "{{cloud.account.id}}") AND if ("{{cloud.region}}" = "\*", true, cloud.region matches "{{cloud.region}}") AND if ("{{event.action}}" = "\*", true, event.action matches "{{event.action}}") AND if ("{{event.outcome}}" = "\*", true, event.outcome matches "{{event.outcome}}") AND if ("{{user.name}}" = "\*", true, user.name matches "{{user.name}}") AND if ("{{client.ip}}" = "\*", true, client.ip matches "{{client.ip}}") AND if ("{{cloud.service.name}}" = "\*", true, cloud.service.name matches "{{cloud.service.name}}") AND if ("{{cloud.instance.id}}" = "\*", true, cloud.instance.id matches "{{cloud.instance.id}}") AND if ("{{threat.group.name}}" = "\*", true, actor matches "{{threat.group.name}}") AND if ("{{risk.static\_level}}" = "\*", true, risk.static\_level \>= toInt("{{risk.static\_level}}"))<br /><br />\| json field=raw "malware\_families[\*]" as threat\_malware\_families nodrop<br />\| json field=raw "last\_updated" as last\_updated nodrop<br />\| formatDate(fromseconds(last\_updated), "MM-dd-yyyy") as threat\_last\_updated<br />\| json field=raw "labels[\*].name" as label\_name nodrop<br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br /><br />\| timeslice 1d<br />\| count by \_timeslice<br />\| fillmissing timeslice|
||Total Findings|Logs|Installed Apps/Cloud Infrastructure Security for AWS/Active Threats: AWS Resources|\_sourceCategory={{GuardDutyLogsdatasource}}  <br />\| json "accountId", "region", "partition", "id", "arn", "type","service.serviceName","service.detectorId","service.action","severity","title","description", "vpcId", "subnetId", "groupId" , "tags", "groupName", "resource.instanceDetails", "resource.accessKeyDetails.userName" as cloud.account.id, cloud.region, partition, id, arn, type, service\_name, detector\_id, action, severity\_level, title, description, vpcId, subnetId , securityGroupId, tags, securityGroupName, instanceDetails, user.name nodrop<br /><br />\| json field=instanceDetails "instanceId", "instanceType","networkInterfaces[0].publicIp" as instanceid, cloud.machine.type, server.ip<br />\| json field=\_raw "resource.resourceType" as resourceType<br />\| json field=\_raw "resource.s3BucketDetails[0].name" as bucketName nodrop<br />\| if (resourceType = "S3Bucket", bucketName, instanceid) as cloud.instance.id<br /><br />\| json field=action "awsApiCallAction.remoteIpDetails.ipAddressV4", "networkConnectionAction.remoteIpDetails.ipAddressV4","networkConnectionAction.localPortDetails.port" as awsCallActionIp, networkActionIp, localPort nodrop<br /><br />\| parse field=type "\*:\*/\*" as threat.tactic.name,cloud.service.name,threat.technique.name <br />\| if (severity\_level = 0, 0, 0) as risk.static\_level<br />\| if (severity\_level \> 0 and severity\_level \<= 2, 1, risk.static\_level) as risk.static\_level<br />\| if (severity\_level \> 2 and severity\_level \<= 5, 2, risk.static\_level) as risk.static\_level<br />\| if (severity\_level \> 5 and severity\_level \<= 9, 3, risk.static\_level) as risk.static\_level<br />\| if (severity\_level \> 9, 3, risk.static\_level) as risk.static\_level<br /><br />// handle empty values<br />\| if(isEmpty(user.name), "NA", user.name) as user.name<br />\| if(isEmpty(awsCallActionIp), if (isEmpty(networkActionIp), "NA",networkActionIp) , awsCallActionIp) as client.ip<br />\| if(isEmpty(cloud.account.id), "NA", cloud.account.id) as cloud.account.id<br /><br />// global filters<br />\| where if ("{{cloud.account.id}}" = "\*", true, cloud.account.id matches "{{cloud.account.id}}") AND if ("{{cloud.region}}" = "\*", true, cloud.region matches "{{cloud.region}}") AND if ("{{cloud.instance.id}}" = "\*", true, cloud.instance.id matches "{{cloud.instance.id}}") AND if ("{{server.ip}}" = "\*", true, server.ip matches "{{server.ip}}") AND if ("{{risk.static\_level}}" = "\*", true, risk.static\_level \>= toInt("{{risk.static\_level}}")) AND if ("{{threat.tactic.name}}" = "\*", true, threat.tactic.name matches "{{threat.tactic.name}}") AND if ("{{cloud.service.name}}" = "\*", true, cloud.service.name matches "{{cloud.service.name}}") AND if ("{{user.name}}" = "\*", true, user.name matches "{{user.name}}") AND if ("{{client.ip}}" = "\*", true, client.ip matches "{{client.ip}}")<br /><br />\| count|

