# AWS CloudTrail
## Sumo Logic App For: AWS CloudTrail
The Sumo Logic App for AWS CloudTrail helps you monitor your AWS deployments, with predefined dashboards that present user and administrator activity, network and security information, CloudTrail console logins, and information about your S3 buckets and public objects.
Docs Link: [AWS CloudTrail](https://help.sumologic.com/?cid=5068)

## Searches

### Log Searches

- **Administrative Activities Over Time**: from Dashboard: AWS CloudTrail/AWS CloudTrail - User Monitoring - New 
- **Created and Deleted Network and Security Events**: from Dashboard: AWS CloudTrail/AWS CloudTrail - Overview - New 
- **Created Resources**: from Dashboard: AWS CloudTrail/AWS CloudTrail - Overview - New 
- **Deleted Resources Over Time**: from Dashboard: AWS CloudTrail/AWS CloudTrail - Overview - New 
- **Failed Logins**: from Dashboard: AWS CloudTrail/AWS CloudTrail - Overview - New 
- **Geo Location of All Users**: from Dashboard: AWS CloudTrail/AWS CloudTrail - Overview - New 
- **Geo Location of All Users**: from Dashboard: AWS CloudTrail/AWS CloudTrail - User Monitoring - New 
- **Geo Location of All Users**: from Dashboard: AWS CloudTrail/AWS CloudTrail - Console Logins - New 
- **Launched and Terminated Instances by User**: from Dashboard: AWS CloudTrail/AWS CloudTrail - User Monitoring - New 
- **Login Events By User**: from Dashboard: AWS CloudTrail/AWS CloudTrail - Console Logins - New 
- **Login Results - One Day Time Comparison**: from Dashboard: AWS CloudTrail/AWS CloudTrail - Console Logins - New 
- **Logins from Multiple IP**: from Dashboard: AWS CloudTrail/AWS CloudTrail - Console Logins - New 
- **Logins from Outside the USA**: from Dashboard: AWS CloudTrail/AWS CloudTrail - Console Logins - New 
- **Logins Over Time**: from Dashboard: AWS CloudTrail/AWS CloudTrail - Console Logins - New 
- **Logins without MFA**: from Dashboard: AWS CloudTrail/AWS CloudTrail - Console Logins - New 
- **Outlier - Failed Login**: from Dashboard: AWS CloudTrail/AWS CloudTrail - Console Logins - New 
- **Outlier - Success Login**: from Dashboard: AWS CloudTrail/AWS CloudTrail - Console Logins - New 
- **Recent Activity by Administrative Users**: from Dashboard: AWS CloudTrail/AWS CloudTrail - User Monitoring - New 
- **Top 10 Activities by Administrative Users**: from Dashboard: AWS CloudTrail/AWS CloudTrail - User Monitoring - New 
- **Top 10 Users**: from Dashboard: AWS CloudTrail/AWS CloudTrail - Overview - New 
- **Top 10 Users**: from Dashboard: AWS CloudTrail/AWS CloudTrail - User Monitoring - New

### Metric Searches


## Search Table

|app\_topic|search\_name|type|origin|search|
|:--|:--|:--|:--|:--|
|AWS CloudTrail|Administrative Activities Over Time|Logs|AWS CloudTrail/AWS CloudTrail - User Monitoring - New|\_sourceCategory = Labs/AWS/CloudTrail\* <br />\| parse "\\"userName\\":\\"\*\\"" as user\_name nodrop<br />\| json field=\_raw "userIdentity.principalId" as principal\_id nodrop<br />\| parse regex field = principal\_id ":(?\<user\_principal\>.+)" nodrop<br />\| if (user\_name="", user\_principal, user\_name) as user <br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name<br />\| parse regex field=event\_name "^(?\<event\_type\>[A-Z][a-z]+?)[A-Z]"<br />\| where event\_type not in ("Get","Describe","List")<br />\| lookup admin\_user from /shared/aws/cloudtrail/admin\_users on admin\_user=user <br />\| where !isNull(admin\_user) <br />\| timeslice 1h<br />\|where if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}")<br />\|count \_timeslice,user<br />\| transpose row \_timeslice column user|
|AWS CloudTrail|Created and Deleted Network and Security Events|Logs|AWS CloudTrail/AWS CloudTrail - Overview - New|\_sourceCategory = Labs/AWS/CloudTrail\* (\*Security\* OR \*Network\*) <br />\| parse "\\"userName\\":\\"\*\\"" as user\_name nodrop<br />\| json field=\_raw "userIdentity.principalId" as principal\_id nodrop<br />\| parse regex field = principal\_id ":(?\<user\_principal\>.+)" nodrop<br />\| if (user\_name="", user\_principal, user\_name) as user <br />\| parse "\\"eventName\\":\\"\*\\"" as event<br />\| parse regex field=event "^(?\<event\_type\>[A-Z][a-z]+?)[A-Z]"<br />\| where (event matches "\*Security\*" OR event matches "\*Network\*") and event\_type in ("Create","Delete")<br />\|where if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}")<br />\|count by event <br />\| sort \_count|
|AWS CloudTrail|Created Resources|Logs|AWS CloudTrail/AWS CloudTrail - Overview - New|\_sourceCategory = Labs/AWS/CloudTrail\* (Create\* OR Run\*)<br />\| parse "\\"userName\\":\\"\*\\"" as user\_name nodrop<br />\| json field=\_raw "userIdentity.principalId" as principal\_id nodrop<br />\| parse regex field = principal\_id ":(?\<user\_principal\>.+)" nodrop<br />\| if (user\_name="", user\_principal, user\_name) as user <br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name<br />\| parse regex field=event\_name "^(?:Create\|Run)(?\<resource\_type\>[A-Z][A-Za-z]+)"<br />\|where if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}")<br />\|count by resource\_type|
|AWS CloudTrail|Deleted Resources Over Time|Logs|AWS CloudTrail/AWS CloudTrail - Overview - New|\_sourceCategory = Labs/AWS/CloudTrail\* Delete\*<br />\| parse "\\"userName\\":\\"\*\\"" as user\_name nodrop<br />\| json field=\_raw "userIdentity.principalId" as principal\_id nodrop<br />\| parse regex field = principal\_id ":(?\<user\_principal\>.+)" nodrop<br />\| if (user\_name="", user\_principal, user\_name) as user <br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name<br />\| parse regex field=event\_name "^(?:Delete)(?\<resource\_type\>[A-Z][A-Za-z]+)"<br />\|where if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}")<br />\|count resource\_type<br />\| sort by \_count|
|AWS CloudTrail|Failed Logins|Logs|AWS CloudTrail/AWS CloudTrail - Overview - New|\_sourceCategory = Labs/AWS/CloudTrail\* ConsoleLogin Failure<br />\| parse "\\"eventName\\":\\"\*\\"" as eventName nodrop<br />\| parse "\\"responseElements\\":{\\"ConsoleLogin\\":\\"\*\\"}" as loginResult nodrop<br />\| where eventName="ConsoleLogin" and loginresult="Failure"<br />\|where if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}")<br />\|count by loginResult|
|AWS CloudTrail|Geo Location of All Users|Logs|AWS CloudTrail/AWS CloudTrail - Overview - New|\_sourceCategory = Labs/AWS/CloudTrail\* sourceIPAddress <br />\| json "sourceIPAddress"<br />\|where if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}")<br />\|count by sourceIPAddress<br />\| lookup latitude, longitude, country\_code, country\_name, region, city, postal\_code from geo://location on ip = sourceIPAddress<br />\| where !isNull(latitude)<br />\| sum(\_count) as \_count by latitude, longitude, country\_code, country\_name, region, city, postal\_code<br />\| sort by \_count|
|AWS CloudTrail|Geo Location of All Users|Logs|AWS CloudTrail/AWS CloudTrail - User Monitoring - New|\_sourceCategory = Labs/AWS/CloudTrail\* sourceIPAddress <br />\| json "sourceIPAddress"<br />\|where if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}")<br />\|count by sourceIPAddress<br />\| lookup latitude, longitude, country\_code, country\_name, region, city, postal\_code from geo://location on ip = sourceIPAddress<br />\| where !isNull(latitude)<br />\| sum(\_count) as \_count by latitude, longitude, country\_code, country\_name, region, city, postal\_code<br />\| sort by \_count|
|AWS CloudTrail|Geo Location of All Users|Logs|AWS CloudTrail/AWS CloudTrail - Console Logins - New|\_sourceCategory = Labs/AWS/CloudTrail <br />\| json "sourceIPAddress"<br />\| parse "\\"eventName\\":\\"\*\\"" as eventName nodrop<br />\| parse "\\"userName\\":\\"\*\\"" as user\_name nodrop<br />\| json field=\_raw "userIdentity.principalId" as principal\_id nodrop<br />\| parse regex field = principal\_id ":(?\<user\_principal\>.+)" nodrop<br />\| if (user\_name="", user\_principal, user\_name) as user <br />\| parse "\\"responseElements\\":{\\"ConsoleLogin\\":\\"\*\\"}" as loginResult nodrop<br />\| parse "\\"MFAUsed\\":\\"\*\\"" as mfaUsed nodrop<br />\| where eventName="ConsoleLogin"<br />\|where if ("{{user}}" = "\*", true, user matches "{{user}}")<br />\|count by sourceIPAddress<br />\| lookup latitude, longitude, country\_code, country\_name, region, city, postal\_code from geo://location on ip = sourceIPAddress<br />\| where !isNull(latitude)<br />\| sum(\_count) as \_count by latitude, longitude, country\_code, country\_name, region, city, postal\_code<br />\| sort by \_count|
|AWS CloudTrail|Launched and Terminated Instances by User|Logs|AWS CloudTrail/AWS CloudTrail - User Monitoring - New|\_sourceCategory = Labs/AWS/CloudTrail\*  ("TerminateInstances" OR "RunInstances")<br />\| parse "\\"userName\\":\\"\*\\"" as user\_name nodrop<br />\| json field=\_raw "userIdentity.principalId" as principal\_id nodrop<br />\| parse regex field = principal\_id ":(?\<user\_principal\>.+)" nodrop<br />\| if (user\_name="", user\_principal, user\_name) as user <br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name<br />\| where event\_name in ("TerminateInstances","RunInstances")<br />\| if(event\_name="RunInstances","Launch-Instance","Terminate-Instance") as event\_name<br />\|where if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}")<br />\|count as count by user,event\_name<br />\| transpose row user column event\_name|
|AWS CloudTrail|Login Events By User|Logs|AWS CloudTrail/AWS CloudTrail - Console Logins - New|\_sourceCategory = Labs/AWS/CloudTrail\* "ConsoleLogin"<br />\| parse "\\"eventName\\":\\"\*\\"" as eventName nodrop<br />\| where eventName="ConsoleLogin"<br />\| parse "\\"sourceIPAddress\\":\\"\*\\"" as sourceIPAddress nodrop<br />\| parse "\\"userName\\":\\"\*\\"" as user\_name nodrop<br />\| json field=\_raw "userIdentity.principalId" as principal\_id nodrop<br />\| parse regex field = principal\_id ":(?\<user\_principal\>.+)" nodrop<br />\| if (user\_name="", user\_principal, user\_name) as user <br />\| json field=\_raw "responseElements.ConsoleLogin" as loginResult nodrop<br />\| parse "\\"MFAUsed\\":\\"\*\\"" as mfaUsed nodrop<br />\| timeslice 1h<br />\|where if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{loginresult}}" = "\*", true, loginresult matches "{{loginresult}}")<br />\|count by \_timeslice, user<br />\| transpose row \_timeslice column  user|
|AWS CloudTrail|Login Results - One Day Time Comparison|Logs|AWS CloudTrail/AWS CloudTrail - Console Logins - New|\_sourceCategory = Labs/AWS/CloudTrail\*  "ConsoleLogin" <br />\| parse "\\"eventName\\":\\"\*\\"" as eventName nodrop<br />\| where eventName="ConsoleLogin"<br />\| parse "\\"sourceIPAddress\\":\\"\*\\"" as sourceIPAddress nodrop<br />\| parse "\\"userName\\":\\"\*\\"" as user\_name nodrop<br />\| json field=\_raw "userIdentity.principalId" as principal\_id nodrop<br />\| parse regex field = principal\_id ":(?\<user\_principal\>.+)" nodrop<br />\| if (user\_name="", user\_principal, user\_name) as user <br />\| json field=\_raw "responseElements.ConsoleLogin" as loginResult nodrop<br />\| parse "\\"MFAUsed\\":\\"\*\\"" as mfaUsed nodrop<br />\|where if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{loginresult}}" = "\*", true, loginresult matches "{{loginresult}}")<br />\|count by loginResult<br />\| compare with timeshift 1d|
|AWS CloudTrail|Logins from Multiple IP|Logs|AWS CloudTrail/AWS CloudTrail - Console Logins - New|\_sourceCategory = Labs/AWS/CloudTrail\*  "ConsoleLogin" <br />\| parse "\\"eventName\\":\\"\*\\"" as eventName nodrop<br />\| where eventName="ConsoleLogin"<br />\| parse "\\"sourceIPAddress\\":\\"\*\\"" as sourceIPAddress nodrop<br />\| parse "\\"userName\\":\\"\*\\"" as user\_name nodrop<br />\| json field=\_raw "userIdentity.principalId" as principal\_id nodrop<br />\| parse regex field = principal\_id ":(?\<user\_principal\>.+)" nodrop<br />\| if (user\_name="", user\_principal, user\_name) as user <br />\| json field=\_raw "responseElements.ConsoleLogin" as loginResult nodrop<br />\| parse "\\"MFAUsed\\":\\"\*\\"" as mfaUsed nodrop<br />\|where if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{loginresult}}" = "\*", true, loginresult matches "{{loginresult}}")<br />\|count\_distinct(sourceIPAddress) as instances by user<br />\| where instances \> 1<br />\| sort by instances, user asc|
|AWS CloudTrail|Logins from Outside the USA|Logs|AWS CloudTrail/AWS CloudTrail - Console Logins - New|\_sourceCategory = Labs/AWS/CloudTrail\*  "ConsoleLogin" <br />\| parse "\\"eventName\\":\\"\*\\"" as eventName nodrop<br />\| where eventName="ConsoleLogin"<br />\| json "sourceIPAddress"<br />\| parse "\\"userName\\":\\"\*\\"" as user\_name nodrop<br />\| json field=\_raw "userIdentity.principalId" as principal\_id nodrop<br />\| parse regex field = principal\_id ":(?\<user\_principal\>.+)" nodrop<br />\| if (user\_name="", user\_principal, user\_name) as user <br />\| json field=\_raw "responseElements.ConsoleLogin" as loginResult nodrop<br />\| parse "\\"MFAUsed\\":\\"\*\\"" as mfaUsed nodrop<br />\|where if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{loginresult}}" = "\*", true, loginresult matches "{{loginresult}}")<br />\|count by sourceIPAddress, user, loginresult<br />\| lookup latitude, longitude, country\_code, country\_name, region, city, postal\_code from geo://location on ip = sourceIPAddress<br />\| where country\_code\<\>"US" and !isNull(latitude)<br />\| fields user, country\_code, loginresult, \_count<br />\| sort by \_count, country\_code asc, user, loginresult|
|AWS CloudTrail|Logins Over Time|Logs|AWS CloudTrail/AWS CloudTrail - Console Logins - New|\_sourceCategory = Labs/AWS/CloudTrail\*  "ConsoleLogin" <br />\| parse "\\"eventName\\":\\"\*\\"" as eventName nodrop<br />\| where eventName="ConsoleLogin"<br />\| parse "\\"sourceIPAddress\\":\\"\*\\"" as sourceIPAddress nodrop<br />\| parse "\\"userName\\":\\"\*\\"" as user\_name nodrop<br />\| json field=\_raw "userIdentity.principalId" as principal\_id nodrop<br />\| parse regex field = principal\_id ":(?\<user\_principal\>.+)" nodrop<br />\| if (user\_name="", user\_principal, user\_name) as user <br />\| json field=\_raw "responseElements.ConsoleLogin" as loginResult nodrop<br />\| parse "\\"MFAUsed\\":\\"\*\\"" as mfaUsed nodrop<br />\| timeslice 1h<br />\|where if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{loginresult}}" = "\*", true, loginresult matches "{{loginresult}}")<br />\|count by \_timeslice, loginResult<br />\| transpose row \_timeslice column loginResult|
|AWS CloudTrail|Logins without MFA|Logs|AWS CloudTrail/AWS CloudTrail - Console Logins - New|\_sourceCategory = Labs/AWS/CloudTrail\*  "ConsoleLogin" "\\"MFAUsed\\":\\"No\\""<br />\| parse "\\"eventName\\":\\"\*\\"" as eventName nodrop<br />\| where eventName="ConsoleLogin"<br />\| parse "\\"sourceIPAddress\\":\\"\*\\"" as sourceIPAddress nodrop<br />\| parse "\\"userName\\":\\"\*\\"" as user\_name nodrop<br />\| json field=\_raw "userIdentity.principalId" as principal\_id nodrop<br />\| parse regex field = principal\_id ":(?\<user\_principal\>.+)" nodrop<br />\| if (user\_name="", user\_principal, user\_name) as user <br />\| json field=\_raw "responseElements.ConsoleLogin" as loginResult nodrop<br />\| parse "\\"MFAUsed\\":\\"\*\\"" as mfaUsed nodrop<br />\| where mfaUsed\<\>"Yes"<br />\|where if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{loginresult}}" = "\*", true, loginresult matches "{{loginresult}}")<br />\|count by user, loginresult<br />\| sort by \_count, user, loginresult|
|AWS CloudTrail|Outlier - Failed Login|Logs|AWS CloudTrail/AWS CloudTrail - Console Logins - New|\_sourceCategory = Labs/AWS/CloudTrail\*  "ConsoleLogin" "Failure"<br />\| parse "\\"eventName\\":\\"\*\\"" as eventName nodrop<br />\| where eventName="ConsoleLogin"<br />\| parse "\\"sourceIPAddress\\":\\"\*\\"" as sourceIPAddress nodrop<br />\| parse "\\"userName\\":\\"\*\\"" as user\_name nodrop<br />\| json field=\_raw "userIdentity.principalId" as principal\_id nodrop<br />\| parse regex field = principal\_id ":(?\<user\_principal\>.+)" nodrop<br />\| if (user\_name="", user\_principal, user\_name) as user <br />\| json field=\_raw "responseElements.ConsoleLogin" as loginResult nodrop<br />\| where loginResult ="Failure"<br />\| parse "\\"MFAUsed\\":\\"\*\\"" as mfaUsed nodrop<br />\| timeslice 1h<br />\|where if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{loginresult}}" = "\*", true, loginresult matches "{{loginresult}}")<br />\|count by \_timeslice<br />\| fillmissing timeslice(1h)<br />\| sort by \_timeslice<br />\| outlier \_count|
|AWS CloudTrail|Outlier - Success Login|Logs|AWS CloudTrail/AWS CloudTrail - Console Logins - New|\_sourceCategory = Labs/AWS/CloudTrail\*  "ConsoleLogin" "Success"<br />\| parse "\\"eventName\\":\\"\*\\"" as eventName nodrop<br />\| where eventName="ConsoleLogin"<br />\| parse "\\"sourceIPAddress\\":\\"\*\\"" as sourceIPAddress nodrop<br />\| parse "\\"userName\\":\\"\*\\"" as user\_name nodrop<br />\| json field=\_raw "userIdentity.principalId" as principal\_id nodrop<br />\| parse regex field = principal\_id ":(?\<user\_principal\>.+)" nodrop<br />\| if (user\_name="", user\_principal, user\_name) as user <br />\| json field=\_raw "responseElements.ConsoleLogin" as loginResult nodrop<br />\| where loginResult ="Success"<br />\| parse "\\"MFAUsed\\":\\"\*\\"" as mfaUsed nodrop<br />\| timeslice 1h<br />\|where if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{loginresult}}" = "\*", true, loginresult matches "{{loginresult}}")<br />\|count by \_timeslice<br />\| fillmissing timeslice(1h)<br />\| sort by \_timeslice<br />\| outlier \_count|
|AWS CloudTrail|Recent Activity by Administrative Users|Logs|AWS CloudTrail/AWS CloudTrail - User Monitoring - New|\_sourceCategory = Labs/AWS/CloudTrail\* <br />\| parse "\\"userName\\":\\"\*\\"" as user\_name nodrop<br />\| json field=\_raw "userIdentity.principalId" as principal\_id nodrop<br />\| parse regex field = principal\_id ":(?\<user\_principal\>.+)" nodrop<br />\| if (user\_name="", user\_principal, user\_name) as user <br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name<br />\| parse "awsRegion\\":\\"\*\\"" as aws\_Region <br />\| parse regex field=event\_name "^(?\<event\_type\>[A-Z][a-z]+?)[A-Z]"<br />\| parse regex "sourceIPAddress\\":\\"(?\<src\_ip\>\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})\\""<br />\| where event\_type not in ("Get","Describe","List")<br />\| lookup admin\_user from /shared/aws/cloudtrail/admin\_users on admin\_user=user <br />\| where !isNull(admin\_user) <br />\| lookup country\_name, city from geo://location on ip = src\_ip<br />\| timeslice 1m<br />\|where if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}")<br />\|count \_timeslice, user, event\_name,aws\_region,country\_name,city<br />\| fields -\_count <br />\| sort \_timeslice <br />\| limit 20|
|AWS CloudTrail|Top 10 Activities by Administrative Users|Logs|AWS CloudTrail/AWS CloudTrail - User Monitoring - New|\_sourceCategory = Labs/AWS/CloudTrail\* <br />\| parse "\\"userName\\":\\"\*\\"" as user\_name nodrop<br />\| json field=\_raw "userIdentity.principalId" as principal\_id nodrop<br />\| parse regex field = principal\_id ":(?\<user\_principal\>.+)" nodrop<br />\| if (user\_name="", user\_principal, user\_name) as user <br />\| parse "\\"eventName\\":\\"\*\\"" as event\_name<br />\| parse regex field=event\_name "^(?\<event\_type\>[A-Z][a-z]+?)[A-Z]"<br />\| where event\_type not in ("Get","Describe","List")<br />\| lookup admin\_user from /shared/aws/cloudtrail/admin\_users on admin\_user=user <br />\| where !isNull(admin\_user)<br />\|where if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}")<br />\|count as count event\_name<br />\| sort count <br />\| limit 10|
|AWS CloudTrail|Top 10 Users|Logs|AWS CloudTrail/AWS CloudTrail - Overview - New|\_sourceCategory = Labs/AWS/CloudTrail\*<br />\| parse "\\"userName\\":\\"\*\\"" as user\_name nodrop<br />\| json field=\_raw "userIdentity.principalId" as principal\_id nodrop<br />\| parse regex field = principal\_id ":(?\<user\_principal\>.+)" nodrop<br />\| if (user\_name="", user\_principal, user\_name) as user<br />\|where if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}")<br />\|count as count by user<br />\| sort count <br />\| limit 10|
|AWS CloudTrail|Top 10 Users|Logs|AWS CloudTrail/AWS CloudTrail - User Monitoring - New|\_sourceCategory = Labs/AWS/CloudTrail\*<br />\| parse "\\"userName\\":\\"\*\\"" as user\_name nodrop<br />\| json field=\_raw "userIdentity.principalId" as principal\_id nodrop<br />\| parse regex field = principal\_id ":(?\<user\_principal\>.+)" nodrop<br />\| if (user\_name="", user\_principal, user\_name) as user<br />\|where if ("{{user}}" = "\*", true, user matches "{{user}}") AND if ("{{event\_name}}" = "\*", true, event\_name matches "{{event\_name}}")<br />\|count as count by user<br />\| sort count <br />\| limit 10|

