# AWS GuardDuty

## Searches

### Log Searches

- **Guard Duty Threat Map**: from Dashboard: AWS GuardDuty/Amazon GuardDuty - Overview - New 
- **High Severity Threats Table**: from Dashboard: AWS GuardDuty/Amazon GuardDuty - Overview - New 
- **Severity and AccountID**: from Dashboard: AWS GuardDuty/Amazon GuardDuty - Overview - New 
- **Severity and Region**: from Dashboard: AWS GuardDuty/Amazon GuardDuty - Overview - New 
- **Severity and ResourceType**: from Dashboard: AWS GuardDuty/Amazon GuardDuty - Overview - New 
- **Severity Trend**: from Dashboard: AWS GuardDuty/Amazon GuardDuty - Overview - New 
- **Threats by IP**: from Dashboard: AWS GuardDuty/Amazon GuardDuty - Overview - New 
- **Threats by ThreatPurpose, ResourceType, ThreatName**: from Dashboard: AWS GuardDuty/Amazon GuardDuty - Overview - New

### Metric Searches


## Search Table

|app\_topic|search\_name|type|origin|search|
|:--|:--|:--|:--|:--|
|AWS GuardDuty|Guard Duty Threat Map|Logs|AWS GuardDuty/Amazon GuardDuty - Overview - New|\_sourceCategory = Labs/AWS/GuardDuty\* (geoLocation and lat and lon)<br />\| json field=\_raw "accountId", "region", "partition", "id", "arn", "type","service.serviceName","service.detectorId","service.action","severity","title","description" nodrop<br />\| parse field=type "\*:\*/\*" as ThreatPurpose,ResourceType,ThreatName<br />\| parse "\\"vpcId\\":\\"\*\\"" as vpcId, "\\"subnetId\\":\\"\*\\"" as subnetId,"\\"groupId\\":\\"\*\\"" as securityGroupId,"\\"tags\\":[\*]" as tags,"\\"groupName\\":\\"\*\\"" as securityGroupName nodrop<br />\| json field=\_raw "resource.instanceDetails.instanceId" as instanceid nodrop<br />\| if(severity=0, "Info",if(severity=2, "Low", if(severity=5, "Medium", if(severity=8, "High",if(severity=9.5, "Critical",severity))))) as severity<br />\| json field=%service.action "networkConnectionAction.remoteIpDetails.geoLocation.lon", "networkConnectionAction.remoteIpDetails.geoLocation.lat", "networkConnectionAction.remoteIpDetails.organization.asnOrg", "networkConnectionAction.remoteIpDetails.organization.org", "networkConnectionAction.remoteIpDetails.organization.isp", "networkConnectionAction.remoteIpDetails.ipAddressV4" as longitude, latitude, asnOrg, organization, isp, ip<br />\|where if ("{{severity}}" = "\*", true, severity matches "{{severity}}") AND if ("{{instanceid}}" = "\*", true, instanceid matches "{{instanceid}}") AND if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{region}}" = "\*", true, region matches "{{region}}") AND if ("{{vpcid}}" = "\*", true, vpcid matches "{{vpcid}}") AND if ("{{subnetid}}" = "\*", true, subnetid matches "{{subnetid}}") AND if ("{{tags}}" = "\*", true, tags matches "{{tags}}") AND if ("{{threatpurpose}}" = "\*", true, threatpurpose matches "{{threatpurpose}}") AND if ("{{securitygroupname}}" = "\*", true, securitygroupname matches "{{securitygroupname}}") AND if ("{{arn}}" = "\*", true, arn matches "{{arn}}") AND if ("{{resourcetype}}" = "\*", true, resourcetype matches "{{resourcetype}}") AND if ("{{securitygroupid}}" = "\*", true, securitygroupid matches "{{securitygroupid}}") AND if ("{{ip}}" = "\*", true, ip matches "{{ip}}")<br />\|count by latitude, longitude<br />\| sort \_count|
|AWS GuardDuty|High Severity Threats Table|Logs|AWS GuardDuty/Amazon GuardDuty - Overview - New|\_sourceCategory = Labs/AWS/GuardDuty\* <br />\| json field=\_raw "accountId", "region", "partition", "id", "arn", "type","service.serviceName","service.detectorId","service.action","severity","title","description" nodrop<br />\| parse field=type "\*:\*/\*" as ThreatPurpose,ResourceType,ThreatName<br />\| json field=%service.action "networkConnectionAction.remoteIpDetails.ipAddressV4","networkConnectionAction.localPortDetails.port" as ip, localPort nodrop<br />\| parse "\\"vpcId\\":\\"\*\\"" as vpcId, "\\"subnetId\\":\\"\*\\"" as subnetId,"\\"groupId\\":\\"\*\\"" as securityGroupId,"\\"tags\\":[\*]" as tags,"\\"groupName\\":\\"\*\\"" as securityGroupName nodrop<br />\| json field=\_raw "resource.instanceDetails.instanceId" as instanceid nodrop<br />\| if(severity=0, "Info",if(severity=2, "Low", if(severity=5, "Medium", if(severity=8, "High",if(severity=9.5, "Critical",severity))))) as severity<br />\| if(!isNull(instanceid),concat ("https://",region,".console.aws.amazon.com/ec2/v2/home?region=",region,"#Instances:search=",instanceid),"") as link<br />\| json field=%service.action "networkConnectionAction.remoteIpDetails.geoLocation.lon" as longitude nodrop<br />\| where severity = "High"<br />\| timeslice 1m<br />\|where if ("{{severity}}" = "\*", true, severity matches "{{severity}}") AND if ("{{instanceid}}" = "\*", true, instanceid matches "{{instanceid}}") AND if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{region}}" = "\*", true, region matches "{{region}}") AND if ("{{vpcid}}" = "\*", true, vpcid matches "{{vpcid}}") AND if ("{{subnetid}}" = "\*", true, subnetid matches "{{subnetid}}") AND if ("{{tags}}" = "\*", true, tags matches "{{tags}}") AND if ("{{securitygroupname}}" = "\*", true, securitygroupname matches "{{securitygroupname}}") AND if ("{{arn}}" = "\*", true, arn matches "{{arn}}") AND if ("{{resourcetype}}" = "\*", true, resourcetype matches "{{resourcetype}}") AND if ("{{securitygroupid}}" = "\*", true, securitygroupid matches "{{securitygroupid}}") AND if ("{{ip}}" = "\*", true, ip matches "{{ip}}")<br />\|count by \_timeslice, accountId, region, resourceType, description, link<br />\| order by \_timeslice<br />\| fields - \_count|
|AWS GuardDuty|Severity and AccountID|Logs|AWS GuardDuty/Amazon GuardDuty - Overview - New|\_sourceCategory = Labs/AWS/GuardDuty\* <br />\| json field=\_raw "accountId", "region", "partition", "id", "arn", "type","service.serviceName","service.detectorId","service.action","severity","title","description" nodrop<br />\| parse field=type "\*:\*/\*" as ThreatPurpose,ResourceType,ThreatName<br />\| json field=%service.action "networkConnectionAction.remoteIpDetails.ipAddressV4","networkConnectionAction.localPortDetails.port" as ip, localPort nodrop<br />\| parse "\\"vpcId\\":\\"\*\\"" as vpcId, "\\"subnetId\\":\\"\*\\"" as subnetId,"\\"groupId\\":\\"\*\\"" as securityGroupId,"\\"tags\\":[\*]" as tags,"\\"groupName\\":\\"\*\\"" as securityGroupName nodrop<br />\| json field=\_raw "resource.instanceDetails.instanceId" as instanceid nodrop<br />\| if(severity=0, "Info",if(severity=2, "Low", if(severity=5, "Medium", if(severity=8, "High",if(severity=9.5, "Critical",severity))))) as severity<br />\|where if ("{{severity}}" = "\*", true, severity matches "{{severity}}") AND if ("{{instanceid}}" = "\*", true, instanceid matches "{{instanceid}}") AND if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{region}}" = "\*", true, region matches "{{region}}") AND if ("{{vpcid}}" = "\*", true, vpcid matches "{{vpcid}}") AND if ("{{subnetid}}" = "\*", true, subnetid matches "{{subnetid}}") AND if ("{{tags}}" = "\*", true, tags matches "{{tags}}") AND if ("{{threatpurpose}}" = "\*", true, threatpurpose matches "{{threatpurpose}}") AND if ("{{securitygroupname}}" = "\*", true, securitygroupname matches "{{securitygroupname}}") AND if ("{{arn}}" = "\*", true, arn matches "{{arn}}") AND if ("{{resourcetype}}" = "\*", true, resourcetype matches "{{resourcetype}}") AND if ("{{securitygroupid}}" = "\*", true, securitygroupid matches "{{securitygroupid}}") AND if ("{{ip}}" = "\*", true, ip matches "{{ip}}")<br />\|count by severity, accountId<br />\| transpose row severity column accountId|
|AWS GuardDuty|Severity and Region|Logs|AWS GuardDuty/Amazon GuardDuty - Overview - New|\_sourceCategory = Labs/AWS/GuardDuty\* <br />\| json field=\_raw "accountId", "region", "partition", "id", "arn", "type","service.serviceName","service.detectorId","service.action","severity","title","description" nodrop<br />\| parse field=type "\*:\*/\*" as ThreatPurpose,ResourceType,ThreatName<br />\| json field=%service.action "networkConnectionAction.remoteIpDetails.ipAddressV4","networkConnectionAction.localPortDetails.port" as ip, localPort nodrop<br />\| parse "\\"vpcId\\":\\"\*\\"" as vpcId, "\\"subnetId\\":\\"\*\\"" as subnetId,"\\"groupId\\":\\"\*\\"" as securityGroupId,"\\"tags\\":[\*]" as tags,"\\"groupName\\":\\"\*\\"" as securityGroupName nodrop<br />\| json field=\_raw "resource.instanceDetails.instanceId" as instanceid nodrop<br />\| if(severity=0, "Info",if(severity=2, "Low", if(severity=5, "Medium", if(severity=8, "High",if(severity=9.5, "Critical",severity))))) as severity<br />\|where if ("{{severity}}" = "\*", true, severity matches "{{severity}}") AND if ("{{instanceid}}" = "\*", true, instanceid matches "{{instanceid}}") AND if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{region}}" = "\*", true, region matches "{{region}}") AND if ("{{vpcid}}" = "\*", true, vpcid matches "{{vpcid}}") AND if ("{{subnetid}}" = "\*", true, subnetid matches "{{subnetid}}") AND if ("{{tags}}" = "\*", true, tags matches "{{tags}}") AND if ("{{threatpurpose}}" = "\*", true, threatpurpose matches "{{threatpurpose}}") AND if ("{{securitygroupname}}" = "\*", true, securitygroupname matches "{{securitygroupname}}") AND if ("{{arn}}" = "\*", true, arn matches "{{arn}}") AND if ("{{resourcetype}}" = "\*", true, resourcetype matches "{{resourcetype}}") AND if ("{{securitygroupid}}" = "\*", true, securitygroupid matches "{{securitygroupid}}") AND if ("{{ip}}" = "\*", true, ip matches "{{ip}}")<br />\|count by severity, region<br />\| transpose row severity column region|
|AWS GuardDuty|Severity and ResourceType|Logs|AWS GuardDuty/Amazon GuardDuty - Overview - New|\_sourceCategory = Labs/AWS/GuardDuty\* <br />\| json field=\_raw "accountId", "region", "partition", "id", "arn", "type","service.serviceName","service.detectorId","service.action","severity","title","description" nodrop<br />\| parse field=type "\*:\*/\*" as ThreatPurpose,ResourceType,ThreatName<br />\| json field=%service.action "networkConnectionAction.remoteIpDetails.ipAddressV4","networkConnectionAction.localPortDetails.port" as ip, localPort nodrop<br />\| parse "\\"vpcId\\":\\"\*\\"" as vpcId, "\\"subnetId\\":\\"\*\\"" as subnetId,"\\"groupId\\":\\"\*\\"" as securityGroupId,"\\"tags\\":[\*]" as tags,"\\"groupName\\":\\"\*\\"" as securityGroupName nodrop<br />\| json field=\_raw "resource.instanceDetails.instanceId" as instanceid nodrop<br />\| if(severity=0, "Info",if(severity=2, "Low", if(severity=5, "Medium", if(severity=8, "High",if(severity=9.5, "Critical",severity))))) as severity<br />\|where if ("{{severity}}" = "\*", true, severity matches "{{severity}}") AND if ("{{instanceid}}" = "\*", true, instanceid matches "{{instanceid}}") AND if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{region}}" = "\*", true, region matches "{{region}}") AND if ("{{vpcid}}" = "\*", true, vpcid matches "{{vpcid}}") AND if ("{{subnetid}}" = "\*", true, subnetid matches "{{subnetid}}") AND if ("{{tags}}" = "\*", true, tags matches "{{tags}}") AND if ("{{threatpurpose}}" = "\*", true, threatpurpose matches "{{threatpurpose}}") AND if ("{{securitygroupname}}" = "\*", true, securitygroupname matches "{{securitygroupname}}") AND if ("{{arn}}" = "\*", true, arn matches "{{arn}}") AND if ("{{resourcetype}}" = "\*", true, resourcetype matches "{{resourcetype}}") AND if ("{{securitygroupid}}" = "\*", true, securitygroupid matches "{{securitygroupid}}") AND if ("{{ip}}" = "\*", true, ip matches "{{ip}}")<br />\|count by severity,resourceType<br />\| transpose row severity column resourceType|
|AWS GuardDuty|Severity Trend|Logs|AWS GuardDuty/Amazon GuardDuty - Overview - New|\_sourceCategory = Labs/AWS/GuardDuty\* severity<br />\| json "severity"<br />\| json field=\_raw "accountId", "region", "partition", "id", "arn", "type","service.serviceName","service.detectorId","service.action","title","description" nodrop<br />\| parse field=type "\*:\*/\*" as ThreatPurpose,ResourceType,ThreatName<br />\| json field=%service.action "networkConnectionAction.remoteIpDetails.ipAddressV4","networkConnectionAction.localPortDetails.port" as ip, localPort nodrop<br />\| parse "\\"vpcId\\":\\"\*\\"" as vpcId, "\\"subnetId\\":\\"\*\\"" as subnetId,"\\"groupId\\":\\"\*\\"" as securityGroupId,"\\"tags\\":[\*]" as tags,"\\"groupName\\":\\"\*\\"" as securityGroupName nodrop<br />\| json field=\_raw "resource.instanceDetails.instanceId" as instanceid nodrop<br />\| if(severity=0, "Info",if(severity=2, "Low", if(severity=5, "Medium", if(severity=8, "High",if(severity=9.5, "Critical",severity))))) as severity<br />\| timeslice 15m<br />\|where if ("{{severity}}" = "\*", true, severity matches "{{severity}}") AND if ("{{instanceid}}" = "\*", true, instanceid matches "{{instanceid}}") AND if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{region}}" = "\*", true, region matches "{{region}}") AND if ("{{vpcid}}" = "\*", true, vpcid matches "{{vpcid}}") AND if ("{{subnetid}}" = "\*", true, subnetid matches "{{subnetid}}") AND if ("{{tags}}" = "\*", true, tags matches "{{tags}}") AND if ("{{threatpurpose}}" = "\*", true, threatpurpose matches "{{threatpurpose}}") AND if ("{{securitygroupname}}" = "\*", true, securitygroupname matches "{{securitygroupname}}") AND if ("{{arn}}" = "\*", true, arn matches "{{arn}}") AND if ("{{resourcetype}}" = "\*", true, resourcetype matches "{{resourcetype}}") AND if ("{{securitygroupid}}" = "\*", true, securitygroupid matches "{{securitygroupid}}") AND if ("{{ip}}" = "\*", true, ip matches "{{ip}}")<br />\|count by severity, \_timeslice<br />\| transpose row \_timeslice column severity|
|AWS GuardDuty|Threats by IP|Logs|AWS GuardDuty/Amazon GuardDuty - Overview - New|\_sourceCategory = Labs/AWS/GuardDuty\* <br />\| json field=\_raw "accountId", "region", "partition", "id", "arn", "type","service.serviceName","service.detectorId","service.action","severity","title","description" nodrop<br />\| parse field=type "\*:\*/\*" as ThreatPurpose,ResourceType,ThreatName<br />\| json field=%service.action "networkConnectionAction.remoteIpDetails.ipAddressV4","networkConnectionAction.localPortDetails.port" as ip, localPort nodrop<br />\| parse "\\"vpcId\\":\\"\*\\"" as vpcId, "\\"subnetId\\":\\"\*\\"" as subnetId,"\\"groupId\\":\\"\*\\"" as securityGroupId,"\\"tags\\":[\*]" as tags,"\\"groupName\\":\\"\*\\"" as securityGroupName nodrop<br />\| json field=\_raw "resource.instanceDetails.instanceId" as instanceid nodrop<br />\| if(severity=0, "Info",if(severity=2, "Low", if(severity=5, "Medium", if(severity=8, "High",if(severity=9.5, "Critical",severity))))) as severity<br />\|where if ("{{severity}}" = "\*", true, severity matches "{{severity}}") AND if ("{{instanceid}}" = "\*", true, instanceid matches "{{instanceid}}") AND if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{region}}" = "\*", true, region matches "{{region}}") AND if ("{{vpcid}}" = "\*", true, vpcid matches "{{vpcid}}") AND if ("{{subnetid}}" = "\*", true, subnetid matches "{{subnetid}}") AND if ("{{tags}}" = "\*", true, tags matches "{{tags}}") AND if ("{{threatpurpose}}" = "\*", true, threatpurpose matches "{{threatpurpose}}") AND if ("{{securitygroupname}}" = "\*", true, securitygroupname matches "{{securitygroupname}}") AND if ("{{arn}}" = "\*", true, arn matches "{{arn}}") AND if ("{{resourcetype}}" = "\*", true, resourcetype matches "{{resourcetype}}") AND if ("{{securitygroupid}}" = "\*", true, securitygroupid matches "{{securitygroupid}}") AND if ("{{ip}}" = "\*", true, ip matches "{{ip}}")<br />\|count by ip<br />\| where !isNull(ip)<br />\| sort \_count|
|AWS GuardDuty|Threats by ThreatPurpose, ResourceType, ThreatName|Logs|AWS GuardDuty/Amazon GuardDuty - Overview - New|\_sourceCategory = Labs/AWS/GuardDuty\* <br />\| json field=\_raw "accountId", "region", "partition", "id", "arn", "type","service.serviceName","service.detectorId","service.action","severity","title","description" nodrop<br />\| parse field=type "\*:\*/\*" as ThreatPurpose,ResourceType,ThreatName<br />\| json field=%service.action "networkConnectionAction.remoteIpDetails.ipAddressV4","networkConnectionAction.localPortDetails.port" as ip, localPort nodrop<br />\| parse "\\"vpcId\\":\\"\*\\"" as vpcId, "\\"subnetId\\":\\"\*\\"" as subnetId,"\\"groupId\\":\\"\*\\"" as securityGroupId,"\\"tags\\":[\*]" as tags,"\\"groupName\\":\\"\*\\"" as securityGroupName nodrop<br />\| json field=\_raw "resource.instanceDetails.instanceId" as instanceid nodrop<br />\| if(severity=0, "Info",if(severity=2, "Low", if(severity=5, "Medium", if(severity=8, "High",if(severity=9.5, "Critical",severity))))) as severity<br />\| if(!isNull(instanceid),concat ("https://",region,".console.aws.amazon.com/ec2/v2/home?region=",region,"#Instances:search=",instanceid),"") as link<br />\| json field=%service.action "networkConnectionAction.remoteIpDetails.geoLocation.lon" as longitude nodrop<br />\| parse field=type "\*:\*/\*" as ThreatPurpose,ResourceType,ThreatName<br />\|where if ("{{severity}}" = "\*", true, severity matches "{{severity}}") AND if ("{{instanceid}}" = "\*", true, instanceid matches "{{instanceid}}") AND if ("{{accountid}}" = "\*", true, accountid matches "{{accountid}}") AND if ("{{region}}" = "\*", true, region matches "{{region}}") AND if ("{{vpcid}}" = "\*", true, vpcid matches "{{vpcid}}") AND if ("{{subnetid}}" = "\*", true, subnetid matches "{{subnetid}}") AND if ("{{tags}}" = "\*", true, tags matches "{{tags}}") AND if ("{{threatpurpose}}" = "\*", true, threatpurpose matches "{{threatpurpose}}") AND if ("{{securitygroupname}}" = "\*", true, securitygroupname matches "{{securitygroupname}}") AND if ("{{arn}}" = "\*", true, arn matches "{{arn}}") AND if ("{{resourcetype}}" = "\*", true, resourcetype matches "{{resourcetype}}") AND if ("{{securitygroupid}}" = "\*", true, securitygroupid matches "{{securitygroupid}}") AND if ("{{ip}}" = "\*", true, ip matches "{{ip}}")<br />\|count as count by ThreatPurpose,ResourceType,ThreatName<br />\| sort count|

