# Amazon Route 53 Resolver Security
## Sumo Logic App For: Amazon Route 53 Resolver Security
Amazon Route 53 Resolver is a highly available cloud-based DNS service from Amazon. The Sumo Logic Route 53 Resolver Security application enables you to monitor both Query Logs, and if in use, the DNS Firewall logs. Query logging enables visibility to inbound and outbound DNS queries to the Resolver endpoint. Integrating the logs with Sumo Logic provides insights such as queries by location or instance id. With Amazon Route 53 Resolver DNS Firewall, you can filter and regulate outbound DNS traffic for your AWS virtual private cloud (VPC). To do this, you create reusable collections of filtering rules in DNS Firewall rule groups, associate the rule groups to your VPC. By integrating these DNS Firewall logs with Sumo Logic you can monitor VPC activity for misconfigurations and suspicious traffic. DNS Firewall is a feature of Route 53 Resolver and doesn't require any additional Resolver setup to use.
Docs Link: [Amazon Route 53 Resolver Security](https://help.sumologic.com/?cid=10173)

## Searches

### Log Searches

- **Alerted DNS Queries by Instance ID Over Time**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Resolver DNS Firewall 
- **Alerted DNS Queries by Instance ID Over Time**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview 
- **Alerted DNS Queries by Rule Group ID & Domain List ID**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Resolver DNS Firewall 
- **Alerted Queries by Instance ID and Source Address**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Resolver DNS Firewall 
- **Alerted Queries by Instance ID and Source Address? (Top 10)**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Resolver DNS Firewall 
- **Alerted Queries IPv4 Resolution by GeoLocation**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Resolver DNS Firewall 
- **Anomalies within Alerted DNS Queries**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview 
- **Anomalies within Blocked DNS Queries**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview 
- **Anomolies within Alerted DNS Queries**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Resolver DNS Firewall 
- **Anomolies within Blocked?DNS Queries**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Resolver DNS Firewall 
- **Blocked DNS Queries by Instance ID Over Time**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview 
- **Blocked Queries by Instance ID and Source Address**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Resolver DNS Firewall 
- **Blocked?DNS Queries by Instance ID Over Time**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Resolver DNS Firewall 
- **Blocked?DNS Queries by Rule Group ID & Domain List ID**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Resolver DNS Firewall 
- **Blocked?Queries by Instance ID and Source Address? (Top 10)**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Resolver DNS Firewall 
- **Bytes Sent Over DNS Requests by Instance ID**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details 
- **Bytes Sent Over DNS Requests by VPC**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details 
- **DNS Queries by Instance ID and Source Address**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details 
- **DNS Queries by Instance ID and Source Address**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview 
- **DNS Queries by Type and VPC-ID**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details 
- **DNS Queries by Type and VPC-ID**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview 
- **IPv4 Resolution by Geo Location**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview 
- **Least 10 Queried Domains**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview 
- **Resolver Query Logs Detail**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details 
- **Reverse DNS Query to Non-Existent Domain by Instance ID**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details 
- **Reverse DNS Query to Non-Existent Domain by Query Name**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details 
- **Reverse DNS Query to Non-Existent Domain by Query Name & Instance ID**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details 
- **Successful Reverse DNS Query by Instance ID**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details 
- **Successful Reverse DNS Query by Query Name & Instance ID**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details 
- **Successful Reverse DNS Query by Query Name?**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details 
- **Threat by Actor**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Threat Intel 
- **Threat by Actor**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Threat Intel 
- **Threat by Malicious Confidence**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Threat Intel 
- **Threat by Malicious Confidence**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Threat Intel 
- **Threat Count**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Threat Intel 
- **Threat Count**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Threat Intel 
- **Threat Outlier**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview 
- **Threat Outlier**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details 
- **Threat Table**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Threat Intel 
- **Threat Table?**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Threat Intel 
- **Threats by Instance ID**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Threat Intel 
- **Threats by Instance ID**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Threat Intel 
- **Threats by Instance ID**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Threat Intel 
- **Threats Over Time**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Threat Intel 
- **Threats Over Time**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview 
- **Threats Over Time**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Threat Intel 
- **Threats Over Time**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details 
- **Threats Over Time by Instance ID**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Threat Intel 
- **Top 10 Alerted Domains**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Resolver DNS Firewall 
- **Top 10 Alerted Domains**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview 
- **Top 10 Blocked Domains?**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview 
- **Top 10 Blocked?Domains**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Resolver DNS Firewall 
- **Top 10 Queried Domains**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview 
- **Top 50 Domains by Query Length and InstanceID**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details 
- **Top 50 Highest Entropy Domains**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details 
- **Top 50 Highest Entropy Domains**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview 
- **Total Hits from Threat Intel Source**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details 
- **Total Hits from Threat Intel Source**: from Dashboard: Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview

### Metric Searches


## Search Table

|app\_topic|search\_name|type|origin|search|
|:--|:--|:--|:--|:--|
|Amazon Route 53 Resolver Security|Alerted DNS Queries by Instance ID Over Time|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Resolver DNS Firewall|\_sourceCategory={{Route53ResolverQueryLogsSource}}  ALERT<br />\| where firewall\_rule\_action = "ALERT"<br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "(?\<response\>\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})"  multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| timeslice 15m<br />\| count by \_timeslice, instance\_id, srcaddr<br />\| transpose row \_timeslice column instance\_id, srcaddr|
|Amazon Route 53 Resolver Security|Alerted DNS Queries by Instance ID Over Time|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview|\_sourceCategory={{Route53ResolverQueryLogsSource}}  ALERT<br />\| where firewall\_rule\_action = "ALERT"<br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "(?\<response\>\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})"  multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| timeslice 15m<br />\| count by \_timeslice, instance\_id, srcaddr<br />\| transpose row \_timeslice column instance\_id, srcaddr|
|Amazon Route 53 Resolver Security|Alerted DNS Queries by Rule Group ID & Domain List ID|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Resolver DNS Firewall|\_sourceCategory={{Route53ResolverQueryLogsSource}}  ALERT<br />\| where firewall\_rule\_action = "ALERT"<br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "(?\<response\>\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})"  multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| count by firewall\_rule\_group\_id, firewall\_domain\_list\_id<br />\| sort by \_count|
|Amazon Route 53 Resolver Security|Alerted Queries by Instance ID and Source Address|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Resolver DNS Firewall|\_sourceCategory={{Route53ResolverQueryLogsSource}}  ALERT<br />\| where firewall\_rule\_action = "ALERT"<br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "(?\<response\>\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})"  multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| count by instance\_id, srcaddr<br />\| sort by \_count|
|Amazon Route 53 Resolver Security|Alerted Queries by Instance ID and Source Address? (Top 10)|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Resolver DNS Firewall|\_sourceCategory={{Route53ResolverQueryLogsSource}}  ALERT<br />\| where firewall\_rule\_action = "ALERT"<br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "(?\<response\>\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})"  multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| count by instance\_id, srcaddr<br />\| sort by \_count<br />\| limit 10|
|Amazon Route 53 Resolver Security|Alerted Queries IPv4 Resolution by GeoLocation|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Resolver DNS Firewall|\_sourceCategory={{Route53ResolverQueryLogsSource}}  ALERT<br />\| where firewall\_rule\_action = "ALERT"<br />\| where query\_type = "A"<br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "(?\<response\>\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})"  multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| where !isPrivateIP(response)<br />\| lookup latitude, longitude, country\_code, country\_name, region, city, postal\_code from geo://location on ip = response<br />\| count by latitude, longitude, country\_code, country\_name, region, city, postal\_code<br />\| sort \_count|
|Amazon Route 53 Resolver Security|Anomalies within Alerted DNS Queries|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview|\_sourceCategory={{Route53ResolverQueryLogsSource}}  ALERT<br />\| where firewall\_rule\_action = "ALERT"<br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "(?\<response\>\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})"  multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| timeslice 15m<br />\| count as Alerted by \_timeslice <br />\| fillmissing timeslice(15m)<br />\| sort by \_timeslice<br />\| outlier Alerted|
|Amazon Route 53 Resolver Security|Anomalies within Blocked DNS Queries|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview|\_sourceCategory={{Route53ResolverQueryLogsSource}}  BLOCK<br />\| where firewall\_rule\_action = "BLOCK"<br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "(?\<response\>\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})"  multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| timeslice 15m<br />\| count as Alerted by \_timeslice <br />\| fillmissing timeslice(15m)<br />\| sort by \_timeslice<br />\| outlier Alerted|
|Amazon Route 53 Resolver Security|Anomolies within Alerted DNS Queries|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Resolver DNS Firewall|\_sourceCategory={{Route53ResolverQueryLogsSource}}  ALERT<br />\| where firewall\_rule\_action = "ALERT"<br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "(?\<response\>\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})"  multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| timeslice 15m<br />\| count as Alerted by \_timeslice <br />\| fillmissing timeslice(15m)<br />\| sort by \_timeslice<br />\| outlier Alerted|
|Amazon Route 53 Resolver Security|Anomolies within Blocked?DNS Queries|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Resolver DNS Firewall|\_sourceCategory={{Route53ResolverQueryLogsSource}}  BLOCK<br />\| where firewall\_rule\_action = "BLOCK"<br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "(?\<response\>\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})"  multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| timeslice 15m<br />\| count as BLOCKED by \_timeslice <br />\| fillmissing timeslice(15m)<br />\| sort by \_timeslice<br />\| outlier BLOCKED|
|Amazon Route 53 Resolver Security|Blocked DNS Queries by Instance ID Over Time|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview|\_sourceCategory={{Route53ResolverQueryLogsSource}}  BLOCK<br />\| where firewall\_rule\_action = "BLOCK"<br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "(?\<response\>\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})"  multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| timeslice 15m<br />\| count by \_timeslice, instance\_id, srcaddr<br />\| transpose row \_timeslice column instance\_id, srcaddr|
|Amazon Route 53 Resolver Security|Blocked Queries by Instance ID and Source Address|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Resolver DNS Firewall|\_sourceCategory={{Route53ResolverQueryLogsSource}}  BLOCK<br />\| where firewall\_rule\_action = "BLOCK"<br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "(?\<response\>\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})"  multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| count by instance\_id, srcaddr<br />\| sort by \_count|
|Amazon Route 53 Resolver Security|Blocked?DNS Queries by Instance ID Over Time|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Resolver DNS Firewall|\_sourceCategory={{Route53ResolverQueryLogsSource}}  BLOCK<br />\| where firewall\_rule\_action = "BLOCK"<br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "(?\<response\>\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})"  multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| timeslice 15m<br />\| count by \_timeslice, instance\_id, srcaddr<br />\| transpose row \_timeslice column instance\_id, srcaddr|
|Amazon Route 53 Resolver Security|Blocked?DNS Queries by Rule Group ID & Domain List ID|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Resolver DNS Firewall|\_sourceCategory={{Route53ResolverQueryLogsSource}}  BLOCK<br />\| where firewall\_rule\_action = "BLOCK"<br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "(?\<response\>\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})"  multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| count by firewall\_rule\_group\_id, firewall\_domain\_list\_id<br />\| sort by \_count|
|Amazon Route 53 Resolver Security|Blocked?Queries by Instance ID and Source Address? (Top 10)|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Resolver DNS Firewall|\_sourceCategory={{Route53ResolverQueryLogsSource}}  BLOCK<br />\| where firewall\_rule\_action = "BLOCK"<br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "(?\<response\>\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})"  multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| count by instance\_id, srcaddr<br />\| sort by \_count<br />\| limit 10|
|Amazon Route 53 Resolver Security|Bytes Sent Over DNS Requests by Instance ID|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details|\_sourceCategory={{Route53ResolverQueryLogsSource}}  <br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "(?\<response\>\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})"  multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| length(query\_name) as query\_name\_length<br />\| timeslice 10m<br />\| sum(query\_name\_length) as bytes\_sent\_in\_requests by \_timeslice, instance\_id<br />\| fillmissing timeslice<br />\| sort by \_timeslice<br />\| transpose row \_timeslice column instance\_id|
|Amazon Route 53 Resolver Security|Bytes Sent Over DNS Requests by VPC|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details|\_sourceCategory={{Route53ResolverQueryLogsSource}}  <br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "(?\<response\>\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})"  multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| length(query\_name) as query\_name\_length<br />\| timeslice 10m<br />\| sum(query\_name\_length) as bytes\_sent\_in\_requests by \_timeslice, vpc\_id<br />\| fillmissing timeslice<br />\| sort by \_timeslice<br />\| transpose row \_timeslice column vpc\_id|
|Amazon Route 53 Resolver Security|DNS Queries by Instance ID and Source Address|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details|\_sourceCategory={{Route53ResolverQueryLogsSource}}  <br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "(?\<response\>\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})"  multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| timeslice 10m<br />\| count by \_timeslice, instance\_id, srcaddr<br />\| fillmissing timeslice<br />\| sort by \_timeslice<br />\| transpose row \_timeslice column instance\_id, srcaddr|
|Amazon Route 53 Resolver Security|DNS Queries by Instance ID and Source Address|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview|\_sourceCategory={{Route53ResolverQueryLogsSource}}  <br />\| %"srcids.instance" as instance\_id<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches "{{firewall\_rule\_group\_id}}"<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches "{{firewall\_domain\_list\_id}}"<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches "{{firewall\_rule\_action}}"<br />\| timeslice 1h<br />\| count by \_timeslice, instance\_id, srcaddr<br />\| transpose row \_timeslice column instance\_id, srcaddr|
|Amazon Route 53 Resolver Security|DNS Queries by Type and VPC-ID|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details|\_sourceCategory={{Route53ResolverQueryLogsSource}}  <br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "(?\<response\>\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})"  multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| timeslice 10m<br />\| count by  \_timeslice, query\_type, vpc\_id<br />\| fillmissing timeslice<br />\| sort by \_timeslice<br />\| transpose row \_timeslice column query\_type, vpc\_id|
|Amazon Route 53 Resolver Security|DNS Queries by Type and VPC-ID|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview|\_sourceCategory={{Route53ResolverQueryLogsSource}}  <br />\| %"srcids.instance" as instance\_id<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches "{{firewall\_rule\_group\_id}}"<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches "{{firewall\_domain\_list\_id}}"<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches "{{firewall\_rule\_action}}"<br />\| timeslice 1h <br />\| count by  \_timeslice, query\_type, vpc\_id<br />\| transpose row \_timeslice column query\_type, vpc\_id|
|Amazon Route 53 Resolver Security|IPv4 Resolution by Geo Location|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview|\_sourceCategory={{Route53ResolverQueryLogsSource}}  <br />\| where query\_type = "A"<br />\| %"srcids.instance" as instance\_id<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches "{{firewall\_rule\_group\_id}}"<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches "{{firewall\_domain\_list\_id}}"<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches "{{firewall\_rule\_action}}"<br />\| json "answers[\*].Rdata" as response<br />\| extract field=response "(?\<response\>\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})"  multi <br />\| where !isPrivateIP(response)<br />\| lookup latitude, longitude, country\_code, country\_name, region, city, postal\_code from geo://location on ip = response<br />\| count by latitude, longitude, country\_code, country\_name, region, city, postal\_code<br />\| sort \_count|
|Amazon Route 53 Resolver Security|Least 10 Queried Domains|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview|\_sourceCategory={{Route53ResolverQueryLogsSource}}  <br />\| %"srcids.instance" as instance\_id<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches "{{firewall\_rule\_group\_id}}"<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches "{{firewall\_domain\_list\_id}}"<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches "{{firewall\_rule\_action}}"<br />\| count by query\_name \| sort by \_count asc<br />\| limit 10|
|Amazon Route 53 Resolver Security|Resolver Query Logs Detail|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details|\_sourceCategory={{Route53ResolverQueryLogsSource}}  <br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "\\"(?\<response\>.\*?)\\"" multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(response matches "[]", "", response) as response<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| lookup organization, asn from asn://default on ip = response<br />\| count by query\_name, response, query\_type, firewall\_rule\_action, firewall\_rule\_group\_id, firewall\_domain\_list\_id, organization, asn, account\_id, region, vpc\_id, instance\_id, srcaddr<br />\| sort by \_count|
|Amazon Route 53 Resolver Security|Reverse DNS Query to Non-Existent Domain by Instance ID|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details|\_sourceCategory={{Route53ResolverQueryLogsSource}}  PTR NXDOMAIN<br />\| where rcode = "NXDOMAIN"<br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "\\"(?\<response\>.\*?)\\"" multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(response matches "[]", "", response) as response<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| count by instance\_id<br />\| sort by \_count|
|Amazon Route 53 Resolver Security|Reverse DNS Query to Non-Existent Domain by Query Name|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details|\_sourceCategory={{Route53ResolverQueryLogsSource}}  PTR NXDOMAIN<br />\| where rcode = "NXDOMAIN"<br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "\\"(?\<response\>.\*?)\\"" multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(response matches "[]", "", response) as response<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| count by query\_name<br />\| sort by \_count|
|Amazon Route 53 Resolver Security|Reverse DNS Query to Non-Existent Domain by Query Name & Instance ID|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details|\_sourceCategory={{Route53ResolverQueryLogsSource}}  PTR NXDOMAIN<br />\| where rcode = "NXDOMAIN"<br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "\\"(?\<response\>.\*?)\\"" multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(response matches "[]", "", response) as response<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| count by query\_name, instance\_id<br />\| sort by \_count|
|Amazon Route 53 Resolver Security|Successful Reverse DNS Query by Instance ID|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details|\_sourceCategory={{Route53ResolverQueryLogsSource}}  PTR<br />\| where rcode = "NOERROR"<br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "\\"(?\<response\>.\*?)\\"" multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(response matches "[]", "", response) as response<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| count by instance\_id<br />\| sort by \_count|
|Amazon Route 53 Resolver Security|Successful Reverse DNS Query by Query Name & Instance ID|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details|\_sourceCategory={{Route53ResolverQueryLogsSource}}  PTR<br />\| where rcode = "NOERROR"<br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "\\"(?\<response\>.\*?)\\"" multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(response matches "[]", "", response) as response<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| count by query\_name, response, instance\_id<br />\| sort by \_count|
|Amazon Route 53 Resolver Security|Successful Reverse DNS Query by Query Name?|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details|\_sourceCategory={{Route53ResolverQueryLogsSource}}  PTR<br />\| where rcode = "NOERROR"<br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "\\"(?\<response\>.\*?)\\"" multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(response matches "[]", "", response) as response<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| count by query\_name, response<br />\| sort by \_count|
|Amazon Route 53 Resolver Security|Threat by Actor|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Threat Intel|\_sourceCategory={{Route53ResolverQueryLogsSource}} <br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "\\"(?\<response\>.\*?)\\"" multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(response matches "[]", "", response) as response<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| count as domain\_count by query\_name<br />\| lookup type, actor, raw, threatlevel as malicious\_confidence from sumo://threat/cs on threat=query\_name<br />\| where  type = "domain" and !isNull(malicious\_confidence)<br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| if (isEmpty(actor), "Unassigned", actor) as Actor<br />\| sum (domain\_count) as threat\_count by Actor|
|Amazon Route 53 Resolver Security|Threat by Actor|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Threat Intel|\_sourceCategory={{Route53ResolverQueryLogsSource}} <br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "\\"(?\<response\>.\*?)\\"" multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(response matches "[]", "", response) as response<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| if (response matches "237.219.190.119" ,"194.150.118.8", response) as response<br />\| count as ip\_count by response<br />\| lookup type, actor, raw, threatlevel as malicious\_confidence from sumo://threat/cs on threat=response <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| where  type="ip\_address" and !isNull(malicious\_confidence)<br />\| if (isEmpty(actor), "Unassigned", actor) as Actor<br />\| sum (ip\_count) as threat\_count by actor|
|Amazon Route 53 Resolver Security|Threat by Malicious Confidence|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Threat Intel|\_sourceCategory={{Route53ResolverQueryLogsSource}} <br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "\\"(?\<response\>.\*?)\\"" multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(response matches "[]", "", response) as response<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| count as domain\_count by query\_name<br />\| lookup type, actor, raw, threatlevel as malicious\_confidence from sumo://threat/cs on threat=query\_name<br />\| where  type = "domain" and !isNull(malicious\_confidence)<br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| if (isEmpty(actor), "Unassigned", actor) as Actor<br />\| sum (domain\_count) as threat\_count by malicious\_confidence|
|Amazon Route 53 Resolver Security|Threat by Malicious Confidence|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Threat Intel|\_sourceCategory={{Route53ResolverQueryLogsSource}} <br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "\\"(?\<response\>.\*?)\\"" multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(response matches "[]", "", response) as response<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| if (response matches "237.219.190.119" ,"194.150.118.8", response) as response<br />\| count as ip\_count by response<br />\| lookup type, actor, raw, threatlevel as malicious\_confidence from sumo://threat/cs on threat=response <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| where  type="ip\_address" and !isNull(malicious\_confidence)<br />\| if (isEmpty(actor), "Unassigned", actor) as Actor<br />\| sum (ip\_count) as threat\_count by malicious\_confidence|
|Amazon Route 53 Resolver Security|Threat Count|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Threat Intel|\_sourceCategory={{Route53ResolverQueryLogsSource}} <br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "\\"(?\<response\>.\*?)\\"" multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(response matches "[]", "", response) as response<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| count as domain\_count by query\_name<br />\| lookup type, actor, raw, threatlevel as malicious\_confidence from sumo://threat/cs on threat=query\_name<br />\| where  type = "domain" and !isNull(malicious\_confidence)<br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| if (isEmpty(actor), "Unassigned", actor) as Actor<br />\| sum (domain\_count) as threat\_count|
|Amazon Route 53 Resolver Security|Threat Count|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Threat Intel|\_sourceCategory={{Route53ResolverQueryLogsSource}} <br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "\\"(?\<response\>.\*?)\\"" multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(response matches "[]", "", response) as response<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| if (response matches "237.219.190.119" ,"194.150.118.8", response) as response<br />\| count as ip\_count by response<br />\| lookup type, actor, raw, threatlevel as malicious\_confidence from sumo://threat/cs on threat=response <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| where  type="ip\_address" and !isNull(malicious\_confidence)<br />\| if (isEmpty(actor), "Unassigned", actor) as Actor<br />\| sum (ip\_count) as threat\_count|
|Amazon Route 53 Resolver Security|Threat Outlier|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview|\_sourceCategory={{Route53ResolverQueryLogsSource}} <br />\| %"srcids.instance" as instance\_id<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches "{{firewall\_rule\_group\_id}}"<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches "{{firewall\_domain\_list\_id}}"<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches "{{firewall\_rule\_action}}"<br />\| lookup type, actor, raw, threatlevel as malicious\_confidence from sumo://threat/cs on threat=query\_name<br />\| where  type = "domain" and !isNull(malicious\_confidence)<br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| if (isEmpty(actor), "Unassigned", actor) as Actor<br />\| timeslice 10m<br />\| count(Actor) as actor by \_timeslice<br />\| fillmissing timeslice<br />\| outlier actor|
|Amazon Route 53 Resolver Security|Threat Outlier|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details|\_sourceCategory={{Route53ResolverQueryLogsSource}} <br />\| %"srcids.instance" as instance\_id<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches "{{firewall\_rule\_group\_id}}"<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches "{{firewall\_domain\_list\_id}}"<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches "{{firewall\_rule\_action}}"<br />\| lookup type, actor, raw, threatlevel as malicious\_confidence from sumo://threat/cs on threat=query\_name<br />\| where  type = "domain" and !isNull(malicious\_confidence)<br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| if (isEmpty(actor), "Unassigned", actor) as Actor<br />\| timeslice 10m<br />\| count(Actor) as actor by \_timeslice<br />\| fillmissing timeslice<br />\| outlier actor|
|Amazon Route 53 Resolver Security|Threat Table|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Threat Intel|\_sourceCategory={{Route53ResolverQueryLogsSource}} <br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "\\"(?\<response\>.\*?)\\"" multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(response matches "[]", "", response) as response<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| count as domain\_count by query\_name, instance\_id<br />\| lookup type, actor, raw, threatlevel as malicious\_confidence from sumo://threat/cs on threat=query\_name<br />\| where  type = "domain" and !isNull(malicious\_confidence)<br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| if (isEmpty(actor), "Unassigned", actor) as Actor<br />\| sum (domain\_count) as threat\_count by query\_name, malicious\_confidence, Actor,  instance\_id, label\_name<br />\| sort by threat\_count |
|Amazon Route 53 Resolver Security|Threat Table?|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Threat Intel|\_sourceCategory={{Route53ResolverQueryLogsSource}} <br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "\\"(?\<response\>.\*?)\\"" multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(response matches "[]", "", response) as response<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| count as ip\_count by response, instance\_id<br />\| if (response matches "237.219.190.119" ,"194.150.118.8", response) as response<br />\| lookup type, actor, raw, threatlevel as malicious\_confidence from sumo://threat/cs on threat=response<br />\| where  type = "ip\_address" and !isNull(malicious\_confidence)<br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| if (isEmpty(actor), "Unassigned", actor) as Actor<br />\| sum (ip\_count) as threat\_count by response, malicious\_confidence, Actor,  instance\_id, label\_name<br />\| sort by threat\_count |
|Amazon Route 53 Resolver Security|Threats by Instance ID|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Threat Intel|\_sourceCategory={{Route53ResolverQueryLogsSource}} <br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "\\"(?\<response\>.\*?)\\"" multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(response matches "[]", "", response) as response<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| if (response matches "237.219.190.119" ,"194.150.118.8", response) as response<br />\| timeslice 15m<br />\| count as ip\_count by response, instance\_id, \_timeslice<br />\| lookup type, actor, raw, threatlevel as malicious\_confidence from sumo://threat/cs on threat=response<br />\| where  type = "ip\_address" and !isNull(malicious\_confidence)<br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| if (isEmpty(actor), "Unassigned", actor) as Actor<br />\| sum (ip\_count) as threat\_count by  \_timeslice, instance\_id<br />\| transpose row \_timeslice column instance\_id|
|Amazon Route 53 Resolver Security|Threats by Instance ID|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Threat Intel|\_sourceCategory={{Route53ResolverQueryLogsSource}} <br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "\\"(?\<response\>.\*?)\\"" multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(response matches "[]", "", response) as response<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| if (response matches "237.219.190.119" ,"194.150.118.8", response) as response<br />\| count as ip\_count by response, instance\_id<br />\| lookup type, actor, raw, threatlevel as malicious\_confidence from sumo://threat/cs on threat=response<br />\| where  type = "ip\_address" and !isNull(malicious\_confidence)<br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| if (isEmpty(actor), "Unassigned", actor) as Actor<br />\| sum (ip\_count) as threat\_count by instance\_id<br />\| sort by threat\_count|
|Amazon Route 53 Resolver Security|Threats by Instance ID|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Threat Intel|\_sourceCategory={{Route53ResolverQueryLogsSource}} <br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "\\"(?\<response\>.\*?)\\"" multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(response matches "[]", "", response) as response<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| count as domain\_count by query\_name, instance\_id<br />\| lookup type, actor, raw, threatlevel as malicious\_confidence from sumo://threat/cs on threat=query\_name<br />\| where  type = "domain" and !isNull(malicious\_confidence)<br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| if (isEmpty(actor), "Unassigned", actor) as Actor<br />\| sum (domain\_count) as threat\_count by instance\_id<br />\| sort by threat\_count|
|Amazon Route 53 Resolver Security|Threats Over Time|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Threat Intel|\_sourceCategory={{Route53ResolverQueryLogsSource}} <br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "\\"(?\<response\>.\*?)\\"" multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(response matches "[]", "", response) as response<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| if (response matches "237.219.190.119" ,"194.150.118.8", response) as response<br />\| timeslice 15m<br />\| count as ip\_count by response, instance\_id, \_timeslice<br />\| lookup type, actor, raw, threatlevel as malicious\_confidence from sumo://threat/cs on threat=response<br />\| where  type = "ip\_address" and !isNull(malicious\_confidence)<br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| if (isEmpty(actor), "Unassigned", actor) as Actor<br />\| sum (ip\_count) as threat\_count by  \_timeslice|
|Amazon Route 53 Resolver Security|Threats Over Time|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview|\_sourceCategory={{Route53ResolverQueryLogsSource}} <br />\| %"srcids.instance" as instance\_id<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches "{{firewall\_rule\_group\_id}}"<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches "{{firewall\_domain\_list\_id}}"<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches "{{firewall\_rule\_action}}"<br />\| timeslice 15m<br />\| count as domain\_count by query\_name, \_timeslice<br />\| lookup type, actor, raw, threatlevel as malicious\_confidence from sumo://threat/cs on threat=query\_name<br />\| where  type = "domain" and !isNull(malicious\_confidence)<br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| if (isEmpty(actor), "Unassigned", actor) as Actor<br />\| sum (domain\_count) as threat\_count by \_timeslice|
|Amazon Route 53 Resolver Security|Threats Over Time|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Threat Intel|\_sourceCategory={{Route53ResolverQueryLogsSource}} <br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "\\"(?\<response\>.\*?)\\"" multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(response matches "[]", "", response) as response<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| timeslice 15m<br />\| count as domain\_count by query\_name, \_timeslice<br />\| lookup type, actor, raw, threatlevel as malicious\_confidence from sumo://threat/cs on threat=query\_name<br />\| where  type = "domain" and !isNull(malicious\_confidence)      <br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| if (isEmpty(actor), "Unassigned", actor) as Actor<br />\| sum (domain\_count) as threat\_count by \_timeslice|
|Amazon Route 53 Resolver Security|Threats Over Time|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details|\_sourceCategory={{Route53ResolverQueryLogsSource}} <br />\| %"srcids.instance" as instance\_id<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches "{{firewall\_rule\_group\_id}}"<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches "{{firewall\_domain\_list\_id}}"<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches "{{firewall\_rule\_action}}"<br />\| timeslice 15m<br />\| count as domain\_count by query\_name, \_timeslice<br />\| lookup type, actor, raw, threatlevel as malicious\_confidence from sumo://threat/cs on threat=query\_name<br />\| where  type = "domain" and !isNull(malicious\_confidence)<br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| if (isEmpty(actor), "Unassigned", actor) as Actor<br />\| sum (domain\_count) as threat\_count by \_timeslice|
|Amazon Route 53 Resolver Security|Threats Over Time by Instance ID|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Threat Intel|\_sourceCategory={{Route53ResolverQueryLogsSource}} <br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "\\"(?\<response\>.\*?)\\"" multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(response matches "[]", "", response) as response<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| timeslice 15m<br />\| count as domain\_count by query\_name, \_timeslice, instance\_id<br />\| lookup type, actor, raw, threatlevel as malicious\_confidence from sumo://threat/cs on threat=query\_name<br />\| where  type = "domain" and !isNull(malicious\_confidence)<br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| if (isEmpty(actor), "Unassigned", actor) as Actor<br />\| sum (domain\_count) as threat\_count by \_timeslice, instance\_id<br />\| transpose row \_timeslice column instance\_id|
|Amazon Route 53 Resolver Security|Top 10 Alerted Domains|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Resolver DNS Firewall|\_sourceCategory={{Route53ResolverQueryLogsSource}}  ALERT<br />\| where firewall\_rule\_action = "ALERT"<br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "(?\<response\>\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})"  multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| count by query\_name<br />\| sort by \_count<br />\| limit 10|
|Amazon Route 53 Resolver Security|Top 10 Alerted Domains|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview|\_sourceCategory={{Route53ResolverQueryLogsSource}}  ALERT<br />\| where firewall\_rule\_action = "ALERT"<br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "(?\<response\>\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})"  multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| count by query\_name<br />\| sort by \_count<br />\| limit 10|
|Amazon Route 53 Resolver Security|Top 10 Blocked Domains?|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview|\_sourceCategory={{Route53ResolverQueryLogsSource}}  BLOCK<br />\| where firewall\_rule\_action = "BLOCK"<br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "(?\<response\>\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})"  multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| count by query\_name<br />\| sort by \_count<br />\| limit 10|
|Amazon Route 53 Resolver Security|Top 10 Blocked?Domains|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Resolver DNS Firewall|\_sourceCategory={{Route53ResolverQueryLogsSource}}  BLOCK<br />\| where firewall\_rule\_action = "BLOCK"<br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "(?\<response\>\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})"  multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| count by query\_name<br />\| sort by \_count<br />\| limit 10|
|Amazon Route 53 Resolver Security|Top 10 Queried Domains|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview|\_sourceCategory={{Route53ResolverQueryLogsSource}}  <br />\| %"srcids.instance" as instance\_id<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches "{{firewall\_rule\_group\_id}}"<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches "{{firewall\_domain\_list\_id}}"<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches "{{firewall\_rule\_action}}"<br />\| count by query\_name<br />\| sort by \_count<br />\| limit 10|
|Amazon Route 53 Resolver Security|Top 50 Domains by Query Length and InstanceID|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details|\_sourceCategory={{Route53ResolverQueryLogsSource}}  <br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "\\"(?\<response\>.\*?)\\"" multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(response matches "[]", "", response) as response<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| where !isEmpty(query\_name) AND (query\_name contains ".") \| length(query\_name) as dns\_length <br />\| count by instance\_id, dns\_length, query\_name<br />\| sort by dns\_length<br />\| limit 50|
|Amazon Route 53 Resolver Security|Top 50 Highest Entropy Domains|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details|\_sourceCategory={{Route53ResolverQueryLogsSource}}  <br />\| %"srcids.instance" as instance\_id<br />\| json "answers[\*].Rdata" as response nodrop<br />\| extract field=response "\\"(?\<response\>.\*?)\\"" multi nodrop<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(response matches "[]", "", response) as response<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches toLowerCase("{{firewall\_rule\_group\_id}}")<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches toLowerCase("{{firewall\_domain\_list\_id}}")<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches toLowerCase("{{firewall\_rule\_action}}")<br />\| where !isEmpty(query\_name) AND (query\_name contains ".") \| length(query\_name) as dns\_length \| count query\_name <br />\| parse regex field=query\_name "(?:\\S+\\.\|)(?\<root\>\\S+\\.?)\\.(?\<tld\>\\S+)" nodrop<br />\| count root, query\_name<br />\|parse regex field=root "(?\<char\>\\S)" multi nodrop <br />\| count char, root, query\_name<br />\| length(root) as dns\_length <br />\| \_count/dns\_length as frequency <br />\| frequency\*(log(frequency)/log(2)) as x <br />\| sum(x) as y by root, query\_name <br />\| y\*-1 as entropy <br />\| count root,query\_name, entropy<br />\| sort by entropy<br />\| limit 50|
|Amazon Route 53 Resolver Security|Top 50 Highest Entropy Domains|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview|\_sourceCategory={{Route53ResolverQueryLogsSource}}  <br />\| %"srcids.instance" as instance\_id<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches "{{firewall\_rule\_group\_id}}"<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches "{{firewall\_domain\_list\_id}}"<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches "{{firewall\_rule\_action}}"<br />\| where !isEmpty(query\_name) AND (query\_name contains ".") \| length(query\_name) as dns\_length \| count query\_name <br />\| parse regex field=query\_name "(?:\\S+\\.\|)(?\<root\>\\S+\\.?)\\.(?\<tld\>\\S+)" nodrop<br />\| count root, query\_name<br />\|parse regex field=root "(?\<char\>\\S)" multi nodrop <br />\| count char, root, query\_name<br />\| length(root) as dns\_length <br />\| \_count/dns\_length as frequency <br />\| frequency\*(log(frequency)/log(2)) as x <br />\| sum(x) as y by root, query\_name <br />\| y\*-1 as entropy <br />\| count root,query\_name, entropy<br />\| sort by entropy<br />\| limit 50|
|Amazon Route 53 Resolver Security|Total Hits from Threat Intel Source|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Security Details|\_sourceCategory={{Route53ResolverQueryLogsSource}} <br />\| %"srcids.instance" as instance\_id<br />\| where vpc\_id matches "{{vpc\_id}}"<br />\| where query\_name matches "{{query\_name}}"<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches "{{query\_type}}"<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches "{{instance\_id}}"<br />\| where region matches "{{region}}"<br />\| count as domain\_count by query\_name<br />\| lookup type, actor, raw, threatlevel as malicious\_confidence from sumo://threat/cs on threat=query\_name<br />\| where  type = "domain" and !isNull(malicious\_confidence)<br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| if (isEmpty(actor), "Unassigned", actor) as Actor<br />\| sum (domain\_count) as threat\_count|
|Amazon Route 53 Resolver Security|Total Hits from Threat Intel Source|Logs|Installed Apps/Amazon Route 53 Resolver Security/Amazon Route 53 Resolver Security - Query Logging Overview|\_sourceCategory={{Route53ResolverQueryLogsSource}} <br />\| %"srcids.instance" as instance\_id<br />\| toLowerCase(region)<br />\| toLowerCase(vpc\_id)<br />\| toLowerCase(query\_name)<br />\| toLowerCase(instance\_id)<br />\| toUpperCase(Query\_type)<br />\| toLowerCase(instance\_id)<br />\| toLowerCase(firewall\_rule\_group\_id)<br />\| toLowerCase(firewall\_domain\_list\_id)<br />\| toLowerCase(firewall\_rule\_action)<br />\| toLowerCase(response)<br />\| where vpc\_id matches toLowerCase("{{vpc\_id}}")<br />\| where query\_name matches toLowerCase("{{query\_name}}")<br />\| where account\_id matches "{{account\_id}}"<br />\| where query\_type matches toUpperCase("{{query\_type}}")<br />\| where srcaddr matches "{{srcaddr}}"<br />\| where instance\_id matches toLowerCase("{{instance\_id}}")<br />\| where region matches toLowerCase("{{region}}")<br />\| if(isNull(response), "", response) as response<br />\| where response matches toLowerCase("{{response}}")<br />\| if(isNull(firewall\_rule\_group\_id), "", firewall\_rule\_group\_id) as firewall\_rule\_group\_id<br />\| where firewall\_rule\_group\_id matches "{{firewall\_rule\_group\_id}}"<br />\| if(isNull(firewall\_domain\_list\_id), "", firewall\_domain\_list\_id) as firewall\_domain\_list\_id<br />\| where firewall\_domain\_list\_id matches "{{firewall\_domain\_list\_id}}"<br />\| if(isNull(firewall\_rule\_action), "", firewall\_rule\_action) as firewall\_rule\_action<br />\| where firewall\_rule\_action matches "{{firewall\_rule\_action}}"<br />\| count as domain\_count by query\_name<br />\| lookup type, actor, raw, threatlevel as malicious\_confidence from sumo://threat/cs on threat=query\_name<br />\| where  type = "domain" and !isNull(malicious\_confidence)<br />\| json field=raw "labels[\*].name" as label\_name <br />\| replace(label\_name, "\\\\/","-\>") as label\_name<br />\| replace(label\_name, "\\""," ") as label\_name<br />\| if (isEmpty(actor), "Unassigned", actor) as Actor<br />\| sum (domain\_count) as threat\_count|

