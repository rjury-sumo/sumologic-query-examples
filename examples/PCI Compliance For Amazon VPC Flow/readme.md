# PCI Compliance For Amazon VPC Flow
## Sumo Logic App For: PCI Compliance For Amazon VPC Flow
The Sumo Logic App for Payment Card Industry (PCI) Compliance for Amazon VPC Flow App offers dashboards to help you monitor that network traffic, network activities, and network security are within your expected ranges. The PCI Compliance for Amazon VPC Flow App covers PCI requirements 01, 02 and 04.
Docs Link: [PCI Compliance For Amazon VPC Flow](https://help.sumologic.com/?cid=1100)

## Searches

### Log Searches

- **Allowed Network Activity by Direction**: from Dashboard: PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 01 - Accepted And Rejected Traffic - New 
- **Allowed Network Activity by Transport and Internet Layer Protocol**: from Dashboard: PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 01 - Accepted And Rejected Traffic - New 
- **Allowed Traffic Over Time**: from Dashboard: PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 01 - Accepted And Rejected Traffic - New 
- **Denied Traffic Over Time**: from Dashboard: PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 01 - Accepted And Rejected Traffic - New 
- **Insecure Allowed Traffic by Application and Involved Host**: from Dashboard: PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 02, 04 - Insecure Data In Transit - New 
- **Insecure Allowed Traffic by Protocol**: from Dashboard: PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 02, 04 - Insecure Data In Transit - New 
- **Insecure Allowed Traffic by Target Port and Involved Host**: from Dashboard: PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 02, 04 - Insecure Data In Transit - New 
- **Insecure Denied Traffic by Protocol**: from Dashboard: PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 02, 04 - Insecure Data In Transit - New 
- **Insecure Transport Protocol to or from CDE**: from Dashboard: PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 02, 04 - Insecure Data In Transit - New 
- **Multi-service Detected on Same Host**: from Dashboard: PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 01, 02 - Data Access Monitoring - New 
- **Network Activity - Unencrypted Default Port**: from Dashboard: PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 02, 04 - Insecure Data In Transit - New 
- **Network Traffic Accepted vs Rejected**: from Dashboard: PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 01 - Accepted And Rejected Traffic - New 
- **Top DestIP**: from Dashboard: PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 01 - Accepted And Rejected Traffic - New 
- **Top DestIP**: from Dashboard: PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 01 - Accepted And Rejected Traffic - New 
- **Top SrcIP**: from Dashboard: PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 01 - Accepted And Rejected Traffic - New 
- **Top SrcIP**: from Dashboard: PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 01 - Accepted And Rejected Traffic - New 
- **Top TCP Dest Ports**: from Dashboard: PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 01, 02 - Data Access Monitoring - New 
- **Top UDP Dest Ports**: from Dashboard: PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 01, 02 - Data Access Monitoring - New 
- **Traffic By Application Over Time**: from Dashboard: PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 01, 02 - Data Access Monitoring - New

### Metric Searches


## Search Table

|app\_topic|search\_name|type|origin|search|
|:--|:--|:--|:--|:--|
|PCI Compliance For Amazon VPC Flow|Allowed Network Activity by Direction|Logs|PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 01 - Accepted And Rejected Traffic - New|\_sourceCategory = Labs/AWS/VPC ACCEPT<br />\| json "logStream", "logGroup", "message" as logStream, logGroup, msg<br />\| parse field=msg "\* \* \* \* \* \* \* \* \* \* \* \* \* \*" as version, account\_id, interface\_id, src\_ip, dest\_ip, src\_port, dest\_port, Protocol, packets, bytes, start, end, action, log\_status<br />\| where action="ACCEPT"<br />\| where ((compareCIDRPrefix("172.16.0.0", src\_ip, toInt(12)) or compareCIDRPrefix("192.168.0.0", src\_ip, toInt(16)) or compareCIDRPrefix("10.0.0.0", src\_ip, toInt(8)) and (!compareCIDRPrefix("172.16.0.0", dest\_ip, toInt(12)) and !compareCIDRPrefix("192.168.0.0", dest\_ip, toInt(16)) and !compareCIDRPrefix("10.0.0.0", dest\_ip, toInt(8)))) or <br />(compareCIDRPrefix("172.16.0.0", dest\_ip, toInt(12)) or compareCIDRPrefix("192.168.0.0", dest\_ip, toInt(16)) or compareCIDRPrefix("10.0.0.0", dest\_ip, toInt(8)) and (!compareCIDRPrefix("172.16.0.0", src\_ip, toInt(12)) and !compareCIDRPrefix("192.168.0.0", src\_ip, toInt(16)) and !compareCIDRPrefix("10.0.0.0", src\_ip, toInt(8)))))<br /><br />\| if (compareCIDRPrefix("172.16.0.0", src\_ip, toInt(12)) or compareCIDRPrefix("192.168.0.0", src\_ip, toInt(16)) or compareCIDRPrefix("10.0.0.0", src\_ip, toInt(8)), "outbound","inbound") as direction<br />\| timeslice 1m<br />\|where if ("{{protocol}}" = "\*", true, protocol matches "{{protocol}}") AND if ("{{action}}" = "\*", true, action matches "{{action}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{dest\_port}}" = "\*", true, dest\_port matches "{{dest\_port}}") AND if ("{{src\_port}}" = "\*", true, src\_port matches "{{src\_port}}") AND if ("{{dest\_ip}}" = "\*", true, dest\_ip matches "{{dest\_ip}}") AND if ("{{direction}}" = "\*", true, direction matches "{{direction}}") AND if ("{{account\_id}}" = "\*", true, account\_id matches "{{account\_id}}")<br />\|count by \_timeslice, direction \| transpose row \_timeslice column direction|
|PCI Compliance For Amazon VPC Flow|Allowed Network Activity by Transport and Internet Layer Protocol|Logs|PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 01 - Accepted And Rejected Traffic - New|\_sourceCategory = Labs/AWS/VPC ACCEPT<br />\| json "logStream", "logGroup", "message" as logStream, logGroup, msg<br />\| parse field=msg "\* \* \* \* \* \* \* \* \* \* \* \* \* \*" as version, account\_id, interface\_id, src\_ip, dest\_ip, src\_port, dest\_port, Protocol, packets, bytes, start, end, action, log\_status<br />\| where action="ACCEPT"<br />\| where ((compareCIDRPrefix("172.16.0.0", src\_ip, toInt(12)) or compareCIDRPrefix("192.168.0.0", src\_ip, toInt(16)) or compareCIDRPrefix("10.0.0.0", src\_ip, toInt(8)) and (!compareCIDRPrefix("172.16.0.0", dest\_ip, toInt(12)) and !compareCIDRPrefix("192.168.0.0", dest\_ip, toInt(16)) and !compareCIDRPrefix("10.0.0.0", dest\_ip, toInt(8)))) or <br />(compareCIDRPrefix("172.16.0.0", dest\_ip, toInt(12)) or compareCIDRPrefix("192.168.0.0", dest\_ip, toInt(16)) or compareCIDRPrefix("10.0.0.0", dest\_ip, toInt(8)) and (!compareCIDRPrefix("172.16.0.0", src\_ip, toInt(12)) and !compareCIDRPrefix("192.168.0.0", src\_ip, toInt(16)) and !compareCIDRPrefix("10.0.0.0", src\_ip, toInt(8)))))<br />\| timeslice 1m<br />\|where if ("{{protocol}}" = "\*", true, protocol matches "{{protocol}}") AND if ("{{action}}" = "\*", true, action matches "{{action}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{dest\_port}}" = "\*", true, dest\_port matches "{{dest\_port}}") AND if ("{{src\_port}}" = "\*", true, src\_port matches "{{src\_port}}") AND if ("{{dest\_ip}}" = "\*", true, dest\_ip matches "{{dest\_ip}}") AND if ("{{account\_id}}" = "\*", true, account\_id matches "{{account\_id}}")<br />\|count by \_timeslice, protocol \| protocol as Protocol\_Val<br />\| lookup Keyword from https://s3.amazonaws.com/sumologic-app-data/protocol-numbers.csv on Decimal=Protocol\_val <br />\| if (isNull(keyword), Protocol\_val, Keyword) as Protocol \| fields -keyword, protocol\_val <br />\| transpose row \_timeslice column protocol|
|PCI Compliance For Amazon VPC Flow|Allowed Traffic Over Time|Logs|PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 01 - Accepted And Rejected Traffic - New|\_sourceCategory = Labs/AWS/VPC ACCEPT<br />\| json "logStream", "logGroup", "message" as logStream, logGroup, msg<br />\| parse field=msg "\* \* \* \* \* \* \* \* \* \* \* \* \* \*" as version, account\_id, interface\_id, src\_ip, dest\_ip, src\_port, dest\_port, Protocol, packets, bytes, start, end, action, log\_status<br />\| where action="ACCEPT"<br />\| timeslice 5m<br />\|where if ("{{protocol}}" = "\*", true, protocol matches "{{protocol}}") AND if ("{{action}}" = "\*", true, action matches "{{action}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{dest\_port}}" = "\*", true, dest\_port matches "{{dest\_port}}") AND if ("{{src\_port}}" = "\*", true, src\_port matches "{{src\_port}}") AND if ("{{dest\_ip}}" = "\*", true, dest\_ip matches "{{dest\_ip}}") AND if ("{{account\_id}}" = "\*", true, account\_id matches "{{account\_id}}")<br />\|count by \_timeslice|
|PCI Compliance For Amazon VPC Flow|Denied Traffic Over Time|Logs|PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 01 - Accepted And Rejected Traffic - New|\_sourceCategory = Labs/AWS/VPC REJECT<br />\| json "logStream", "logGroup", "message" as logStream, logGroup, msg<br />\| parse field=msg "\* \* \* \* \* \* \* \* \* \* \* \* \* \*" as version, account\_id, interface\_id, src\_ip, dest\_ip, src\_port, dest\_port, Protocol, packets, bytes, start, end, action, log\_status<br />\| where action="REJECT"<br />\| timeslice 5m<br />\|where if ("{{protocol}}" = "\*", true, protocol matches "{{protocol}}") AND if ("{{action}}" = "\*", true, action matches "{{action}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{dest\_port}}" = "\*", true, dest\_port matches "{{dest\_port}}") AND if ("{{src\_port}}" = "\*", true, src\_port matches "{{src\_port}}") AND if ("{{dest\_ip}}" = "\*", true, dest\_ip matches "{{dest\_ip}}") AND if ("{{account\_id}}" = "\*", true, account\_id matches "{{account\_id}}")<br />\|count by \_timeslice|
|PCI Compliance For Amazon VPC Flow|Insecure Allowed Traffic by Application and Involved Host|Logs|PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 02, 04 - Insecure Data In Transit - New|\_sourceCategory = Labs/AWS/VPC ACCEPT (21 or 23 or 80 or 8008 or 8080 or 513)<br />\| json "logStream", "logGroup", "message" as logStream, logGroup, msg<br />\| parse field=msg "\* \* \* \* \* \* \* \* \* \* \* \* \* \*" as version, account\_id, interface\_id, src\_ip, dest\_ip, src\_port, dest\_port, Protocol, packets, bytes, start, end, action, log\_status<br />\| where Action="ACCEPT" and dest\_port in ("21", "23", "80", "8008", "8080", "513")<br />\| if ((compareCIDRPrefix("172.16.0.0", dest\_ip, toInt(12)) or compareCIDRPrefix("192.168.0.0", dest\_ip, toInt(16)) or compareCIDRPrefix("10.0.0.0", dest\_ip, toInt(8))), dest\_ip, src\_ip) as %"Cardholder Host"<br />\|where if ("{{protocol}}" = "\*", true, protocol matches "{{protocol}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{dest\_port}}" = "\*", true, dest\_port matches "{{dest\_port}}") AND if ("{{src\_port}}" = "\*", true, src\_port matches "{{src\_port}}") AND if ("{{dest\_ip}}" = "\*", true, dest\_ip matches "{{dest\_ip}}") AND if ("{{account\_id}}" = "\*", true, account\_id matches "{{account\_id}}") AND if ("{{interface\_id}}" = "\*", true, interface\_id matches "{{interface\_id}}")<br />\|count as Incidents by %"Cardholder Host", dest\_port<br />\| lookup Keyword from https://s3.amazonaws.com/sumologic-app-data/port-numbers.csv on Decimal=dest\_port<br />\| if (isNull(keyword), dest\_port, Keyword) as application<br />\| fields -keyword, dest\_port <br />\| transpose row %"Cardholder Host" column application|
|PCI Compliance For Amazon VPC Flow|Insecure Allowed Traffic by Protocol|Logs|PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 02, 04 - Insecure Data In Transit - New|\_sourceCategory = Labs/AWS/VPC ACCEPT (21 or 23 or 80 or 8008 or 8080 or 513)<br />\| json "logStream", "logGroup", "message" as logStream, logGroup, msg<br />\| parse field=msg "\* \* \* \* \* \* \* \* \* \* \* \* \* \*" as version, account\_id, interface\_id, src\_ip, dest\_ip, src\_port, dest\_port, Protocol, packets, bytes, start, end, action, log\_status<br />\| where Action="ACCEPT" and dest\_port in ("21", "23", "80", "8008", "8080", "513")<br />\| if ((compareCIDRPrefix("172.16.0.0", dest\_ip, toInt(12)) or compareCIDRPrefix("192.168.0.0", dest\_ip, toInt(16)) or compareCIDRPrefix("10.0.0.0", dest\_ip, toInt(8))), dest\_ip, src\_ip) as %"Cardholder Host"<br />\| timeslice 5m<br />\|where if ("{{protocol}}" = "\*", true, protocol matches "{{protocol}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{dest\_port}}" = "\*", true, dest\_port matches "{{dest\_port}}") AND if ("{{src\_port}}" = "\*", true, src\_port matches "{{src\_port}}") AND if ("{{dest\_ip}}" = "\*", true, dest\_ip matches "{{dest\_ip}}") AND if ("{{account\_id}}" = "\*", true, account\_id matches "{{account\_id}}") AND if ("{{interface\_id}}" = "\*", true, interface\_id matches "{{interface\_id}}")<br />\|count as Incidents by \_timeslice, Protocol \| protocol as Protocol\_Val<br />\| lookup Keyword from https://s3.amazonaws.com/sumologic-app-data/protocol-numbers.csv on Decimal=Protocol\_val <br />\| if (isNull(keyword), Protocol\_val, Keyword) as Protocol<br />\| fields -keyword, protocol\_val <br />\| transpose row \_timeslice column Protocol|
|PCI Compliance For Amazon VPC Flow|Insecure Allowed Traffic by Target Port and Involved Host|Logs|PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 02, 04 - Insecure Data In Transit - New|\_sourceCategory = Labs/AWS/VPC\* ACCEPT (21 or 23 or 80 or 8008 or 8080 or 513)<br />\| json "logStream", "logGroup", "message" as logStream, logGroup, msg<br />\| parse field=msg "\* \* \* \* \* \* \* \* \* \* \* \* \* \*" as version, account\_id, interface\_id, src\_ip, dest\_ip, src\_port, dest\_port, Protocol, packets, bytes, start, end, action, log\_status<br />\| where Action="ACCEPT" and dest\_port in ("21", "23", "80", "8008", "8080", "513")<br />\| if ((compareCIDRPrefix("172.16.0.0", dest\_ip, toInt(12)) or compareCIDRPrefix("192.168.0.0", dest\_ip, toInt(16)) or compareCIDRPrefix("10.0.0.0", dest\_ip, toInt(8))), dest\_ip, src\_ip) as %"Cardholder Host"<br />\| dest\_port as %"Destination Port"<br />\|where if ("{{protocol}}" = "\*", true, protocol matches "{{protocol}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{dest\_port}}" = "\*", true, dest\_port matches "{{dest\_port}}") AND if ("{{src\_port}}" = "\*", true, src\_port matches "{{src\_port}}") AND if ("{{dest\_ip}}" = "\*", true, dest\_ip matches "{{dest\_ip}}") AND if ("{{account\_id}}" = "\*", true, account\_id matches "{{account\_id}}") AND if ("{{interface\_id}}" = "\*", true, interface\_id matches "{{interface\_id}}")<br />\|count as Incidents by %"Cardholder Host", %"Destination Port", Protocol \| protocol as Protocol\_Val<br />\| lookup Keyword from https://s3.amazonaws.com/sumologic-app-data/protocol-numbers.csv on Decimal=Protocol\_val <br />\| if (isNull(keyword), Protocol\_val, Keyword) as Protocol \| protocol as %"Protocol"<br />\| fields -keyword, protocol\_val <br />\| transpose row %"Destination Port", Protocol column %"Cardholder Host"|
|PCI Compliance For Amazon VPC Flow|Insecure Denied Traffic by Protocol|Logs|PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 02, 04 - Insecure Data In Transit - New|\_sourceCategory = Labs/AWS/VPC REJECT (21 or 23 or 80 or 8008 or 8080 or 513)<br />\| json "logStream", "logGroup", "message" as logStream, logGroup, msg<br />\| parse field=msg "\* \* \* \* \* \* \* \* \* \* \* \* \* \*" as version, account\_id, interface\_id, src\_ip, dest\_ip, src\_port, dest\_port, Protocol, packets, bytes, start, end, action, log\_status<br />\| where Action="REJECT" and dest\_port in ("21", "23", "80", "8008", "8080", "513")<br />\| if ((compareCIDRPrefix("172.16.0.0", dest\_ip, toInt(12)) or compareCIDRPrefix("192.168.0.0", dest\_ip, toInt(16)) or compareCIDRPrefix("10.0.0.0", dest\_ip, toInt(8))), dest\_ip, src\_ip) as %"Cardholder Host"<br />\| timeslice 5m<br />\|where if ("{{protocol}}" = "\*", true, protocol matches "{{protocol}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{dest\_port}}" = "\*", true, dest\_port matches "{{dest\_port}}") AND if ("{{src\_port}}" = "\*", true, src\_port matches "{{src\_port}}") AND if ("{{dest\_ip}}" = "\*", true, dest\_ip matches "{{dest\_ip}}") AND if ("{{account\_id}}" = "\*", true, account\_id matches "{{account\_id}}") AND if ("{{interface\_id}}" = "\*", true, interface\_id matches "{{interface\_id}}")<br />\|count as Incidents by \_timeslice, Protocol \| protocol as Protocol\_Val<br />\| lookup Keyword from https://s3.amazonaws.com/sumologic-app-data/protocol-numbers.csv on Decimal=Protocol\_val <br />\| if (isNull(keyword), Protocol\_val, Keyword) as Protocol<br />\| fields -keyword, protocol\_val <br />\| transpose row \_timeslice column Protocol|
|PCI Compliance For Amazon VPC Flow|Insecure Transport Protocol to or from CDE|Logs|PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 02, 04 - Insecure Data In Transit - New|\_sourceCategory = Labs/AWS/VPC ACCEPT (21 or 23 or 513)<br />\| json "logStream", "logGroup", "message" as logStream, logGroup, msg<br />\| parse field=msg "\* \* \* \* \* \* \* \* \* \* \* \* \* \*" as version, account\_id, interface\_id, src\_ip, dest\_ip, src\_port, dest\_port, Protocol, packets, bytes, start, end, action, log\_status<br />// 21 - FTP, 23 - Telnet, 513 - rlogin<br />\| where Action="ACCEPT" and dest\_port in ("21", "23", "513")<br />// Note - Its assumed that the CDE comprise of IP address from 172.16.0.0/12, 192.168.0.0/16 and 10.0.0.0/8. User can configure specific IP addresses  based on org CDE IP address range(s)<br />\| where (compareCIDRPrefix("172.16.0.0", dest\_ip, toInt(12)) or compareCIDRPrefix("192.168.0.0", dest\_ip, toInt(16)) or compareCIDRPrefix("10.0.0.0", dest\_ip, toInt(8)) or compareCIDRPrefix("172.16.0.0", src\_ip, toInt(12)) or compareCIDRPrefix("192.168.0.0", src\_ip, toInt(16)) or compareCIDRPrefix("10.0.0.0", src\_ip, toInt(8)) and (dest\_port in ("21", "23", "513")))<br />\| timeslice 15m<br />\|where if ("{{protocol}}" = "\*", true, protocol matches "{{protocol}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{dest\_port}}" = "\*", true, dest\_port matches "{{dest\_port}}") AND if ("{{src\_port}}" = "\*", true, src\_port matches "{{src\_port}}") AND if ("{{dest\_ip}}" = "\*", true, dest\_ip matches "{{dest\_ip}}") AND if ("{{account\_id}}" = "\*", true, account\_id matches "{{account\_id}}") AND if ("{{interface\_id}}" = "\*", true, interface\_id matches "{{interface\_id}}")<br />\|count as eventCount by \_timeslice, account\_Id, dest\_ip, dest\_port, interface\_Id, protocol, src\_ip, src\_port<br />\| "High" as Severity \| "Insecure Transport Protocol to or from CDE" as message|
|PCI Compliance For Amazon VPC Flow|Multi-service Detected on Same Host|Logs|PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 01, 02 - Data Access Monitoring - New|\_sourceCategory = Labs/AWS/VPC ACCEPT (80 or 8008 or 8080 or 443 or 3306 or 5439 or 5432 or 1433 or 2638 or 5984) // 3306 - MySQL/RDS, 5439 - Amazon Redshift, 5432 - PostgreSQL, 1433 - MS SQL Server, 2638 - SQLAnywhere, 5984 - couchdb<br />\| json "logStream", "logGroup", "message" as logStream, logGroup, msg<br />\| parse field=msg "\* \* \* \* \* \* \* \* \* \* \* \* \* \*" as version, account\_id, interface\_id, src\_ip, dest\_ip, src\_port, dest\_port, Protocol, packets, bytes, start, end, action, log\_status<br />\| where action="ACCEPT"<br />\| if (dest\_port in ("80", "8008", "8080", "443"), 1, 0 ) as web<br />\| if (dest\_port in ("3306", "5439", "5432", "1433", "2638", "5984"), 1, 0 ) as db<br />\|where if ("{{action}}" = "\*", true, action matches "{{action}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{dest\_port}}" = "\*", true, dest\_port matches "{{dest\_port}}") AND if ("{{src\_port}}" = "\*", true, src\_port matches "{{src\_port}}") AND if ("{{dest\_ip}}" = "\*", true, dest\_ip matches "{{dest\_ip}}") AND if ("{{account\_id}}" = "\*", true, account\_id matches "{{account\_id}}")<br />\|sum(web) as webcount, sum(db) as dbcount by dest\_ip<br />// db ports and web ports typically should not be open on same host<br />\| where (webcount \> 0 and dbcount \> 0)<br />\| fields -webcount, dbcount<br />\| toMillis(now()) as \_timeslice<br />\| "Multi-services detected (DB Port open with Web Port) on same host" as message<br />\| "Medium" as Severity|
|PCI Compliance For Amazon VPC Flow|Network Activity - Unencrypted Default Port|Logs|PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 02, 04 - Insecure Data In Transit - New|\_sourceCategory = Labs/AWS/VPC ACCEPT (21 or 23 or 80 or 8008 or 8080 or 513)<br />\| json "logStream", "logGroup", "message" as logStream, logGroup, msg<br />\| parse field=msg "\* \* \* \* \* \* \* \* \* \* \* \* \* \*" as version, account\_id, interface\_id, src\_ip, dest\_ip, src\_port, dest\_port, Protocol, packets, bytes, start, end, action, log\_status<br />\| where Action="ACCEPT" and dest\_port in ("21", "23", "80", "8008", "8080", "513")<br />// Unencrypted traffic default ports (FTP - port 21, telnet - port 23, http - port 80, 8008, 8080, rlogin - port 513)<br />\| timeslice 1m<br />\|where if ("{{protocol}}" = "\*", true, protocol matches "{{protocol}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{dest\_port}}" = "\*", true, dest\_port matches "{{dest\_port}}") AND if ("{{src\_port}}" = "\*", true, src\_port matches "{{src\_port}}") AND if ("{{dest\_ip}}" = "\*", true, dest\_ip matches "{{dest\_ip}}") AND if ("{{account\_id}}" = "\*", true, account\_id matches "{{account\_id}}") AND if ("{{interface\_id}}" = "\*", true, interface\_id matches "{{interface\_id}}")<br />\|count by \_timeslice, dest\_port <br />\| transpose row \_timeslice column dest\_port|
|PCI Compliance For Amazon VPC Flow|Network Traffic Accepted vs Rejected|Logs|PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 01 - Accepted And Rejected Traffic - New|\_sourceCategory = Labs/AWS/VPC (ACCEPT or REJECT)<br />\| json "logStream", "logGroup", "message" as logStream, logGroup, msg<br />\| parse field=msg "\* \* \* \* \* \* \* \* \* \* \* \* \* \*" as version, account\_id, interface\_id, src\_ip, dest\_ip, src\_port, dest\_port, Protocol, packets, bytes, start, end, action, log\_status<br />\| where action in ("ACCEPT", "REJECT")<br />\| timeslice 1m<br />\|where if ("{{protocol}}" = "\*", true, protocol matches "{{protocol}}") AND if ("{{action}}" = "\*", true, action matches "{{action}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{dest\_port}}" = "\*", true, dest\_port matches "{{dest\_port}}") AND if ("{{src\_port}}" = "\*", true, src\_port matches "{{src\_port}}") AND if ("{{dest\_ip}}" = "\*", true, dest\_ip matches "{{dest\_ip}}") AND if ("{{account\_id}}" = "\*", true, account\_id matches "{{account\_id}}")<br />\|count by \_timeslice, action <br />\| transpose row \_timeslice column action|
|PCI Compliance For Amazon VPC Flow|Top DestIP|Logs|PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 01 - Accepted And Rejected Traffic - New|\_sourceCategory = Labs/AWS/VPC ACCEPT<br />\| json "logStream", "logGroup", "message" as logStream, logGroup, msg<br />\| parse field=msg "\* \* \* \* \* \* \* \* \* \* \* \* \* \*" as version, account\_id, interface\_id, src\_ip, dest\_ip, src\_port, dest\_port, Protocol, packets, bytes, start, end, action, log\_status<br />\| where action="ACCEPT"<br />\|where if ("{{protocol}}" = "\*", true, protocol matches "{{protocol}}") AND if ("{{action}}" = "\*", true, action matches "{{action}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{dest\_port}}" = "\*", true, dest\_port matches "{{dest\_port}}") AND if ("{{src\_port}}" = "\*", true, src\_port matches "{{src\_port}}") AND if ("{{dest\_ip}}" = "\*", true, dest\_ip matches "{{dest\_ip}}") AND if ("{{account\_id}}" = "\*", true, account\_id matches "{{account\_id}}")<br />\|count by dest\_ip \| dest\_ip as %"Destination IP"<br />\| top 10 %"Destination IP" by \_count|
|PCI Compliance For Amazon VPC Flow|Top DestIP|Logs|PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 01 - Accepted And Rejected Traffic - New|\_sourceCategory = Labs/AWS/VPC REJECT<br />\| json "logStream", "logGroup", "message" as logStream, logGroup, msg<br />\| parse field=msg "\* \* \* \* \* \* \* \* \* \* \* \* \* \*" as version, account\_id, interface\_id, src\_ip, dest\_ip, src\_port, dest\_port, Protocol, packets, bytes, start, end, action, log\_status<br />\| where action="REJECT"<br />\|where if ("{{protocol}}" = "\*", true, protocol matches "{{protocol}}") AND if ("{{action}}" = "\*", true, action matches "{{action}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{dest\_port}}" = "\*", true, dest\_port matches "{{dest\_port}}") AND if ("{{src\_port}}" = "\*", true, src\_port matches "{{src\_port}}") AND if ("{{dest\_ip}}" = "\*", true, dest\_ip matches "{{dest\_ip}}") AND if ("{{account\_id}}" = "\*", true, account\_id matches "{{account\_id}}")<br />\|count by dest\_ip \| dest\_ip as %"Destination IP"<br />\| top 10 %"Destination IP" by \_count|
|PCI Compliance For Amazon VPC Flow|Top SrcIP|Logs|PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 01 - Accepted And Rejected Traffic - New|\_sourceCategory = Labs/AWS/VPC REJECT<br />\| json "logStream", "logGroup", "message" as logStream, logGroup, msg<br />\| parse field=msg "\* \* \* \* \* \* \* \* \* \* \* \* \* \*" as version, account\_id, interface\_id, src\_ip, dest\_ip, src\_port, dest\_port, Protocol, packets, bytes, start, end, action, log\_status<br />\| where action="REJECT"<br />\|where if ("{{protocol}}" = "\*", true, protocol matches "{{protocol}}") AND if ("{{action}}" = "\*", true, action matches "{{action}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{dest\_port}}" = "\*", true, dest\_port matches "{{dest\_port}}") AND if ("{{src\_port}}" = "\*", true, src\_port matches "{{src\_port}}") AND if ("{{dest\_ip}}" = "\*", true, dest\_ip matches "{{dest\_ip}}") AND if ("{{account\_id}}" = "\*", true, account\_id matches "{{account\_id}}")<br />\|count by src\_ip \| src\_ip as %"Source IP"<br />\| top 10 %"Source IP" by \_count|
|PCI Compliance For Amazon VPC Flow|Top SrcIP|Logs|PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 01 - Accepted And Rejected Traffic - New|\_sourceCategory = Labs/AWS/VPC ACCEPT<br />\| json "logStream", "logGroup", "message" as logStream, logGroup, msg<br />\| parse field=msg "\* \* \* \* \* \* \* \* \* \* \* \* \* \*" as version, account\_id, interface\_id, src\_ip, dest\_ip, src\_port, dest\_port, Protocol, packets, bytes, start, end, action, log\_status<br />\| where action="ACCEPT"<br />\|where if ("{{protocol}}" = "\*", true, protocol matches "{{protocol}}") AND if ("{{action}}" = "\*", true, action matches "{{action}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{dest\_port}}" = "\*", true, dest\_port matches "{{dest\_port}}") AND if ("{{src\_port}}" = "\*", true, src\_port matches "{{src\_port}}") AND if ("{{dest\_ip}}" = "\*", true, dest\_ip matches "{{dest\_ip}}") AND if ("{{account\_id}}" = "\*", true, account\_id matches "{{account\_id}}")<br />\|count by src\_ip \| src\_ip as %"Source IP"<br />\| top 10 %"Source IP" by \_count|
|PCI Compliance For Amazon VPC Flow|Top TCP Dest Ports|Logs|PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 01, 02 - Data Access Monitoring - New|\_sourceCategory = Labs/AWS/VPC ACCEPT 6 // TCP = 6<br />\| json "logStream", "logGroup", "message" as logStream, logGroup, msg<br />\| parse field=msg "\* \* \* \* \* \* \* \* \* \* \* \* \* \*" as version, account\_id, interface\_id, src\_ip, dest\_ip, src\_port, dest\_port, Protocol, packets, bytes, start, end, action, log\_status<br />\| where Action="ACCEPT" and Protocol="6"<br />\| where ((compareCIDRPrefix("172.16.0.0", src\_ip, toInt(12)) or compareCIDRPrefix("192.168.0.0", src\_ip, toInt(16)) or compareCIDRPrefix("10.0.0.0", src\_ip, toInt(8)) and (!compareCIDRPrefix("172.16.0.0", dest\_ip, toInt(12)) and !compareCIDRPrefix("192.168.0.0", dest\_ip, toInt(16)) and !compareCIDRPrefix("10.0.0.0", dest\_ip, toInt(8)))) or <br />(compareCIDRPrefix("172.16.0.0", dest\_ip, toInt(12)) or compareCIDRPrefix("192.168.0.0", dest\_ip, toInt(16)) or compareCIDRPrefix("10.0.0.0", dest\_ip, toInt(8)) and (!compareCIDRPrefix("172.16.0.0", src\_ip, toInt(12)) and !compareCIDRPrefix("192.168.0.0", src\_ip, toInt(16)) and !compareCIDRPrefix("10.0.0.0", src\_ip, toInt(8)))))<br />\|where if ("{{action}}" = "\*", true, action matches "{{action}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{dest\_port}}" = "\*", true, dest\_port matches "{{dest\_port}}") AND if ("{{src\_port}}" = "\*", true, src\_port matches "{{src\_port}}") AND if ("{{dest\_ip}}" = "\*", true, dest\_ip matches "{{dest\_ip}}") AND if ("{{account\_id}}" = "\*", true, account\_id matches "{{account\_id}}")<br />\|count as count by dest\_port \| sort by count \| limit 10|
|PCI Compliance For Amazon VPC Flow|Top UDP Dest Ports|Logs|PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 01, 02 - Data Access Monitoring - New|\_sourceCategory = Labs/AWS/VPC ACCEPT 17 // UDP = 17<br />\| json "logStream", "logGroup", "message" as logStream, logGroup, msg<br />\| parse field=msg "\* \* \* \* \* \* \* \* \* \* \* \* \* \*" as version, account\_id, interface\_id, src\_ip, dest\_ip, src\_port, dest\_port, Protocol, packets, bytes, start, end, action, log\_status<br />\| where Action="ACCEPT" and Protocol="17"<br />\| where ((compareCIDRPrefix("172.16.0.0", src\_ip, toInt(12)) or compareCIDRPrefix("192.168.0.0", src\_ip, toInt(16)) or compareCIDRPrefix("10.0.0.0", src\_ip, toInt(8)) and (!compareCIDRPrefix("172.16.0.0", dest\_ip, toInt(12)) and !compareCIDRPrefix("192.168.0.0", dest\_ip, toInt(16)) and !compareCIDRPrefix("10.0.0.0", dest\_ip, toInt(8)))) or <br />(compareCIDRPrefix("172.16.0.0", dest\_ip, toInt(12)) or compareCIDRPrefix("192.168.0.0", dest\_ip, toInt(16)) or compareCIDRPrefix("10.0.0.0", dest\_ip, toInt(8)) and (!compareCIDRPrefix("172.16.0.0", src\_ip, toInt(12)) and !compareCIDRPrefix("192.168.0.0", src\_ip, toInt(16)) and !compareCIDRPrefix("10.0.0.0", src\_ip, toInt(8)))))<br />\|where if ("{{action}}" = "\*", true, action matches "{{action}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{dest\_port}}" = "\*", true, dest\_port matches "{{dest\_port}}") AND if ("{{src\_port}}" = "\*", true, src\_port matches "{{src\_port}}") AND if ("{{dest\_ip}}" = "\*", true, dest\_ip matches "{{dest\_ip}}") AND if ("{{account\_id}}" = "\*", true, account\_id matches "{{account\_id}}")<br />\|count as count by dest\_port \| sort by count \| limit 10|
|PCI Compliance For Amazon VPC Flow|Traffic By Application Over Time|Logs|PCI Compliance For Amazon VPC Flow/Amazon VPC Flow Logs - PCI Req 01, 02 - Data Access Monitoring - New|\_sourceCategory = Labs/AWS/VPC ACCEPT (21 or 23 or 80 or 8008 or 8080 or 443 or 513 or 3306 or 5439 or 5432 or 1433 or 2638 or 5984) // 3306 - MySQL/RDS, 5439 - Amazon Redshift, 5432 - PostgreSQL, 1433 - MS SQL Server, 2638 - SQLAnywhere, 5984 - couchdb<br />\| json "logStream", "logGroup", "message" as logStream, logGroup, msg<br />\| parse field=msg "\* \* \* \* \* \* \* \* \* \* \* \* \* \*" as version, account\_id, interface\_id, src\_ip, dest\_ip, src\_port, dest\_port, Protocol, packets, bytes, start, end, action, log\_status<br />\| where Action="ACCEPT" and dest\_port in ("21", "23", "80", "8008", "8080", "443", "513", "3306", "5439", "5432", "1433", "2638", "5984")<br />\| timeslice 5m<br />\|where if ("{{action}}" = "\*", true, action matches "{{action}}") AND if ("{{src\_ip}}" = "\*", true, src\_ip matches "{{src\_ip}}") AND if ("{{dest\_port}}" = "\*", true, dest\_port matches "{{dest\_port}}") AND if ("{{src\_port}}" = "\*", true, src\_port matches "{{src\_port}}") AND if ("{{dest\_ip}}" = "\*", true, dest\_ip matches "{{dest\_ip}}") AND if ("{{account\_id}}" = "\*", true, account\_id matches "{{account\_id}}")<br />\|count as count by \_timeslice, dest\_port<br />\| lookup Keyword from https://s3.amazonaws.com/sumologic-app-data/port-numbers.csv on Decimal=dest\_port<br />\| if (isNull(keyword), dest\_port, Keyword) as application<br />\| if (dest\_port="5439", "Redshift", application ) as application<br />\| fields -keyword, dest\_port <br />\| transpose row \_timeslice column application|

